 1. Introduction treatment. It is crucial that visibly foreign particles are not present in injections, as they cannot be metabolized by the human body ( Zheng, 2005 ). Nevertheless, different categories of foreign particles, for example rubber chips, chemical fibers, glass fragments, calcium carbonate and other crystalline solids ( Zhao et al., 2005 ) often appear in injection liquids due to the quality of the injection container, the packaging, collisions during proce-dures, filtration or filling. Thrombus, phlebitis, tumors, anaphy-lactic reactions or even death can be caused once these insoluble particles are injected into the circulatory system.
 maceutical Industry Association, 99.6% of pharmaceutical cor-porations in China employ the manual visual inspection method to check their products ( Zheng, 2005 ). This method may be somewhat useful, but the inspection validity and repeatability are poor, with the omission error rate (percentage of unqualified products believed to be qualified) synchronously increasing due to inspectors using their eyes for long periods of time.
In order to follow the US Food and Drug Administration X  X  strict clauses, the pharmaceutical industry relies heavily on automated process-control and quality-assurance systems in order to ensure that batch production is carried out repeatedly, reliably, and accurately. This is where the automatic inspection machine can be utilized. Only a few enterprises, for example, Germany X  X  Seidenader ( http://www.seidenader.de ), Italy X  X  Brevetti C.E.A ( http://www.brevetti-cea.com ) and Japan X  X  Eisai Co., Ltd. ( http:// www.eisai.com/index.asp ) have developed this kind of equip-ment. Similarly, quite a small number of pharmaceutical indus-tries in China have purchased and utilized these machines because they are too expensive. Furthermore, the liquid filtering procedures and packaging materials are quite different in China from those used in western countries, which results in high error-inspection rates.

Other developments in this field, such as the use of rectangular plastic bottles in medicinal solution detection based on real-time image processing are proposed in a reference article ( Ishii et al., 1998 ). In addition, some experiments have researched the dis-crimination of particles concerning their size and shape ( Shimizu et al., 2004 ), as well as the visualization of the spatial behavior of particles ( Kato et al., 2002 ). The developmental studies of the detection of impure particles in water supplies are demonstrated in ( Kato et al., 2002 ), and some other inspection examples can be found by Marino et al. (2007) and Chang et al., (2009) .
Aiming to overcome the shortcomings on current liquid foreign particles inspection methods, an automatic liquid foreign particle inspection machine based on machine vision has been developed. The ampoules or vials are small, simple in shape and have a smooth surface. Therefore, it is easy to gather the foreign particles into the center by forming a vortex in the solution and distinguishing them from scratches when they are abruptly stopped. In addition, in our machine, the detection object is mass transfusion and it is commonly used with glass or plastic contain-ers. Certain containers can have complicated surfaces with embossed symbols and graduations on the surface, which makes it difficult to create a vortex and to distinguish the foreign particles from uneven parts of the surface.

Image segmentation and the recognition of foreign particles are the key modules of AIM. A large number of different image segmentation techniques are currently available. Basic algorithms such as thresholding, edge detection and region growing are described in article ( Gonzalez and Woods, 2002 ). Although simple to implement, these methods usually have serious shortcomings when employed in practical situations. Several newer and more advanced techniques have been proposed to address these pro-blems. One interesting class of methods is the graph-based method ( Felzenszwalb and Huttenlocher, 2004 ), which has yielded several impressive results ( Shi and Malik, 2000 ; Wenbing et al., 2008 ; Xiao and Shah, 2005 ). Regarding  X  X  X otion pattern recogni-tion X  X , a new methodology ( Chamorro-Martinez and Fernandez-Valdivia, 2007 ), is applied to the optical flow estimations.  X  X  X dap-tive integrated image segmentation and object recognition X  X  are described in the paper ( Bhanu and Peng, 2000 ) and  X  X  X ersatile segmentation procedures X  X  in the paper ( Vanzella and Torre, 2006 ).
PCNN is a biologically inspired type of neural network, which was based on the experimental observations of synchronous pulse bursts in the visual cortex of cats and monkeys ( Eckhorn et al., 1990 ). The PCNN model can be applied to image processing without a training process. However, in orde r for it to be applied successfully, there needs to be a properly set number for the numerical control parameters. Unfortunately, it is difficult to estimate how to select the best values for a given application. The optimum values typically depend on certain attributes of the images which are to be segmented, such as pixel intensity ranges, contrasts and noise levels. As a consequence, values which were successful for one set of images may not be useful for other images with different intensity ranges, contrasts and noise levels. Some different solutions have been suggested in order to address this problem, including the use of  X  X  X daptive connection weights between neighboring neurons X  X  ( Schreiter et al., 2003 ),  X  X  X utomatic adaptation by genetic algorithms X  X  ( Bhanu et al., 1995 ),  X  X  X einforcement learning X  X  ( Bhanu and Peng, 2000 ) and  X  X  X eural networks X  X  ( Boskovitz and Guterman, 2002 ).
This paper illuminates an adaptive segmentation method based on a modified PCNN. Most of the parameters are simplified and the iteration time N is determined by maximizing 2-D Tsallis Entropy. According to the continuity and smoothness properties of the extracted objects X  moving trace, the inspection machine judges whether it is acceptable or not. Furthermore, improved spin/stop techniques for controlling the motors and illumination styles are applied to reduce the influence of air bubbles. The experimental results show that AIM, which is superior to profi-cient workers, can detect the visible foreign particles effectively with speed and accuracy.

The rest of this paper is organized as follows: Section 2 introduces the AIM, including the mechanical structure, the electric control system, the illumination styles and the spin/stop control strategies; Section 3 presents the procedures of image preproces-sing, the sequence image differences based on  X  X  X ssimilation filling X  X , the calculation of the image X  X  2-D Tsallis Entropy, foreign particles segmentation based on modified PCNN, feature extractions and foreign particles judgment; Section 4 highlights the experiments and the analysis of the results; Section 5 presents the conclusion. 2. Overview of the intelligent inspection machine 2.1. Types of foreign particles
Foreign particles like fiber, glass chip, rubber, hair or styrene resin may appear in parenteral drugs. However, these particles can only be divided into two types, black and white, depending on their appearance under special illumination. Some appear as black spots against backlight illumination. Others appear as luminous spots when illuminated by collimated light. Table 1 shows some typical samples and sources of the foreign particles. 2.2. System X  X  mechanical structure
One important observation is the motion of the fluid in the injection container as it rotates. The long-standing belief that centripetal force was the primary particle motivator and that once set in motion particles would stay near the interior wall has been disproved. During the initial period in which the container is spun, centripetal force does, in fact, move the particles outward against the interior wall. However, shortly after the rotational motion has been abruptly stopped, a vortex is created in the fluid, and particles of lower mass move in a spiral motion towards the axis of rotation within the container. If the particle has sufficiently low mass, the vortex will lift the particle off of the floor of the container. Thus, two important stations (see Figs. 1 and 2 ) are arranged in the system X  X  mechanical design. An in-feed star wheel, a main inspection plat-form and an out-feed star wheel cons titute the transmission system: (1) High speed revolving station : a rotating tray, driven by the motor which is located underneath the machine table, rotates quickly as the injection container triggers the photoelectric sensor 1. The foreign particles are moved outwards against the interior wall due to centripetal force. The rotating tray and (2) Abruptly stopping station : this station is one of the areas 2.3. Electric control system with industrial PC and PLC have better real-time performance and stability, which completely fits into the assembly X  X  long-standing work station. IPC is mainly in charge of running the detection software, the image analysis and the product qualification X  X  judgment. Specifically, PLC sends trigger pulses to a camera every 35 ms as the relevant photoelectric sensor is triggered by the passing injection bottle. IPC accesses the images stored in the video capturing card via PCI bus, it judges the injection as either qualified or not with detection software, then sends signals to the ejector. Here, multi-channel data is processed; hence SIEMENS S7-300 PLC has been selected for this control system. 2.4. Illumination styles and imaging method
To acquire high-definition, stable luminance images, 630-nm red LEDs are selected. For foreign particles such as hair, or carbide, a 2-D LED backlight panel (see Fig. 4 (a)) is placed behind the bottle facing the camera. The particles moving with the liquid pass between the light source and the camera. In order to detect white particles such as glass fragments, a round condensing LED panel is installed underneath the bottle and a plastic blackboard is placed behind it (see Fig. 4 (b)). Reflecting lights can then reach the camera as the glass fragment falls.

To ideally illuminate the injection container as it rotates, the samples need to be uniformly lit from all sides. Using a custom-built current controller, light intensity is controlled from the system X  X  host PC through standard digital I/O lines. Low-opacity particles (such as fibers) can be illuminated more effectively using low light levels, while heavy (optically dense) particles can be illuminated with a brighter, more intense light.

For large-volume injection containers, a suitable depth of field (DOF) is required. This is accomplished using a 100-mm-focal-length lens and folded optics in order to increase the object-to-camera distance and thus increase the depth of field on the objects side, which is shown in Fig. 5 . Furthermore, such folded optics can reduce the space between the imaging system and the injection container. 2.5. Improved spin/stop servo control strategy
To reduce the occurrence probability of air bubbles, improved spin/stop techniques for the rotating tray is demonstrated with reference to Fig. 6 , in which the abscissa denotes the time ( t ), and the ordinate represents the spin speed ( w ). Compared to former researcher X  X  studies,  X  X  X cceleration phase A  X  X  and  X  X  X eceleration phase D  X  X  are added to reduce the violent vibrations created by the motor X  X  abrupt starting and stopping.
 The spin/stop technique is preferably executed as follows:
At t  X  t 0 , the bottle starts to rotate up to 1500 revolutions per minute with constant acceleration. This phase is indicated as  X  X  X cceleration phase A  X  X .
 visible at all times, so subsequent images ( I 1 , I 2 , I and compared in order to improve the detection reliability (see Fig. 6 ).
This phase is indicated as  X  X  X epeated measurement phase RM  X  X . 3. Key algorithms of foreign particles inspection system demands of the manufacturers, fingerprints, graduations or dust can sometimes be seen on the surfaces of the bottles (shown in Fig. 7 (a)). Unfortunately, in a single image, foreign particles lack structural information and distinctive characteristics, especially if they only occupy several pixels. In addition, it is hard to distinguish them from noises (lights) and disturbances (dusts or graduations) depending solely on their gray values. Fortunately, foreign substances in liquid have two obvious properties which can make them easy to identify the moving trace is timely continuous and there are certain gray value differences between foreign particles and the background. Thus, the procedures of foreign particle inspections can be performed as follows: (in addition, the flowchart is shown in Fig. 8 ): (1) Sequential images of bottles are acquired with two different (2) A preprocessing procedure is applied to regulate the input of (3) The difference algorithms of the sequential images are based (4) The sequential images X  2-D Tsallis Entropy is calculated. (5) Foreign particles segmentation is based on modified PCNN. Its (6) The foreign particles are deemed as acceptable or not through 3.1. Image preprocessing
In an image with foreign objects, the majority of the pixels are occupied in the background which pertains to slowly varying, low-frequency parts, while foreign particles pertain to high frequency parts and are unrelated to the background. Even though low frequency components can be attenuated with high-pass filters, parts of the high luminance noises are retained. Butterworth high-pass filter ( Gonzalez and Woods, 2002 ) is applied in this paper.
Image M N can be recognized as formed with large low frequency background and some high frequency parts. Suppose the captured sequence images are f  X  x , y ; t i  X  X  p  X  x , y ; t i  X  X  q  X  x , y ; t i  X  x  X  0 , 1 , ... , M ; y  X  0 , 1 , ... , N ; i  X  0 , 1 , ... , n  X  1  X  where p ( x , y ; t i ) are ideal background; q ( x , y ; t including high frequency noises and foreign particles. According to convolution theorem, G  X  u , v ; t i  X  X  F  X  u , v ; t i  X  H  X  u , v ; t i  X  X  2  X  images after Fourier transformation, then reverse transform it and get the enhanced images. 3.2. Modified sequence image X  X  difference based on  X  X  X ssimilation filling X  X 
The  X  X  X ollow phenomenon X  X  may occur in image difference methods due to foreign particles (e.g. fiber and hair) having lower mass or short-moving distance. This defect can be compensated with assimilation-filling algorithms based on the traditional image difference method (see Fig. 9 ). This algorithm is carried out as follows. Let I k ( x , y ) denote the sequential images. Step 1: Calculate the different images D k ( x , y ) between frames: D k  X  x , y  X  X  9 I k  X  1  X  x , y  X  I k  X  x , y  X  9  X  3  X  Step 2: Get the binary images with thresholding to D k ( x , y ).
Step 3: Calculate the minimum circumscribed rectangle Box ( i ) within which foreign particles are included.

Step 4: Consider two points P 1 and P 2 on a random line L through random pixel P in Box ( i ), they are satisfied with
Set pixel P  X  X  gray value 255, which denotes pixel P is assimi-lated within R according to L .

As we can see from the difference image in Fig. 7 (b), small particles do exist in the glucose injection liquids. Referring to article ( Zheng, 2005 ), injections are chemical liquids which also contain some tiny medicinal powder. Therefore, to distinguish bright spots as foreign substances, noises or acceptably small medicinal powder, a more accurate object outline must be obtained. 3.3. Calculation of image X  X  2-D Tsallis Entropy
Images in nature have long-range memories and dissipative system. They can be better described with non-extensive Tsallis Entropy ( Tsallis, 1988 ). Through thousands of image processing experiments, it can be concluded that more effective results ( Abutableb, 1989 ; Sahoo and Arora, 2004 ; Sahoo and Arora, 2006 ) can be achieved when q  X  0.8 , as compared to Shannon Entropy.
Images X  Tsallis Entropy can be calculated through one-dimen-sional histograms. Defects such as boundary fractures, or under or over segmentation may exist in image segmentation because only gray values are considered in one-dimensional histograms. How-ever, spatial information is included in 2-D histograms in addition to the gray values ( Sahoo and Arora, 2004 ). Hence, Tsallis Entropy, combined with 2-D histograms, is applied in image segmentation.
Let f ( m , n ) be the gray value of the pixel located at the point ( m , n ) . A digital image of size M N is a matrix of the form [ f ( m , n ) 9 m  X  1, 2, y , M and n  X  1, 2, y , N ] or in short form [ f ( m , n ) ]. In our test images, the set of all gray values G  X  {0, 1, 2,
The 2-D histogram X  X  construction and the calculations of image X  X  Tsallis Entropy are discussed as follows: neighborhood of the pixel located at the point ( x , y ) . The average gray value for the 3 3 neighborhood of each pixel is calculated as g  X  x , y  X  X  1 9 where [ r ] denotes the integer part of the number r . While computing the average gray value, disregard the two rows from the top and bottom and the two columns from the sides.
The pixel X  X  gray value, f ( x , y ) , and the average of its neighbor-hood, g ( x , y ) , are used to construct a 2-D histogram using h  X  m , n  X  X  Prob f f  X  x , y  X  X  m and g  X  x , y  X  X  n g X  5  X  where m , n A G . For a given image, there are several methods used to estimate this density function. One of the most frequently used methods is the  X  X  method of relative frequency  X  X .
The normalized histogram is approximated by using the following formula: ^ h  X  m , n  X  X  number of pixels with f f  X  x , y  X  X  m , g  X  x , y  X  X  n g
The joint probability mass function p ( m, n ) is given by p  X  m , n  X  X  ^ h  X  m , n  X  X  7  X  where m , n  X  0, 1, 2, y , 255. (2) Image X  X  2-D Tsallis Entropy : supposing an image f ( x , y ) has been segmented into two independent sets, object O and background B , respectively; their 2-D Tsallis Entropy can be defined as
E q  X  f  X  X  E q  X  O  X  X  E q  X  B  X  X  X  1 q  X  E q  X  O  X  E q  X  B  X  X  8  X  where E q ( O ) and E q ( B ) denotes the 2-D Tsallis Entropy:
E q  X  O  X  X 
E q  X  B  X  X  where h ij ( O ) and h ij ( B ) denotes the object and background X  X  2-D histograms, respectively. 3.4. Foreign substance segmentation based on modified PCNN (1) PCNN model and parameters determination : PCNN is a biologi-cally inspired type of neural network and was adopted for image processing by Johnson and Padgett (1999) .As Karvonen (2004) mentions, a very large set of data is required to optimize PCNN parameters, which is unfeasible in most (2) Determine the best iteration time N of the PCNN model : 3.5. Feature extraction and foreign particles judgment
In order to recognize multiple objects, every particle in the sequence images should be labeled and their invariance proper-ties must be extracted. Selected properties need perfect invar-iance in order to get an image of geometrical transformations such as motions, rotations and translations. Three values having good invariance properties are shown as follows: (1) Ratio of object X  X  circumference to area, k 1 . k 1  X  L (2) Length X  X idth ratio k 2 . Searching each object X  X  minimum (3) Compactness k 3 . k 3  X  S i /(a i b i ) . (4) Furthermore, coordinates ( C ix , C iy ) of particles and remaining
According to the invariance properties of k 1 , k 2 , k 3 objects X  moving trace (see Fig.11 ), we can judge that they are foreign substances or caused by noise through two principles: (1) The images are captured when the bottle is kept static. At this (2) The traces formed by the particles are smooth, while those 4. Experiments and analysis 4.1. Experimental description The  X  X  Knapp X  X ushner Test  X  X , recognized by The European Pharmacopoeia and The US Food &amp; Drug Administration (FDA), is applied to evaluate the AIM and the detection software X  X  effectiveness. It is used to compare the machine inspection of particles in liquid containers with that of human inspection. Since the correct inspection rate cannot be larger than 100%, the idea is that the machine X  X  sensitivity should be approximately 10 X 20% better than a human X  X  and its rejection criterion should correlate with that of the inspectors. Testing results are shown in Table 2 .
Experimental instructions: (1) All of the following experiments were carried out on the (2) 125 ml 0.9% sodium chloride solution and 125 ml 10% glucose (3) Hardware composition : CPU (Pentium 4, 3.00 GHz), 1 GB (4) Implementation environment : MATLAB 2008a. where FQA, FQB: quality factor of proficient inspectors and AIM. FQ i  X  ( n / N )10, where n is rejected times; N is the overall detection times. Sensitivity: one parameter of the machine.

According to the inspection speed (7200 bottles/h, 125 ml volume) and the camera X  X  capturing frequency (60 frames per second) in our system, seven sequential images are required for image processing. It should be noted that different inspection speeds, image processing and electrical/mechanical execution speeds determines the optimum number of captured images. Regarding particles with high mass (such as big glass chips or carbide), 5 images are enough; while the particles of lower mass (fiber or short hair), commonly require 7 X 10 images.

In Experiments I and II, capturing only 5 or 4 images was required for test examples. 4.2. Experiment I (black foreign particle detection)
After capturing five sequential images of a 0.9% sodium chloride injection with backlight and doing the segmentation with the Canny operator, followed by the modified PCNN, which is shown in Fig. 14 , edge-based methods ( X  X  X oG, Sobel, Canny operator X  X ) were selected as examples to be compared with the proposed modified PCNN method. Their shortcomings can be concluded from the comparisons. 4.3. Experiment II (White foreign particle detection)
Four sequential images of 0.9% sodium chloride injection with bottom illumination were acquired and segmented with LoG, Sobel, Canny operator, and the modified PCNN, respectively (see
Fig.15 ). 4.4. Experiment III (objective evaluation of segmentation results)
Segmentation consistency U ( Kohler, 1981 ), region contrast C ( Yin, 2007 ) and shape measurement S ( Kohler, 1981 ) are com-pared between Canny, the traditional PCNN model and the modified PCNN algorithm proposed in this paper (see Table 3 ). These parameters are defined as follows:
U  X  1 number of components in set R i , C 1 is the normalization coeffi-cient:
C  X  9 f
O  X  f B where f O and f B are image pixels of objects and background, respectively: S  X 
P where f N ( x , y ) denotes the mean value of neighborhood N ( x , y ); T is the threshold. D ( x , y ) is the generalized gradient; C normalization coefficient.

The larger the values of these three parameters, the higher the quality of the segmentation validity. 4.5. Experiment IV (injections with typical foreign particles detection test)
Proficient inspectors selected some 10% glucose injections with three kind of typical foreign particles (45,000 injections with Glass chips, Fiber and Rubber chips, 15,000 bottles each kind) which were checked by designed AIM. Their correct detec-tion rates are shown in Table 4 .
 4.6. Experiment V (batch detection with AIM) glucose injections were used as batch detection objects: (1) A batch of glucose injections were inspected by AIM and the (2) Firstly, the injections were in spected by proficient workers. 4.7. Experiment VI and our machine. The comparison can be seen in Table 7 . 4.8. Experiment analysis particles can be extracted with LoG, Sobel and Canny operator; nevertheless, high-frequency random noises are also observed.
When noises are assumed to be foreign particles, the error detection rate is higher at the same time. In Experiment I, although the segmentation results with Sobel operator are some-what better than Canny and LoG operator, the edges of images ( http://www.seidenader.de ); ( http://www.brevetti-cea.com ) are too weak to be distinguished. The modified PCNN model can filter noises effectively, and judge the extracted blobs as foreign substances according to the properties of the moving trace. Upon objective comparison of the segmentation effectiveness through quantifiable indexes, the modified PCNN is superior and one-third of the iteration time as compared to the traditional methods.
Table 2 , Experiments IV and V indicate that AIM is better than the traditional method by which utilizes human inspections. Omission error rates are only one-fourth of the proficient inspec-tors. Correct detection rates of injections with black foreign particles precede those with white ones primarily owing to the high contrast images of black foreign substances under the circumstance of backlight illumination style. While white sub-stances (glass chips for example), if their reflecting planes do not facing the CCD camera, the image contrast will reduce sharply with bottom light reflection illumination style. False alarm occurrences mainly caused by (1) vibrations derived from rotary table and rotating tray X  X  abrupt stop, (2) disturbance from outside lights and (3) instability of light source for detection. False alarm rates of injections with glass particles are larger than those with fiber or rubber chips mainly due to instability of the light source and disturbance from outside lights. Omission errors appear due to thefactthattheforeignparticlesmaymoveoutsideofthecamera X  X  focus and, therefore, the particles will be blurred or will not appear in the images. In this circumstance, more images must be acquired, which improves the particle X  X  appearance probability in the images. and can detect more tiny foreign particles. Although the inspec-tion speed is 7200 bottles/h, the AIM X  X  omission error rate is only 0.15%. 5. Conclusions cles in injection liquid is demonstrated in this article. Obstruc-tions like scratches, embossed symbols, and graduations on the containers surface can be removed with sequential image proces-sing. Most of the PCNN model X  X  parameters are simplified and one of the parameters (iteration time) can be achieved by maximizing the 2-D Tsallis Entropy. It is capable of perfectly segmenting images even when there is a considerable overlap in the intensity ranges of adjacent regions. The continuity and smoothness properties of the extracted object X  X  moving trace are the judging criterion of the system. Experiments show that AIM is superior to the proficient inspectors on liquid particle inspection.
The machine is designed for 125 ml volume injections; never-theless, different volumes, from 10 to 1000 ml can also be inspected by reconfiguring CCD cameras, LED panel size, and other clamping devices. 4 mega-pixels or higher resolution imagers may be utilized to inspect the 1000 ml injection contain-ers, which guarantee that small foreign objects (like 30 m min diameter) can be effectively detected.
 drive units in order to reduce the vibrations created by the mechanical systems. More suitable illumination styles and differ-ent image processing algorithms may be explored with the current inspection platform.
 Acknowledgments
Development Plan (Grant nos. 2007AA04Z244, 2008AA04Z214) and the National Natural Science Foundation of China (Grant nos. 60835004, 60775047, 61072121).
 References
