 Jurgen Van Gael jv279@cam.ac.uk Yunus Saatci ys267@cam.ac.uk Yee Whye Teh ywteh@gatsby.ucl.ac.uk Zoubin Ghahramani zoubin@eng.cam.ac.uk The hidden Markov model (HMM) (Rabiner, 1989) is one of the most widely used models in machine learn-ing and statistics for sequential or time series data. The HMM consists of a hidden state sequence with Markov dynamics, and independent observations at each time given the corresponding state. There are three learning related tasks associated with the HMM: inference of the hidden state sequence, learning of the parameters, and selection of the right model size. Inference for the hidden state trajectory can be performed exactly using the forward-backward algo-rithm (Rabiner, 1989), a dynamic programming algo-rithm with O ( TK 2 ) computational costs where T is the number of time steps and K number of states. The standard approach to learning uses the Baum-Welch algorithm, a special instance of the EM al-gorithm (Dempster et al., 1977) which produces (lo-cally) maximum likelihood (ML) parameters. Such ML learning of parameters can potentially lead to over-fitting if the model size is inappropriate for the amount of data available. This can be partially mitigated us-ing a more fully Bayesian learning procedure, e.g. using variational approximations (MacKay, 1997) or Markov chain Monte Carlo (MCMC) sampling (Scott, 2002). Such Bayesian approaches also produce estimates of the marginal probability of data, which can be used to select for the appropriate model size (or to average over model sizes if ones desires a more Bayesian analysis). Such model selection procedures can be computation-ally expensive since multiple HMMs of different sizes need to be explored.
 A new twist on the problem of model selection has emerged in recent years with the increasing popu-larity of nonparametric Bayesian models. These are models of infinite capacity, a finite portion of which will be used to model a finite amount of observed data. The idea of searching/averaging over the space of finite models is replaced with Bayesian inference over the size of submodel used to explain data. Ex-amples of successful applications of nonparametric Bayesian methods include Gaussian Processes (Ras-mussen &amp; Williams, 2005) for regression and classifi-cation, Dirichlet Process (DP) mixture models (Es-cobar &amp; West, 1995; Rasmussen, 2000) for cluster-ing heterogeneous data and density estimation, Indian Buffet Processes for latent factor analysis (Griffiths &amp; Ghahramani, 2006), and defining distributions over non-trivial combinatorial objects such as trees (Teh et al., 2008).
 The Infinite Hidden Markov Model (iHMM), otherwise known as the HDP-HMM, (Beal et al., 2002) is a non-parametric Bayesian extension of the HMM with an infinite number of hidden states. Exact Bayesian in-ference for the iHMM is intractable. Specifically, given a particular setting of the parameters the forward-backward algorithm cannot be applied since the num-ber of states K is infinite, while with the parameters marginalized out all hidden state variables will be cou-pled and the forward-backward algorithm cannot be applied either. Currently the only approximate in-ference algorithm available is Gibbs sampling, where individual hidden state variables are resampled condi-tioned on all other variables (Teh et al., 2006). Unfor-tunately convergence of Gibbs sampling is notoriously slow in the HMM setting due to the strong dependen-cies between consecutive time steps often exhibited by time series data (Scott, 2002).
 In this paper we propose a new sampler for the iHMM called beam sampling . Beam sampling combines two ideas X  X lice sampling and dynamic programming X  X o sample whole state trajectories efficiently. Our ap-plication of slice sampling (Neal, 2003) is inspired by (Walker, 2007), who used it to limit the number of clusters considered when sampling assignment vari-ables in DP mixtures to a finite number. We apply slice sampling to limit to a finite number the states considered in each time step of the iHMM, so that dy-namic programming can be used to sample whole state trajectories efficiently. We call our proposal beam sampling due to its similarity to beam search, a heuris-tic procedure for finding the maximum a posteriori trajectory given observations in non-linear dynamical systems. The underlying idea in both is to limit the search to a small number of states so that a good tra-jectory can be found using reasonable computational resources. However, ours is a MCMC sampling method with guaranteed convergence to the true posterior. We first present a self-contained description of the iHMM using the Hierarchical Dirichlet process (HDP) formalism (Teh et al., 2006) in Section 2, followed by a discussion of Gibbs sampling in Section 3. We introduce beam sampling in Section 4 and compare it against Gibbs sampling on both artificial and real datasets in Section 5. We find that beam sampling is (1) at least as fast if not faster than Gibbs sam-pling; (2) more robust than Gibbs sampling as its performance is not as dependent on initialization and hyperparameter choice; (3) handles non-conjugacy in the model more naturally; (4) straightforward to im-plement. We conclude in Section 6 with a discus-sion and suggestions for other cases in which beam sampling might prove useful. All software is avail-able from http://mlg.eng.cam.ac.uk/jurgen to encour-age more widespread adoption of the iHMM and the beam sampler. We start this section by describing the finite HMM, then taking the infinite limit to obtain an intuition for the infinite HMM, followed by a more precise def-inition. A finite HMM consists of a hidden state se-quence s = ( s 1 ,s 2 ,...,s T ) and a corresponding ob-servation sequence y = ( y 1 ,y 2 ,...,y T ). Each state variable s t can take on a finite number of states, say 1 ...K . Transitions between states are governed by Markov dynamics parameterized by the transition ma-trix  X  , where  X  ij = p ( s t = j | s t  X  1 = i ), while the ini-tial state probabilities are  X  0 i = p ( s 1 = i ). For each state s t  X  { 1 ...K } there is a parameter  X  s t which parametrizes the observation likelihood for that state: y | s t  X  F (  X  s the HMM, the joint distribution over hidden states s and observations y can be written (with s 0 = 0): We complete the Bayesian description by specifying the priors. Let the observation parameters  X  be iid drawn from a prior distribution H . With no fur-ther prior knowledge on the state sequence, the typical prior for the transition (and initial) probabilities are symmetric Dirichlet distributions.
 A na  X  X ve way to obtain a nonparametric HMM with an infinite number of states might be to use symmetric Dirichlet priors over the transition probabilities with parameter  X /K and take K  X   X  . Such an approach has been successfully used to derive DP mixture mod-els (Rasmussen, 2000) but unfortunately does not work in the HMM context. The subtle reason is that there is no coupling across transitions out of different states since the transition probabilities are given indepen-dent priors (Beal et al., 2002). To introduce coupling across transitions, one may use a hierarchical Bayesian formalism where the Dirichlet priors have shared pa-rameters and given a higher level prior, e.g. where  X  k are transition probabilities out of state k and  X  are the shared prior parameters. As K  X  X  X  , the hi-erarchical prior (1) approaches (with some alterations) a hierarchical Dirichlet process (Teh et al., 2006). A hierarchical Dirichlet process (HDP) is a set of Dirichlet processes (DPs) coupled through a shared random base measure which is itself drawn from a DP (Teh et al., 2006). Specifically, each G k  X  DP (  X ,G 0 ) with shared base measure G 0 , which can be understood as the mean of G k , and concentration parameter  X  &gt; 0, which governs variability around G 0 , with small  X  implying greater variability. The shared base measure is itself given a DP prior: G 0  X  DP (  X ,H ) with H a global base measure. The stick-breaking con-struction for HDPs shows that the random measures can be expressed as follows: G 0 = P  X  k 0 =1  X  k 0  X   X  G k = P breaking construction for DPs (Sethuraman, 1994),  X  k  X  DP (  X ,  X  ), and each  X  k 0  X  H independently. Identifying each G k as describing both the transition probabilities  X  kk 0 from state k to k 0 and the emis-sion distributions parametrized by  X  k 0 , we can now formally define the iHMM as follows:  X   X  GEM (  X  ) ,  X  k |  X   X  DP (  X ,  X  ) ,  X  k  X  H, (2) s The graphical model corresponding to this hierarchical model is shown in figure 1. Thus  X  k 0 is the prior mean for transition probabilities leading into state k 0 , and  X  governs the variability around the prior mean. If we fix  X  = ( 1 K ... 1 K , 0 , 0 ... ) where the first K entries are and the remaining are 0, then transition probabilities into state k 0 will be non-zero only if k 0  X  X  1 ...K } , and we recover the Bayesian HMM of (MacKay, 1997). Finally we place priors over the hyperparameters  X  and  X  . A common solution, when we do not have strong beliefs about the hyperparameters, is to use gamma hyperpriors:  X   X  Gamma ( a  X  ,b  X  ) and  X   X  Gamma ( a  X  ,b  X  ). (Teh et al., 2006) describe how these hyperparameters can be sampled efficiently, and we will use this in the experiments to follow. The Gibbs sampler was the first sampling algorithm for the iHMM that converges to the true posterior. One proposal builds on the direct assignment sampling scheme for the HDP in (Teh et al., 2006) by marginal-izing out the hidden variables  X  ,  X  from (2), (3) and ignoring the ordering of states implicit in  X  . Thus we only need to sample the hidden trajectory s , the base DP parameters  X  and the hyperparameters  X  ,  X  . Sam-pling  X  , X , X  is exactly the same as for the HDP so we refer to (Teh et al., 2006) for details.
 In order to resample s t , we need to compute the prob-ability p ( s t | s  X  t ,  X  , y , X ,H )  X  p ( y t | s t , s p ( s t | s  X  t ,  X  , X  ). The first factor is the con-ditional likelihood of y t given s , y and H : R p ( y t | s t ,  X  s t ) p (  X  s t | s  X  t , y  X  t ,H ) d  X  compute when the base distribution H and likelihood F from equations (2) and (3) are conjugate. For the second factor we can use the fact that the hid-den state sequence is Markov. Let n ij be the number of transitions from state i to state j excluding time steps t  X  1 and t . Let n  X  i ,n i  X  be the number of tran-sitions in and out of state i . Finally, let K be the number of distinct states in s  X  t . Then we have that 1 p ( s t = k | s  X  t ,  X  , X  )  X  For each 1  X  t  X  T we need to compute O ( K ) probabilities, hence the Gibbs sampler has an O ( TK ) computational complexity. Non-conjugate models can be handled using more sophisticated sampling tech-niques. In our experiments below, we used algorithm 8 from (Neal, 2000).
 The Gibbs sampler X  X  success is due to its straightfor-ward implementation. However, it suffers from one major drawback: sequential and time series data are likely to be strongly correlated. For example, if we know the value of a stock at time t then we can be reasonably sure that it will be similar at time t + 1. As is well known, this is a situation which is far from ideal for the Gibbs sampler: strong correlations in the hid-den states will make it unlikely that individual updates to s t can cause large blocks within s to be changed. We will now introduce the beam sampler which does not suffer from this slow mixing behavior by sampling the whole sequence s in one go. The forward-backward algorithm does not apply to the iHMM because the number of states, and hence the number of potential state trajectories, are infinite. The idea of beam sampling is to introduce auxiliary variables u such that conditioned on u the number of trajectories with positive probability is finite. Now dynamic programming can be used to compute the conditional probabilities of each of these trajectories and thus sample whole trajectories efficiently. These auxiliary variables do not change the marginal distri-bution over other variables hence MCMC sampling will converge to the true posterior. This idea of using aux-iliary variables to limit computation costs is inspired by (Walker, 2007), who applied it to limit the number of components in a DP mixture model that need be considered during sampling.
 As opposed to the sampler in the previous section, the beam sampler does not marginalize out  X  nor  X  . Specifically, the beam sampler iteratively samples the auxiliary variables u , the trajectory s , the transition probabilities  X  , the shared DP parameters  X  and the hyperparameters  X  and  X  conditioned on all other vari-ables. In the following, we shall describe in more detail how to sample each set of variables, as well as how the auxiliary variables allow dynamic programming to be carried out over a finite number of trajectories without approximations.
 Sampling u : for each t we introduce an auxil-iary variable u t with conditional distribution u t  X  Sampling s : we sample the whole trajectory s given the auxiliary variables u and other variables using a form of forward filtering-backward sampling. The im-portant observation here is that only trajectories s with  X  s t  X  1 s t  X  u t for all t will have non-zero probabil-ity given u . There are only finitely many such trajec-tories 2 and as a result we can compute the conditional distribution over all such trajectories efficiently using dynamic programming.
 First note that the probability density for u if condition C is true and 0 otherwise. We compute p ( s t | y 1: t ,u 1: t ) for all t as follows (we omitted the ad-ditional conditioning variables  X  and  X  for clarity): = X = p ( y t | s t ) X = p ( y t | s t ) X Note that we only need to compute (4) for the finitely many s t values belonging to some trajectory with positive probability. Further, although the sum over s t  X  1 is technically a sum over an infinite number of terms, the auxiliary variable u t truncates this summa-tion to the finitely many s t  X  1  X  X  that satisfy both con-Finally, to sample the whole trajectory s , we sam-ple s T from p ( s T | y 1: T ,u 1: T ) and perform a backward pass where we sample s t given the sample for s t +1 Sampling  X  ,  X  ,  X  : these follow directly from the theory of HDPs (Teh et al., 2006), but we briefly de-scribe these for completeness.
 Let n ij be the number of times state i transi-tions to state j in the trajectory s , where i,j  X  { 1 ...K } , K is the number of distinct states in s , and these states have been relabeled 1 ...K . Merg-ing the infinitely many states not represented in s into one state, the conditional distribution of (  X  s ,  X  ,  X  is To sample  X  we introduce a further set of auxiliary variables m ij which are independent with conditional distributions where S (  X  ,  X  ) denotes Stirling numbers of the first kind. The shared DP parameter (  X  1 ..., X  K , P  X  k 0 = K +1 has conditional distribution 1974) gives more details.
 Finally, each  X  k is independent of others conditional on s , y and their prior distribution H , i.e. p (  X  | s , y ,H ) = Q k p (  X  k | s , y ,H ). When the base distribution H is conjugate to the data distribution F each  X  k can be sampled efficiently. Otherwise we may resort to Metropolis-Hastings or other approaches. Note that in the non-conjugate case this is simpler than for Gibbs sampling. In the experimental section, we describe an application where the base distribution and likelihood are non-conjugate.
 To conclude our discussion of the beam sampler, it is useful to point out that there is nothing special about sampling u t from the uniform distribution on [0 , X  s t  X  1 ,s t ]: by choosing a distribution over [0 , X  with higher mass near smaller values of u t , we will al-low more trajectories to have positive probability and hence considered by the forward filtering-backward sampling algorithm. Although this will typically im-prove mixing time, it also comes at additional compu-tational cost. This brings us to the issue of the com-putational cost of the beam sampler: since for each timestep and each state assignment we need to sum over all represented previous states, the worst case complexity is O ( TK 2 ). However, the sum in (4) is only over previous states for which the transition probabil-ity is larger than u t ; this means that in practice we might only need to sum over a few previous states. In our experiments below, we will give some empirical evidence for this  X  X verage case X  behavior. Further, we have found that the drastically improved mixing of the beam sampler more than made up for the additional cost over Gibbs sampling. Finally, although we did not find any advantage doing so, it is certainly possible to interleave the beam sampler and the Gibbs sampler. We evaluate the beam sampler on two artificial and two real datasets to illustrate the following properties: (1) the beam sampler mixes in much fewer iterations than the Gibbs sampler; (2) the actual complexity per iteration of the beam sampler is only marginally more than the Gibbs sampler; (3) the beam sampler mixes well regardless of strong correlations in the data; (4) the beam sampler is more robust with respect to vary-ing initialization and prior distribution; (5) the beam sampler handles non conjugate models naturally; (6) the iHMM is a viable alternative to the finite HMM. All datasets and a Matlab version of our software are available at http://mlg.eng.cam.ac.uk/jurgen . 5.1. Artificial Data Our first experiment compares the performance of the iHMM on a sequence of length 800 generated by a 4 state HMM. The hidden state sequence was almost cyclic (1-2-3-4-1-2-3-. . . ) with a 1% probability of self transition: i.o.w the true distribution of hidden states is strong negatively correlated. We use a multinomial output distribution with the following emission matrix Next we run the Gibbs and beam sampler 20 times from a random initialization with every state randomly chosen between 1 and 20. We test the performance of both samplers using three different hyperparame-ter settings: (1) vague gamma hyperpriors for  X  and  X  ( Gamma (1 , 1) and Gamma (2 , 1) respectively); (2) strong gamma hyperpriors for  X  and  X  ( Gamma (6 , 15) and Gamma (16 , 4) respectively); (3) fixed hyperparam-eters  X  = 0 . 4 , X  = 3 . 8. The latter were chosen using the values the beam and Gibbs samplers converged to. At every iteration, we greedily compute an assignment of sample states to true states to maximize overlap and use the resulting Hamming distance as our error mea-sure. The top plot in figure 3 clearly shows that the beam sampler discovers the underlying structure much faster than the Gibbs sampler. Also, the beam sam-pler is insensitive to the prior while the performance of the Gibbs sampler becomes worse as we strengthen our prior beliefs. The bottom plot of figure 3 shows how many states are summed over in equation (4) av-eraged per timestep, per state. We find that after only about 20 iterations, the beam sampler on average con-siders a little more than one state. This implies that the actual complexity of the beam sampler is closer to O ( TK ) rather than the worst case complexity of O ( TK 2 ). Although this behavior is dependent on the choice of distribution for the auxiliary variable u t and the sparsity of the transition matrix, we have verified that this behavior is consistent also for larger iHMM X  X . Our second experiment illustrates the performance of the beam sampler on data generated from HMM X  X  with increasing positive correlation between the hid-den states. We generated sequences of length 4000 from a 4 state HMM with self-transition probabilities increasing from 0 . 75 to 0 . 95 and finally 0 . 999. In one experiment (top plot of figure 4) we generated nor-mal distributed observation from an informative out-dard deviation 0 . 5, in another experiment (bottom plot of figure 4) we generated normal distributed ob-servations from a less informative output model with We initialize the experiment as above and set the base distribution for the state means to be a 0 mean normal with 2 . 0 standard deviation. Then, we greedily com-pute the error compared to ground truth and average the results over 60 different random starting positions. The top row shows that with an informative prior, both the Gibbs and beam sampler can reduce the ini-tial error by at least 50% independent of the correla-tion between hidden states. When the output model is less informative however and there is little corre-lation between the hidden states, the learning prob-lem is hardest: the lower left plot shows that both the beam and Gibbs sampler discover structure only slowly. When the correlation increases, the learning problem should become easier. However, as the lower right plot shows, although the beam sampler mixes in-creasingly well, the Gibbs sampler suffers from slow random walk behavior. 5.2. Well Data The next experiment illustrates the performance of the iHMM on a changepoint detection problem. The data consists of 4050 noisy measurements of nuclear-response of rock strata obtained via lowering a probe through a bore-hole. Figure 5 illustrates this datasets. The data has been previously analyzed in (Ruanaidh &amp; Fitzgerald, 1996) by eliminating the forty great-est outliers and running a changepoint detection algo-rithm with a fixed number of changepoints. This ap-proach works well as this one-dimensional dataset can be inspected visually to make a decision on whether to throw away datapoints and get a rough idea for the number of changepoints. However, we believe that with a nonparametric model, we can automatically adapt the number of changepoints. Moreover, by set-ting up a noise model with fat tails, we hope to auto-matically handle the outlier problem.
 We model the mean of the nuclear-response for every segment. First we normalize the data to have zero mean; then we specify a zero mean normal distribu-tion for the base distribution H . We choose the vari-ance of this normal to be the empirical variance of the dataset. For the output model, we let F correspond to a Student-t distribution with  X  = 1, also known as the Cauchy distribution. We set the scale parame-ter for the Cauchy distribution to twice the empirical standard deviation for the dataset. Since the Cauchy likelihood is not conjugate with respect to the nor-mal base distribution, we modified the Gibbs sampler based on algorithm 8 in (Neal, 2000). We use the aux-iliary variable sampling scheme discussed in (Gelman et al., 2004) to resample the segment means.
 Figure 5 shows the results of one sample from the beam sampler: the iHMM segments the dataset reasonably well and robustly handles the outliers. To compare the Gibbs and beam samplers, we compute 50 samples af-ter a burnin of 5000 iterations with 1000 iterations in between each sample. For every pair of datapoints we compute the probability that they are in the same seg-ment, averaged over the first five samples (left plots in figure 6) and the last thirty samples (right plots in figure 6). First, note that after the first 10000 itera-tions, the Gibbs sampler hasn X  X  discovered any struc-ture while the beam sampler has. This supports our claim that the beam sampler mixes faster than the Gibbs sampler. Moreover, we expect that the Gibbs sampler will have trouble to reassign the state assign-ment for whole segments because of slow random walk behavior. The beam sampler on the other hand re-samples whole hidden state sequences and should be able to reassign whole segments more easily. The right plots of figure 6 confirm our expectation: a careful in-spection of both plots shows that the Gibbs sampler is visually more black-white indicating that either two datapoints are always in the same cluster or never in the same cluster; the beam sampler, on the other hand, has gray areas which indicate that it averages over dif-ferent assignments of the segments: e.g. the Gibbs plot (upper right) suggests that the leftmost segment and rightmost segment are always in the same state, while the beam sampler plot (bottom right) indicates that only part of the time, the left and rightmost segments are in the same state (90% of the time). 5.3. Alice in Wonderland Another application domain for HMMs is the area of text prediction. One such task is that of predicting sequences of letters in text taken from Alice X  X  Adven-tures in Wonderland . We compare the performance of a finite HMM trained using variational Bayes (as de-scribed in (MacKay, 1997)) with two iHMMs trained using beam sampling and Gibbs sampling. Both sam-plers had a burn-in of 1000 iterations and an additional 10000 iterations to collect 50 samples of hidden state sequences from the posterior (i.e. we sample every 200 iterations).
 The training data for each HMM (whether finite or infinite) was taken to be a single sequence of 1000 characters from the first chapter of the book. There were 31 different observation symbols (26 letters ignor-ing case plus space and basic punctuation characters). The test data was taken to be the subsequent 4000 characters from the same chapter. For all finite HMMs we analyzed performance on models with the number of hidden states ranging from 1 to 50. For VB, we note that the true predictive distribution is intractable to compute. Therefore, we used the posterior param-eter distributions to sample 50 candidate parameter settings, and used these to compute an approximate predictive log-likelihood. For the iHMMs, we sam-pled 50 hidden state sequences from the stationary distribution after convergence and used these samples to compute an approximate predictive log-likelihood. For the VB-HMM we set the prior pseudo-counts for the transition matrix to 4 /K across all states and the prior pseudo-counts for the emission matrix to 0 . 3 across all symbols. Accordingly, we set the hyperprior for the iHMMs such that a  X  = 4 and b  X  = 1 and H  X  Dirichlet (() 0 . 3 ,  X  X  X  0 . 3). The results for VB and the iHMMs were averaged over 50 and 20 independent
Predictive Log X  X ikelihood runs respectively. The plot includes error bars corre-sponding to 2 standard deviations.
 Figure 7 illustrates the estimated predictive log-likelihoods for the finite VB-HMM and the two iHMMs trained using beam and Gibbs sampling. We find that the iHMMs have superior predictive power when com-pared to the VB-HMM, even when we select the best number of hidden states (around K = 16). Both the iHMMs converged to a posterior distribution over hid-den state sequences with around 16 states, showing that nonparametric Bayesian techniques are an effec-tive way to handle model selection. The final perfor-mance of the Gibbs and beam sampler were not found to be significantly different as we set the number of iterations high enough to ensure that both algorithms converge. Indeed, the aim of this experiment is not to compare the performance of individuals iHMM sam-pling schemes, rather, it is to further illustrate the rel-ative effectiveness of using models of infinite capacity. In this paper we introduced the beam sampler, a new inference algorithm for the iHMM that draws inspi-ration from slice sampling and dynamic programming to sample whole hidden state trajectories efficiently. We showed that the beam sampler is a more robust sampling algorithm than the Gibbs sampler. We be-lieve that the beam sampler is the algorithm of choice for iHMM inference because it converges faster than the Gibbs sampler and is straightforward to imple-ment. Moreover, it conveniently allows us to learn non-conjugate models. To encourage adoption of the iHMM as an alternative to HMM learning, we have made the software and datasets used in this paper available at http://mlg.eng.cam.ac.uk/jurgen . The beam sampler idea is flexible enough to do in-ference for various extensions of the iHMM: our cur-rent work involves an adaptation of the beam sampler to an extension of the iHMM that handles inputs, ef-fectively resulting in a nonparametric generalization of the input-output HMM (Bengio &amp; Frasconi, 1995). We believe this is a promising model for nonparamet-ric Bayesian learning of POMDPs. Another project currently underway is to use the beam sampler for ef-ficiently learning finite, but very large hidden Markov models. Finally, we are exploring the possibilities of using the embedded HMM construction (Neal et al., 2004) as an alternative for the beam sampler for effi-cient inference in the iHMM.

