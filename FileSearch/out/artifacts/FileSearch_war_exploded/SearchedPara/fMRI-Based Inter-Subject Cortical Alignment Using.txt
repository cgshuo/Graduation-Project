 Functional MRI (fMRI) studies of human neuroanatomical organization commonly analyze fMRI data across a population of subjects. The effective use of this data requires deriving a spatial cor-respondence across the set of subjects, i.e., the data must be aligned, or registered, into a common coordinate space. Current inter-subject registration techniques derive this correspondence by align-ing anatomically-defined features, e.g. major sulci and gyri, across subjects, either in the volume or on extracted cortical surfaces. Talairach normalization [1], for example, derives a piecewise affine transformation by matching a set of major anatomical landmarks in the brain volume. More ad-vanced techniques match a denser set of anatomical features, such as cortical curvature [2], and derive nonlinear transformations between a reference space and each subject X  X  cortical surface. It is known, however, that an accurate inter-subject functional correspondence cannot be derived vary across subjects [3], [4]. Because of this deficiency in current alignment methods, it is com-mon practice to spatially smooth each subject X  X  functional data prior to a population based analysis. However, this incurs the penalty of blurring the functional data within and across distinct cortical regions. Thus, the functional alignment of multi-subject fMRI data remains an important problem. We propose to register functional loci directly by using anatomical and functional data to learn an inter-subject cortical correspondence. This approach was first explored in [5], where subject cortices were registered by maximizing the inter-subject correlation of the functional response elicited by a common stimulus (a movie viewing). In essence, the correspondence was selected to maximize the correlation of the fMRI time series between subjects. This relies on the functional response being time-locked with the experimental stimulus. Large regions of visual and auditory cortex stimulated by a movie viewing do indeed show consistent inter-subject synchrony [6]. However, other areas in the intrinsic [7] or default [8] system fail to exhibit significant correlations across repeated stimulus trials. The technique of [5] is hence not expected to improve alignment in these intrinsic regions. In contrast to [5], we propose to achieve inter-subject alignment by aligning intra-subject patterns of cortical functional connectivity . By functional connectivity, we mean within-subject similarity of the temporal response of remote regions of cortex [9]. This can be estimated from fMRI data, for example, by correlating the functional time series between pairs of cortical nodes within a subject. This yields a dense set of functional features for each subject from which we learn an inter-subject correspondence. Unlike other functional connectivity work (see e.g. [10]), we define connectivity approach is inspired by studies showing that the patterns of functional connectivity in the intrinsic network are consistent across subjects [7], [11]. This suggests that our method has the potential to learn an inter-subject functional correspondence within both extrinsic and intrinsic cortical networks. In summary, we formulate a multi-subject cortical alignment algorithm that minimizes the difference between functional connectivity vectors of corresponding cortical nodes across subjects. We do so by learning a dense-deformation field on the cortex of each subject, suitably regularized to preserve cortical topology [2]. Our key contributions are: a) the novel alignment objective, b) a principled algorithm for accomplishing the alignment, and c) experimental verification on fMRI data. The paper is organized as follows. In  X  2 we formulate the multi-subject alignment problem, followed by a detailed exposition of the algorithm in  X  3 and  X  4. Finally, we exhibit results of the algorithm applied to multi-subject fMRI data in  X  5 and draw conclusions in  X  6. For each subject we are given volumetric anatomical MRI data and fMRI data. The anatomical data is used to extract a two-dimensional surface model of cortex. This greatly facilitates cortical based analysis and subsequent visualization [12], [13], [14]. Cortex is segmented, then each cortical hemisphere is inflated to obtain a smooth surface, which is projected to the sphere, S 2 , represented by a discrete spherical mesh M s = { p k  X  S 2 ; 1  X  k  X  N v / 2 } . The two cortical hemispheres are hence modeled by the disjoint union S = S 2 ] S 2 , represented by the corresponding disjoint union of mesh points M = M s ] M s . Anatomical cortical features, such as cortical curvature, are The fMRI volumeric data is first aligned with the anatomical scan, then mapped onto S . This assigns each mesh node p k  X  M a  X  X olumetric cortical voxel X  v k  X  R 3 , with associated functional time register the functional connectivity derived from the time series. Let  X  ( f 1 ,f 2 ) denote a similar-the pairwise entries of f 1 ,f 2 . Define the functional connectivity of the fMRI data under  X  as the cortical nodes. Functional connections both within and across cortical hemispheres are considered. Functional connectivity can be conceptualized as the adjacency matrix of an edge-weighted graph on all cortical nodes. The edge between nodes p i ,p j is weighted by the pairwise similarity measure data structure is huge. Hence we need efficient mechanisms for working with C .
 We are given the data discussed above for N s subjects. Subject k  X  X  training data is specified by sam-C k , all sampled on the mesh M k , k = 1 ,...,N s . Our objective is to learn a relation consisting of N s -tuples of corresponding points across the set of cortices. To do so, we could select a node from M 1 for subject 1 and learn the corresponding points on the cortices of the remaining N s  X  1 subjects through smooth and invertible mappings g k : S 1  X  S k , k = 2 ,...,N s . However, this arbi-trarily and undesirably gives special status to one subject. Instead, we introduce a reference model S ref = S 2 ] S 2 with mesh M ref . For each node p  X  M ref on S ref , we seek to learn the N s -tuple of In general terms, we can now summarize our task as follows: use the functional connectivity data C k , in conjunction with the anatomical data D a,k , k = 1 ,...,N s , to estimate warping functions { g k : k = 1 ,...,N s } , subject to specified regularity conditions, that bring some specified balance of anatomy and functional connectivity into alignment across subjects. That said, for the remainder of the paper we restrict attention to aligning only functional connectivity across subjects. There is no doubt that anatomy must be an integral part of a full solution; but that aspect is not new, and is already well understood. Restricting attention to the alignment of functional connectivity will allow us to concentrate on the most novel and important aspects of our approach.
 To proceed, assume a reference connectivity C ref , such that for each subject k = 1 ,...,N s , series using mesh nodes in a neighborhood of g k ( p ) . This will be important as we proceed. Given (1), we estimate g by maximizing a regularized log likelihood: where Reg( g k ) constrains each warping function g k to be smooth and invertible. Here, we will focus on the log likelihood term and delay the discussion of regularization to  X  3. Optimization of (2) is complicated by the fact that C ref is a latent variable, so it must be estimated along with g . We use Expectation-Maximization to iteratively alternate between computing an expectation of C ref (E-step), and a maximum likelihood estimate of g given both the observed and estimated unobserved data (M-step) [15]. In the E-step, the expectation of C ref , C ref , conditioned on the current estimate of g , In the M-step, the estimate where we have assumed that the noise in (1) is i.i.d. Gaussian. Because (4b) decouples, we can optimize over each subject X  X  warp separately, i.e., these optimizations can be done in parallel: However, an interesting alternative is to perform these sequentially with an E-step after each that updates the reference estimate C ref . This also allows some other interesting adaptations. We note: where is the leave-one-out template for subject k , which is indepedendent of g k . Thus, we replace (5) by: From (5) and (8) we observe that the multi-subject alignment problem reduces to a sequence of pairwise registrations, each of which registers one subject to an average of connectivity matrices. If we use (5), each round of pairwise registrations can be done in parallel and the results used to update the average template. The difficulty is the computational update of C ref . Alternatively, using (8) we do the pairwise registrations sequentially and compute a new leave-one-out template after each registration. This is the approach we pursue. An algorithm for solving the pairwise registration is derived in the next section and we examine the computation of leave-one-out templates in  X  4. We now develop an algorithm for aligning one subject, with connectivity C F , to a reference, with  X  ( f 1 ,f 2 ) = corr( f 1 ,f 2 ) and assume that the time series have zero mean and unit norm. A function g : M R  X  S F maps a reference mesh point p i  X  M R to g ( p i )  X  S F . By interpolating the floating subject X  X  times series at the points g ( p i )  X  S F we obtain the associated warped functional connectivity:  X  C F = [  X  ( f F g ( p
Here k X k f is the matrix Frobenius norm and the regularization term Reg( g ) serves as a prior over the space of allowable mappings. In the following steps, we examine how to efficiently solve (9). Step 1: Parameterizing the dependence of  X  C F on the warp. We first develop the dependence of the matrix  X  C F on the warping function g . This requires specifying how the time series at the the mesh points { p F i  X  M F ,i = 1 ,...,N v } . Here, we employ linear interpolation with a spherical specific objectives: (a) The kernel should be monomodal. Since the gradient of the registration objective depends on the derivative of the interpolation kernel, this will reduce the likelihood of the algorithm converging to a local minimum; (b) The support of the kernel should be finite. This will limit interpolation complexity. However, as the size of the support decreases, so will the capture range of the algorithm. At the initial stages of the algorithm, the kernel should have a broad extent, due to higher initial uncertainty, and become increasingly more localized as the algorithm converges. Thus, (c) The support of the kernel should be easily adjustable.
 With these considerations in mind, we select  X ( p,p i ) to be a spherical radial basis function  X  i : S R and d ( p,p i ) is the spherical geodesic distance between p and p i [16]. Then  X  i ( p ) is monomodal with a maximum at p i , it depends only on the distance between p and p i and is radially symmetric. In detail, we employ the particular spherical radial basis function: the parameter r . So the kernel has all of our desired properties.
 We can now make the dependence of  X  C F on g more explicit. Let T F = [ f F 1 ,f F 2 ,  X  X  X  ,f F N e T N v matrix of interpolation coefficients dependent on g and the interpolation kernel. Next, noting that C F = T T F T F , we use A to write the post-warp correlation matrix as: where D = diag( d 1 ,d 2 ,  X  X  X  ,d N v ) serves to normalize the updated data to unit norm: d j = k f F ( g ( p j )) k  X  1 . Finally, we use  X  A = AD to write: Here, (12) encodes the dependence of the registration objective on g through the matrix  X  A . It is also important to note that since the interpolation kernel is locally supported,  X  A is a sparse matrix. Step 2: Efficient Representation/Computation of the Registration Objective. We now consider the N v  X  N v matrices C F and C R . At a spatial resolution of 2 mm, the spherical model of human cortex can yield N v  X  72 , 000 total mesh points. In this situation, direct computation with C F and C R is prohibitive. Hence we need an efficient way to represent and compute the objective (12). For fMRI data it is reasonable to assume that N t N v . Hence, since the data has been centered, the assumption that rank( T F ) = rank( T R ) = d . Then C F and C R can be efficiently represented by compact d -dimensional SVDs C F = V F  X  F V T F and C R = V R  X  R V T R . Moveover, these can be computed directly from SVDs of the data matrices: T F = U T F  X  T F V T T detail: V F = V T F , V R = V T R ,  X  F =  X  T T The above representation avoids computing C F and C R , but we must also show that it enables efficient evaluation of (12). To this end, introduce the following linear transformation: where W F = V F V  X  F , W R = V R V  X  R , are orthogonal with the N v  X  d columns of V  X  F and V
R forming orthonormal bases for range( V F ) and (14) into (12) and simplifying yields: with The d  X  d matrix B 1 is readily computed since V F , V R are of manageable size. Computation of the d  X  N v matrix B 2 depends on V  X  R . This has ON columns spanning the N v  X  d dimensional subspace closer examination. Now (16) can be viewed as a projection of the rows of V T F  X  A onto the columns Hence a QR -factorization QR =  X  A T V F  X  V R B T 1 yields d ON vectors in null( C R ) . Choosing these as the first d columns of V  X  R , yields B 2 = [ R , 0] , i.e., B 2 is very sparse.
 In summary, we have derived the following efficient means of evaluating the objective. By one-time preprocessing of the time series data we obtain  X  F ,  X  R and V F ,V R . Then given a warp g ,  X  A Step 3: The Transformation Space and Regularization. We now examine the specification of g in greater detail. We allow each mesh point to move freely (locally) in two directions. The use of such nonlinear warp models for inter-subject cortical alignment has been validated over, for example, rigid-body transformations [17]. To specify g , we first need to set up a coordinate system on the x : U  X  R 3 with x (  X , X  ) = (sin  X  cos  X , sin  X  sin  X , cos  X  ) . Here,  X  is a zenith angle measured against one of the principal axes, and  X  is an azimuthal angle measured in one of the projective such parameterizations are required to cover the entire sphere [18].
 The warp g must be regularized to avoid undesired topological distortions (e.g. folding and excessive expansion) and to avoid over-fitting the data. This is achieved by adding a regularization term to the objective that penalizes such distortions. There are several ways this can be done. Here we follow [14] and regularize g by penalizing both metric and areal distortion. The metric distortion term penalizes warps that disrupt local distances between neighboring mesh nodes. This has the effect of limiting the expansion/contraction of cortex. The areal distortion term seeks to preserve a consistent orientation of the surface. Given a triangularization of the spherical mesh, each triangle is given an oriented normal vector that initially points radially outward from the sphere. Constraining the oriented area of all triangles to be positive prevents folds in the surface [14].
 Step 4: Optimization of the objective. We optimize (3) over g by gradient descent. De-note the objective by S ( g ) , let [  X  1 ( p )  X  2 ( p )  X  X  X   X  N v ( p ) ] Algorithm 1 Pairwise algorithm 1: Given: SVD of floating dataset  X  F , V F and 2: Given: Initial warp estimate g (0) 3: Given: Sequence r 1 &gt; r 2 &gt;  X  X  X  &gt; r M of 4: for m = 1 to M do 5: Set the kernel  X  i in (10), with r = r m 6: Smooth the reference to resolution r m 7: Solve for  X  g in (9) by gradient descent 9: end for 10: Output result: g ( M )  X  and e  X  j . Then, by the chain rule, the partial derivative of S ( g ) with respect to e  X  j is given by: kernel is supported locally, the summation in (18) is taken over a small number of terms. A full expression for  X  X / X  e  X  j is given in the supplemental, and that of  X  Reg( g ) / X  e  X  j in [14]. To help avoid local minima we take a multi-resolution optimization approach [19]. The registration resolution of the data. The result at resolution r m is used to initialize the alignment at resolution r m +1 . The alignment for r m is performed by matching the kernel parameter r in (10) to r m . Note that the reference dataset is also spatially smoothed at each r m by the transformation in (11), with We now return to the multi-subject alignment problem, which is summarized as Algorithm 2 in Figure 1. It only remains to discuss efficient computation of the leave-one-out-template (7). Since C k is an average of N s  X  1 positive semi-definite matrices each of rank d , the rank d of C k is bounded as follows d  X  d  X  ( N s  X  1) d . Assume that e C n , the connectivity matrix of subject n after warp g n (see (11)), has an efficient d N v dimensional SVD representation e C n = e V n e  X  n e V T n . To compute the SVD for C k , we exploit the sequential nature of the multi-subject alignment algo-computed in the previous iteration. This is achieved by expressing C k in terms of C k  X  1 : and computing matrix decompositions for the singular vectors of e C k  X  1 and e C k in terms of V k  X  1 : V k  X  1 . The second term of (20a), Q k  X  1 R k  X  1 , is the QR-decomposition of the residual components of e
V k  X  1 after projection onto range( V k  X  1 ) . Since C k  X  1 is an average of positive semi-definite Using the matrix decompositions (20a) and (20b), C k in (19) above can be expressed as: where G is the symmetric ( d + d )  X  ( d + d ) matrix: We now compute the SVD of G = V G  X  G V T G . Then, using (21), we obtain the SVD for C k as: For a moderate number of subjects, ( d + d )  X  N s d N v , this approach is more efficient than a of each warped connectivity matrix e C k , alleviating the need to store large N v  X  N v matrices. 2 sessions separated by a short break. The data was preprocessed following [5]. For each subject, a structural scan was acquired before each session, from which the cortical surface http://surfer.nmr.mgh.harvard.edu). Similar to [5], we find that anatomical alignment based on cor-tical curvature serves as a superior starting point for functional alignment over Talairach alignment. gorithm 1. Since the data starts in anatomical correspondence, we expect small warp displacements within subject and larger ones across subjects. The mean intra-subject warp displacement was 0 . 72 mm (  X  = 0 . 48 ), with 77% of the mesh nodes warped less than 1 mm and fewer than 1 . 5% warped by more than the data spatial resolution ( 2 mm). In contrast, the mean inter-subject warp displacement was 1 . 46 mm (  X  = 0 . 92 mm), with 22% of nodes warped more than 2 mm. See Figures 2(a)-(b). In a separate analysis, each subject was aligned to its leave-one-out template on each session using the consistency of the correspondence derived from different sessions, we compared the warps g k, 1 to g k, 2 for each subject k . Here, we only consider nodes that are warped by at least the data resolu-tion. This analysis provides a measure of the sensitivity to noise present in the fMRI data. At node p , we compute the angle 0  X   X   X   X  between the warp tangent vectors of g k, 1 ( p j ) and g k, 2 ( p j ) . This measures the consistency of the direction of the warp across sessions: smaller values of  X  sug-gest a greater warp coherence across sessions. Figure 2(c) shows a histogram of  X  averaged across the cortical nodes of all 10 subjects. The tight distribution centered near  X  = 0 suggests significant consistency in the warp direction across sessions. In particular, 93% of the density for  X  lies inside  X / 2 , 81% inside  X / 4 , and 58% inside  X / 8 . As a secondary comparison, we compute a normalized d (  X  ,  X  ) is spherical geodesic distance. The measure takes variability in both warp angle and magni-histogram for WNC is given in 2(d); WNC exhibits a peak at 0 . 15 , with a mean of 0 . 28 (  X  = 0 . 22 ). ( g 1 ,...,g N s ) for 10 subjects. The alignment required approximately 10 hours on a Intel 3 . 8 GHz Nehalem quad-core processor with 12 GB RAM. To evaluate the alignment, we apply the warps to the held out second session fMRI data, where subjects viewed a different segment of the movie. This warping yields data { f k g ume to avoid artificial smoothing. The cross-validated inter-subject correlation ISC( p i ) is the mean correlation of each subject X  X  functional time series with the mean time series of the other subjects: We also compute the mean inter-subject correlation, ISC = (1 /N v ) P N v i =1 ISC( p i ) . We compare the cross-validated ISC map with the ISC map of the second session movie viewing computed under anatomical correspondence. Mean ISC improved by 18% , from 0 . 072 to 0 . 085 . In by 22 . 9% , from 19 , 362 to 23 , 789 . Figure 3 shows the ISC maps computed under anatomical alignment and functional alignment on the inflated right cortical hemisphere. As expected, the areas of improvement in inter-subject correlation are consistent with the extrinsic regions of cortex [6]. We have proposed a novel cortical registration algorithm that produces a functional correspondence across a set of subjects. The algorithm uses the fMRI data directly to align the spatial patterns of functional response elicited by a movie viewing. Despite the high-dimensionality of the data under consideration, the algorithm is efficient in both space and time complexity.
 By comparing the inter-subject alignments derived from different fMRI experimental sessions, we show that the correspondence is consistent and robust to noise and variability in the fMRI temporal response. We also cross-validate the correspondence on independent test data that was not used to derive the alignment. On the test data, the algorithm produces a consistent increase in inter-subject correlation of fMRI time series, suggesting that functional alignment of extrinsic regions of cortex that are directly driven by the movie viewing experiment, such as visual and auditory areas, is improved considerably. Further testing is warranted to evaluate improvement in intrinsic areas of cortex whose response is not temporally synchronized with the experimental stimulus. [1] J. Talairach and P. Tournoux. Co-planar Stereotaxic Atlas of the Human Brain . Thieme Pub-[2] B. Fischl, R.B.H. Tootell, and A.M. Dale. High-resolution intersubject averaging and a coor-[3] J.D.G. Watson, R. Myers, R.S.F. Frackowiak, J.V. Hajnal, R.P. Woods, J.C. Mazziotta, [4] J. Rademacher, V.S. Caviness, H. Steinmetz, and A.M. Galaburda. Topographical variation of [5] M.R. Sabuncu, B.D. Singer, B. Conroy, R.E. Bryan, P.J. Ramadge, and J.V. Haxby. Function-[6] U. Hasson, Y. Nir, G. Fuhrmann, and R. Malach. Intersubject synchronization of cortical [7] Y. Golland, S. Bentin, H. Gelbard, Y. Benjamini, R. Heller, Y. Nir, U. Hasson, and R. Malach. [8] M.E. Raichle, A.M. MacLeod, A.Z. Snyder, W.J. Powers, D.A. Gusnard, and G.L. Shulman. [9] K.J. Friston. Functional and effective connectivity in neuroimaging. Human Brain Mapping , [10] Michael D. Greicius, Ben Krasnow, Allan L. Reiss, and Vinod Menon. Functional connectivity [11] J.L. Vincent, A.Z. Snyder, M.D. Fox, B.J. Shannon, J.R. Andrews, M.E. Raichle, and R.L. [12] D.C. Van Essen, H.A. Drury, J. Dickson, J. Harwell, D. Hanlon, and C.H. Anderson. An [13] A.M. Dale, B. Fischl, and M.I. Sereno. Cortical surface-based analysis. i. segmentation and [14] B. Fischl, M.I. Sereno, and A.M. Dale. Cortical surface-based analysis. ii. inflation, flattening, [15] G.J. McLachlan and T. Krishnan. The EM Algorithm and Extensions . Wiley, 1997. [16] G.E. Fasshauer and L.L. Schumaker. Scattered data fitting on the sphere. Proceedings of the [17] B.A. Ardekani, A.H. Bachman, S.C. Strother, Y. Fujibayashi, and Y. Yonekura. Impact of [18] M. Do Carmo. Differential Geometry of Curves and Surfaces . Prentice Hall, 1976. [19] R. Bajcsy and S. Kovacic. Multiresolution elastic matching. Computer Vision, Graphics, and
