 University of Edinburgh Structural equation modelling (SEM) is a technique widely used in the behavioural sciences. It has also appeared as a standard approach for analysis of what has become known as effective connectivity in the functional magnetic resonance imaging (fMRI) literature and is still in common use despite the increasing interest in dynamical methods such as dynamic causal models [ 6 ]. Simply put, effective connectivity analysis involves looking at the possible causal influences between brain regions given measurements of the activity of those regions. Structural equation models are a Gaussian modelling tool, and are similar to Gaussian belief networks. In fact Gaussian belief networks can be seen as a subset of valid structural equation models. However structural equation models do not have the same acyclicity constraints as belief networks. It should be noted that the graphical form used in this paper is at odds with traditional SEM representations, and consistent with that used for belief networks, as those will be more familiar to the expected audience.
 Within the fMRI context, the use of structural equation generally takes the following form. First certain regions of interests (commonly called seeds ) are chosen according to some understanding of what brain regions might be of interest or of importance. Then neurobiological knowledge is used to propose a connectivity model. This connectivity model states what regions are connected to what other regions, and the direction of the connectivity. This connectivity model is used to define a structural equation model. The parameters of this model are then typically estimated using maximum likelihood methods, and then comparison of connection parameters is made across subject classes.
 In this paper we consider what can be done when it is hard to specify connectivity a priori, and ask how much we can achieve by learning network structures from the fMRI data itself. The novel de-velopments of this paper include the examination of various generative representations for structural equation models which allow straightforward comparisons with belief networks and other models such as dynamic causal models. We implement Bayesian Information Criterion approximations to the evidence and use this in a Metropolis-Hastings sampling scheme for learning structural equation models. These models are then applied to toy data, and to fMRI data, which allows the examination of the types of assumptions typically made. 1.1 Related Work: Structural Equation Models Structural equation models and path analysis have a long history. The methods were introduced in the context of genetics in [ 20 ], and in econometrics in [ 7 ]. They have been used extensively in the social sciences in a variety of ways. Linear Gaussian structural equation models can be split into the case of path analysis [ 20 ], where the all the variables are directly measurable and structural equation models with latent variables [ 1 ], where latent variable models are allowed. Factor analysis is another special case of this latter. Furthermore structural equation models can also be characterised by the inclusion of exogenous influences.
 Structural equation models have been analysed and understood in Bayesian terms before. They form a part of the causal modelling framework of Pearl [ 11 ], and have been discussed within that context, as well as a number of others [ 11 , 4 , 13 , 10 ]. Approaches to learning structural equation models have not played a significant part in fMRI methods. One approach is described in [ 3 ] where they use a genetic algorithm approach for the search. In [ 21 ], the authors look at learning Bayesian networks but do not consider cyclic networks. For dynamic causal models (rather than structural equation models) the issue of model comparison was dealt with in [ 12 ], but large scale structure learning was not considered.
 In fMRI literature, SEMs have generally been used to model  X  X ffective connectivity X , or rather mod-elling the causal relationships between different brain regions. They were first applied to imaging data by [ 9 ], and there have been many further applications [ 2 , 5 , 14 ]. The first analysis on data from schizophrenia studies was detailed in [ 15 ]. In fact it seems SEMs have been the most widely used model for connectivity analyses in neuroimaging. In all of the studies cited above the underlying structure was presumed known or presumed to be one of a small number of possibilities. There has been some discussion of how best to obtain reasonable structures from neuro-anatomical data, but this approach is currently used only very rarely. The presumption in much fMRI connectivity analysis is that we can obtain models for activity dependence from neuro-anatomical sources. The problem with this is that it fails to account for the fact that connectivity analysis is usually done with a limited number of regions. It is highly possible that a connection from one region to another is mediated via a third region, which is not included in the SEM model. The strength of that mediation is unknown from neuro-anatomical data and is generally ignored: most connectivity models focus only on direct anatomical connections, with the accompanying implicit assumption that there are no other regions involved in the network under study, or that these regions would contribute only minimally to the model. Furthermore, just because regions are physically connected does not mean there is any actual functional influence in a particular context. Hence it has to be accepted that neuro-anatomically derived connectivity is a first guess at best.
 It is not the purpose of this paper to propose that anatomical connectivity be ignored, but instead it asks what happens if we go to the other extreme: can we say something about connectivity from the data? In reality anatomical connectivity models are needed, and can be used to provide good priors for the connections and even for the relative connection strengths. Statistically there are huge equivalences in structural equation models that will not be determined by the data alone. In this section two generative views of structural equation modelling are presented. The idea behind structural equation modelling is that it represents causal dependence between different variables. The fact that cyclic structures are allowed in structural equation models could be seen as an implicit assumption of some underlying dynamic which the structural equation model is an equilibrium rep-resentation of. Indeed that is commonly how effective connectivity models are interpreted in an fMRI context. Two linear models, both of which produce a structural equation model prior, are pre-sented here. Though these models have the same statistical properties, they have different generative motivations and different non-linear extensions, so they are both potentially instructive. 3.1 The Traditional Model The standard SEM view is that the core SEM structure is a covariance produced by the solution to a set of linear equations x = A x +  X  with Gaussian term  X  . This does not have any direct generative elucidation, but can instead be thought of as relating to a deterministic dynamical system subject to uncertain fixed input. Suppose we have a dynamical system x t +1 = A x t +  X  , subject to some input  X  , where we presume the system input is unknown and Gaussian distributed. To generate from the model, we sample  X  , run the dynamical system to its fixed point, and use that fixed point as a sample of x . This fixed point is given by x = ( I  X  A )  X  1  X  which produces the standard SEM covariance structure for x . This requires A to be a contraction map to obtain stable fixed points. All the other aspects of the general form of SEM are either inputs to or measurements from this system. 3.2 Average Activity Of A Gaussian Dynamic Bayesian Network An alternative and potentially appealing view is that the the SEM represents the distribution of the long term activity of the nodes in a Gaussian dynamic Bayesian network (Kalman filter). Sup-pose we have x t = A x t  X  1 +  X  t , where  X  t are IID Gaussian variables, and x 0 , x 1 , . . . is a se-ries of real variables. This defines a Markov chain, and is the evolution equation of a Gaus-sian dynamic Bayesian network. Suppose we are at the equilibrium distribution of this Markov chain. Then setting  X  x = (1 / (1 / contraction map, (1 / distributed identically to  X  t due to the fact that the variance of a sum of Gaussians is the sum of the variances. The approximation becomes an equality in the large N limit. Again this is the required form for obtaining the covariance of the SEM.
 This interpretation says that if we have some latent system running as a Gaussian dynamic Bayesian network, but our measuring equipment is only capable of capturing longer term averages of the network activity then our measurements are distributed according to an SEM. This generative inter-pretation is appealing in the context of fMRI acquisition. Note in both of these interpretations that it is important that A is a contraction. By formulating the generative framework we see it is important to restrict the form of connectivity model in this way. The standard formalism for Structural Equation Models is now outlined. A structural equation model for observational variables y , latent variables, x and sometimes for latent input variables  X  and observations of the input variables z is given by the following equations where  X  ,  X  ,  X  and  X  are Gaussian, and A is presumed to be zero diagonal.
 For for S = I  X  A , the resulting covariance for the observed variables ( y , z ) is given by where K  X  is the covariance of  X  , K  X  the covariance of  X  etc. There are a number of common simplifications to this framework. The first case involves presuming no inputs and a fully visible system. Hence we marginalise the observations of the input variables z , set K  X  =  X  , C = 0 , R = 0 , B = 1 ,  X  = 0 . Then the covariance K 1 of y is K 1 = ( I  X  A )  X  1 K  X  [( I  X  A )  X  1 ] T . The next simplest case would involve presuming once again that there are no inputs but that in fact the observations are stochastic functions of the latent variables. This involves setting K  X  =  X  , C = 0 , R = 0 , B = 1 . We then have K 2 = ( I  X  A )  X  1 K  X  [( I  X  A )  X  1 ] T + K  X  . If we view the observations as noisy versions of the latent variables then K  X  is diagonal. This will be the most general case considered in this paper. Adding any of the remaining components is not particularly demanding as it simply uses a conditional rather than unconditional model.
 Suppose we denote by K the covariance corresponding to the required model. For most of this paper we presume K = K 2 . We then have the following probability for the whole data Y = { y 1 , y 2 , . . . , y N } .
  X  and  X  , along with elements of the matrix A and covariances K  X  and K  X  , are parameters. The previous section outlines the basic model of the data given the various parameters. In this section we provide prior distributions for the parameters of the structural equation model. Independent Gaussian priors are put on the parameters: with regularisation parameter T . For the purposes of this paper we take  X  A ij = 0 , presume we have no particular a priori bias towards positive or negative connections and a uniform prior over structures. An independent prior over connections seems reasonable as two separate connections between different brain regions would have no a priori reason to be related. Any relationship is due to functional purpose and is therefore a posteriori. The use of a uniform prior over all structures is an extreme position, which we have taken in this paper to contrast with using only one structure. In reality we would want to use neurobiologically guided priors over structures.
 Inverse gamma priors were also specified for K  X  and K  X  originally, along with a prior for the mean  X   X  . It was found that these typically had no effects on the experiments and were dropped for simplicity. Hence K  X  and K  X  will be optimised without regularisation, and  X   X  is set to zero. T is chosen by 10 fold cross-validation from a set of 10 possible values.
 We can calculate all the relevant derivatives for the SEM straightforwardly, and adapt the parameters to maximize the posterior of the structural equation model. In this paper we use a conjugate gradient approach. By adding a Bayesian Information Criterion term [ 16 ], (  X  0 . 5 m log N ) for m parameters and N data points, to the log posterior at the maximum posterior solution, we can obtain an approx-imation of the evidence P ( Y | M ) where M encodes the structural information we are interested in and consists of indicator variables M ij indicating a connection for node j to node i . This will enable us to sample from an approximate posterior distribution of structures to find a sample which best represents the data. In order to represent the posterior distribution over network structures, we resort to a sampling ap-proach. Because there are no acyclicity constraints, MCMC proposals are simpler than the compa-rable situation for belief networks in that no acyclicity checking needs to be done for the proposals. A simple proposal scheme is to randomly generate a swap matrix M S which is XORed with M . We choose highly sparse swap matrices, but to reduce the possibility of transitioning randomly about the larger graphs, without ever considering smaller networks we introduce a bias towards removing con-nections rather than adding connections in generating the swap matrix. This means the proposal is no longer symmetric, and so a corresponding Hastings factor needs to be included in the acceptance probability, so the result is still a sample from the original posterior. We tested the approach on a toy problem with 8 variables. We sampled 800 data points from y = ( I  X  A )  X  1  X  +  X  for  X  Gaussian with unit diagonal covariance,  X  Gaussian with 0 . 2 diagonal covariance and with A given by This connectivity matrix is represented graphically in Figure 1 1. In modelling this we used T = 10 . This prior ensures that any A that is not of very low prior probability is a contraction. Also contraction constraints were added to the optimisation. Priors on other parameters were set to be broad. An annealed sampling procedure was used for the first 4000 samples from the Metropolis-Hastings Monte-Carlo procedure. After that a further 4000 samples burn-in was used. The next 4000 samples were used for analysis.
 We assess what edges are common in the samples, and what the highest posterior sampled graphs are. Figure 1 b provides illustrations of edges which are present in more than 0 . 15 of the samples. It can be seen that many of the critical edges are there in most samples (indeed some are always there). Those which are missing in both cases tend to be either low magnitude connections or are due to directional confusion. Figure 1: (a) Graphical structure of the ground truth model for the toy data, and (b) Edges present in more The graphs for the maximum posterior sample and a random sample are shown in Figure 1 . We can see that again in the maximum posterior sample, there is a misplaced edge (the edge from 5 to 6 is replaced by one from 5 to 1 ) and a number are missing or have exchanged direction. The samples generally have likelihoods which are very similar to the likelihood for the true model. We can conclude from this that we can gain some information from learning SEM structures, but as with learning any graphical models there are many symmetries and equivalences, so it is vital not to infer too much from the learnt structures. The approach of this paper was tested on two different fMRI datasets. The first dataset (D1) was taken from a dataset that had previously used to examine inter-session variance in a single subject [ 8 , 17 ]. We used the auditory paced finger-tapping task; briefly, a single subject tapped his right index finger, paced by an auditory tone (1.5Hz). Each activation epoch was alternated with a rest epoch, in which the pacing tone was delivered to control for auditory activation. Thirteen blocks were collected per session (seven rest and six active). Each block was 24s/6 scans long, making 78 scans in total for each of 33 sessions. The subject maintained fixation on a cross that was backprojected onto a transparent screen by a LCD video projector as in previous experiments.
 The subject was a healthy 23 year old right-handed male. The data were acquired on a Siemens MAGNETOM Vision (Siemens, Erlangen, Germany) at 2T. Each BOLD-EPI volume scan consisted of 48 transverse slices (inplane matrix 64x64; voxel size 3x3x3mm; TE=40ms; TR=4.1s). A T1-weighted high-resolution MRI of the subject (1 x 1 x 1.5mm resolution) was acquired to facilitate anatomical localisation of the functional data.
 The data were processed with statistical parametric mapping (SPM) software SPM5 (Wellcome Department of Cognitive Neurology; www.fil.ion.ucl.ac.uk/spm). After removal of the first two volumes to account for T1 saturation effects, cerebral volumes were realigned to correct for both within-and between-session subject motion). The data were filtered with a 128s high-pass filter, and an AR(1)-model was used to account for serial correlation in the data Experimental effects were estimated using session design matrices modeling the hemodynamically convolved time-course of the active movement condition, and 6 subject movement parameters. Note that no spatial smoothing was applied to this dataset, to attempt to preserve single-voxel timeseries.
 Seeds were selected from significantly active voxels identified using a random effects analysis in SPM5 (ones-sample t-test across 33 sessions; p &lt; 0 . 05 FWE corrected for multiple comparsions). For comparison with previous extant work, the most significant voxel in each cluster was chosen as a seed, giving 13 seeds representing 13 separate anatomical regions. When it was obvious that a given cluster encompassed more than one distinct anatomical region, seeds were also selected for other regions covered by the cluster. 2000 data points were used for training, the remaining 574 were reserved as a test set.
 The second dataset (D2) was from a long term study of subjects who are at genetically enhanced risk of schizophrenia. Imaging was carried out on 90 subjects at the Brain Imaging Research Centre for Scotland (Edinburgh, Scotland, UK) on a GE 1.5 T Signa scanner. A high resolution structural scan was acquired using a 3D T1-weighted sequence (TI = 600 ms). Functional data was acquired using an EPI sequence. A total of 204 volumes were acquired. The first four volumes of each acquisition were discarded. Preliminary analysis was carried out using SPM99. Data were first realigned to correct for head movement, normalized to the standard EPI template and smoothed.
 The resulting data consists of a image-volume series of 200 time points for each of the remaining 90 patients. The voxel time courses were temporally filtered. In order to reduce task related effects, we modelled the task conditions with standard block effects (Hayling), all convolved with canonical hemodynamical response functions, and fitted a general linear model (which also included regressors for the estimated head movement) to the time filtered data; the residuals of this procedure were used as the data for all the work described in this paper. The full data set was split into two halves, a training and a test set. Data from 45 of the subjects was used for training and 45 for testing. For an effective connectivity analysis, a number of brain regions (seeds) were chosen on the basis of the results of a functional connectivity study [ 19 ] and taking regard of areas which may be of particular clinical interest. In total 14 regions were chosen, along with their 14 cross-hemisphere counterparts. Hence we are interested in learning a 28 by 28 connectivity matrix. 8.1 Learning SEM Structure For both datasets a similar procedure to the toy example was followed for learning structure for the fMRI data. The stability of the log posterior along with estimations of cross-correlation against lag were used as heuristics to determine convergence prior to obtaining 10000 sample points. Assuming a fully visible path analysis (covariance K 1 ) model, where no measurement noise is in-cluded is typical in fMRI analysis (e.g. [ 15 ] for a Schizophrenia studies), we found that samples from the posterior of this model were in fact so highly connected that displaying them would infea-sible. For D2 a connectivity of 350 of the 752 total possible connections was typical. However note that only 376 connections are needed to fully specify a general covariance. Hence we can assume that in this situation the data is not suggesting any particular structure in the data which is reasonably amenable to path analysis.
 We can generalise the path analysis model by making the region activities latent variables, and allow the measurement variables to be noisy versions of those regions. In SEM terms this is equivalent to assuming the covariance structure given by K 2 . A repeat of the whole procedure with this covariance results in much smaller structures. We focus on this approach.
 For dataset D 1 , we sample posterior structures given the training data with T = 100 . There is notable variation in these structures although some key links (eg Left Motor Cortex (L M1) to Left Posterior Parietal Cortex (L PPC) are included in most samples. In addition an a priori connectivity Figure 3: Graphical structure for (a) the highest posterior structure from the sample (b) random sample. (c) a structure is proposed for the regions in the study, taking into account the task involved. This was ob-tained by using knowledge of neuroanatomical connectivity drawn from studies using tract-tracing in non-human primates. It was produced independent of the connectivity analysis and without knowl-edge of its results, but taking into account the seed locations and their corresponding activities. Note that this is a simple finger tapping motor task with seeds corresponding to the associated regions. Though not trivial, we would expect the specification to be easier and more accurate here than for more complicated cognitive tasks, due to the high number of papers using this task in functional neuroimaging. Task D1 is also of note due to its focus on repeated scanning in a single individual, thus negating any problems in seed selection that may arise from inter-subject spatial variance. These two cases described above are specified as different hypothesised models. We denote the hand-specified structure M H and we select the maximum a posteriori sample M L (for  X  X earnt Model X ) as a potential alternative. The two structures are illustrated in Figure 2 . The maximum a posteriori parameters are then estimated for the two models using the same conjugate gradient procedure on the same dataset. These two models are then used predictively on the remaining un-seen test data. We compute the predictive log-likelihoods for each model. We find that the best predictive log-likelihoods for each approach are the same (3SF) for both models. They are also the same as the predictive likelihood using the full sample covariance, which given the large data sizes used is well specified. Both these models perform better than other random models with equivalent numbers of connections. In reality learnt models are going to be used in new situations and situa-tions with less data. One test of the appropriateness of a model is to assess its predictive capability when trained on little data. By estimating the model parameters on 100 data points, instead of 2000 , we find that the learnt model performs very slightly better than the hand specified model (log odds ratio of 63 on a 574 point test set), and both perform better than the full covariance (log odds of 292 ). This indicates that both M H and M L are providing salient reduced representations which capture useful characteristics of the data.
 We also ran tests on D2. Maximum posterior samples and a random sample are illustrated in Figure 3 . Note that although these samples appear to still be quite highly connected, they in fact have about 130 connections. Even so this is significantly greater than the idealised connectivity structures typically used in most studies.
 One further approach is to assume a fully connected structure, but where the connectivity is in two categories. We have priors on connectivity with the same values of T ij as before for the strong connections and much larger values for the weaker connections. When this is added to the form of the model (where we make the incorrect but practical assumption that the BIC assumption still holds for the stronger connections) we obtain even simpler structures. Following this procedure we find that models of the form of 3 c are typical samples from the posterior where only the larger connections are shown. Again connections such as those between the Cuneus/Precuneus and the Superior Frontal Gyrus, the Thalamic connections, and some of the cross-hemispheric connections are amongst those that would be expected. This approach is related to recent work on the use of sparse priors for effective connectivity [ 18 ]. This work demonstrates that if we learn structural equation models from data, we find there is little evidence for the simple forms of path analysis model which is in common use in the fMRI literature. We suggest that learning connectivity can be a reasonable complement to current procedures where prior specification is hard. Learning on its own does discover useful parameterised representations, but these parameterisations are not the same as reasonable prior specifications. This is unsurprising due to the statistical equivalence of many SEM structures. It should be expected that combining learnt structures with prior anatomical models will help in the specification of more accurate con-nectivity assumptions, as it will reduce the number of equivalence and focus on more reasonable structural forms. Furthermore future comparisons can be made using a sample of reasonable models instead of a single a priori chosen model. We would also expect that the major gains in learning models with come from the focus on dynamical networks which do not suffer from specificity prob-lems. Even if the level of temporal information is small, any temporal information provides handles for inferring causality that are unavailable with static equilibrium models.

