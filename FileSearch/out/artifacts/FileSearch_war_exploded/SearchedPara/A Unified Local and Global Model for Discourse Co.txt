 Models of coherent discourse are central to several tasks in natural language processing: such mod-els have been used in text generation (Kibble and Power, 2004) and evaluation of human-produced text in educational applications (Miltsakaki and Ku-kich, 2004; Higgins et al., 2004). Moreover, an ac-curate model can reveal information about document structure, aiding in such tasks as supervised summa-rization (Barzilay and Lapata, 2005).
 Models of coherence tend to fall into two classes. Local models (Lapata, 2003; Barzilay and Lapata, 2005; Foltz et al., 1998) attempt to capture the gen-eralization that adjacent sentences often have similar content, and therefore tend to contain related words. Models of this type are good at finding sentences that belong near one another in the document. How-ever, they have trouble finding the beginning or end of the document, or recovering from sudden shifts in topic (such as occur at paragraph boundaries). Some local models also have trouble deciding which of a pair of related sentences ought to come first.
In contrast, the global HMM model of Barzilay and Lee (2004) tries to track the predictable changes in topic between sentences. This gives it a pro-nounced advantage in ordering sentences, since it can learn to represent beginnings, ends and bound-aries as separate states. However, it has no local features; the particular words in each sentence are generated based only on the current state of the doc-ument. Since information can pass from sentence to sentence only in this restricted manner, the model sometimes fails to place sentences next to the correct neighbors.

We attempt here to unify the two approaches by constructing a model with both sentence-to-sentence dependencies providing local cues, and a hidden topic variable for global structure. Our local fea-tures are based on the entity grid model of (Barzilay and Lapata, 2005; Lapata and Barzilay, 2005). This model has previously been most successful in a con-ditional setting; to integrate it into our model, we first relax its independence assumptions to improve its performance when used generatively. Our global model is an HMM like that of Barzilay and Lee (2004), but with emission probabilities drawn from the entity grid. We present results for two tasks, the ordering task, on which global models usually do well, and the discrimination task, on which lo-cal models tend to outperform them. Our model im-proves on purely global or local approaches on both tasks.

Previous work by Soricut and Marcu (2006) has also attempted to integrate local and global fea-tures using a mixture model, with promising results. However, mixture models lack explanatory power; since each of the individual component models is known to be flawed, it is difficult to say that the com-bination is theoretically more sound than the parts, even if it usually works better. Moreover, since the model we describe uses a strict subset of the fea-tures used in the component models of (Soricut and Marcu, 2006), we suspect that adding it to the mix-ture would lead to still further improved results. Entity grids, first described in (Lapata and Barzilay, 2005), are designed to capture some ideas of Cen-tering Theory (Grosz et al., 1995), namely that ad-jacent utterances in a locally coherent discourses are likely to contain the same nouns, and that important nouns often appear in syntactically important roles such as subject or object. An entity grid represents a document as a matrix with a column for each en-tity, and a row for each sentence. The entry r scribes the syntactic role of entity j in sentence i : these roles are subject ( S ), object ( O ), or some other role ( X ) 1 . In addition there is a special marker ( -) for nouns which do not appear at all in a given sen-tence. Each noun appears only once in a given row of the grid; if a noun appears multiple times, its grid symbol describes the most important of its syntac-tic roles: subject if possible, then object, or finally other. An example text is figure 1, whose grid is fig-ure 2.

Nouns are also treated as salient or non-salient, another important concern of Centering Theory. We condition events involving a noun on the frequency of that noun. Unfortunately, this way of representing salience makes our model slightly deficient, since the model conditions on a particular noun occurring e.g. 2 times, but assigns nonzero probabilities to documents where it occurs 3 times. This is theo-Figure 1: A section of a document, with syntactic roles of noun phrases marked. retically quite unpleasant but in comparing different orderings of the same document, it seems not to do too much damage.

Properly speaking entities may be referents of many different nouns and pronouns throughout the discourse, and both (Lapata and Barzilay, 2005) and (Barzilay and Lapata, 2005) present models which use coreference resolution systems to group nouns. We follow (Soricut and Marcu, 2006) in dropping this component of the system, and treat each head noun as having an individual single referent. To model transitions in this entity grid model, Lapata and Barzilay (2005) takes a generative ap-proach. First, the probability of a document is de-fined as P ( D ) = P ( S all the sentences. Sentences are generated in order conditioned on all previous sentences: We make a Markov assumption of order h (in our experiments h = 2 ) to shorten the history. We repre-sent the truncated history as ~ S h
Each sentence S nouns representing entities, E sponding syntactic roles R which are not entities, W independent of the previous sentences. For any fixed set of sentences S and so cannot help in finding a coherent ordering. The probability of a sentence is therefore dependent only on the entities:
Next, the model assumes that each entity e pears in sentences and takes on syntactic roles in-dependent of all the other entities. As we show in section 3, this assumption can be problem-atic. Once we assume this, however, we can sim-plify P ( E tity whether it occurs in sentence i and if so, which role it takes. This is equivalent to predicting r We represent the history of the specific entity e ~r For instance, in figure 2, the probability of S horizon 1 is the product of P ( S | X ) (for FLIGHT ), P ( X | X  ) (for PROPER ), and likewise for each other entity, P (  X  X  O ) , P (  X  X  S ) , P (  X  X  X  ) 3 .
Although this generative approach outperforms several models in correlation with coherence ratings assigned by human judges, it suffers in comparison with later systems. Barzilay and Lapata (2005) uses the same grid representation, but treats the transi-tion probabilities P ( r features for input to an SVM classifier. Soricut and Marcu (2006) X  X  implementation of the entity-based model also uses discriminative training.

The generative model X  X  main weakness in com-parison to these conditional models is its assump-tion of independence between entities. In real doc-uments, each sentence tends to contain only a few nouns, and even fewer of them can fill roles like subject and object. In other words, nouns compete with each other for the available syntactic positions in sentences; once one noun is chosen as the sub-ject, the probability that any other will also become a subject (of a different subclause of the same sen-tence) is drastically lowered. Since the generative entity grid does not take this into account, it learns that in general, the probability of any given entity appearing in a specific sentence is low. Thus it gen-erates blank sentences (those without any nouns at all) with overwhelmingly high probability.

It may not be obvious that this misallocation of probability mass also reduces the effectiveness of the generative entity grid in ordering fixed sets of sentences. However, consider the case where an en-tity has a history ~r h , and then does not appear in the next sentence. The model treats this as evidence that entities generally do not occur immediately af-ter ~r h  X  but it may also happen that the entity was outcompeted by some other word with even more significance. In this section, we relax the troublesome assump-tion of independence between entities, thus mov-ing the probability distribution over documents away from blank sentences. We begin at the same point as above: sequential generation of sentences: P ( D ) = Q into entities and non-entities, treat the non-entities as independent of the history ~ S and omit them. We also distinguish two types of entities. Let the known set K i = e j : e j  X  have appeared before sentence i . Of the entities ap-pearing in S those which are not are new entities . Since each en-tity in the document is new precisely once, we treat these as independent and omit them from our calcu-lations as we did the non-entities. We return to both groups of omitted words in section 4 below when discussing our topic-based models.

To model a sentence, then, we generate the set of known entities it contains along with their syntac-tic roles, given the history and the known set K We truncate the history, as above, with horizon h ; note that this does not make the model Markovian, since the known set has no horizon. Finally, we con-sider only the portion of the history which relates to known nouns (since all non-known nouns have the same history --). In all the equations below, we re-strict E sentence i , and R The probability of a sentence is now: We make one further simplification before begin-ning to approximate: we first generate the set of syn-tactic slots R tities, and then decide which entities from the known set to select. Again, we assume independence from the history, so that the contribution of P ( R ordering of a fixed set of sentences is constant and we omit it:
Estimating P ( E ficult, since the contexts are very sparse. To con-tinue, we make a series of approximations. First let each role be filled individually (where r  X  e is the boolean indicator function  X  X oun e fills role r  X ):
P ( E i | R i , ~ R h ( i Notice that this process can select the same noun e to fill multiple roles r , while the entity grid cannot represent such an occurrence. The resulting distri-bution is therefore slightly deficient.

Unfortunately, we are still faced with the sparse context ~ R h known nouns. It is much easier to estimate P ( r  X  e tory of the particular noun which is chosen to fill slot r . However, in this case we do not have a proper probability distribution: i.e. the probabilities do not sum to 1. To overcome this difficulty we simply nor-The individual probabilities P ( r  X  e are calculated by counting situations in the train-ing documents in which a known noun has his-tory ~r h versus situations where the slot r exists but is filled by some other noun. Some rare contexts are still sparse, and so we smooth by adding a pseu-docount of 1 for all events. Our model is ex-pressed by equations (1),(4),(5),(6) and (7). In figure 2, the probability of S now calculated as follows: the known set con-tains PLAN , AIRPLANE , CONDITION , FLIGHT , PILOT , OWNER and OCCUPANT . There is one syn-tactic role filled by a known noun, S . The proba-bility is then calculated as P (+ | S , X ) (the proba-bility of selecting a noun with history X to fill the role of S ) normalized by P (+ | S , O )+ P (+ | S , S )+ P (+ | S , X ) + 4  X  P (+ | S ,  X  ) .

Like Lapata and Barzilay (2005), our relaxed model assigns low probability to sentences where nouns with important-seeming histories do not ap-pear. However, in our model, the penalty is less severe if there are many competitor nouns. On the other hand, if the sentence contains many slots, giv-ing the noun more opportunity to fill one of them, the penalty is proportionally greater if it does not appear. The model we describe above is a purely local one, and moreover it relies on a particular set of local fea-tures which capture the way adjacent sentences tend to share lexical choices. Its lack of any global struc-ture makes it impossible for the model to recover at a paragraph boundary, or to accurately guess which sentence should begin a document. Its lack of lexi-calization, meanwhile, renders it incapable of learn-ing dependences between pairs of words: for in-stance, that a sentence discussing a crash is often followed by a casualty report.

We remedy both these problems by extending our model of document generation. Like Barzilay and Lee (2004), we learn an HMM in which each sen-tence has a hidden topic q ditioned on the previous state q model of each state is an instance of the relaxed en-tity grid model as described above, but in addition to conditioning on the role and history, we condi-tion also on the state and on the particular set of lexical items lex ( K the role: P ( r  X  e distribution is approximated as above by the nor-malized value of P ( r  X  e However, due to our use of lexical information, even this may be too sparse for accurate estima-tion, so we back off by interpolating with the pre-Figure 3: A single time-slice of our HMM.
 W i  X  P Y (  X | q i ;  X  LM , discount LM ) N i  X  P Y (  X | q i ;  X  NN , discount NN ) E i  X  EGrid (  X | R, q  X  DP (  X | q i  X  1 ) In the equations above, only the manually set inter-polation hyperparameters are indicated. vious model. In each context, we introduce  X  pseudo-observations, split fractionally according to the backoff distribution: if we abbreviate the context in the relaxed entity grid as C and the event as e , this smoothing corresponds to:
P ( e | C, q i , e j ) = This is equivalent to defining the topic-based entity grid as a Dirichlet process with parameter  X  pling from the relaxed entity grid.

In addition, we are now in a position to gener-ate the non-entity words W an informative way, by conditioning on the sentence topic q entities, they do not form contiguous sequences of words, so we make a bag-of-words assumption. To model these sets of words, we use unigram ver-sions of the hierarchical Pitman-Yor processes of (Teh, 2006), which implement a Bayesian version of Kneser-Ney smoothing.

To represent the HMM itself, we adapt the non-parametric HMM of (Beal et al., 2001). This is a Bayesian alternative to the conventional HMM model learned using EM, chosen mostly for conve-nience. Our variant of it, unlike (Beal et al., 2001), has no parameter  X  to control self-transitions; our emission model is complex enough to make it un-necessary.

The actual number of states found by the model depends mostly on the backoff constants, the  X  s (and, for Pitman-Yor processes, discount s) chosen for the emission models (the entity grid, non-entity word model and new noun model), and is relatively insensitive to particular choices of prior for the other hyperparameters. As the backoff constants decrease, the emission models become more dependent on the state variable q , which leads to more states (and eventually to memorization of the training data). If instead the backoff rate increases, the emission mod-els all become close to the general distribution and the model prefers relatively few states. We train with interpolations which generally result in around 40 states.

Once the interpolation constants are set, the model can be trained by Gibbs sampling. We also do inference over the remaining hyperparameters of the model by Metropolis sampling from uninforma-tive priors. Convergence is generally very rapid; we obtain good results after about 10 iterations. Unlike Barzilay and Lee (2004), we do not initialize with an informative starting distribution.

When finding the probability of a test document, we do not do inference over the full Bayesian model, because the number of states, and the probability of different transitions, can change with every new ob-servation, making dynamic programming impossi-ble. Beal et al. (2001) proposes an inference algo-rithm based on particle filters, but we feel that in this case, the effects are relatively minor, so we ap-proximate by treating the model as a standard HMM, using a fixed transition function based only on the training data. This allows us to use the conventional Viterbi algorithm. The backoff rates we choose at training time are typically too small for optimal in-ference in the ordering task. Before doing tests, we set them to higher values (determined to optimize ordering performance on held-out data) so that our emission distributions are properly smoothed. Our experiments use the popular AIRPLANE cor-pus, a collection of documents describing airplane crashes taken from the database of the National Transportation Safety Board, used in (Barzilay and Lee, 2004; Barzilay and Lapata, 2005; Soricut and Marcu, 2006). We use the standard division of the corpus into 100 training and 100 test docu-ments; for development purposes we did 10-fold cross-validation on the training data. The AIRPLANE documents have some advantages for coherence re-search: they are short (11.5 sentences on average) and quite formulaic, which makes it easy to find lex-ical and structural patterns. On the other hand, they do have some oddities. 46 of the training documents begin with a standard preamble:  X  X his is prelimi-nary information, subject to change, and may con-tain errors. Any errors in this report will be corrected when the final report has been completed, X  which essentially gives coherence models the first two sen-tences for free. Others, however, begin abruptly with no introductory material whatsoever, and sometimes without even providing references for their definite noun phrases; one document begins:  X  X t V1, the DC-10-30 X  X  number 1 engine, a General Electric CF6-50C2, experienced a casing breach when the 2nd-stage low pressure turbine (LPT) anti-rotation nozzle locks failed. X  Even humans might have trou-ble identifying this sentence as the beginning of a document. 5.1 Sentence Ordering In the sentence ordering task, (Lapata, 2003; Barzi-lay and Lee, 2004; Barzilay and Lapata, 2005; Sori-cut and Marcu, 2006), we view a document as an unordered bag of sentences and try to find the or-dering of the sentences which maximizes coherence according to our model. This type of ordering pro-cess has applications in natural language generation and multi-document summarization. Unfortunately, finding the optimal ordering according to a prob-abilistic model with local features is NP-complete and non-approximable (Althaus et al., 2004). More-over, since our model is not Markovian, the relax-ation used as a heuristic for A  X  search by Soricut and Marcu (2006) is ineffective. We therefore use simulated annealing to find a high-probability order-ing, starting from a random permutation of the sen-tences. Our search system has few Estimated Search Errors as defined by Soricut and Marcu (2006); it rarely proposes an ordering which has lower proba-(Barzilay and Lapata, 2005) -90 (Barzilay and Lee, 2004) .44 74 5 (Soricut and Marcu, 2006) .50 -6 Topic-based (relaxed) .50 94
To evaluate the quality of the orderings we predict as optimal, we use Kendall X  X   X  , a measurement of the number of pairwise swaps needed to transform our proposed ordering into the original document, normalized to lie between  X  1 (reverse order) and 1 (original order). Lapata (2006) shows that it corre-sponds well with human judgements of coherence and reading times. A slight problem with  X  is that it does not always distinguish between proposed or-derings of a document which disrupt local relation-ships at random, and orderings in which paragraph-like units move as a whole. In longer documents, it may be worth taking this problem into account when selecting a metric; however, the documents in the AIRPLANE corpus are mostly short and have little paragraph structure, so  X  is an effective metric. 5.2 Discrimination Our second task is the discriminative test used by (Barzilay and Lapata, 2005). In this task we gen-erate random permutations of a test document, and measure how often the probability of a permutation is higher than that of the original document. This task bears some resemblance to the task of discrim-inating coherent from incoherent essays in (Milt-sakaki and Kukich, 2004), and is also equivalent in the limit to the ranking metric of (Barzilay and Lee, 2004), which we cannot calculate because our model does not produce k -best output. As opposed to the ordering task, which tries to measure how close the model X  X  preferred orderings are to the orig-inal, this measurement assesses how many orderings the model prefers. We use 20 random permutations per document, for 2000 total tests. Naive Entity Grid .17 81 Relaxed Entity Grid .02 87 Topic-based (naive) .39 85 Topic-based (relaxed) .54 96 Table 2: Results for 10-fold cross-validation on AIR -PLANE training data. Since the ordering task requires a model to propose the complete structure for a set of sentences, it is very dependent on global features. To perform ad-equately, a model must be able to locate the begin-ning and end of the document, and place intermedi-ate sentences relative to these two points. Without any way of doing this, our relaxed entity grid model has  X  of approximately 0, meaning its optimal or-derings are essentially uncorrelated with the correct and Lee, 2004), which does have global structure, performs much better on ordering, at  X  of . 44 . How-ever, local features can help substantially for this task, since models which use them are better at plac-ing related sentences next to one another. Using both sets of features, our topic-based model achieves state of the art performance (  X  = . 5 ) on the ordering task, comparable with the mixture model of (Soricut and Marcu, 2006).

The need for good local coherence features is es-pecially clear from the results on the discrimination task (table 1). Permuting a document may leave ob-vious  X  X ignposts X  like the introduction and conclu-sion in place, but it almost always splits up many pairs of neighboring sentences, reducing local co-herence. (Barzilay and Lee, 2004), which lacks lo-cal features, does quite poorly on this task ( 74% ), while our model performs extremely well ( 94% ).
It is also clear from the results that our relaxed en-tity grid model ( 87% ) improves substantially on the generative naive entity grid ( 81% ). When used on its own, it performs much better on the discrimina-tion task, which is the one for which it was designed. (The naive entity grid has a higher  X  score, . 17 , es-sentially by accident. It slightly prefers to generate infrequent nouns from the start context rather than the context --, which happens to produce the correct placement for the  X  X reliminary information X  pream-ble.) When used as the emission model for known entities in our topic-based system, the relaxed en-tity grid shows its improved performance even more strongly (table 2); its results are about 10% higher than the naive version under both metrics.

Our combined model uses only entity-grid fea-tures and unigram language models,a strict subset of the feature set of (Soricut and Marcu, 2006). Their mixture includes an entity grid model and a version of the HMM of (Barzilay and Lee, 2004), which uses n-gram language modeling. It also uses a model of lexical generation based on the IBM-1 model for machine translation, which produces all words in the document conditioned on words from previous sen-tences. In contrast, we generate only entities con-ditioned on words from previous sentences; other words are conditionally independent given the topic variable. It seems likely therefore that using our model as a component of a mixture might improve on the state of the art result. Ordering in the AIRPLANE corpus and similar con-strained sets of short documents is by no means a solved problem, but the results so far show a good deal of promise. Unfortunately, in longer and less formulaic corpora, the models, inference algorithms and even evaluation metrics used thus far may prove extremely difficult to scale up. Domains with more natural writing styles will make lexical prediction a much more difficult problem. On the other hand, the wider variety of grammatical constructions used may motivate more complex syntactic features, for instance as proposed by (Siddharthan et al., 2004) in sentence clustering.

Finding optimal orderings is a difficult task even for short documents, and will become exponen-tially more challenging in longer ones. For multi-paragraph documents, it is probably impractical to use full-scale coherence models to find optimal or-derings directly. A better approach may be a coarse-to-fine or hierarchical system which cuts up longer documents into more manageable chunks that can be ordered as a unit.

Multi-paragraph documents also pose a problem for the  X  metric itself. In documents with clear the-matic divisions between their different sections, a good ordering metric should treat transposed para-graphs differently than transposed sentences. We are extremely grateful to Regina Barzilay, for her code, data and extensive support, Mirella Lapata for code and advice, and the BLLIP group, especially Tom Griffiths, Sharon Goldwater and Mark Johnson, for comments and criticism. We were supported by DARPA GALE contract HR0011-06-2-0001 and the Karen T. Romer Foundation. Finally we thank three anonymous reviewers for their comments.

