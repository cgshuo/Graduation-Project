 Graphical models such as Markov Random Fields (MRFs) have been successfully applied to a wide variety of fields, from computer vision to computational biology. From the point of view of in-ference, we are generally interested in two questions: finding the marginal probabilities of specific subsets of the variables, and finding the Maximum a Posteriori (MAP) assignment. Both of these require approximate methods.
 We focus on a particular class of variational approximation methods that cast the inference problem as a non-linear optimization over the marginal polytope , the set of valid marginal probabilities. The selection of appropriate marginals from the marginal polytope is guided by the (non-linear) entropy function. Both the marginal polytope and the entropy are difficult to characterize in general, reflect-ing the hardness of exact inference calculations. Most message-passing algorithms for evaluating marginals, including belief propagation and tree-reweighted sum-product (TRW), operate instead within the local consistency polytope , characterized by pairwise consistent marginals. For general graphs, this is an outer bound of the marginal polytope. Various approximations have also been sug-gested for the entropy function. For example, in the TRW algorithm [10], the entropy is decomposed into a weighted combination of entropies of tree-structured distributions.
 Our goal here is to provide tighter outer bounds on the marginal polytope. We show how this can be achieved efficiently using a cutting-plane algorithm , iterating between solving a relaxed problem and adding additional constraints. Cutting-plane algorithms are a well-known technique for solving integer linear programs. The key to such approaches is to have an efficient separation algorithm which, given an infeasible solution, can quickly find a violated constraint, generally from a very large class of valid constraints on the set of integral solutions.
 The motivation for our approach comes from the cutting-plane literature for the maximum cut prob-lem. Barahona et al. [3] showed that the MAP problem in pairwise binary MRFs is equivalent to a linear optimization over the cut polytope, which is the convex hull of all valid graph cuts. Tighter relaxations were obtained by using a separation algorithm together with the cutting-plane method-ology. We extend this work by deriving a new class of outer bounds on the marginal polytope for non-binary and non-pairwise MRFs. The key realization is that valid constraints can be constructed by a series of projections onto the cut polytope 1 . More broadly, we seek to highlight emerging connections between polyhedral combinatorics and probabilistic inference. Markov Random Fields. Let x  X   X  n denote a random vector on n variables, where, for simplicity, real valued potentials or sufficient statistics  X  ( x ) = {  X  k ( x ) } and a parameter vector  X   X  R d : where  X   X ,  X  ( x )  X  denotes the dot product of the parameters and the sufficient statistics. In pairwise MRFs , potentials are restricted to be at most over the edges in the graph. We assume that the  X  Variational inference. The inference task is to evaluate the mean vector  X  = E  X  [  X  ( x )] . The log-partition function A (  X  ) , a convex function of  X  , plays a critical role in these calculations. In particular, we can write the log-partition function in terms of its Fenchel-Legendre conjugate [11]: where B (  X  ) =  X  H (  X  ) is the negative entropy of the distribution parameterized by  X  and is also convex. M is the set of realizable mean vectors  X  known as the marginal polytope . More precisely, M :=  X   X  R d | X  p ( x ) s.t.  X  = E p [  X  ( x )] . The value  X   X   X  X  that maximizes (1) is precisely the desired mean vector corresponding to p ( x ;  X  ) .
 Both M and the entropy H (  X  ) are difficult to characterize in general and have to be approximated. We call the resulting approximate mean vectors pseudomarginals . Mean field algorithms optimize over an inner bound on the marginal polytope (which is not convex) by restricting the marginal vec-tors to those coming from simpler, e.g., fully factored, distributions. The entropy can be evaluated exactly in this case (the distribution is simple). Alternatively, we can relax the optimization to be over an outer bound on the marginal polytope and also bound the entropy function.
 Most message passing algorithms for evaluating marginal probabilities obtain locally consistent beliefs so that the pseudomarginals over the edges agree with the singleton pseudomarginals at the nodes. The solution is therefore sought within the local marginal polytope Clearly, M  X  LOCAL ( G ) since true marginals are also locally consistent. For trees, M = LOCAL ( G ) . Both LOCAL(G) and M have the same integral vertices for general graphs [11, 6]. Belief propagation can be seen as optimizing pseudomarginals over LOCAL ( G ) with a (non-convex) Bethe approximation to the entropy [15]. The tree-reweighted sum-product algorithm [10], on the other hand, uses a concave upper bound on the entropy, expressed as a convex combination of entropies corresponding to the spanning trees of the original graph. The log-determinant relaxation [12] is instead based on a semi-definite outer bound on the marginal polytope combined with a Gaussian approximation to the entropy function. Since the moment matrix M 1 (  X  ) can be written as E  X  [(1 x ) T (1 x )] for  X   X  M , the outer bound is obtained simply by requiring only that the pseudomarginals lie in SDEF 1 ( K n ) = {  X   X  R + | M 1 (  X  ) 0 } .
 Maximum a posteriori. The marginal polytope also plays a critical role in finding the MAP assign-ment. The problem is to find an assignment x  X   X  n which maximizes p ( x ;  X  ) , or equivalently: where the log-partition function A (  X  ) remains a constant and can be ignored. The last equality holds because the optimal value of the linear program is obtained at a vertex (integral solution). That is, when the MAP assignment x  X  is unique, the maximizing  X   X  is  X  ( x  X  ) . Algorithm 1 Cutting-plane algorithm for probabilistic inference 2: repeat 3:  X   X   X  argmax  X   X  OUTER { X   X ,  X   X  X  X  B  X  (  X  ) } 4: Choose projection graph G  X  , e.g. single , k , or full 5: C  X  Find Violated Inequalities ( G  X  ,  X   X  (  X   X  )) 6: OUTER  X  OUTER  X  X  7: until C = R d (did not find any violated inequalities) Cycle inequalities. The marginal polytope can be defined by the intersection of a large number of linear inequalities. We focus on inequalities beyond those specifying LOCAL ( G ) , in particular the cycle inequalities [4, 2, 6]. Assume the variables are binary. Given an assignment x  X  { 0 , 1 } n , ( i, j )  X  E is cut if x i 6 = x j . The cycle inequalities arise from the observation that a cycle must have an even (possibly zero) number of cut edges. Suppose we start at node i , where x i = 0 . As we traverse the cycle, the assignment changes each time we cross a cut edge. Since we must return to x = 0 , the assignment can only change an even number of times. For a cycle C and any F  X  C such Since this constraint is valid for all assignments x  X  X  0 , 1 } n , it holds also in expectation. Thus is valid for any  X   X  M { 0 , 1 } , the marginal polytope of a binary pairwise MRF. For a chordless graph G if and only if G has no K 4 -minor. Although there are exponentially many cycles and cycle inequalities for a graph, Barahona and Mahjoub [4, 6] give a simple algorithm to separate the whole class of cycle inequalities.
 To see whether any cycle inequality is violated, construct the undirected graph G 0 = ( V 0 , E 0 ) where V ( i each node i  X  V we find the shortest path in G 0 from i 1 to i 2 . The shortest of all these paths will not use both copies of any node j (otherwise the path j 1 to j 2 would be shorter), and so defines a cycle in is less than 1, we have found a violated cycle inequality; otherwise,  X  satisfies all cycle inequalities. Using Dijkstra X  X  shortest paths algorithm with a Fibonacci heap [5], the separation problem can be solved in time O ( n 2 log n + n | E | ) . Our main result is the proposed Algorithm 1 given above. The algorithm alternates between solv-ing for an upper bound of the log-partition function (see Eq. 1) and tightening the outer bound on the marginal polytope by incorporating valid constraints that are violated by the current pseudo-marginals. The projection graph (line 4) is not needed for binary pairwise MRFs and will be de-scribed in the next section. We start the algorithm (line 1) with the loose outer bound on the marginal polytope given by the local consistency constraints. Tighter initial constraints, e.g., M 1 (  X  ) 0 , are possible as well.
 The separation algorithm returns a feasible set C given by the intersection of halfspaces, and we in-tersect this with OUTER to obtain a smaller feasible space, i.e. a tighter relaxation. The experiments in Section 5 use the separation algorithm for cycle inequalities. However, any class of valid con-straints for the marginal polytope with an efficient separation algorithm may be used in line 5. Other examples besides the cycle inequalities include the odd-wheel and bicycle odd-wheel inequalities [6], and also linear inequalities that enforce positive semi-definiteness of M 1 (  X  ) . The cutting-plane algorithm is in effect optimizing the variational objective (Eq. 1) over a relaxation of the marginal polytope defined by the intersection of all inequalities that can be returned in line 5. Any entropy approximation B  X  (  X  ) can be used so long as we can efficiently solve the optimization problem in line 3. The log-determinant and TRW entropy approximations have two appealing fea-Figure 1: Illustration of the projection  X   X  for one edge ( i, j )  X  E where  X  i = { 0 , 1 , 2 } and  X  j = { 0 , 1 , 2 , 3 } . The projection graph G  X  , shown on the right, has 3 partitions for i and 7 for j . tures. First, as upper bounds they permit the algorithm to be used for obtaining tighter upper bounds on the log-partition function. Second, the objective functions to be maximized are convex and can be solved efficiently using conditional gradient or other methods.
 When the algorithm terminates, we can use the last  X   X  vector as an approximation to the single node and edge marginals. The results given in Section 5 use this method. The algorithm for MAP is the same, excluding the entropy function in line 3; the optimization is simply a linear program. Since all integral vectors in the relaxation OUTER are extreme points of the marginal polytope, any integral  X   X  is the MAP assignment. In this section we give a new class of valid inequalities for the marginal polytope of non-binary and non-pairwise MRFs, and show how to efficiently separate this exponentially large set of inequalities. The key theoretical idea is to project the marginal polytope onto different binary marginal polytopes. Aggregation and projection are well-known techniques in polyhedral combinatorics for obtaining valid inequalities [6]. Given a linear projection  X ( x ) = A x , any valid inequality c 0  X ( x )  X  b for  X ( x ) also gives the valid inequality c 0 A x  X  b for x . We obtain new inequalities by aggregating the values of each variable.
 For each variable i , let  X  q i be a partition of its values into two non-empty sets, i.e., the map  X  q i :  X  the projection graph G  X  = ( V  X  , E  X  ) so that there is a node for each  X  q i  X   X  i , and nodes  X  q i and  X  j are connected if ( i, j )  X  E . We call the graph consisting of all possible variable partitions the full projection graph . In Figure 1 we show part of the full projection graph corresponding to one edge ( i, j ) , where x i has three values and x j has four values. Intuitively, a partition for a variable splits its values into two clusters, resulting in a binary variable. For example, the (new) variable corresponding to the partition { 0 , 1 }{ 2 } of x i is 1 if x i = 2 , and 0 otherwise. The following gives a projection of marginal vectors of non-binary MRFs onto the marginal polytope of the projection graph G  X  , which has binary variables for each partition.
 Definition 1. The linear map  X   X  takes  X   X  M and for each node v =  X  q i  X  V  X  as-P To construct valid inequalities for each projection we need to characterize the image space. Let M { 0 , 1 } ( G  X  ) denote the binary marginal polytope of the projection graph.
 Theorem 1. The image of the projection  X   X  is M { 0 , 1 } ( G  X  ) , i.e.  X   X  : M X  X  { 0 , 1 } ( G  X  ) . Proof. Since  X   X  is a linear map, it suffices to show that, for every extreme point  X   X  X  ,  X   X  (  X  )  X  M { 0 , 1 } ( G  X  ) . The extreme points of M correspond one-to-one with assignments x  X   X  n . Given an extreme point  X   X  M and variable v =  X  q i  X  V  X  , define x 0 (  X  ) v = P s  X   X   X   X  (  X  ) = E [  X  ( x 0 (  X  ))] , showing that  X   X  (  X  )  X  X  { 0 , 1 } ( G  X  ) .
 This result allows valid inequalities for M { 0 , 1 } ( G  X  ) to carry over to M . In general, the projec-tion  X   X  will not be surjective. Suppose every variable has k values. The single projection graph , where |  X  i | = 1 for all i , has one node per variable and is surjective. The full projection graph has O (2 k ) nodes per variable. A cutting-plane algorithm may begin by projecting onto a small graph, then expanding to larger graphs only after satisfying all inequalities given by the smaller one. The k  X  projection graph G k = ( V k , E k ) has k partitions per variable corresponding to each value versus all the other values.
 These projections yield a new class of cycle inequalities for the marginal polytope. Consider a single projection graph G  X  , a cycle C in G , and any F  X  C such that | F | is odd. Let  X  i be the partition for node i . We obtain the following valid inequality for  X   X  M by applying the projection  X   X  and the cycle inequality: where the latter holds only for | F | = 1 . We can only obtain the more general inequality by fixing a partition of each node X  X  values.
 Theorem 2. For every single projection graph G  X  and every cycle inequality arising from a chord-less circuit C on G  X  ,  X   X   X  LOCAL( G ) \M such that  X  violates that inequality.
 r  X   X  j \{ s j , t j } . The polytope resulting from the projection of M onto the remaining values (e.g.  X  i ; s i ) is isomorphic to M { 0 , 1 } for the graph G  X  . Barahona and Mahjoub [4] showed that the cycle G , this cannot be a facet of LOCAL( G ) . Let LOCAL { 0 , 1 } be the projection of LOCAL(G) onto the remaining values. Thus,  X   X  0  X  LOCAL { 0 , 1 } \M { 0 , 1 } , and we can assign  X  accordingly. Note that the theorem implies that the projected cycle inequalities are strictly tighter than LOCAL ( G ) , but it does not characterize how much is gained.
 If all n variables have k values, then there are O ((2 k ) n ) different single projection graphs. However, since for every cycle inequality in the single projection graphs there is an equivalent cycle inequality in the full projection graph, it suffices to consider just the full projection graph. Thus, even though the projection is not surjective, the full projection graph, which has O ( n 2 k ) nodes, allows us to efficiently obtain a tighter relaxation than any combination of projection graphs would give. In particular, the separation problem for all cycle inequalities (5) for all single projection graphs, when we allow some additional valid inequalities for M (arising from the cycle using more than one partition for some variables), can now be solved in time O ( poly ( n, 2 k )) .
 Related work. In earlier work, Althaus et al. [1] analyze the GMEC polyhedron , which is equivalent to the marginal polytope. They use a similar value-aggregation technique to derive valid constraints from the triangle inequalities. Koster et al. [8] investigate the Partial Constraint Satisfaction Prob-lem polytope , which is also equivalent to the marginal polytope. They used value-aggregation to show that a class of cycle inequalities (corresponding to Eq. 5 for | F | = 1 ) are valid for this poly-tope, and give an algorithm to separate the inequalities for a single cycle. Interestingly, both papers showed that these constraints are facet-defining.
 Non-pairwise Markov random fields. These results could be applied to non-pairwise MRFs by first projecting the marginal vector onto the marginal polytope of a pairwise MRF. More generally, suppose we include additional variables corresponding to the joint probability of a cluster of vari-ables. We need to add constraints enforcing that all variables in common between two clusters have the same marginals. For pairwise clusters these are simply the usual local consistency constraints. We can now apply the projections of the previous section, considering various partitions of each cluster variable, to obtain a tighter relaxation of the marginal polytope. Computing marginals . We experimented with Algorithm 1 using both the log-determinant [12] and the TRW [10] entropy approximations. These trials are on Ising models , which are pairwise MRFs TRW can efficiently optimize over the spanning tree polytope, for these experiments we simply use a weighted distribution over spanning trees, where each tree X  X  weight is the sum of the absolute value of its edge weights  X  ij . The edge appearance probabilities for this distribution can be efficiently computed using the Matrix Tree Theorem [13]. We optimize the TRW objective with conditional gradient, using linear programming after each gradient step to project onto OUTER . We used the glpkmex and YALMIP optimization packages within Matlab, and wrote the separation algorithm for the cycle inequalities in Java.
 In Figure 2 we show results for 10 node complete graphs with  X  i  X  U [  X  1 , 1] and  X  ij  X  U [  X  x, x ] , where the coupling strength is varied along the x -axis of the figure. For each data point we averaged the results over 100 trials. The y -axis shows the average ` 1 error of the single node marginals. These MRFs are highly coupled, and loopy belief propagation (not shown) with a .5 decay rate seldom con-verges. The TRW and log-determinant algorithms, optimizing over the local consistency polytope, give pseudomarginals only slightly better than loopy BP. Even adding the positive semi-definite constraint M 1 (  X  ) 0 , for which TRW must be optimized using conditional gradient and semi-definite programming for the projection step, does not improve the accuracy by much. However, both entropy approximations give significantly better pseudomarginals when used by our algorithm together with the cycle inequalities (see  X  X RW + Cycle X  and  X  X ogdet + Cycle X  in the figures). For small MRFs, we can exactly represent the marginal polytope as the convex hull of its 2 n vertices. We found that the cycle inequalities give nearly as good accuracy as the exact marginal polytope (see  X  X RW + Marg X  and  X  X ogdet + Marg X ).
 Our work sheds some light on the relative value of the entropy approximation compared to the relaxation of the marginal polytope. When the MRF is weakly coupled, both entropy approximations do reasonably well using the local consistency polytope. This is not surprising: the limit of weak coupling is a fully disconnected graph, for which both the entropy approximation and the marginal polytope relaxation are exact. With the local consistency polytope, both entropy approximations get steadily worse as the coupling increases. In contrast, using the exact marginal polytope, we see a peak at  X  = 2 , then a steady improvement in accuracy as the coupling term grows. This occurs because the limit of strong coupling is the MAP problem, for which using the exact marginal polytope will give exact results. The interesting region is near the peak  X  = 2 , where the entropy term is neither exact nor outweighed by the coupling. Our algorithm seems to  X  X olve X  the part of the problem caused by the local consistency polytope relaxation: TRW X  X  accuracy goes from .33 to .15, and log-determinant X  X  accuracy from .17 to .076. The fact that neither entropy approximation can achieve accuracy below .07, even with the exact marginal polytope, motivates further research on improving this part of the approximation. Figure 3: Accuracy of single node marginals with TRW entropy,  X  i  X  U [  X  1 , 1] and  X  ij  X  U [  X  4 , 4] . Next, we looked at the number of iterations (in terms of the loop in Algorithm 1) the algorithm takes before all cycle inequalities are satisfied. In each iteration we add to OUTER at most 2 n violated cycle inequalities, coming from the n shortest paths. In Figure 3 we show boxplots of the l 1 error of the single node marginals for both 10x10 grid MRFs (40 trials) and 20 node complete MRFs (10 trials). We also show whether the pseudomarginals are on the correct side of .5, which is important if we were doing prediction based on the results from approximate inference. The middle line gives the median, the boxes show the upper and lower quartiles, and the whiskers show the extent of the data. Iteration 1 corresponds to TRW with only the local consistency constraints. For the grid MRFs, all of the cycle inequalities were satisfied within 10 iterations. We observed the same convergence results on a 30x30 grid, although we could not assess the accuracy due to the difficulty of exact marginals calculation. For the complete graph MRFs, the algorithm took many more iterations before all cycle inequalities were satisfied.
 Protein side-chain prediction . We next applied our algorithm to the problem of predicting protein side-chain configurations. Given the 3-dimensional structure of a protein X  X  backbone, the task is to predict the relative angle of each amino acid X  X  side-chain. The angles are discretized into at most 45 values. Yanover et al. [14] showed that minimization of the Rosetta energy function corresponds to finding the MAP assignment of a non-binary pairwise MRF. They also showed that the tree-reweighted max-product algorithm [9] can be used to solve the LP relaxation given by LOCAL(G), and that this succeeds in finding the MAP assignment for 339 of the 369 proteins in their data set. However, the optimal solution to the LP relaxation for the remaining 30 proteins, arguably the most difficult of the proteins, is fractional.
 Using the k -projection graph and projected cycle inequalities, we succeeded in finding the MAP assignment for all proteins except for the protein  X 1rl6 X . We show in Figure 4 the number of cutting-plane iterations needed for each of the 30 proteins. In each iteration, we solve the LP relaxation, and, if the solution is not integral, run the separation algorithm to find violated inequalities. For the protein  X 1rl6 X , after 12 cutting-plane iterations, the solution was not integral, and we could not find any violated cycle inequalities using the k -projection graph. We then tried using the full projection graph, and found the MAP after just one (additional) iteration. Figure 4 shows one of the cycle inequalities (5) in the full projection graph that was found to be violated. The cut edges indicate  X  these variables. This example shows that the relaxation given by the full projection graph is strictly tighter than that of the k -projection graph. The commercial linear programming solver CPLEX 10.0 solves each LP relaxation in under 75 sec-onds. Using simple heuristics, the separation algorithm runs in seconds, and we find each protein X  X  MAP assignment in under 11.3 minutes. Kingsford et al. [7] found, and we also observed, that CPLEX X  X  branch-and-cut algorithm for solving integer linear programs also works well for these problems. One interesting future direction would be to combine the two approaches, using our new outer bounds within the branch-and-cut scheme. Our results show that the new outer bounds are powerful, allowing us to find the MAP solution for all of the MRFs, and suggesting that using them will also lead to significantly more accurate marginals for non-binary MRFs. The facial structure of the cut polytope, equivalently, the binary marginal polytope, has been well-studied over the last twenty years. The cycle inequalities are just one of many large classes of valid inequalities for the cut polytope for which efficient separation algorithms are known. Our theoretical results can be used to derive outer bounds for the marginal polytope from any of the valid inequalities on the cut polytope. Our approach is particularly valuable because it takes advantage of the sparsity of the graph, and only uses additional constraints when they are guaranteed to affect the solution. An interesting open problem is to develop new message-passing algorithms which can incorporate cycle and other inequalities, to efficiently do the optimization within the cutting-plane algorithm. Acknowledgments The authors thank Amir Globerson and David Karger for helpful discussions. This work was sup-ported in part by the DARPA Transfer Learning program. D.S. was also supported by a National Science Foundation Graduate Research Fellowship.

