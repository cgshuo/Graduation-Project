 Shie Mannor shie@ee.technion.ac.il Department of Electrical Engineering, Technion, Israel Ofir Mebel ofirmebel@gmail.com Department of Electrical Engineering, Technion, Israel Huan Xu mpexuh@nus.edu.sg Markov decision processes (MDPs) are widely used tools to model sequential decision making in stochastic dynamic environments (e.g., Puterman, 1994; Sutton &amp; Barto, 1998). Typically, the parameters of these models (reward and transition probability) are esti-mated from finite and sometimes noisy data, so they often deviate from their true value. Such deviation, termed  X  X arameter uncertainty, X  can cause the per-formance of the  X  X ptimal X  policies to degrade signifi-cantly, as demonstrated in Mannor et al. (2007). Many efforts have been made to alleviate the effect of parameter uncertainty in MDPs (e.g., Nilim &amp; El Ghaoui, 2005; Iyengar, 2005; Givan et al., 2000; Ep-stein &amp; Schneider, 2007; Bagnell et al., 2001). In-spired by the so-called  X  X obust optimization X  frame-work (Ben-Tal &amp; Nemirovski, 1998; Bertsimas &amp; Sim, 2004; Ben-Tal et al., 2009), the common approach re-gards the MDP X  X  uncertain parameters r and p as fixed but unknown elements of a known set U , often termed as the uncertainty set , and ranks solutions based on their performance under (respective) worst parameter realization.
 Previous study in robust MDPs typically assumes that there exists no coupling between uncertain parameters of different states. That is, U = Q s  X  X  U s , where U s the uncertainty set for ( p s ,r s ), the transition probabil-ities and rewards for each state. Such an assumption is restrictive, and can often lead to conservative solu-tions as it essentially assumes that all parameters take worst possible realization simultaneously  X  an event that rarely happens in practice.
 In this paper we propose and analyze a robust MDP approach that allows coupled uncertainty to miti-gate conservativeness of the uncoupled uncertainty model. Specifically, we consider a setup which we term LDST after famous proverb  X  X ightning Does not Strike Twice: X  while each parameter may be any ele-ment of the uncertainty set, the total number of states whose parameters deviate from their nominal value is bounded. The motivation is intuitive: suppose the parameter of each state deviates with a small prob-ability, and all states are independent, then the to-tal number of states with deviated parameters will be small. Hence, protection against the scenario that only a limited number of states deviate from their nominal parameter is sufficient to ensure that the solution is very likely to be robust to the real parameters. The LDST approach is conceptually intuitive and sim-ple, yet with added modeling power. Indeed, it is backed by probabilistic guarantees that hold under reasonable conditions. While the LDST approach pro-vides a flexible way to control the conservativeness of robust MDPs, it remains computationally friendly: it is tractable even when both reward parameters and transition probabilities are uncertain, for one of the two setups which we will consider. For the other one that is computationally more challenging, it is tractable in the special case where only the reward parameters are uncertain.
 One advantage of the LDST approach is that it requires no distribution information. This is in sharp contrast to some other variants of MDP meth-ods also aiming to mitigate conservativeness, includ-ing Bayesian reinforcement learning (Strens, 2000; Poupart, 2010), chance constrained MDP (Delage &amp; Mannor, 2010), and distributionally robust MDP (Xu &amp; Mannor, 2010), all assuming a-priori information on the distribution of the system parameters.
 In Section 2 we give background on MDPs and de-fine the LDST formulation. In Section 3 we define the non-adaptive model and prove that it is computation-ally hard in the general case, but tractable if only the rewards are subject to deviations. In Section 4 we de-fine the adaptive model and give tractable algorithms for solving both finite and infinite-horizon problems. In Section 5 we define the concept of fractional devia-tion and prove that the adaptive model is solvable also when fractional deviations are considered. Simulation of the adaptive model is demonstrated in Section 6 and a conclusion is given in Section 7. In this section we briefly explain our notations, some preliminaries about MDP, and the setups that we in-vestigate. Following standard notations from Puter-man (1994), we define a Markov decision process as a 6-tuple &lt; T, X , S , A ,p,r &gt; : here T , possibly infinite, is the decision horizon;  X   X  (0 , 1] is the discount factor, and can be 1 only when T &lt;  X  . The state space S and the action space A are both finite. In state s  X  X  , the decision maker can pick an action a  X  X  , and obtains a reward of r ( s,a ), and the next state will be s 0  X  S with a probability p ( s 0 | s,a ). We use a subscript s to denote the parameter for state s . For example, r s is the re-ward vector for different actions in state s . We assume that the initial state is distributed according to  X  (  X  ), i.e., the initial state is s with probability  X  ( s ). The sets of all history-dependent randomized strategies, all Markovian randomized strategies, and all Markovian deterministic strategies are denoted by  X  HR ,  X  MR and  X 
MD , respectively. The decision goal is to maximize the performance X (  X ,p,r ) , E  X  { P T t =1  X  t  X  1 r ( s i.e., the expected accumulative reward, under param-eter p and r .
 An uncertain MDP (uMDP) is defined as a tuple &lt; T, X , S , A ,p 0 ,r 0 , U ,D &gt; . In contrast to standard MDP, the true parameters p true and r true are unknown. Instead, for each state s , we know p 0 s and r 0 s termed nominal parameters hereafter, which are essentially point estimations of the parameters p s and r s , as well as an uncertainty set U s such that ( p s ,r s )  X  U s . As standard in robust optimization and robust MDPs, we assume that the nominal parameters p 0 s and r 0 s be-long to the uncertainty set U s , and the uncertainty sets {U s } s  X  X  are convex. As discussed above, previ-ous work in robust MDP all focused on the case that parameter realization is uncoupled, i.e., ( p,r ) can take any value in U , Q s U s . In this paper we add the pos-sibility of coupling between uncertainties to avoid be-ing overly conservative. Following the proverb  X  X ight-ning does not strike twice, X  we consider uncertainty models that do not allow disaster to happen too fre-quently. In particular, besides the constraint that the parameters belong to respective uncertainty sets, we further require that the number of states whose param-eters deviate from their nominal values is bounded by the given threshold D . An illustration of different ef-fective uncertainty sets the model can produce is given in Figure 1 for three states, where it can be seen that the model spans both the model oblivious to uncer-tainty, and the conservative model of uncoupled un-certainty. We will later demonstrate that the values of D in-between these extremes are both advantageous, and tractable.
 Intuitively, LDST can be thought of as a two-player zero-sum game, where the decision maker chooses a policy, and an adversarial Nature picks an admissi-ble parameter realization attempting to minimize the reward of the decision maker. Two models are possi-ble, leading to two forms that we will investigate in the sequel. In the first model, termed non-adaptive model , depending on the control policy, Nature chooses the parameter realization of all states once and fixed thereafter, thus leading to a single stage game. In the second model, both players adapt their actions to the trajectory of the MDP, leading to a sequential game. To illustrate the difference, consider the following ex-ample: suppose at state s 0 , taking an action a will lead the system to either state s 1 or state s 2 , both with pos-itive probabilities, and that only the parameter of one state is allowed to deviate. In the adaptive uncertainty model the following deviation is allowed: deviate s 1 if the system reaches s 1 , and deviate s 2 if the system reaches s 2 . In contrast, in the non-adaptive model the state whose parameters deviate must be fixed, and can not depend on whether the system reaches s 1 or s 2 . In this section, we focus on the non-adaptive case. As mentioned above, the uncertain parameters, while un-known, are fixed a priori and do not depend on the trajectory of the MDP. Similarly, the decision maker has to fix a strategy and can not adapt to the realiza-tion of the parameters. Equivalently, this means that the decision maker does not observe whether or when the parameters deviate.
 Our goal is to find a strategy that performs best under the worst admissible parameter realization. That is, to solve the following problem: where: U D , To put it in words, the set of admissible parameters U
D is defined as follows: the parameters of no more than D states can deviate from their nominal values, and the deviated parameters belong to their respective uncertainty set U s .
 The main motivation of this formulation is that often in practice, the correlation between the parameters of different states is weak, or even completely indepen-dent. In such a case, protection against the scenario that only a limited number of states deviate from their nominal parameter is sufficient to ensure that the so-lution is very likely to be robust to the real parame-ters. To illustrate this intuition, we have the following theorem which considers a generative deviation model where the parameters of different states are indepen-dent. The proof is deferred to Appendix A.
 Theorem 1. Suppose the parameters of different states deviate independently, with a probability  X  for s  X  S . Then with probability at least 1  X   X  we have ( p,r )  X  U D 0 , where D 0 , P s  X  X   X  s + 3.1. Computational Complexity In general, the non-adaptive case  X  Problem 1  X  is computationally hard. To make this statement formal, we consider the following  X  X es/no X  decision problem. Decision Problem. Given a Markov decision process with |S| = n and |A| = m , D  X  [0 : n ] , U s for all s  X  X  and  X   X  R . Does there exist  X   X   X  HR such that We denote the decision problem by L ( X  HR ). Sim-ilarly we can define L ( X  MR ) and L ( X  MD ). We next show that answering the decision problem is hard even for very simple uncertainty set U . This immediately implies that finding a strategy  X  that satisfies (2) is computationally difficult. The proof, deferred to Ap-pendix B, is based on reduction from Vertex Cover Problem .
 Theorem 2. Suppose for any s  X  S , U s is a line segment, i.e., the convex combination of two points. Then, the problems L ( X  HR ) , L ( X  MR ) and L ( X  MD ) are NP-hard. 3.2. Reward-Uncertainty Case While in general Problem 1 can be intractable, we show that if only the reward parameters are subject to uncertainty then the problem is solvable in poly-nomial time. We first define the concept of tractable uncertainty set: Definition 1. A set U is called tractable , if in poly-nomial time, the following can be solved for any c : Using this formulation we state the main result of this section. The proof is given in Appendix C in the sup-plementary material.
 Theorem 3. Suppose that only the reward is subject to uncertainty. If for all s  X  X  , U s is a tractable uncer-tainty set, then Problem 1 can be solved in polynomial time.
 When uncertainty sets are polytopes or ellipsoids as often the case in practice, we can convert Problem 1 into easier convex optimization problems such as LP or quadratic programming, for which large scale prob-lems can be solved using standard solvers in reasonable time. See Appendix D and E for detail. This section is devoted to the adaptive case , i.e., the parameter realization  X  in particular the choice of de-viating states  X  depends on the history trajectory of the MDP. Moreover, the decision maker observes pa-rameter deviation retrospectively . That is, in each de-cision stage the decision maker chooses an action, after which the true parameters are realized and observed by the decision maker. Hence the decision maker is aware of the occurrence of parameter deviation, and his strategy is allowed to depend on such information. In practice, there are two cases where the agent can confidently determines a deviation. The first case is where the parameter deviation is accompanied by ex-ternal signals (e.g., lighting). For example, consider a problem of determining the route for a helicopter, the deviation is when there is a storm, and it is reason-able to assume that the agent can observe the storm if it really happens. A similar example is portfolio optimization where the parameter deviation is due to market crash or company bankrupcy, which certainly can be observed. The second case, where there is no external signal, is the case where the support of the nominal parameter and deviation barely intersects (in the probabilistic sense). Take the simulation in Section 6 as an example, although under the nominal parame-ter, it is possible that the number of customers come is large, the probability is very small. Recurrence of such events is more unlikely. Hence, the agent can count each of these events as one parameter deviation, and allow the Nature one or two extra chances of parameter deviation. Solving the resulting adaptive case would yield a solution that with overwhelming probabilities is robust to fixed number of parameter deviation, yet not overly conservative. Notice that a special example of the second case is when the supports are disjoint. 4.1. Finite-horizon case Mathematically, the finite-horizon adaptive case can be formulated as the following decision problem 1 , Here, s t is the randomized state at decision epoch t . Hence, for all s,s 0  X  S we have Pr( s t +1 = s 0 | s s,a t ) = p t ( s 0 | s,a t ) . We remark that in the adaptive case we require that the number of decision stages (as opposed to states ) where the parameter deviates is bounded by D . Hence, the parameters of a state are allowed to take different values for multiple visits. Similarly to Theorem 1, Formulation (3) is justified by the following probabilistic guarantee. The proof is almost identical to that of Theorem 1, and omitted. Theorem 4. Suppose the parameters of different stages deviate independently, with a probability  X  t for t = 1 ,  X  X  X  ,T . Then with probability at least 1  X   X  we have that the total number of deviations P The next theorem, which is the main result of this subsection, asserts that in sharp contrast to the non-adaptive case, the adaptive-case can be solved via backward induction.
 Theorem 5. Let v T +1 ( s,d ) = 0 for all s  X  S and d  X  [0 : D ] , and define for t = 1 ,  X  X  X  ,T , where q t ( s,d,a,p,r ) , P s 0 p ( s 0 | s,a ) v t +1 ( s r ( s,a ) . Then the optimal strategy to Problem 3 is to take a  X  t ( s,d ) at stage t , state s , where stage-parameters are allowed to deviate at most d times from this stage on.
 Before proving the theorem, we first explain our intu-ition: we can re-formulate Problem 3 as a sequential game of perfect information on an augmented state-space. More precisely, Problem 3 can be regarded as a sequential game, where there are two players, namely the decision maker who attempts to maximize the to-tal expected reward by choosing actions sequentially, and Nature who aims to minimize the total expected reward by choosing parameter-realization. Thus, we can expand the decision horizon into 2 T where the de-cision maker makes move in each odd decision stage, and Nature makes move in each even decision stage. Furthermore, both the decision maker and Nature are aware of the number of  X  X eviated visits X  so far, which affect their optimal strategies. Hence, we need to aug-ment the state-space with this information. Thus, we construct the following game.
 Consider the following augmented state space, where we have two types of states: the decision maker states and the Nature states. The set of decision maker states is given by and the set of Nature states is given by The entire (augmented) state space is thus A zero-sum stochastic game with time horizon 2 T be-tween two players on S is constructed as follows. In each decision epoch 2 t  X  1 for t = 1 ,  X  X  X  ,T , the system state belongs to S D and only the decision maker can choose an action a  X  A . Let the state be ( s,d ) where s  X  S and d  X  [0 : D ], and suppose the decision maker takes action a  X  X  , then the next state will be ( s,d,a ), with both players get zero-reward.
 In each decision epoch 2 t for t = 1 ,  X  X  X  ,T , the system state belongs to S N and only Nature can choose an action. The action set for Nature is the following: if d  X  1, Nature can either pick the nominal parame-ter ( p 0 s ,r 0 s ), in which case the next state will be ( s where s 0 is a random variable following the probability distribution p 0 ( s 0 | s,a ), and the decision maker gets a reward r 0 ( s,a ), which Nature simultaneously loses; al-ternatively, Nature can pick a parameter ( p 0 ,r 0 )  X  X  s in which case the next state will be ( s 0 ,d  X  1) where s s 1 , 1 s 1 , 0 is a random variable following the probability distribu-tion p 0 ( s 0 | s,a ), and the decision maker gets a reward r ( s,a ), which Nature, again, simultaneously loses. If d = 0, Nature can only pick the nominal parame-ter ( p 0 s ,r 0 s ). An example of this construction is given graphically in Figure 2. It is easy to see that solving Problem 3 is equivalent to solving the aforementioned stochastic game. This leads to the proof of Theorem 5. Proof of Theorem 5. We prove the theorem by investi-gating the aforementioned stochastic game, and show-ing that a Nash equilibrium exists for the stochastic game, where the decision maker X  X  move is a  X  t ( s,d ). Since the solution to the stochastic game and the solu-tion to Problem 3 coincide (Filar &amp; Vrieze, 1996), the theorem thus follows.
 We now construct the Nash equilibrium. Let the deci-sion maker take the strategy a  X  t ( s,d ) at state ( s,d )  X  S
D in decision epoch 2 t  X  1. Let Nature take the fol-lowing action at state ( s,d,a )  X  S N in decision epoch 2 t : do not deviate the parameters (i.e, pick param-eter ( p 0 s ,r 0 s )) if either d = 0, or q t ( s,d,a,p Observe that if Nature fixes this strategy, the stochas-tic game reduces to a standard MDP for the decision maker to maximize his total reward, in which case his optimal strategy is take a  X  t ( s,d ) at each ( s,d )  X  S at the decision epoch 2 t  X  1. On the other hand, if the decision maker fixes his strategy, then for Nature to minimize the total-reward for the decision maker, it is easy to see that the aforementioned strategy is optimal. Thus, the aforementioned pair of strategies is a Nash equilibrium, which implies the theorem. Algorithm 1 illustrates how Theorem 5 can be used to compute optimal policy for the non-adaptive model in the LDST setup. Its time-complexity is O TD |S||A| |S| + M where M is defined as the maximal computational effort in performing a single minimization of q t ( s,d,a,p,r ) in ( p,r )  X  U s for any s  X  X  ,t  X  [1 : T ]. 4.2. Discounted-Reward Infinite Horizon Case We extend the formulation of the adaptive case into the infinite horizon case, with discounted total reward criterion. Depending on whether the number of pa-rameter deviations is also discounted, we formulate and investigate the following two setups: Algorithm 1 Backward Induction to solve the adap-tive case Input: uMDP &lt; T, S , A ,p 0 ,r 0 , U ,D &gt;
Initialize V T +1 ( s,d ) = 0  X  s  X  X  ,d  X  [0 : D ]. for t = T downto 1 do end for return  X  t ( s,d )  X  t  X  [1 : T ] ,s  X  X  ,d  X  [0 : D ] In Setup A the total number of stages where param-eters deviate is bounded. In contrast, in Setup B, similarly to future reward, future parameter devia-tion is discounted. Setup A is easy to compute as we can apply the same technique to augment the state-space with the remaining budget of  X  X ature X . Setup B further requires discretization of the remaining bud-get. Both setups X  optimal value functions admit im-plicit equations similar to the Bellman Equations, as shown in Appendix F in the supplementary material, and thus are solvable in the same methods as classic infinite-horizon MDPs. This section is motivated from the following setup: in each stage, the real parameter is likely to slightly de-viate from the nominal one, whereas large deviation is rare. Notice that the previous approach that bounds the number that parameter deviates does not apply to this setup. Hence, we extend previous results to the continuous deviation case, i.e., Nature is allowed to perform  X  X ractional X  deviations.
 More specifically, suppose the nominal parameters are p ,r 0 and the uncertainty set is U , and that U s is star-shaped 2 in respect to ( p 0 s ,r 0 s ) for each s  X  S . If the realized parameter is ( p,r )  X  U , then Nature is considered to have consumed a budget of deviation b ( p,r,p 0 ,r 0 , U ) such that b ( p,r,p 0 ,r 0 , U ) , min {  X   X  0 | where  X  U , { (  X  p , X  r ) | ( p 0 +  X  p ,r 0 +  X  r )  X  X } . Since ( p,r )  X  U , we get b ( p,r,p 0 ,r 0 , U )  X  1. Roughly speaking, a  X  X mall X  deviation is considered  X  X ess ex-pensive X  compared to a large one. Thus, we can formulate the continuous extension as follows, with  X   X   X   X  1, and  X  &lt; 1. 3 Similarly to Problems 4 and 5 from the previous sec-tion, Problem 6 is solvable (approximately) using a discretization scheme. The statement and proof are given in Appendix G in the supplementary material. We next provide a probabilistic guarantee of the con-tinuous model, for the finite horizon case. The proof is similar to the previous probabilistic guarantees and is given in Appendix H in the supplementary material. Theorem 6. Suppose the amount of parameter a mean  X  t . Then with probability at least 1  X   X  we have the that total amount of devia-P We present simulation results of the proposed method under a setup closely resembles our motivating exam-ple, i.e., parameters randomly deviate from their nom-inal values with a small probability. We use a scenario based on the Single-Product Stochastic Inventory Con-trol problem described in Puterman (1994). Here the states represent the number of items in the inventory, with maximal capacity of MAXSTOCK items. Ev-ery day an order is made for new items at the cost of STOREPRICE each. A price is paid for holding the items in the inventory (both old and new), which is a function of the number of items HOLDINGCOST(n) . A Poisson-distributed number of customers, with ex-pected value of NUMCUSTOMERS place orders for the item and pay CUSTOMERPRICE for each prod-uct sold. If the demand cannot be met, the store is  X  X ined X  total of PENALTY(n) where n is the number of customers whose demand cannot be met. The simu-lation is run for T days, and any unused stock at time T + 1 is wasted.
 The deviation we added to this scenario is Rush : the maximal number of customers, MAXSTOCK , arrive simultaneously on the same day. Thus the uncertainty set U s t consists of two points: regular Poisson arrival and Rush . Note that a Rush affects both the transition probabilities and the rewards.
 We simulated the above scenario for different values of initially assumed number of deviations d 0 4 , and applied random occurrences of Rush with probability p rush for each day independently. We also added the expected value of the optimal MDP policy aware of the occurrence of Rush for comparison. The results are given in Figure 3. It can be seen that with a suitable choice of d 0 such as expected number of devi-ation, the performance of LDST X  X  policy is comparable to the performance of the optimal policy for each sce-nario, while both nominal ( d 0 = 0) and conservative, uncoupled uncertainty ( d 0 = T ) polices give worse per-formance as expected. We proposed a new robust MDP framework, termed  X  X ightning Does not Strike Twice, X  to model the case that uncertain parameters among different states are coupled by sharing a common pool of  X  X udget X  of de-viation. This leads to a tractable formulation that pro-vides a flexible tradeoff between risk and value, which can be adjusted by tuning the  X  X udget. X  One obstacle that prevents robust MDPs from being widely applied is that the solution tends to be con-servative  X  an outcome of the traditional formulation that uncertainties are uncoupled. On the other hand, coupled uncertainty in MDPs is in general computa-tionally difficult. Therefore, it is important to iden-tify sub-classes of coupled uncertainty that are flexi-ble enough to overcome conservativeness, yet remains computationally tractable. This paper is the first of such attempts, which we hope will facilitate the appli-cability of robust MDPs.
 S. Mannor has received funding from the Israel Sci-ence Foundation (contract 890015) and the European Unions Seventh Framework Programme (FP7/2007-2013) under grant agreement no. 249254. H. Xu is partially supported by the National University of Sin-gapore under startup grant R-265-000-384-133.
 Bagnell, A., Ng, A., and Schneider, J. Solving un-certain Markov decision problems. Technical Re-port CMU-RI-TR-01-25, Carnegie Mellon Univer-sity, August 2001.
 Ben-Tal, A. and Nemirovski, A. Robust convex opti-mization. 23(4):769 X 805, 1998.
 Ben-Tal, A., El Ghaoui, L., and Nemirovski, A. Robust Optimization . Princeton University Press, 2009. Bertsimas, D. and Sim, M. The price of robustness. 52(1):35 X 53, January 2004.
 Delage, E. and Mannor, S. Percentile optimization for Markov decision processes with parameter uncer-tainty. Operations Research , 58(1):203 X 213, 2010. Epstein, Larry G. and Schneider, M. Learning under ambiguity. Review of Economic Studies , 74(4):1275 X  1303, 2007.
 Filar, J. and Vrieze, K. Competitive Markov Decision Process . Springer-Verlag New York, 1996.
 Givan, R., Leach, S., and Dean, T. Bounded-parameter Markov decision processes. Artificial In-telligence , 122(1-2):71 X 109, 2000.
 Iyengar, G. Robust dynamic programming. Mathemat-ics of Operations Reseasrch , 30(2):257 X 280, 2005. Mannor, S., Simeste, D., Sun, P., and Tsitsiklis, J.
Bias and variance approximation in value function estimates. Management Science , 53:308 X 322, 2007. Nilim, A. and El Ghaoui, L. Robust control of Markov decision processes with uncertain transition matri-ces. Operations Research , 53(5):780 X 798, 2005. Poupart, Pascal. Bayesian reinforcement learn-ing. In Sammut, Claude and Webb, Geoffrey I. (eds.), Encyclopedia of Machine Learning , pp. 90 X  93. Springer, 2010. ISBN 978-0-387-30768-8.
 Puterman, Martin L. Markov Decision Processes . John Wiley &amp; Sons, New York, 1994.
 Strens, M. A Bayesian framework for reinforcement learning. In ICML , pp. 943 X 950, 2000.
 Sutton, Richard S. and Barto, Andrew G. Reinforce-ment Learning: An Introduction . MIT Press, 1998. Xu, H. and Mannor, S. Distributionally robust Markov
