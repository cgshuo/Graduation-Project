 Mark ov random elds (MRFs) [12 ] have been applied to a wide variety of real-w orld problems. Ho we ver, the probabilistic inference task in MRFs  X  computing the posterior distrib ution of one or more variables  X  is tractable only in small tree-width netw orks, which are not often an appropriate model in practice. Thus, one typically must resort to the use of approximate inference methods, most commonly (in recent years) some variant of loop y belief propagation [11 ].
 posteriori (MAP) inference problem  X  computing the single most lik ely assignment relati ve to the distrib ution. Some what surprisingly , there are certain classes of netw orks where MAP inference can be performed very efciently using combinatorial optimization algorithms, even though posterior probability inference is intractable. So far, two main such classes of netw orks have been studied. Re gular (or associative) networks [18 ], where the potentials encode a preference for adjacent vari-ables to tak e the same value, can be solv ed optimally or almost optimally using a minimum cut algorithm. Con versely , matc hing networks , where the potentials encode a type of mutual exclusion constraints between values of adjacent variables, can be solv ed using matching algorithms. These types of netw orks have been sho wn to be applicable in a variety of applications, such as stereo re-construction [13 ] and segmentation for regular netw orks, and image correspondence [15 ] or word alignment for matching netw orks [19 ].
 these tractable subclasses. The problem may well have a lar ge component that can be well-modeled as regular or as a matching problem, but there may be additional constraints that tak e it outside this restricted scope. For example, in a task of registering features between two images or 3D scans, we may formulate the task as a matching problem, but may also want to encode constraints that enforce the preserv ation of local or global geometry [1]. Unfortunately , once the netw ork contains some  X non-complying X  potentials, it is not clear if and how one can apply the combinatorial optimization algorithm, even if only as a subroutine. In practice, in such netw orks, one often simply resorts to applying standard inference methods, such as belief propagation. Unfortunately , belief propagation may be far from an ideal procedure for these types of netw orks. In man y cases, the MRF structures associated with the tractable components are quite dense and contain man y small loops, leading to con vergence problems and bad approximations. Indeed, recent empirical studies studies [17 ] sho w that belief propagation methods perform considerably worse than min-cut-based methods when ap-plied to a variety of (purely) regular MRFs. Thus, falling back on belief propagation methods for these MRFs may result in poor performance.
 can exploit combinatorial optimization algorithms for tractable subnetw orks. The basic idea in our the netw ork can often be partitioned into a number of subnetw orks whose union is equi valent to the original distrib ution. If we can efciently solv e the MAP problem for each of these subnetw orks, we would lik e to combine these results in order to nd an approximate MAP for the original problem. The obvious dif culty is that a MAP solution, by itself, pro vides only a single assignment, and one cannot simply combine dif ferent assignments. The key insight is that we can combine the information from the dif ferent sub-netw orks by computing max-mar ginals for each one. A max-mar ginal for an indi vidual variable X is a vector that species, for each value x , the probability of the MAP assignment in which X = x . If we have a black box that computes a max-mar ginal for each variable X in a subnetw ork, we can embed that black box as a subroutine in a max-product belief propagation algorithm, without changing the algorithm' s basic properties.
 algorithms for both regular netw orks and matching netw orks can be embedded in this frame work. In particular , we also describe efcient combinatorial optimization algorithms for both types of netw orks that can compute all the max-mar ginals in the netw ork at a cost similar to that of nding the single MAP assignment. We evaluate the applicability of C OMPOSE on synthetic netw orks and on an image registration task for scans of a cell obtained using an electron microscope, all of which are matching problems with additional pairwise constraints. We compare C OMPOSE to variants of both max-product and sum-product belief propagation, as well as to straight matching. Our results demonstrate that the ability of C OMPOSE to transmit information globally across the netw ork leads to impro ved con vergence, decreased running time, and higher -scoring assignments. (or Mark ov Random Fields) over discrete variables X = f X results extend easily to the more general case of non-pairwise Mark ov netw orks. We denote an assignment of values to X with x , and an assignment of a value to a single variable X pairwise Mark ov netw ork M is dened as a graph G = ( V ; E ) and set of potentials F that include both node potentials distrib ution via an unnormalized density P 0 distrib ution as P
There are dif ferent types of queries that one may want to compute on a Mark ov netw ork. Most common are (conditional) probability queries , where the task is to compute the mar ginal prob-ability of one or more variables, possibly given some evidence. This type of inference is es-sentially equi valent to computing the partition function, which sums up exponentially man y as-signments, a computation which is currently intractable except in netw orks of low tree width . An alternati ve type of inference task is the is maximum a posteriori (MAP) problem  X  nding arg max x P F ( x ) = arg max x P 0 F ( x ) . In the MAP problem, we can avoid computing the partition function, so there are certain classes of netw orks to which the MAP assignment can be computed ef-fecti vely , even though computing the partition problem can be sho wn to be intractable; we describe two such important classes in Section 4.
 propa gation (MPBP) [20 ] is a commonly-used method for nding an approximate solution. In this algorithm, each node X value for each value x At con vergence, each variable can compute its own local belief as: b lea ves towards a single root, the value of the message passed by X a partial max-mar ginal : the entry for x subnetw ork emanating from X obtain exact max-mar ginals for the entire joint distrib ution. Ho we ver, applied to a netw ork with loops, MPBP often does not con verge, even when combined with techniques such as smoothing and asynchronous message passing, and the answers obtained can be quite approximate. We now describe the C OMPOSE scheme for decomposing the netw ork into hopefully more tractable components, and allo wing approximate max-product computation over the netw ork as a whole to be performed by iterati vely computing max-product in one component and passing approximate max-mar ginals to the other(s). As the unnormalized probability of an assignment in a Mark ov netw ork is a product of local potentials, we can partition the potentials in an MRF into an ensemble of k subgraphs G F ; : : : ; F k . We require that the product of the potentials in these subnetw orks maintain the same information as the original MRF . That is, if we originally have a factor i 2 F 1 ; : : : ; that achie ves this equality is simply to select, for each potential unchanged, and set all of the other ( l )
Ev en if MAP inference in the original netw ork is intractable, it may be tractable in each of the sub-netw orks in the ensemble. But how do we combine the results from MAP inference in an en-semble of netw orks over the same set of variables? Our approach dra ws its moti vation from the MPBP algorithm, which computes messages that correspond to pseudo-max-mar ginals over single variables (approximate max-mar ginals, that do not account for the loops in the netw ork). We be-gin by conceptually reformulating the ensemble as a set of netw orks over disjoint sets of variables  X communicator X  variables X sume that each subnetw ork is associated with an algorithm that can  X read in X  pseudo-max-mar ginals over the communicator variables, and compute pseudo-max-mar ginals over these variables.
More precisely , let message. Then we dene the C OMPOSE message passing scheme as follo ws: That is, each subnetw ork computes its local pseudo-max-mar ginals over each of the indi vidual variables, given, as input, the pseudo-max-mar ginals over the others. The separate pseudo-max-mar ginals are inte grated via the communicator variables. It is not dif cult to see that this message passing scheme is equi valent to a particular scheduling algorithm for max-product belief propa-gation over the ensemble of netw orks, assuming that the max-product computation in each of the subnetw orks is computed exactly using a black-box subroutine.

We note that this message passing scheme is some what related to the tree-r eweighted max-product (TR W) method of Wainwright et al. [8], where the netw ork distrib ution is partitioned as a weighted combination of trees, which also communicate pseudo-max-mar ginals with each other . In this section, we describe two important classes of netw orks where the MAP problem can be solv ed efciently using combinatorial algorithms: matching netw orks, which can be solv ed using bipartite matching algorithms; and regular netw orks, which can be solv ed using (iterated application of) minimum cut algorithms. We sho w how the same algorithms can be adapted, at minimal compu-tational cost, for computing not only the single MAP assignment, but also the set of max-mar ginals. This allo ws these algorithms to be used as one of our  X black box es X  in the C OMPOSE frame work.
Bipartite matching . Man y problems can be well-formulated as maximum-score (or minimum weight) bipartite matching: We are given a graph G = ( A ; U ) , whose nodes are partitioned into disjoint sets A = A [ B . In G , each edge ( a; b ) has one endpoint in A and the other in B and an associated score c ( a; b ) . A bipartite matching is a subset of the edges W U such that each node appears in at most one edge. The notion of a matching can be relax ed to include other types of degree constraints, e.g., constraining certain nodes to appear in at most k edges. The score of the matching is simply the sum of the scores of the edges in W .

The matching problem can also be formulated as an MRF , in several dif ferent ways. For example, in the degree-1 case (each node in A is matched to one node in B ), we can have a variable X each a 2 A whose possible values are all of the nodes in B . The edge scores in the matching graph are then simply singleton potentials in the MRF , where while the costs can be easily encoded in an MRF , the degree constraints on the matching induce a set of pairwise mutual-e xclusion potentials on all pairs of variables in the MRF , leading to a fully connected netw ork. Thus, standard methods for MRF inference cannot handle the netw orks associated with matching problems.

Ne vertheless, nding the maximum score bipartite matching (with any set of degree constraints) can be accomplished easily using standard combinatorial optimization algorithms (e.g., [6]). Ho w-ever, we also need to nd all the max-mar ginals. Fortunately , we can adapt the standard algorithm for nding a single best matching to also nd all of the max-mar ginals. A standard solution to the max-matching problem reduces it to a max-weight o w problem, by introducing an additional  X source X  node that connects to all the nodes in A , and an additional  X sink X  node that connects to all ing). We now run a standard max-weight o w algorithm, and dene an edge to be in the matching inte gral, so that it denes a matching. Let w be the weight of the o w in the graph. A o w in the graph denes a residual graph , where there is an edge in the graph whose capacity is the amount of a unit capacity going in the reverse direction, corresponding to the fact that we can now choose to  X eliminate X  the o w from a to b . The scores in these inverse edges are also negati ve, corresponding to the fact that score is lost when we reduce the o w.

Our goal now is to nd, for each pair ( a; b ) , the score of the optimal matching where we force this pair to be matched. If this pair is matched in the current solution, then the score is simply w . Otherwise, we simply nd the highest scoring path from b to a in the residual graph. An y edges on this new path from A to B will be included in the new matching; any edges from B to A were included in the old matching, but are not in the new matching because of the augmenting path. This path is the best way of changing the o w so as to force o w from a to b . Letting be the weight of this augmenting path, the overall score of the new o w is w + . It follo ws that the cost of this impro ving its score. Thus, we can nd the highest-scoring path by simply negating all edge costs and nding the shortest path in the graph.

Thus, to compute all of the max-mar ginals, we simply need to nd the shortest path from every node a 2 A to every node b 2 B . We can nd this using the Flo yd-W arshall all-pairs-shortest-paths algorithm, which runs in O (( n source shortest-path algorithm for each node in B , at a total cost of O ( n comparison, the cost of solving the initial o w problem is O ( n 3
Minimum Cuts. A very dif ferent class of netw orks that admits an efcient solution is based on the application of a minimum cut algorithm to a graph. At a high level, these netw orks encode situations where adjacent variables lik e to tak e  X similar X  values. There are man y variants of this condition. The simplest variant is applied to pairwise MRFs over binary-v alued random variables. In this case, a potential is said to be regular if: ij ( X i = 0 ; X j = 1) ij ( X i = 1 ; X j = 0) solution can be found as the minimum cut of a weighted graph constructed from the MRF [9]. This with non-binary variables whose negati ve-log-probab ility is a con vex function [5]. Moreo ver, for a range of conditions on the potentials, an -expansion procedure [2], which iterati vely applies a min-cut to a series of graphs, can be used to nd a solution with guaranteed approximation error relati ve to the optimal MAP assignment.
 and Torr [7], studying the problem of condence estimation in MAP problems, sho wed how all of the max-mar ginals in a regular netw ork can be computed using dynamic algorithms for o w computations. Their method also applies to non-binary netw orks with con vex potentials (as in [5]), but not to netw orks for which -expansion is used to nd an approximate MAP assignment. We evaluate C OMPOSE on the image correspondence problem, which is characteristic of match-ing problems with geometric constraints. We compare both max-product tree-reparameterization ( TRMP ) [8] and asynchronous max-product ( AMP ). The axes along which we compare all algo- X  log of the unnormalized lik elihood  X  of the solution found, in the Mark ov netw ork that denes the problem. We use standard message damping of .3 for the max-product algorithms and a con ver-gence threshold of 10 3 for all propagation algorithms. All tests were run on a 3.4 GHz Pentium 4 processor with 2GB of memory .
 to-1 mapping between landmarks in two images. Here, we have a set of template points S = f x 1 ; : : : ; x n g for each mark er x tar get image. Our MRF contains singleton potentials information, so that a mark er x neighborhood looks similar to x to candidates x 0 potentials f may want to encode geometric potentials, which enforce a preference for preserv ation of distance or orientation for pairs of mark ers x nd a 1-to-1 mapping between landmarks in the source and tar get images, we also encode a set of mutual exclusion potentials over pairs of variables, enforcing the constraint that no two mark ers are assigned to the same candidate x 0
Synthetic Netw orks. We rst experimented with synthetically generated netw orks that follo w the abo ve form. To generate the netw orks, we rst create a source  X image X  that contains a set of tem-plate points S = f x plane. Ne xt, the tar get set of points T = f x 0 each template point x variance matrix 2 I . As there was no true local information, the matching (or singleton) potentials for both types of synthetic netw orks were generated uniformly at random on [0 ; 1) . The `correct' matching point, or the one the template variable generates, was given weight .7, ensuring that the correct matching gets a non-ne gligible weight without making the correspondence too obvious. We consider two dif ferent formulations for the geometric potentials. The rst utilizes a minimum span-ning tree connecting the points in S , and the second simply a chain. In both cases, we generate pairwise geometric potentials deviation proportional to the Euclidean distance between x the two constructions were similar , so, due to lack of space, we present results only for the line netw orks.
 Fig. 1(a) sho ws the cumulati ve percentage of con vergent runs as a function of CPU time. C OM -POSE con verges signicantly more often than either AMP or state-of-the-art TRMP . For TRMP , we created one tree over all the geometric and singleton potentials to quickly pass information through the entire graph; the rest of the trees chosen for TRMP were over a singleton potential, all the neigh-boring mutual exclusion potentials, and pairwise potentials neighboring the singleton, allo wing us to maintain the mutual exclusion constraints during dif ferent reparameterization steps in TRMP . Since sum-product algorithms are kno wn in general to be less susceptible to oscillation than their max-product counterparts, we also compared against sum-product asynchronous belief propagation. In our experiments, howe ver, sum-production BP did not achie ve good scores even on runs in which it solutions; we omit results for lack of space.

Fig. 1(b) sho ws the average dif ference in log scores between each algorithm' s result and the av-erage log score of AMP as a function of the number of variables in the netw orks. C OMPOSE clearly outperforms the other algorithms, gaining a lar ger score mar gin as the size of the problem increases. In the synthetic tests we ran for (b) and (c), C OMPOSE achie ved the best score in over 90% of cases. This dif ference was greatest in more dif cult problems, where there is greater variance in the locations of candidates in the tar get image leading to dif culty achie ving a 1-to-1 correspondence.
In Fig. 1(c), we further examine scores from indi vidual runs, comparing C OMPOSE directly to the strongest competitor , TRMP . C OMPOSE consistently outperforms TRMP and never loses by more than a small mar gin; C OMPOSE often achie ves scores on the order of 2 40 times better than performance and whether or not the algorithms con verged.

Fig. 1(d) examines the intermediate scores obtained by C OMPOSE and TRMP on intermediate assignments reached during the inference process, for lar ge (100 variable) problems. Though C OM -POSE does not reach con vergence in messages, it quickly tak es lar ge steps to a very good score on never achie ves a score as high as C OMPOSE . This indicates that C OMPOSE scales better than TRMP to lar ger problems. This beha vior may also help to explain the results from (c), where we see that, even when C OMPOSE does not con verge in messages, it still is able to achie ve good scores. Ov erall, these results indicate that we can use intermediate results for C OMPOSE even before con vergence.
Real Netw orks. We now consider real netw orks generated for the task of electron microscope tomography: the three-dimensional reconstruction of cell and organelle structures based on a series of images obtained at dif ferent tilt angles. The problem is to localize and track mark ers in images across time, and it is a dif cult one; traditional methods lik e cross correlation and graph matching often result in man y errors. We can encode the problem, howe ver, as an MRF , as described abo ve. In this case, the geometric constraints were more elaborate, and it was not clear how to construct a good set of spanning trees. We therefore used a variant on AMP called residual max-product ( RMP ) [3] that schedules messages in an informed way over the netw ork; in this work and others, we have found this variant to achie ve better performance than TRMP on dif cult netw orks.
Fig. 2(a) sho ws a source set of mark ers in an electron tomography image; Fig. 2(b) sho ws the correspondence our algorithm achie ves, and Fig. 2(c) sho ws the correspondence that RMP achie ves. Note that, in Fig. 2(c), points from the source image are assigned to the same point in the tar get image, whereas C OMPOSE does not have the same failing. Of the twelv e pairs of images we tested, RMP failed to con verge on 11/12 within 20 minutes, whereas C OMPOSE failed to con verge on only two of the twelv e. Because the netw ork structure was dif cult for loop y approximate methods, we ran experiments where we replaced mutual exclusion constraints with soft location constraints on indi vidual landmarks; while con vergence impro ved, actual performance was inferior . RMP and TRMP run on a simpler netw ork with soft mutual exclusion constraints are competiti ve with, and even very slightly better than C OMPOSE on simple problems, as problems become more dif cult (more variance in tar get images), C OMPOSE clearly dominates. We also compare C OMPOSE to simply nding the best matching of mark ers to candidates without any geometric information; C
OMPOSE dominates this approach, never scoring worse than the matching. In this paper , we have presented C OMPOSE , an algorithm that exploits the presence of tractable substructures in MRFs within the conte xt of max-product belief propagation. Moti vated by the existence of very efcient algorithms to extract all max-mar ginals from combinatorial substructures, we presented a variation of belief propagation methods that used the max-mar ginals to tak e lar ge steps in inference. We also demonstrated that C OMPOSE signicantly outperforms state-of-the-art methods on dif ferent challenging synthetic and real problems.
 the augmented matching problems described abo ve is that the mutual exclusion constraints create a phenomenon where small changes to local regions of the netw ork can have strong effects on distant parts of the netw ork, and it is dif cult for belief propagation to adequately propagate information. Some existing variants of belief propagation (such as TRMP) attempt to speed the exchange of information across opposing sides of the netw ork by means of intelligent message scheduling. Ev en intelligently-scheduled message passing is limited, howe ver, as messages are inherently local. If there are oscillations across a wide diameter , due to global interactions in the netw ork, the y might contrib ute signicantly to poor performance by BP algorithms.
 but that do not have all of the information about any subset of variables. If the component of the netw ork that is dif cult for belief propagation can be encoded in an efcient special-purpose subnetw ork such as a matching, then we have a means of effecti vely propagating global information. We conjecture that C OMPOSE 's ability to globally pass information contrib utes both to its impro ved con vergence and to the better results it obtains even without con vergence.
 lar [14 , 13], but this work is lar gely specic to certain types of  X close-to-re gular X  MRFs. It would be interesting to compare C OMPOSE and these methods on a range of netw orks containing regu-lar subgraphs. Our work is also related to work trying to solv e the quadr atic assignment problem (QAP) [10 ], a class of problems of which our generalized matching netw orks are a special case. Standard algorithms for QAP include simulated annealing, tab u search, branch and bound, and ant algorithms [16 ]; the latter have some of the avor of message passing, walking trails over the graph representing a QAP and iterati vely updating scores of dif ferent assignments to the QAP . To the best of our kno wledge, howe ver, none of these pre vious methods attempts to use a combinatorial algo-rithm as a component in a general message-passing algorithm, thereby exploiting the structure of the pairwise constraints.

There are man y interesting directions arising from this work. It would be interesting to perform a theoretical analysis of the C OMPOSE approach, perhaps pro viding conditions under which it is guar -anteed to pro vide a certain level of approximation. A second major direction is the identication of other tractable components within real-w orld MRFs that one can solv e using combinatorial opti-mization methods, or other efcient approaches. For example, the constraint satisf action community has studied several special-purpose constraint types that can be solv ed more efciently than using generic methods [4]; it would be interesting to explore whether these constraints arise within MRFs, and, if so, whether the special-purpose procedures can be inte grated into the C OMPOSE frame work. efciently with special-purpose algorithms; the combination of special-purpose solv ers within a general inference scheme may allo w us to solv e problems that are intractable to any current method. This research was supported by the Defense Adv anced Research Projects Agenc y (D ARP A) under the Transfer Learning Program. We also thank Da vid Kar ger for useful con versations and insights. [1] D. Anguelo v, D. Koller , P. Srini vasan, S. Thrun, H. Pang, and J. Da vis. The correlated corre-[2] Y. Bo ykov, O. Veksler , and R. Zabih. Fast approximate ener gy minimization via graph cuts. In [3] G. Elidan, I. McGra w, and D. Koller . Residual belief propagation. In UAI , 2006. [4] J. Hook er, G. Ottosson, E.S. Thorsteinsson, and H.J. Kim. A scheme for unifying optimization [5] H. Ishika wa. Exact optimization for Mark ov random elds with con vex priors. PAMI , 2003. [6] J. Kleinber g and E. Tardos. Algorithm Design . Addison-W esle y, 2005. [7] P. Kohli and P. Torr . Measuring uncertainty in graph cut solutions -efciently computing [8] V. Kolmogoro v and M. Wainwright. On the optimality of tree-re weighted max-product [9] V. Kolmogoro v and R. Zabih. What ener gy functions can be minimized via graph cuts? In [10] E. La wler . The quadratic assignment problem. In Mana gement Science , 1963. [11] K. Murphy and Y. Weiss. Loop y belief propagation for approximate inference: An empirical [12] J. Pearl. Probabilistic Reasoning in Intellig ent Systems . Mor gan Kaufmann, 1988. [13] A. Raj, G. Singh, and R. Zabih. MRF' s for MRI' s: Bayesian reconstruction of MR images via [14] C. Rother , S. Kumar , V. Kolmogoro v, and A. Blak e. Digital tapestry . In CVPR , 2005. [15] J. Shi and J. Malik. Normalized cuts and image segmentation. PAMI , 2000. [16] T. St  X  utzle and M. Dorigo. ACO algorithms for the quadratic assignment problem. In Ne w [17] R. Szeliski, R. Zabih, D. Scharstein, O. Veksler , V. Kolmogoro v, A. Agarw ala, M. Tappen, and [18] B. Taskar , V. Chatalbashe v, and D. Koller . Learning associati ve mark ov netw orks. In ICML [19] B. Taskar , V. Chatalbashe v, D. Koller , and C. Guestrin. Learning structured prediction models: [20] Y. Weiss and W. Freeman. On the optimality of solutions of the max-product belief-propagation
