 Neurons in the brain communicate through the firing of action potentials. This process induces brief  X  X oltage X  spikes in the surrounding environment that can be recorded by electrodes. The recorded neural signal may come from single, or multiple neurons. While single neurons only require a detection algorithm to identify the firings, multiple neurons require the separation of superimposed activities to obtain individual neuron firings. This procedure, also known as spike sorting, is more complex than what is required for single neurons.
 Spike sorting has acquired general attention. Many algorithms have been reported in the litera-ture [1 X 7], with each claiming an improved performance based on different data. Comparisons among different algorithms can be subjective and difficult. For example, benchmarks of in vivo recordings that thoroughly evaluate the performance of algorithms are unavailable. Also, syn-thesized sequences with benchmarks obtained through neuron models [8], isolated single neuron recordings [2], or simultaneous intra-and extra-cellular recordings [9] lack the in vivo recording environment. As a result, synthesized data provide useful but limited feedback on algorithms. This paper discusses a noise study, based on which SNR enhancement techniques are proposed. These techniques are applicable to an unspecified spike sorting algorithm. Specifically, a proce-dure of online estimating both individual spike and noise spectrum is first applied. Based on the estimation, a bandpass filter that fits the spectrum of the underlying spike is selected. This max-imally reduces the broad band noise without sacrificing the signal integrity. In addition, a com-prehensive study of multiple noise sources are performed through lumped circuit model as well as measurements. Experiments suggest that the dominant noise is not from recording electronics, thus de-emphasize the importance of low noise hardware design. More importantly, the measured noise generally shows a family of 1 /f x spectrum, which can be reduced by using noise shaping techniques [10, 11]. Figure 1 shows the proposed noise reduction procedures.
 The rest of this paper is organized as follows. Section 2 focuses on noise sources. Section 3 gives a Wiener kernel based adaptive bandpass filter. Section 4 describes a noise shaping technique that uses fractional order differentiation. Section 5 reports experiment results. Section 6 gives concluding remarks. Recorded neural spikes are superimposed with noise that exhibit non-Gaussian characteristics and can be approximated as 1 /f x noise. The frequency dependency of noise is contributed by multi-ple sources. Identified noise sources include 1 /f  X   X  neuron noise [12 X 14] (notations of 1 /f x and 1 /f  X  represent frequency dependencies of the total noise and neuron noise respectively), electrode-electrolyte interface noise [15], tissue thermal noise, and electronic noise, which are illustrated in Figure 2 using a lumped circuit model. Except electrolyte bulk noise ( 4 kTR b in Figure 2) that has a flattened spectrum, the rest show frequency dependency. Specifically, 1 /f  X   X  neuron noise is in-duced from distant neurons [12 X 14]. Numeric simulations based on simplified neuron models [12] suggest that  X  can vary a wide range depending on the parameters. For the electrode-electrolyte interface noise, non-faradaic type in particular, an effective resistance ( R ee ) is defined for model-ing purposes. R ee generates noise that is attenuated quadratically to frequency in high frequency region by the interface capacitance ( C ee ). Electronic noise consists of two major components: ther-mal noise (  X  kT/g m [16]) and flicker noise (or 1 /f noise [16]). Flicker noise dominates at lower frequency range and is fabrication process dependent. Next, we will address the noise model that will later be used to develop noise removal techniques in Section 3 and Section 4, and verified by experiment results in section 5. 2.1 1 /f  X   X  Neuron Noise overlap the spectrum of the recorded spike signal. They usually have small magnitudes and are noisily aggregated. Analytically, the background activities are described as where V neu represents the superimposed background activities of distant neurons; i and t i,k repre-sent the object identification and its activation time respectively, and v i.neu is the spiking activity template of the i th object. Based on Eq. 1, the power spectrum of V neu is where &lt; &gt; represents the average over the ensemble and over k 1 , P {} is the spectrum operation, X number of activations divided by a period of time). The spectrum of a delta function spike pulse train ( 1 /f  X  frequency dependency. As this term multiplies | X i ( f ) | 2 , the unresolved spiking activities of distant neurons contribute a spectrum of 1 /f x within the signal spectrum. 2.2 Electrode Noise Assume the electrode-electrolyte interface is the non-faradaic type where charges such as electrons and ions, can not pass across the interface. In a typical in vivo recording environment that involves at location x assuming spatial concentration n i ( x ) is described by Nernst equation where D i is the diffusion coefficient,  X  electrical potential, z i charge of the particle, q the charge of one electron, k the Boltzmann constant, T the temperature, and  X  the convection coefficient. In a steady state, J i ( x ) is zero with the boundary condition of maintaining about 1 V voltage drop from metal to electrolyte. In such a case, the electrode interface can be modeled as a lumped resistor R ee in parallel with a lumped capacitor C ee . This naturally forms a lowpass filter for the interface noise. As a result, the induced noise from R ee at the input of the amplifier is Referring to the hypothesis that the amplifier input capacitance ( C i ) is sufficiently small, introducing negligible waveform distortion, the integrated noise by electrode interface satisfies Equation 5 suggests reducing electrode interface noise by increasing double layer capacitance ( C ee ). Without increasing the size of electrodes, carbon-nanotube (CNT) coating [20] can dramatically in-crease electrode surface area, thus, reducing the interface noise. Section 5 will compare conventional electrodes and CNT coated electrodes from a noise point of view.
 In regions away from the interface boundary,  X  n i ( x ) = 0 results in a flattened noise spectrum. Here we use a lumped bulk resistance R b in series with the double-layer interface for modeling noise and  X  is a constant that relates to the electrode geometry. As given in [21],  X   X  0 . 5 for a plate electrode. 2.3 Electronic Noise Noise generated by electronics can be predicted by circuit design tools and validated through mea-surements. At the frequency of interest, there are two major components: thermal noise of transistors and flicker noise where N c.thermal is the circuit thermal noise, N c.flicker the flicker noise, g m the transconductance of the amplifier (  X  X  out / X  X  in ),  X  a circuit architecture dependent constant on the order of O (1) , K a process-dependent constant on the order of 10  X  25 V 2 F [16], C ox the transistor gate capacitance density, and W and L the transistor width and length respectively.
 Given a design schematic, circuit thermal noise can be reduced by increasing transconductance ( g m ), which is to the first order linear to bias current thus power consumption. Flicker noise can be reduced using design techniques such as large size input transistors and chopper modulations [22]. By using advanced semiconductor technologies, also, power and area trade off to noise [16], and elegant de-sign techniques like chopper modulation, current feedback [23], the state-of-the-art low noise neural amplifier can provide less than 2  X V total noise [24]. Such design costs can be necessary and useful if electronics noise contributes significantly to the total noise. Otherwise, the over-designed noise specification may be used to trade off other specifications and potentially result in overall improved performance of the system. Section 5 will present experiments of evaluating noise contribution from different sources, which show that electronics are not the dominant noise source in our experiments. 2.4 Total Noise ( N c.thermal ), and flicker noise ( N c.flicker ). The noise spectrum is empirically fitted by where N 1 /f x and N 0 represent the frequency dependent and flat terms, respectively. Equation 8 describes a combination of both colored noise ( 1 /f x ) and broad band noise, which can be reduced by using noise removal techniques. Section 3 presents an adaptive filtering scheme used to optimally attenuate the broad band noise. Section 4 presents a noise shaping technique used to improve the differentiation between signals and noise within the passband. SNR is calculated by integrating both signal and noise spectrum. Intuitively, a passband, either too narrow or wide, introduces signal distortion or unwanted noise. Figure 5(b) plots the detected spikes passband. While a passband that only fits one spike template may introduce waveform distortion to spikes of other templates, a passband that covers every template will introduce more noise to spikes of every template. A possible solution is to adaptively assign a passband to each spike waveform such that each span will be just wide enough to cover the underlying waveform. This section presents the steps used in order to achieve this solution and includes spike detection, spectrum estimation, and filter generation. 3.1 Spike Detection In this work, spike detection is performed using a nonlinear energy operator (NEO) [25] that captures instantaneous high frequency and high magnitude activities. With a discrete time signal x i , i = ... 1 , 2 , 3 ... , NEO outputs The usefulness of NEO for spike detection can be explored by taking the expectation of Eq. 9 where R x is the auto correlation function, 4 T is the sampling interval, and P ( f, i ) is the estimated power spectrum density with window centered at sample x i . When the frequency of interest is much lower than the sampling frequency, 1  X  cos 2  X f X  is approximately 2  X  2 f 2  X  2 . This emphasizes the high frequency power spectrum. Because spikes are high frequency activities by definition, NEO outputs a larger score when spikes are present. An example of NEO based spike detection is shown in Figure 4, where NEO improves the separation between spikes and the background activity. Figure 3: Spike sequence and its corresponding NEO output. (a) Raw sequence of one channel. (b) The corresponding NEO output of the raw sequence in (a). 3.2 Corner Frequency Estimation Spectrum estimation of individual spikes is performed to select a corresponding bandpass filter that balances the spectrum distortion and noise. Knowing its ability to separate bandlimited signals from broad band noise, a Weiner filter [26] is used here to size the signal passband. In the frequency domain, denoting P XX and P NN as the signal and noise spectra, Weiner filter is Implementing a precise Weiner filter for each detected spike requires considerable computation, as well as a reliable estimation of the signal spectrum. In this work, we are interested in using one of a series of prepared bandpass filters H i ( i = 1 , 2 ...n ) that better matches the solved  X  X ptimal X  Weiner filter subjected to The adaptive scheme presented in Section 3 tacitly assigns a matched frequency mask to individual spikes and balances noise and spectrum integrity. The remaining noise exhibits 1 /f x frequency dependency according to Section 2. In this section, we focus on noise shaping techniques to further distinguish signal from noise.
 The fundamentals of noise shaping are straightforward. Instead of equally amplifying the spectrum, a noise shaping filter allocates more weight to high SNR regions while reducing weight at low SNR regions. This results in an increased ratio of the integrated signal power over the noise power. In general, there are a variety of noise shaping filters that can improve the integrated SNR [10]. In this work, we use a series of fractional derivative operation for noise shaping where h ( x ) is a general function, p is a positive number (can be integer or non-integer) that adjusts the degree of noise shaping; the larger the p , the more emphasis on high frequency spectrum. In Z domain, the realization of fractional derivative operation can be done using binomial series [27]
H ( z ) = (1  X  z  X  1 ) p = where h ( n ) are the fractional derivative filter coefficients that converge to zero.
 The SNR gain in applying a fractional derivative filter H ( f ) is Figure 4: In vivo recording for identifying noise sources. (a) 5-minute recording segment capturing the decay of background activities. (b) Traces of the estimated noise vs. time are plotted. Black  X  curve represents the noise recorded from a custom tungsten electrode; red N curve represents the noise recorded from a CNT coated electrodes with the same size. (c), (d) Noise power spectrums es-timated at the 0, 15 , 30 , 45 minutes after the drug injection. In (c) a conventional tungsten electrode is used. In (d), a CNT coated tungsten electrode of equal size is used for comparison. where I spike ( f ) and I noise ( f ) are power spectrums of spike and noise respectively. Numeric values of SNR gain depend on both data and p (the degree of noise shaping). In our experiments, we empirically choose p in a range of 0 . 5 to 2 . 5 , where numerically calculated SNR gains using Eq. 15 of in vivo recordings are typically more than 3 dB, which is consistent with [10]. To verify the noise analysis presented in Section 2, an in vivo experiment is performed that uses two sharp tungsten electrodes separated by 125  X m to record the hippocampus neuronal activities of a rat. One of the electrodes is coated with carbon-nanotube (CNT), while the other is uncoated. After the electrodes have been placed, a euthanizing drug is injected. After 5 seconds of drug injection, results are summarized and presented in Figure 4. In Figure 4(a), a 5-minute segment that captures the decaying of background activities is plotted. In Figure 4(b), the estimated noise from 600 Hz to 6 KHz for both recording sites are plotted, where noise dramatically reduces ( &gt; 80% ) after the drug takes effect. Initially, the CNT electrode records a comparatively larger noise ( 697  X V 2 ) compared with the uncoated electrode ( 610  X V 2 ). After a few minutes, the background noise recorded by the CNT electrode quickly reduces eventually reaching 37  X V 2 that is about 1 / 3 of noise recorded by its counterpart ( 112  X V 2 ), suggesting the noise floor of using the uncoated tungsten electrode ( 112  X V 2 ) is set by the electrode. From these two plots, we can estimate that the neuron noise is around 500  X  600  X V 2 , electrode interface noise is  X  80  X V , while the sum of electronic noise and electrolyte bulk noise is less than 37  X V 2 (only  X  5% of the total noise). Figure 4(c) displays estimated at 0 , 15 , 30 , 45 minutes after drug injection). Figure 4(d) displays 1 /f x noise spectrum after drug injection). Figure 5: In vivo experiment of evaluating the proposed adaptive bandpass filter. (a) Detected spikes are aligned and superimposed. (b) Example waveforms that have distinguished widths are plotted. (c) Feature extraction results using PCA with a global bandpass filter ( 400 Hz to 5 KHz ) are displayed. (d) Feature extraction results using PCA with adaptive bandpass filters are displayed showing a much improved cluster isolation compared to (c).
 In the second experiment, 77 recordings of in vivo preparations are used to explore the stochas-tic distribution of 1 /f x noise spectrum.  X  x  X  is averaged at 1 . 5 with a standard deviation of 0 . 5 compare the feature extraction results produced by a global bandpass filter (conventional one) and the proposed adaptive bandpass filter, discussed in Section 3. In Figure 5(a), detected spikes are superimposed, where  X  X  thick waveform bundle X  is observed. In Figure 5(b), example waveforms in Figure 5(a) that have different widths are shown. Clearly, these waveforms have noticeably dif-ferent spectrum spans. In Figure 5(c), feature extraction results using PCA (a widely used feature extraction algorithm in spike sorting applications) with a global bandpass filter are displayed. As a comparison, feature extraction results using PCA with adaptive bandpass filters are displayed in Figure 5(d), where multiple clusters are differentiable in the feature space.
 In the fourth experiment, earth mover X  X  distance (EMD), as a cross-bin similarity measure that is robust to waveform misalignment [28], is applied to synthesized data for evaluation of the spike to be the spike waveform bundles from candidate neuron A and B . To estimate the spike variation of a candidate neuron, two waveforms are randomly picked from a same waveform bundle, and the distance between them is calculated using EMD. After repeating the procedure many times, the results are plotted as the black (waveforms from V A ) and blue (waveforms from V A ) traces in Figure 6. The x -axis indexes the trial and the y -axis is the EMD score. Black/blue traces describe the intra-cluster waveform variations of the two neurons under testing. To estimate the separation between candidate neuron A and B , we randomly pick two waveforms, one from V A and the other from V B , then compute the EMD between them. This procedure is repeated many times and the EMD vs. trial index is plotted as the red curve in Figure 6. Four pairs of candidate neurons are tested and shown in Figure 6(a)-(d). It can be observed from Figure 6 that the red curves are not well differentiated from the black/blue ones, which indicate that candidate neurons are not well separated. In Figure 6(e)-(h), we apply a similar procedure on the same four pairs of candidate neurons. The only difference from plots shown in Figure 6(a)-(d) is that the waveforms after noise shaping are used rather than their original counterparts. In Figure 6(e)-(h), the red curves separate from the black/blue traces, suggesting that the noise shaping filter improves waveform differentiations. In the fifth experiment, we apply different orders of noise shaping filters and the same feature extrac-tion algorithm to evaluate the feature extraction results. The noise shaping technique is developed as a general tool that can be incorporated into an unspecified feature extraction algorithm. Here, we use PCA as an example. In Figure 7, 8 figures in the same row are results of the same sequence. Figures from left to right display the feature extraction results with different orders of noise shaping; from 0 (no noise shaping) to 3 . 5 , and stepped by 0 . 5 . All the tests are obtained after adaptive band-Figure 6: EMD vs. trial index. Black and blue trace: EMDs for intra-cluster waveforms; red trace: EMDs for inter-cluster waveforms. (a)-(d) and (e)-(h) are results of 4 different pairs of neurons before and after noise shaping respectively. Traces in (a)-(d) and (e)-(h) have one-to-one correspon-dence. Noise level increases from (a) to (d). Figure 7: Feature extraction results using PCA with different orders of noise shaping. Each row represents a different sequence. Each column represents a different order of noise shaping ( p in dx p ), sweeping from 0 (without noise shaping) to 3.5 , stepped by 0.5. (a)-(h) are results of a synthesized sequence. (i)-(p) are results of an in vivo preparation. Clearly, (f) is better than (a); (m) is better than (i). pass filtering. The first sequence (a)-(h) is a synthesized one from public data base [2], the second sequence is recorded from an in vivo preparation. For both sequences, increased numbers of isolated clusters can be obtained by appropriately choosing the order of the noise shaping filter. In this paper, a study of multiple noise sources for in vivo neural recording is carried out. The dominant noise source is identified to be neuron noise followed by interface noise of the electrode. Overall, the noise exhibits a family of 1 /f x spectrum. The concept of adaptive bandpass filter is pro-posed to reduce noise because it maintains the signal spectrum integrity while maximally reducing the broad band noise. To reduce the noise within the signal passband and improve waveform sepa-ration, a series of fractional order differentiator based noise shaping filters are proposed. The pro-posed noise removal techniques are generally applicable to an unspecified spike sorting algorithm. Experiment results from in vivo preparations, synthesized sequences, and comparative recordings using both conventional and CNT coated electrodes are reported, which verify the noise model and demonstrate the usefulness of the proposed noise removal techniques.
