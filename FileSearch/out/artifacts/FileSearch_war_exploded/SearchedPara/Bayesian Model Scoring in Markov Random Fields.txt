 Bayesian approaches have become an important modeling paradigm in machine learning. They offer a very natural setting in which to address issues such as overfitting which plague standard maximum likelihood approaches. A full Bayesian approach has its computational challenges as it often involves intractable integrals. While for Bayesian networks many of these challenges have been met successfully[3], the situation is quite reverse for Markov random field models. In fact, it is very hard to find any literature at all on model order selection in general MRF models. The main reason for this discrepancy is the fact that MRF models have a normalization constant that depends of this term even prevents one to draw samples from the posterior distribution in most situations In terms of approximating the posterior some new methods have become available recently. In [7] a number of approximate MCMC samplers are proposed. Two of them were reported to be most successful: one based on Langevin sampling with approximate gradients given by contrastive di-vergence and one where the acceptance probability is approximated by replacing the log partition function with the Bethe free energy. Both these methods are very general, but inefficient. In [2] MCMC methods are explored for the Potts model based on the reversible jump formalism. To com-pute acceptance ratios for dimension-changing moves they need to estimate the partition function using a separate estimation procedure making it rather inefficient as well. In [6] and [8] MCMC methods are proposed that use perfect samples to circumvent the calculation of the partition func-tion altogether. This method is elegant but limited in its application due to the need to draw perfect samples. Moreover, two approaches that approximate the posterior by a Gaussian distribution are proposed in [11] (based on expectation propagation) and [13] (based on the Bethe-Laplace approxi-mation).
 In this paper we focus on a different problem, namely that of approximating the marginal likelihood. This quantity is at the heart of Bayesian analysis because it allows one to compare models of different structure. One can use it to either optimize or average over model structures. Even if one has an approximation to the posterior distribution it is not at all obvious how to use it to compute a good estimate for the marginal likelihood. The most direct approach is to use samples from the posterior and compute importance weights, where Q (  X  n | D ) denotes the approximate posterior. Unfortunately, this importance sampler suffers from very high variance when the number of parameters becomes large. It is not untypical that the estimate is effectively based on a single example.
 We propose to use the Laplace approximation, including all O (1) terms where the intractable quan-tities of interest are approximated by either belief propagation (BP) or the linear response theorem based on the solution of BP. We show empirically that the O (1) terms are indispensable for small N . Their inclusion can improve accuracy to up to two orders of magnitude. At the same time we observe that as a function of N , the O (1) -term based on the covariance between features deteriorates and should be omitted for large N . We conjecture that this phenomenon is explained by the fact that the calculation of the covariance between features, which is equal to the second derivative of the log-normalization constant, becomes instable if the bias in the MAP estimate of the parameters is of the order of the variance in the posterior. For any biased estimate of the parameters this phenomenon is therefore bound to happen as we increase N because the variance of the posterior distribution is expected to decrease with N .
 In summary we present a very accurate estimate for the marginal likelihood where it is most needed, evidence in undirected graphical models. Without loss of generality we represent a MRF as a log-linear model, where f ( x ) represent features. In the following we will assume that the random variables x are observed. Generalizations to models with hidden variables exist in theory but we defer the empirical evaluation of this case to future research.
 To score a structure we will follow the Bayesian paradigm and aim to compute the log-marginal likelihood log p ( D ) where D represents a dataset of size N , where p (  X  ) is some arbitrary prior on the parameters  X  .
 In order to approximate this quantity we employ two approximations. Firstly, we expand the both log-likelihood and log-prior around the MAP value  X  MP . For the log-likelihood this boils down to expanding the log-partition function, with  X   X  = (  X   X   X  MP ) and and where all averages are taken over p ( x |  X  MP ) .
 Similarly for the prior we find, where g is the first derivative of log p evaluated at  X  MP and H is the second derivative (or Hessian). The variables  X   X  represent fluctuations of the parameters around the MAP value  X  MP . The marginal likelihood can now be approximated by integrating out the fluctuations  X   X  , considering  X  MP as a hyper-parameter, Inserting the expansions eqns.4 and 6 into eqn.7 we arrive at the standard expression for the Laplace approximation applied to MRFs, log p ( D )  X  (8)
X with F the number of features.
 The difference with Laplace approximations for Bayesian networks is the fact that many terms in the expression above can not be evaluated. First of all, determining  X  MP requires running gradient ascent or iterative scaling to maximize the penalized log-likelihood which requires the computation function Z (  X  MP ) and the covariance matrix C which are both intractable quantities. 2.1 The BP-Linear Response Approximation To make further progress, we introduce a second layer of approximations based on belief propa-gation. In particular, we approximate the required marginals in the gradient for  X  MP with the ones obtained with BP. For fully observed MRFs the value for  X  MP will be very close to the solution ob-tained by pseudo-moment matching (PMM) [5]; the influence of the prior being the only difference between the two. Hence, we use  X  PMM to initialize gradient descent. The approximation incurred by PMM is not always small [10] in which case other approximations such as contrastive divergence may be substituted instead. The term  X  log Z (  X  MP ) will be approximated with the Bethe free en-ergy. This will involve running belief propagation on a model with parameters  X  MP and inserting the beliefs at their fixed points into the expression for the Bethe free energy [16].
 To compute the covariance matrix between the features C (eqn.5), we use the linear response al-gorithm of [15]. This approximation is based on the observation that C is the Hessian of the log-partition function w.r.t. the parameters. This is approximated by the Hessian of the Bethe free energy parameters.
 where  X  =  X  MP , p BP  X  is the marginal computed using belief propagation and x  X  is the collection of variables in the argument of feature f  X  (e.g. nodes or edges). This approximate C is also guaranteed to be symmetric and positive semi-definite. In [15] two algorithms were discussed to compute C in the linear response approximation, one based on a matrix inverse, the other a local propagation parameters  X   X  =  X   X   X  MP and keep track of first order terms in the belief propagation equations. One can show that the first order terms carry the information to compute the covariance matrix. We refer to [15] for more information. In appendix A we provide explicit equations for the case of Boltzman machines which is what is needed to reproduce the experiments in section 4. Perhaps the most practical class of undirected graphical models are the conditional random field (CRF) models. Here we jointly model labels t and input variables x . The most significant mod-ification relative to MRFs is that the normalization term now depends on the input variable. The probability of label given input is given as, To approximate the log marginal evidence we obtain an expression very similar to eqn.8 with the following replacement, where tional log-likelihood In the following experiments we probe the accuracy of the Bethe-Laplace(BP-LR) approximation. In these experiments we have focussed on comparing the value of the estimated log marginal like-lihood with  X  X nnealed importance sampling X  (AIS), which we treat as ground truth[9, 1]. We have focussed on this performance measure because the marginal likelihood is the relevant quantity for both Bayesian model averaging as well as model selection.
 We perform experiments on synthetic data as well as a real-world dataset. For the synthetic data, we use Boltzman machine models (binary undirected graphical models with pairwise interactions) implementation of the linear response approximation is straightforward in this case (see appendix A). Figure 2: Mean difference in scores with AIS (synthetic data). Error-bars are too small to see. Scores computed using the proposed method (BP-LR) were compared against MAP scores (or pe-nalized log-likelihood) where we retain only the first three terms in equation (8) and the commonly used BIC-ML scores where we ignore all O (1) terms (i.e retain only terms 1 , 2 and 5 ). BIC-ML uses the maximum likelihood value  X  ML instead of  X  MP . We also evaluate two other scores -BP-LR-ExactGrad where we use exact gradients to compute the  X  MP and Laplace-Exact which is same as BP-LR-ExactGrad but with C computed exactly as well. Note that these last two methods are practical only for models with small tree-width. Nevertheless they are useful here to illustrate the effect of the bias from BP. 4.1 Synthetic Data We generated 50 different random structures on 5 nodes. For each we sample 6 different sets of samples from each of these (50  X  6) models using exact sampling by exhaustive enumeration. In the first experiment we picked a random dataset/model with d = 0 . 5 4 (the true structure had 6 edges) and studied the variation of different scores with model complexity. We define an ordering on models based on complexity by using nested model sequences. These are such that a model appearing later in the sequence contains all edges from models appearing earlier. Figure (1) shows the results for two such random nested sequences around the true model, for the number of datacases N = 50 and N = 10000 respectively. The error-bars for AIS are over 10 parallel annealing runs which we see are very small. We repeated the plots for multiple such model sequences and the results were similar. Figure (2) shows the average absolute difference of each score with the AIS score over 50 sequences. From these one can see that BP-LR is very accurate at low N . As known in the literature, BIC-ML tends to over-penalize model complexity. At large N , the performance of all methods improve but BP-LR does slightly worse than the BIC-ML.
 In order to better understand the performance of various scores with N , we took the datasets at d = 0 . 5 4 and computed scores at various values of N . At each value, we find the absolute difference in the score assigned to the true structure with the corresponding AIS score. These are then averaged over the 50 datasets. The results are shown in figure (3). We note that all BP-LR methods are about two orders of magnitude more accurate than methods that ignore the O (1) term based on C . However, as we increase N , BP-LR based on  X  MP computed using BP significantly deteriorates. This does not happen with both BP-LR methods based on  X  MP computed using exact gradients (i.e. BP-LR-ExactGrad and Laplace-Exact). Since the latter two methods perform identically, we conclude that it is not the approximation of C by linear response that breaks down, but rather that the bias in  X 
MP is the reason that the estimate of C becomes unreliable. We conjecture that this happens when
Figure 3: Variation of score accuracy with N constant but the variance in the posterior decreases as O (1 /N ) this phenomenon is bound to happen for some value of N .
 Finally since our BP-LR method relies on the BP approximation which is known to break down at strong interactions, we investigated the performance of various scores with d . Again at each value of d we compute the average absolute difference in the scores assigned to the true structure by a method and AIS. We use N = 10000 to keep the effect of N minimal. Results are shown in figure (4). As expected all BP based methods deteriorate with increasing d . The exact methods show that one can improve performance by having a more accurate estimate of  X  MP . 4.2 Real-world Data To see the performance of the BP-LR on real world data, we implemented a linear chain CRF on the  X  X ewsgroup FAQ dataset X  2 [4]. This dataset contains 48 files where each line can be either a header, a question or an answer. The problem is binarized by only retaining the question/answer lines. For where i denotes the line in a document and a indexes the 24 features.
 We generated a random sequence of models by incrementally adding some state features and then some transition features. We then score each model using MAP, BIC-MAP (which is same as BIC-ML but with  X  MP ), AIS and Laplace-Exact. Note that since the graph is a chain, BP-LR is equivalent to BP-LR-ExactGrad and Laplace-Exact. We use N = 2 files each truncated to 100 lines. The results are shown in figure (5). Here again, the Laplace-Exact agrees very closely with AIS compared to the other two methods. (Another less relevant observation is that the scores flatten out around the point where we stop adding the state features showing their importance compared to transition features). The main conclusion from this study is that the Bethe-Laplace approximation can give an excellent nomenon, namely that as N grows the error in the O (1) term based on the covariance between features increases . We found that this term can give an enormous boost in accuracy for small N (up to two orders of magnitude), but its effect can be detrimental for large N . We conjecture that this switch-over point takes place when the bias in  X  MP becomes of the order of the standard deviation in the posterior (which decreases as 1 /N ). At that point the second derivative of the log-likelihood in the Taylor expansion becomes unreliable.
 There are a number of ways to improve the accuracy of approximation. One approach is to use higher order Kikuchi approximations to replace the Bethe approximation. Linear response results are also available for this case [12]. A second improvement could come from improving the estimate of  X 
MP using alternative learning techniques such as contrastive divergence or alternative sample-based approaches. As discussed above, less bias in  X  MP will make the covariance term useful for larger N . techniques proposed in this paper to hidden variables in theory, but we haven X  X  run the experiments necessary to make claims about its performance. This, we leave for future study.
 Moreover, we X  X l define the following independent quantities q i = p ( x i = 1) and  X  ij = p ( x i = In the following we will assume that { q i ,  X  ij } are computed using belief propagation (BP). At the fixed points of BP the following relations hold [14], w ij = log of node i .
 " This material is based upon work supported by the National Science Foundation under Grant No. 0447903.
 [1] M.J. Beal and Z. Ghahramani. The variational bayesian EM algorithm for incomplete data: [2] P. Green and S. Richardson. Hidden markov models and disease mapping. Journal of the [3] D. Heckerman. A tutorial on learning with bayesian networks. pages 301 X 354, 1999. [4] A. McCallum and D. Freitag F. Pereira. Maximum entropy Markov models for information [5] T.S. Jaakkola M.J. Wainwright and A.S. Willsky. Tree-reweighted belief propagation algo-[6] J. M X ller, A. Pettitt, K. Berthelsen, and R. Reeves. An efficient Markov chain Monte Carlo [7] I. Murray and Z. Ghahramani. Bayesian learning in undirected graphical models: approximate [8] I. Murray, Z. Ghahramani, and D.J.C. MacKay. Mcmc for doubly-intractable distributions. In [9] R.M. Neal. Annealed importance sampling. In Statistics and Computing , pages 125 X 139, [10] S. Parise and M. Welling. Learning in markov random fields: An empirical study. In Proc. of [11] Y. Qi, M. Szummer, and T.P. Minka. Bayesian conditional random fields. In Artificial Intelli-[12] K. Tanaka. Probabilistic inference by means of cluster variation method and linear response [13] M. Welling and S. Parise. Bayesian random fields: The Bethe-Laplace approximation. In UAI , [14] M. Welling and Y.W. Teh. Approximate inference in boltzmann machines. Artificial Intelli-[15] M. Welling and Y.W. Teh. Linear response algorithms for approximate inference in graphical [16] J.S. Yedidia, W. Freeman, and Y. Weiss. Constructing free energy approximations and gen-
