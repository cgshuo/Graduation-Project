 Eric Xing y epxing@cs.berkeley.edu Roded Sharan y roded@icsi.berkeley.edu Michael I. Jordan y ] jord an@cs.berkeley.edu The availabilit y of a nearly complete human genome sequence mak es it possible to begin to explore individ-ual di erences between DNA sequences on a genome-wide scale, and to searc h for asso ciations of suc h genot ypic variation with disease and other pheno-types (Risc h, 2000). The largest class of individual di erences in DNA are the single nucle otide polymor-phisms (SNPs) . Millions of SNPs have been detected thus far out of an estimated total of ten million com-mon SNPs (Sac hidanandam et al., 2001).
 A SNP commonly has two varian ts, or alleles , in the population, corresp onding to two speci c nucleotides chosen from f A; C; G; T g . A haplotyp e is a list of al-leles at con tiguous sites in a local region of a single chromosome. Assuming no recom bination in this local region, a haplot ype is inherited as a unit. Recall that for diploid organisms (suc h as humans) the chromo-somes come in pairs. Thus two haplot ypes go together to mak e up a genotyp e , whic h is the list of unor dered pairs of alleles in a region. That is, a genot ype is obtained from a pair of haplot ypes by omitting the speci cation of the asso ciation of eac h allele with one of the two chromosomes|its phase . Common biolog-ical metho ds for assa ying genot ypes typically do not pro vide phase information; phase can be obtained at a considerably higher cost (Patil et al., 2001). It is desir-able to dev elop automatic metho ds for inferring haplo-types from genot ypes and possibly other data sources (e.g., pedigrees). With a set of inferred haplot ypes in hand, asso ciations to disease can be explored. From the point of view of population genetics, the ba-sic mo del underlying the haplot ype inference problem is a nite mixture mo del. That is, letting H denote the set of all possible haplot ypes asso ciated with a given region (a set of cardinalit y 2 k in the case of binary polymorphisms, where k is the num ber of heterozy-gous SNPs), the probabilit y of a genot ype is given by: where I ( h 1 h 2 = g ) is the indicator function of the event that haplot ypes h 1 and h 2 are consisten t with g . Under the assumption of Hardy-W einberg equilibrium (HWE), an assumption that is standard in the litera-ture and will also be made here, the mixing prop ortion p ( h 1 ; h 2 ) is assumed to factor as p ( h 1 ) p ( h 2 Giv en this basic statistical structure, the simplest metho dology for haplot ype inference is maxim um like-liho od via the EM algorithm, treating the haplot ype iden tities as laten t variables and estimating the param-eters p ( h ) (Excoer &amp; Slatkin, 1995). This metho dol-ogy has rather sev ere computational requiremen ts, in that a probabilit y distribution must be main tained on the (large) set of possible haplot ypes, but even more fundamen tally it fails to capture the notion that small sets of haplot ypes should be preferred. This notion deriv es from an underlying assumption that for rela-tively short regions of the chromosome there is limited diversit y due to population bottlenec ks and relativ ely low rates of recom bination and mutation.
 One approac h to dealing with this issue is to form ulate a notion of \parsimon y," and to dev elop algorithms that directly attempt to maximize parsimon y. Sev-eral imp ortan t pap ers have tak en this approac h (Clark et al., 1998; Gus eld, 2002; Eskin et al., 2003) and have yielded new insigh ts and algorithms. Another ap-proac h is to elab orate the probabilistic mo del, in par-ticular by incorp orating priors on the parameters. Dif-feren t priors have been discussed by di eren t authors, ranging from simple Diric hlet priors (Niu et al., 2002) to priors based on the coalescen t pro cess (Stephens et al., 2001) to priors that capture asp ects of recom-bination (Greenspan &amp; Geiger, 2003). These mo dels pro vide implicit notions of parsimon y, via the implicit \Oc kham factor" of the Bayesian formalism.
 We also tak e a Bayesian statistical approac h in the curren t pap er, but we attempt to pro vide more ex-plicit con trol over the num ber of inferred haplot ypes than has been pro vided by the statistical metho ds pro-posed thus far, and the resulting inference algorithm has commonalities with the parsimon y-based schemes. Our approac h is based on a nonparametric prior kno wn as the Dirichlet process (Ferguson, 1973). In the set-ting of nite mixture mo dels, the Diric hlet pro cess| not to be confused with the Diric hlet distribution|is able to capture uncertain ty about the num ber of mix-ture comp onen ts (Escobar &amp; West, 2002). The basic setup can be explained in terms of an urn mo del, and a pro cess that pro ceeds through data sequen tially . Con-sider an urn whic h at the outset con tains a ball of a single color. At eac h step we either dra w a ball from the urn, and replace it with two balls of the same color, or we are given a ball of a new color whic h we place in the urn, with a parameter de ning the probabilities of these two possibilities. The asso ciation of data points to colors de nes a \clustering" of the data.
 To mak e the link with Bayesian mixture mo dels, we asso ciate with eac h color a dra w from the distribution de ning the parameters of the mixture comp onen ts. This pro cess de nes a prior distribution for a mixture mo del with a random num ber of comp onen ts. Multi-plying this prior by a likeliho od yields a posterior dis-tribution . Mark ov chain Mon te Carlo algorithms have been dev elop ed to sample from the posterior distribu-tions asso ciated with Diric hlet pro cess priors (Escobar &amp; West, 2002; Neal, 2000).
 The usefulness of this framew ork for the haplot ype problem should be clear|using a Diric hlet pro cess prior we in essence main tain a pool of haplot ype candi-dates that gro ws as observ ed genot ypes are pro cessed. The gro wth is con trolled via a parameter in the prior distribution that corresp onds to the choice of a new color in the urn mo del, and via the likeliho od, whic h assesses the matc h of the new genot ype to the available haplot ypes.
 To expand on this latter point, an adv antage of the probabilistic formalism is its abilit y to elab orate the observ ation mo del for the genot ypes to include the possibilit y of errors. In particular, the indicator func-tion I ( h 1 h 2 = g ) in Eq. (1) is susp ect|there are man y reasons why an individual genot ype may not matc h with a curren t pool of haplot ypes, suc h as the possibilit y of mutation or recom bination in the meio-sis for that individual, and errors in the genot yping or data recording pro cess. Suc h sources of small dif-ferences should not lead to the inference pro cedure spa wning new haplot ypes.
 In the curren t pap er we presen t a statistical mo del for haplot ype inference based on a Diric hlet pro cess prior and a likeliho od that includes error mo dels for geno-types. We describ e a Mark ov chain Mon te Carlo pro ce-dure, in particular a pro cedure that mak es use of both Gibbs and Metrop olis-Hasting updates, for posterior inference. We presen t results of applying our metho d to the analysis of both sim ulated and real genot ype data, comparing to the state-of-the-art PHASE algo-rithm (Stephens et al., 2001). The input to a phasing algorithm can be represen ted as a genotyp e matrix G with columns corresp onding to SNPs in their order along the chromosome and rows corresp onding to genot yped individuals. G i;j repre-sen ts the information on the two alleles of the i -th individual for SNP j . We denote the two alleles of a SNP by 0 and 1, and G i;j can tak e on one of four val-ues: 0 or 1, indicating a homozygous site; 2, indicating a heterozygous site; and ' ?', indicating missing data. 1 We will describ e our mo del in terms of a pool of ances-tral haplot ypes, or templates , from whic h eac h popula-tion haplot ype originates (Greenspan &amp; Geiger, 2003). The haplot ype itself may undergo point mutation with resp ect to its template. The size of the pool and its comp osition are both unkno wn, and are treated as ran-dom variables under a Diric hlet pro cess prior. We be-gin by pro viding a brief description of the Diric hlet pro cess and subsequen tly sho w how this pro cess can be incorp orated into a mo del for haplot ype inference. 2.1. Diric hlet process mixtures Rather than presen t the Diric hlet pro cess in full gener-alit y, we focus on the speci c setting of mixture mo d-els, and mak e use of an urn mo del to presen t the essen-tial features of the pro cess. For a fuller presen tation, see, e.g., Ishwaran and James (2001). We assume that data x arise from a mixture distribution with mixture comp onen ts p ( x j ). We assume the existence of a base measur e G ( ), whic h is one of the two parameters of the Diric hlet pro cess. (The other is the parameter , whic h we presen t below). The parameter G ( ) is not the prior for , but is used to generate a prior for , in the manner that we now discuss.
 Consider the follo wing pro cess for generating samples f x 1 ; x 2 ; : : : ; x n g from a mixture mo del consisting of an unsp eci ed num ber of mixture comp onen ts, or equiv-alenc e classes : { The equiv alence class of sample i , c i , is dra wn p ( c i = c j for some j &lt; i j c 1 ; : : : ; c i 1 ) = p ( c i 6 = c j for all j &lt; i j c 1 ; : : : ; c i 1 ) = { The parameter c i asso ciated with the mixture Eqs. (2) and (3) de ne a conditional prior for the equiv alence class indicator c i of eac h sample during a sequen tial sampling pro cess. They imply a self-reinforcing prop erty for the choice of equiv alence class of eac h new sample|previously populated classes are more likely to be chosen.
 It is imp ortan t to emphasize that the pro cess that we have discussed will be used as a prior distribution . We now embed this prior in a full mo del that includes a likeliho od for the observ ed data. In Section 3 we de-velop Mark ov chain Mon te Carlo inference pro cedures for this mo del. 2.2. The model We presen t a probabilistic mo del for the generation of haplot ypes in a population and for the generation of genot ypes from these haplot ypes. We assume that eac h individual's genot ype is formed by dra wing two random templates from an ancestral pool, and that these templates are sub ject to random perturbation. To mo del suc h perturbations we assume that eac h lo-cus is mutated indep enden tly from its ancestral state with the same error rate. Finally , we assume that we are given noisy observ ations of the resulting genot ypes. The mo del is displa yed as a graphical mo del in Fig-ure 1.
 Let J be an ordered list of loci of interest. For eac h individual i , we denote his/her paternal haplo-type by H i type by H i of ancestral templates as A = f A 1 ; A 2 ; : : : g , where A k := [ A k; 1 ; : : : ; A k;J ] is a particular mem ber of this set.
 In our framew ork, the probabilit y distribution of the haplot ype variable H i f 0 ; 1 g indexes paternal or maternal origin, is mo d-eled by a mixture mo del with an unsp eci ed num-ber of mixture comp onen ts, eac h corresp onding to an equiv alence class asso ciated with a particular ances-tor. For eac h individual i , we de ne the equiv alence class variables C i nal haplot ypes, resp ectiv ely, to specify the ancestral origin of the corresp onding haplot ype. The C i the random variables corresp onding to the equiv alence classes of the Diric hlet pro cess. The base measure G of the Diric hlet pro cess is a join t measure on ances-tral haplot ypes A and mutation parameters , where the latter captures the probabilit y that an allele at a locus is iden tical to the ancestor at this locus. We let G ( A; ) = p ( A ) p ( ), and we assume that p ( A ) is a uniform distribution over all possible haplot ypes. We let p ( ) be a beta distribution, Beta ( h ; h ), and we choose a small value for h = ( h + h ), corresp onding to a prior exp ectation of a low mutation rate. Giv en C i tional probabilit y of the corresp onding haplot ype in-stance h := [ h 1 ; : : : ; h J ] to be: where p ( h j j a j ; ) is the probabilit y of having allele h at locus j given its ancestor. Eq. (4) assumes that eac h locus is mutated indep enden tly with the same error rate. For haplot ypes, H i a set B of alleles. We use the follo wing single-lo cus mutation model : where I ( ) is the indicator function.
 The join t conditional distribution of haplot ype in-stances h = f h i and parameter instances = f 1 ; : : : ; K g , given the ancestor indicator c of haplot ype instances and the set of ancestors a = f a 1 ; : : : ; a K g , can be written explicitly as: p ( h ; j c ; a ) / Y where m k = P j P i P t I ( h i num ber of alleles that were not mutated with resp ect to the ancestral allele, and m 0 k = P j P i P t I ( h i a k;j ) I ( c i t = k ) is the num ber of mutated alleles. The coun t m k = f m k ; m 0 k g is a sucien t statistic for the parameter k and the coun t m = f m k ; m 0 k g is a suf-cien t statistic for the parameter . The marginal conditional distribution of haplot ype instances can be obtained by integrating out in Eq. (6): p ( h j c ; a ) = Y where ( ) is the gamma function, and R ( h ; h ) = ( h ) ( h ) is the normalization constan t asso ciated with Beta ( h ; h ). (For simplicit y, we use the abbre-viation R h for R ( h ; h ) in the sequel).
 We now introduce a noisy observation model for the genot ypes. We let G i = [ G i; 1 ; : : : ; G i;J ] denote the joint genotyp e of individual i at loci [1 ; : : : ; J ], where eac h G i;j denotes the genot ype at locus j . We assume that the observ ed genot ype at a locus is determined by the paternal and maternal alleles of this locus as follo ws: where h i;j , h i of two actual SNP allele instances at locus j ; \ 1 6 =" de-notes set di erence by exactly one elemen t (i.e., the observ ed genot ype is heterozygous, while the true one is homozygous); \ 2 6 =" denotes set di erence of both el-emen ts (i.e., the observ ed and true genot ypes are dif-feren t and both are homozygous); and 1 and 2 are appropriately de ned normalizing constan ts. We place a beta prior Beta ( g ; g ) on . Assuming indep enden t and iden tical error mo dels for eac h locus, the join t con-ditional probabilit y of the entire genot ype observ ation g = f g i : i 2 f 1 ; 2 ; : : : ; I gg and parameter , given all haplot ype instances is: p ( g ; j h ) = Y where the sucien t statistics u = f u; u 0 ; u 00 g are com-puted as u = P i;j I ( h i;j = g i;j ), u 0 = P i;j I ( h g that u + u 0 + u 00 = IJ . To re ect an assumption that the observ ational error rate is low we set g = ( g + g ) to a small constan t (0.001). Again, the marginal con-ditional distribution of g is computed by integrating out .
 Having describ ed our Bayesian haplot ype mo del, the problem of phasing individual haplot ypes and estimat-ing the size and con guration of the laten t ancestral pool can be solv ed via posterior inference given the genot ype data. In this section, we describ e a Gibbs sampling algo-rithm for exploring the posterior distribution under our mo del, including the laten t ancestral pool. We also presen t a Metrop olis-Hastings varian t of this al-gorithm that app ears to mix better in practice. 3.1. A Gibbs sampling algorithm The Gibbs sampler dra ws samples of eac h random vari-able from a conditional distribution of the variable to be sampled given (previously sampled) values of all the remaining variables of the mo del. The variables needed in our algorithm are: c i cestral template of a haplot ype instance t of individual i ; a k;j , the allele pattern at the j -th locus of the k -th ancestral template; h i the j -th locus of individual i ; and g i;j , the genot ype at locus j of individual i (the only observ ed variables in the mo del). All other variables in the mo del| and |are integrated out. The Gibbs sampler thus samples the values of c i Conceptually , the Gibbs sampler alternates between two coupled stages. First, given the curren t values of the hidden haplot ypes, we sample the c i quen tly a k;j , whic h are asso ciated with the Diric hlet pro cess prior. Second, given the curren t state of the ancestral pool and the ancestral template assignmen t for eac h individual, we sample the h j;i basic haplot ype mo del.
 In the rst stage, the conditional distribution of c i p ( c ) = where [ i t ] denotes the set of indices excluding i t ; n equal to k ; n represen ts the total num ber of instances sampled so far; and m [ i statistics asso ciated with all haplot ype instances orig-inating from ancestor k , except h i simply Bayes theorem with p ( h i the role of the likeliho od and p ( c i the role of the prior. The likeliho od p ( h i is obtained by integrating over the parameter k , as in Eq. (7).
 The conditional probabilit y for a newly prop osed equiv alence class k that is not populated by any previ-ous samples requires a summation over all possible an-cestors: p ( h i function does not factorize over loci, computing this summation tak es time that is exp onen tial in the num-ber of loci. To skirt this problem we endo w eac h locus with its own mutation parameter k;j , with all parame-ters admitting the same prior Beta ( h ; h ). This gives rise to a closed-form form ula for the summation and also for the normalization constan t in Eq. (9). It is also, arguably , a more accurate re ection of realit y. Now we need to sample the ancestor template a k , where k is the newly sampled ancestor index for c i When k is not equal to any other existing index c i 0 a value for a k needs to be chosen from p ( A j h i posterior distribution of A based on the prior p ( A ) and the single dep enden t haplot ype h i hand, if k is an equiv alence class populated by previ-ous samples of c i 0 p ( A j h i template is no longer asso ciated with any haplot ype instance, we remo ve this template from the pool. The conditional distribution for this Gibbs step is there-fore: where m k;j (resp ectiv ely, m 0 k;j ) is the num ber of allelic instances originated from ancestor k at locus j that are iden tical to (resp ectiv ely, di eren t from) the ancestor, when the ancestor has the pattern a k;j .
 We now pro ceed to the second sampling stage, in whic h we sample the haplot ypes h i for all j; i; t , sequen tially according to the follo wing conditional distribution: p ( h i / p ( g i j h i = R g where [ ( i t ; j )] denotes the set of indices excluding ( i similarly for the other sucien t statistics). Note that during eac h sampling step, we do not have to recom-pute the ( ), because the sucien t statistics are either not going to change (e.g., when the newly sampled h i is the same as the old sample), or only going to change by one (e.g., when the newly sampled h i a change of the allele). In suc h cases the new gamma function can be easily updated from the old one. 3.2. A Metrop olis-Hasting sampling algorithm Note that for a long list of loci, a uniform p ( A ) of all possible ancestral template patterns will render the probabilit y of sampling a new ancestor in nitesimal, due to the small value of the smo othed marginal likeli-hood of any haplot ype pattern h i Eq. (9). This could result in slow mixing.
 An alternativ e sampling strategy is to use a par-tial Gibbs sampling strategy with the follo wing Metrop olis-Hasting updates. For the prop osal distri-bution for the equiv alence class of h i q ( c i Then we sample a c Eq. (10). For target distribution p ( c i the prop osal factor cancels when computing the accep-tance probabilit y , leaving: In practice, we found that the above mo di cation to the Gibbs sampling algorithm leads to substan-tial impro vemen t in eciency for long haplot ype lists, whereas for short lists, the Gibbs sampler remains bet-ter due to the high (100%) acceptance rate. We validated our algorithm by applying it to sim ulated and real data and compared its performance to that of the state-of-the-art PHASE algorithm (Stephens et al., 2001) and other curren t algorithms. We re-port on the results of both varian ts of our algo-rithm: The Gibbs sampler, denoted DP(Gibbs), and the Metrop olis-Hasting sampler, denoted DP(MH). Throughout the exp erimen ts, we set the hyperparam-eter in the Diric hlet pro cess to be roughly 1% of the population size, i.e., for a data set of 100 individuals, = 1. We used a burn-in of 2000 iterations (or 4000 for datasets with more than 50 individuals), and used the next 6000 iterations for estimation. 4.1. Simulated data In our rst set of exp erimen ts we applied our metho d to sim ulated data (\short sequence data") from Stephens et al. (2001). This data con tains sets of 2 n haplot ypes, randomly paired to form n genot ypes, under an in nite-sites mo del with parameters = 4 and R = 4 determining the mutation and recom bina-tion rates, resp ectiv ely. We used the rst 40 datasets for eac h com bination of individuals and sites, where the num ber of individuals ranged between 10 and 50, and the num ber of sites ranged between 5 and 30. To evaluate the performance of the algorithms we used the follo wing error measures: err s , the ratio of in-correctly phased SNP sites over all non-trivial het-erozygous SNPs (excluding individuals with a single heterozygous SNP); err i , the the ratio of incorrectly phased individuals over all non-trivial heterogeneous individuals; and d s , the switch distanc e , whic h is the num ber of phase ips required to correct the predicted haplot ypes over all non-trivial heterogeneous SNPs. The results are summarized in Table 1. Overall, we perform sligh tly worse than PHASE on the rst two measures, and sligh tly better on the switc h distance measure (whic h uses 100,000 sampling steps). Both al-gorithms pro vide a substan tial impro vemen t over EM. 4.2. Real data We applied our algorithm to two real datasets and compared its performance to that of PHASE (Stephens et al., 2001) and other algorithms.
 The rst dataset con tains the genot ypes of 129 indi-viduals over 103 polymorphic sites (Daly et al., 2001). In addition it con tains the genot ypes of the paren ts of eac h individual, whic h allo ws the inference of a large portion of the haplot ypes as in Eskin et al. (2003). The results are summarized in Table 2. It is appar-ent that the Metrop olis-Hasting sampling algorithm signi can tly outp erforms the Gibbs sampler, and is to be preferred given the relativ ely limited num ber of sampling steps ( 6000). The overall performance is comparable to that of PHASE and better than both HAP (Halp erin &amp; Eskin, 2002; Eskin et al., 2003) and HAPLOTYPER (Niu et al., 2002).
 It is imp ortan t to emphasize that our metho ds also pro vide a posteriori estimates of the ancestral pool of haplot ype templates and their frequencies. We omit a listing of these haplot ypes, but pro vide an illustrativ e summary of the evolution of these estimates during sampling (Figure 2).
 The second dataset con tains genot ype data from four populations, 90 individuals eac h, across sev eral ge-nomic regions (Gabriel et al., 2002). We focused on the Yoruban population (D), whic h con tains 30 trios of genot ypes (allo wing us to infer most of the true haplot ypes) and analyzed the genot ypes of 28 individ-uals over four medium-sized regions (see below). The results are summarized in Table 3. All metho ds yield higher error rates on these data, compared to the anal-ysis of the data of Daly et al. (2001), presumably due to the low sample size. In this setting, over all but one of the four regions, our algorithm outp erformed PHASE for all three types of error measures. A pre-liminary analysis suggests that our performance gain may be due to the bias toward parsimon y induced by the Diric hlet pro cess prior. We found that the num-ber of template haplot ypes in our algorithm is typically small, whereas in PHASE, the haplot ype pool can be very large (i.e., region 7b has 83 haplot ypes, compared to 10 templates in our case and 28 individuals overall). We have prop osed a Bayesian approac h to the mo del-ing of genot ypes based on a Diric hlet pro cess prior. We have sho wn that the Diric hlet pro cess pro vides a nat-ural represen tation of uncertain ty regarding the size and comp osition of the pool of haplot ypes underly-ing a population. Using Mark ov chain Mon te Carlo algorithms, we have sho wn that this mo del leads to e ectiv e inference pro cedures for inferring the ances-tral pool and for haplot ype phasing based on a set of genot ypes. The mo del accommo dates gro wing data collections and noisy and/or incomplete observ ations. The approac h also naturally imp oses an implicit bias toward small ancestral pools during inference, reminis-cen t of parsimon y metho ds, doing so in a well-founded statistical framew ork that permits errors.
 Our focus here has been on adapting the technology of the Diric hlet pro cess in the setting of the standard haplot ype phasing problem. But an imp ortan t un-derlying motiv ation for our work, and a general mo-tivation for pursuing probabilistic approac hes to ge-nomic inference problems, is the poten tial value of our mo del as a building blo ck for more expressiv e mo dels. In particular, as in Greenspan and Geiger (2003) and Lauritzen and Sheehan (2002), the graph-ical mo del formalism naturally accommo dates various extensions, suc h as segmen tation of chromosomes into haplot ype blo cks and the inclusion of pedigree rela-tionships. The Diric hlet pro cess parameterization also pro vides a natural upgrade path for the consideration of richer mo dels; in particular, it is possible to incorp o-rate more elab orate base measures G into the Diric h-let pro cess framew ork|the coalescence-based distri-bution of Stephens et al. (2001) would be an interest-ing choice.
 This researc h was supp orted in part by NSF ITR Gran t CCR-0121555.

