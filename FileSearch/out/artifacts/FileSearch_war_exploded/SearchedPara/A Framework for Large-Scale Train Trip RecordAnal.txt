 Daisaku Yokoyama 1 , Masahiko Itoh 1 , Masashi Toyoda 1 , Yoshimitsu Tomita 2 , Public transportation systems play an important role in urban areas, and efficient and comfortable transportation is highly demanded, especially in megacities such as Tokyo. Tokyo has one of the most complex train systems in the world, so a major disruptive event can cause congestion and disruption over a wide area. The effect of such events is hard to predic t, even for the operating companies.
Our goal is to implement the ability to analyze and predict passenger behav-iors in a complex transportation system. In particular, we want to implement a system for understanding daily passenger flows and event-driven passenger behaviors, suggesting itineraries, and preparing for events.
 Understanding Daily Passenger Flows. Operating companies want to know Understanding Event-Driven Passenger Behaviors. Events, such as nat-Suggesting Itineraries. If passenger flows could be observed in real time and Preparing for Disruptive Events. Although operating companies already
Our contribution of this paper is as follows: 1. We propose a framework for analyzing large-scale train trip records as the 2. We propose a method to predict how pa ssengers behave after an accident. 3. We evaluate the accuracy and effectiv eness of the proposed method by com-
We describe related work in Section 2 and explain our goal of passenger flow analysis and our developed framework for large-scale trip record analysis in Sec-tion 3. Our method for predicting passenger behavior after an accident is ex-plained in Section 4. In Section 5, we eva luate the accuracy and usefulness of the proposed method on the basis of our analysis of smart card data related to two major accidents. Section 6 summari zes the key points and mentions future work. Transportation log data, including data from operation logs, smart card logs, and equipment monitoring logs has been analyzed in various studies. Ushida et al. used train operation data to visualize and identify delay events and created chromatic diagrams for one line in the Tokyo Metro subway system with the goal of generating a more robust (delay-resistant) timetable [7]. Smart card data has been used as a data source to analyze the operation of a public transportation system [4]. Tr  X  epanier et al. used an alighting point estimation model to analyze passenger behavior from incomplete trip records created from smart card data[6]. Ceapa et al. used oyster (smart card) dat a to clarify passenger flow congestion patterns at several stations in the London Tube system for use in reducing congestion [1]. Their spatio-temporal analysis revealed highly regular congestion patterns during weekdays with large spikes occurring in short time intervals. Sun et al. provided a model for predicting the spatio-temporal density of passengers and applied it to one line in the Singapore railway system [5].

Previous work using smart card data focused only on a single line or a few stations, mainly because the trip records created from the data did not include transfer station information. We overcame this limitation by determining the most probable transfer station(s) for each trip record created from the origin and destination information and were thus better able to analyze how the effects of a disruptive event in a metro network propagate. The system we are constructing for analyzing train trip records currently uses data collected each night rather tha n in real time. Our immediate aim is to evaluate the effectiveness of our approach by analyzing historical data. 3.1 System Overview Entrance and exit information is obtained each time a passenger uses a smart card to enter or exit a station gate (wicket). This information is aggregated on a central server each night. Our system can be used to analyze this information.
The system creates a trip route (start point, transfer points, and end point) for each record and estimates the passe nger flows  X  how many passengers trav-eled a certain section at a certain time (as explained in detail in Section 3.3). By analyzing these flows, we can identify disruptive events resulting from vari-ous causes. Our interactive visualization framework can be used to identify and understand such events (as explained in Section 3.4).

Our method for predicting passenger behavior after an accident uses a pas-senger demand model and a passenger behavior model, which describes the ef-fects of an accident (as described in Sect ions 4.1 and 4.2). Using these models and current traffic condition information, we can predict short-term passenger behavior.

We plan to make a passenger flow simulator that uses the behavior model. We also plan to combine real-time observation data with simulation data to make the predictions more accurate. 3.2 Smart Card Data We used two years X  worth of trip records for the Tokyo Metro subway system cre-ated from smart card data. As shown in Figure 1, the train system in Tokyo has a complicated route structure, consisting of lines of various railway companies including Tokyo Metro, Toei Subway, Japan Railway (JR), and many private railroads. We analyzed the Tokyo Metro trip records for almost all of the Tokyo business area, covering 28 lines, 540 stations, and about 300 million trips. The records included lines and stations bes ides Tokyo Metro ones if passengers used lines of other railway companies for transfers.

In our experiments, we use passengers log data from anonymous smartcards without personal identity information, such as, name, address, age, and gender. From each record, card ID is eliminated . Each record consisted of the origin, destination, and exit time. Since transfer information was not included, we esti-mated the probable route for each trip (as explained in Section 3.3).
During the week, the trains are mainly used by people going to or return-ing home from work while they are used more generally on weekends. We thus separated the data between weekdays and weekends and analyzed the two sets independently. National holidays and several days during vacation seasons were treated as weekend days.

Passenger behavior was assumed to follow periodic patterns, especially daily ones, so we statistically analyzed these data to identify the patterns. Figure 2 shows the average and standard deviation of the number of passengers over one year. The plot points were obtained by estimating the total trip time for each trip record (as described in Section 3.3) and then determining the number of passengers who were travelling during each 10-minute time period.

The weekday and weekend demand patterns are clearly different. In the week-day one, there are two distinct peaks corresponding to the morning and evening rush hours. In the weekend and holiday one, there is only one distinct peak, around 5:20 p.m. The deviations in the weekday pattern are smaller than those in the weekend one, indicating that most passengers in the weekday behave in a periodic manner. Therefore, we may b e able to detect disruptive events by comparing the differences in the average number of passengers for each section of a line. 3.3 Extraction of Passenger Flows From the trip records, we can determi ne how many passengers used a certain station. However, since the data did not include the entrance time, we could not determine how many passengers there were within a certain time period. Moreover, the origin-destination pair information was not enough for estimating the crowdedness of each train or the eff ects of a disruptive incident at a certain location. We need the trip route for each passenger.

There are usually several possible routes for traveling from an origin station to a destination station. A smart card log contains information about where a passenger touched in and where and when he/she touched out at a station gate. It does not include the entrance time and transfer station information. We therefore assumed that the most probable route for each trip (origin and destination pair) was the one with the shortest total trip time.
We defined total trip time t = T + C + W ,where  X  T is the time spent riding, as defined by the timetable,  X  C is the walking time when transferring, as determined by the layout of  X  W is the time waiting for a train to arrive, as defined by the timetable Using this definition, we calculated the estimated time for every possible trip route for each origin-destination pair. We then used the Dijkstra algorithm [2] to find the fastest route.

To identify phenomena that differed from the usual cyclical patterns, we first estimated in which section of a line each passenger was during a particular time on the basis of the fastest route and exit time. We then calculated the number of passengers who were in a certa in section during a certain (10-minute or one-hour) time period and the average number and standard deviation. The weekday and weekend data sets were independently an alyzed as explained in Section 3.2. The average and standard deviation were used t o detect unusual patterns, especially in the weekday cyclical patterns. 3.4 Visualization of Passenger Flows We used a visualization technique [3] to investigate passenger behavior. Our frame-work provides two visualization views, the HeatMap view and the RouteMap view, for exploring passenger flows and spatio-temporal propagation of crowdedness ex-tracted in Section 3.3.

The HeatMap view (Figure 3, left) provid es an overview of the spatio-temporal crowdedness of sections of the lines in the route map. The RouteMap view (Fig-ure 3, right) shows the animated temporal changes in the number of passengers and the crowdedness of each section. The t wo views are coordinated  X  selection of lines and time stamps in the HeatMap view causes the RouteMap view to start showing animated changes in the values for the selected lines and time stamps.
 The combination of these views enables users to detect unusual events. Two HeatMap thresholds (high and low) are defined for determining unusually crowded areas and unusually empty areas (for a cer tain train section and for a certain time period). These unusual geo-temporal areas are concatenated into several chunks separated by normal areas. The size and density of each chunk reflect the large-ness of affected area, and the severity o f the effect. Many of the large extracted chunks corresponded to unusual events, such as natural disasters, public gather-ing, and accidents. The example shown in Figure 3 illustrates the effects of a spring storm. The large red and blue chunks in HeatMap view indicate that passenger flows changed drastically during that event. The RouteMap reveals correspond-ing events by showing the spatio-temporal propagation of the unusual passenger behaviors. Passenger flows after train accidents are predicted using the demand and be-havior models. To predict the number of passengers at the time of an accident without using real-time data, we estimate how many passengers will want to travel during or after the time of the accident by using the demand model. We then estimate how these passengers will change their route by using the behavior model.

Our prediction method requires two kinds of information as input: average passenger flow in the past and the expected time to recover from the accident. The proposed method can predict passenger flows after an accident from this information, without real-time data. 4.1 Passenger Demand Model We estimated each passenger X  X  entrance time by using the trip time estimation method described in Section 3.3. We then calculated the number of passengers starting a trip, for every origin-destination pair, for every 10 minutes. The results reflected the passenger demand during a certain time period. We calculated the average demand for each time slot over one year (Apr. 1, 2012, to Mar. 31, 2013). As mentioned, data for weekdays and weekends were treated independently.
We used this average demand as the passenger demand model. 4.2 Passenger Behavior Model In the passenger behavior model, each passenger has an origin station and a des-tination, and the route taken is calculated as explained in Section 3.3. Example spatio-temporal behaviors of two passe ngers when service on a section of a line is suspended is illustrated in Figure 4. Two passengers (A and B) want to travel from Station 1 (St1) to St2. We assume that we know about the service suspen-sion and the begin and end times of the suspension (represented in the figure as  X  X ut-of-service section X ). Passenger A c ompletes passage through that section before service is suspended and is thus not affected. Passenger B is affected and thus must change his route or time of travel:  X  If there is another route from St1 to St2 that does not use the out-of-service  X  If there is no such route, he must wait until service is restored (as illustrated
Since passengers often change their travel method in such situations, such as by switching to travel by bus or taxi, we use the  X  X bandonment Rate X  to capture this behavior. When N passengers are affected by the out-of-service section, we assume only N  X  (1  X  AbandonmentRate ) passengers continue to use the train system.

The Abandonment Rate should be based on historical data. The estimation of this parameter is described in Section 5. 5.1 Target Data We found disruptive events for the Tokyo Metro subway system by using the transport information webpage of a third-party company 2 . We checked this page every hour for one year and extracted the train operating condition information.
Here we focus on one line (the  X  X ozai L ine X ) in order to set the parameter of our model under the simplest conditions. We found that six disruptive events occurred on the Tozai Line during the year . They caused service suspensions on several sections, and it took several hours to restore service. 5.2 Evaluation Metric Since each trip record contained each passenger X  X  arrival time and not the de-parture time, we could only determine how many passengers had left from a certain station at a certain time ( Exitnum ). We evaluated the passenger behav-ior model by comparing these values. W e estimated how many passengers left from each station by using our passenger demand and behavior models. 5.3 Test Case 1  X  Accident on Nov. 6, 2012 An accident occurred at 17:11 on Nov. 6, 2012. A failure of railway power supply system was found and several sections of the line between Toyocho Station and Kasai Station were closed until 18:34. The accident happened during rush hour, so it affected many passengers.

Figure 5 shows the difference in Exitnum between the estimation obtained using the demand model and the actual trip record data. The estimation was made without considering the accident information. Colors are used in the figure to represent the difference in Exitnum normalized by the value in the trip record data. Blue represents the situation in which the actual number of passengers was lower than the estimated one, and red represents the opposite case. The large blue area indicates that many passengers were unable to travel as they normally did.
 We also estimated Exitnum for all the other stations in the metro system. Since the difference was at the highest for stations on the Tozai Line, we focused on that line in our evaluation.

The estimation results when the out-of-service information was considered, with Abandonment Rate = 0, are shown in Figure 6. Most of the blue area (labeled i) disappeared. However, a new large blue area (labeled ii) appeared around 18:50, after the accident.
 We adjusted the Abandonment Rate to find the most appropriate setting. We computed the sum of the absolute num ber of difference in this sections and timespan to estimate the correctness of our model. Figure 8 shows this value normalized by the average number of passengers who used the Tozai Line at this time of the day. The difference for Abandonment Rate = 0 was larger than the case of no information about the service suspension (green line). We can see that the best setting of the Abandonment Rate was 0.9. With the out-of-service information, the difference improved by about 9%. Figure 7 shows the best case, with Abandonment Rate = 0.9. The large problematic blue area (ii) disappeared with this setting.

Even in the best case (Figure 7), we can see several chunks of blue area (iii and iv). We obtained train operation information for that date from the railway company and determined that most of th e decrease in the number of passengers is understandable: the entire Tozai Line was stopped twice for a short time, from 17:11 to 17:28 (iii), and from 19:19 to 19:29 (iv). The blue chunk in Figure 7 is reasonably explained by this information. 5.4 Test Case 2  X  Accident on Oct. 10, 2012 Another accident occurred at 11:32 on Oct. 10, 2012. A passenger was injured and sections between Kasai Station and Myouden Station were closed until 13:09. Note that the closed sections and time of day differ from those in the November case (Section 5.3).

Figure 9 shows the difference in Exitnum without the out-of-service informa-tion. The difference is smaller than in the November case.

Figure 10 shows the results with the out-of-service information and Aban-donment Rate = 0. The difference during the time period of the accident (i) is smaller, but a new blue area (ii) appeared after the accident.

We again adjusted the Abandonment Rate to find the most appropriate set-ting. Figure 12 shows the total difference in our estimation normalized by the average number of passengers who used the Tozai Line at this time of the day. The best result was achieved when we set the Abandonment Rate to 0.9, the same value as in the November case. This shows that our behavior model can predict user behavior more precisely when the out-of-service information is used. The best setting (Abandonment Rate = 0.9) results are shown in Figure 11. The large blue chunk in Figure 10-(ii) has disappeared. 5.5 Discussion As we can see from the results of our two evaluation cases, our behavior model can predict the effects of train accident s. Although the closed sections and time of day differed between the two test cases, the same parameter setting could be used for both cases. In this prediction, all we needed to know was which sections were closed and for how long. Using the average demand and Abandonment Rate parameter, we predicted the number of passengers without using real-time demand information. The use of real-time demand information would of course make the prediction even more accurate.

When an accident occurs, the operatin g company can usua lly estimate how long it will take to restore service by using knowledge about previous accidents. Therefore they could use our framewor k and predict the effects of an accident in real time. The framework we have developed for analyzing passenger behavior in public transportation systems is aimed at gaining an understanding of passenger flows in real time and predicting short-term passenger behavior. With this framework, we can analyze a large-scale dataset of trip records created from smart card data. Various unusual phenomena can be observed by using interactive visualization. Our model for predicting passenger behavior after train accidents was demon-strated to predict passenger flows even without the use of real-time data.
In the evaluation test cases only a single line has stopped. More complex cases in which several lines are affected will be evaluated in future work.
