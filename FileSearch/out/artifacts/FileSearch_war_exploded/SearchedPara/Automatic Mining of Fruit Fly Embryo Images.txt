 We present FEMine, an automatic system for image-based gene expression analysis. We perform experiments on the largest publicly available collection of Drosophila ISH ( in situ hybridization) images, showing that our FEMine system achieves excellent performance in classification, clustering, and content-based image retrieval. The major innovation of FEMine is the use of automatically discovered latent spatial  X  X hemes X  of gene expressions, LGEs , in the whole-embryo context, as opposed to patterns in nearly disjoint portions of an embryo proposed in previous methods.
 Categories and Subject Descriptors: H.2.8 [Database Management]: Database Applications  X  data mining, im-age databases; J.3 [Life and Medical Sciences]: Biology and Genetics General Terms: Experimentation Keywords: embryonic image analysis, Drosophila, gene ex-pression, independent component analysis, Eigen-Embryo
In multicellular organisms such as Drosophila and human, many important biological processes, including development and differentiation, are essentially ruled by gene expression activity[4, 5]. For multicellular organisms, gene expressions must be described in a spatio-temporal context, i.e., contain-ing both spatial and temporal dynamics of gene activities.  X 
We would like to thank Dr. Hanchuan Peng for inspir-ing discussions on aspects of ISH image analysis. This research is supported in part by NSF (grant nos. IIS-0209107, SENSOR-0329549, EF-0331657, IIS-0326322, and IIS-0534205), CAPES-Brazil (grant no. BEX-1206/05-2), FAPESP-Brazil (grant nos. 03/01769-4 and 2005/04272-9), CNPq-Brazil (grant nos. 471950/2004-1 and 501214/2004-6), the Pennsylvania Infrastructure Technology Alliance, and an NSF CAREER Grant DBI-0546594 for E.P.X.  X  Affiliation of A. Balan and A. Traina: Instituto de Ci X  encias Matem  X  aticas e Computa  X  ao, Universidade de S  X  ao Paulo, S  X  ao Paulo, Brazil.
 Copyright 2006 ACM 1-59593-339-5/06/0008 ... $ 5.00.
In situ hybridization (ISH) analysis is an imaging method that reveal the spatial distribution of gene expression in tis-sues. Such spatial information is indispensable for in-depth analysis of the regulatory and developmental mechanisms in higher eukaryotic organisms [12]. The fast growing  X  X x-pression Pattern X  database under the Berkeley Drosophila Genome Project (BDGP) now contains over 56,000 digital images of expression patterns of over 3,000 genes, and before long all genes in the Drosophila genome will be covered [1]. As of now, the only mining approach offered by the BDGP, for example, co-expressed genes or spatial (anatomical and histological) annotations of the gene expressions, is based on manual-labeling of the images by a domain expert using a controlled vocabulary [16]. Efforts of automating this pro-cess and grounding it on a more objective and robust feature description and distance measure have just begun [10, 14], and the tools available so far are clearly inadequate.
Despite its obvious importance and necessity, there has been little earlier work on automatic analysis and compar-ison of Drosophila embryo ISH images; recently develop-ments mostly resort to simplistic image mining approaches with limited power [6, 8, 10]. The technique developed by Peng and Myers [14] is more robust and combines similarity measure at both local and global level. Nevertheless, these extant approaches offer limited flexibility for capturing com-plex gene ISH patterns that are present in a rich database such as the BDGP. For example, it is hard to capture the fa-mous stripe patterns of pair rule genes in Drosophila embryo using a mixture of Gaussians. Furthermore, it is not clear how to define similarity functions among genes, to infer their dependencies (but see [13] for some recently developments). In this paper, we present a novel image mining system, FlyEmbryo Miner (or FEMine), that can automatically ex-tract, transform, compare, classify and cluster gene expres-sion patterns in Drosophila embryos based on raw ISH im-ages. The major innovation of FEMine is the use of auto-matically discovered latent spatial  X  X hemes X  of gene expres-sions, referred to as LGEs , which capture basic patterns of gene expressions in the whole -embryo context, as opposed to localized patterns in nearly disjoint portions of the embryos that previous methods propose. The work-flow of FEMine contains three major steps: (a) Image processing, in which we perform segmentation and registration, (b) feature extraction with PCA [9] and ICA [7], and (c) data mining, with applications such as classifica-tion, clustering and content-based image retrieval. Table 1 summarizes the workflow of our FEMine system. In this Input: The embryo image database: D = {I 1 ,..., I N } .
Steps: 1. Image preprocessing (Section 2.1):
For each image I i  X  X  , (1.1) Identify and extract the major embryo. (1.2) Register the extracted embryo to a common form.
Result: A registered image database: D = { I 1 ,...,I N } 2. Extract the latent gene expression (LGE) patterns (Section 2.2):
Result: M LGEs (biological meaningful image templates). 3. Data mining using FEMine (Section 3): (3.1) Represent each image I i  X  D with LGEs (Eq. 1). Figure 1: Embryo extraction steps. (a) Input image; (b) Local variance intensities; (c) Binary image after thresholding; (d) Final result after  X  X oles filling X . section, we describe the first two of the three steps of the work-flow, and the third step will be described later.
The image processing stage is necessary in order to pro-vide a standardized image database for gene expression pat-tern comparison. To deal with issues such as noise, occlu-sion, and inconsistent orientation in the embryo ISH images, we perform three image processing steps: embryo extraction , main embryo isolation ,and image registration .
With very few exceptions, the embryos and the back-ground have significantly different local texture properties. Embryos have a rougher texture with high local variance, while the background, a watery solution, has smooth tonal variations, which means pixels with low local variance. We calculate the variance of pixel intensity in a 3x3 window cen-tered at each pixel of the image (Figure 1(b)), and set the pixel as foreground if the value is above a fixed threshold value. A result of this thresholding is shown at Figure 1(c). It is quite common to have embryo-pixels assigned as back-ground, mainly at the center region of them. Thus, after obtaining the binary image, we apply a morphological bi-nary operator to  X  X ill the holes X  inside the embryos X  region. Figure 1 shows an example of each embryo extraction step.
An ISH image taken during a typical embryogenesis ex-periment usually contains a few dozens of embryos, with the most interesting embryo located at the center of the im-age. The embryos in an image may be touching the main Figure 2: The shrink-expand method: (a-d) region erosion (e) two regions found. Figure 3: Region growing: (a) Initialization by the shrink-expand method. (b-e) region growing. embryo, or even occluding it (Figure 1(a)). To extract the main embryo, our first attempt was to use the well known  X  X atershed transform X  to partition the foreground region of the binary image. However, due to the noisy borders and concave shapes of the embryos, the watershed approach with a bad initial state tends to  X  X ver-segment X  the embryos (i.e., too many regions at the final result).

To remedy this, we propose a novel approach to provide an initial state for the watershed algorithm. Basically, we perform a shrink-expand processing of the foreground region, i.e., first the region is continuously eroded until we find two separated regions, as shown in Figure 2. The two partitions of the foreground region are then the initial state for the watershed flooding algorithm. The algorithm  X  X rows X  back the regions, until they touch again, creating a watershed, as shownintheFigure3.

For images with more than two embryos. We apply our  X  X hrink-expand X  algorithm recursively over the foreground region, keeping only the center-most region at each recur-sion step until the  X  X hrink-expand X  algorithm gives only one region. Figure 4 shows an example of recursive partitioning.
Embryos extracted from the previous step could have dif-ferent position, orientation, scale and shape in the images. For a better comparison between patterns in the extracted embryos, we perform an image registration step to transform the images, so that the comparison can be performed regard-less their original position, orientation, scale and shape.
Given that embryos at the same developmental stages do not show considerable differences on shape (i.e., can be mostly rectified by an affine transformation), we select the method proposed by Thvenaz, Ruttimann and Unser [15]. The chosen method uses an efficient variant of the Marquardt-Levenberg algorithm for non-linear optimization and an elab-orate multi-resolution structure to speed up the registration process. We configure the method so that after registra-tion, each embryo will have an ellipsoidal shape, predefined size, and with its major axis aligned horizontally. The final product of our image processing are gray-level images with 352  X  160 pixels. Some examples are presented in Figure 5.
The main goal of our work is to extract biological mean-ingful patterns that captures the overall spatial gene ex-pression patterns in an embryo ISH image. These patterns would also provide a representation of the embryo images, which is as compact as possible and suitable for clustering, Figure 4: Recursive partitioning to separate the main embryo. Figure 5: Processing the ISH images of Drosophila embryos: (a-c) original images (d-f) results. classification and content-based retrieval. We refer to such patterns as  X  X atent gene expression X  (or, LGE) patterns.
We propose a two-step method to discover the latent spa-tial (gene expression) patterns from the embryo ISH im-ages. The first step is to summarize the 1,763 images in our database into a few, more manageable, e.g., M =10, typical images. At the second step, from these typical images, we extract the latent LGE patterns (or templates )thatcompose the spatial gene expressions presented in the images.
For the first step, we propose to use the Principal Compo-nent Analysis (PCA) [9] for discovering the typical images that summarize the database. For mining the LGE patterns at the second step, we propose to use the Independent Com-ponent Analysis (ICA) [7]. As we will show later, the inde-pendent  X  X emplates X  of the embryo images found by ICA efficiently describe the global spatial gene expressions in the images. Next we present the details of these two steps.
We apply PCA to discover typical images in the image database. After our image processing and registration, ev-ery embryo is presented as a 352  X  160 pixel gray-scale im-age, and we propose to consider it as a point N -dimensional space, where N =352  X  160 is the number of pixels. Our database of 1,763 (registered) embryo images can be envi-sioned as a cloud of points in this N -dimensional space. Computationally, let us consider a data set D =[ I 1 , ..., I of embryo images, where each image I i ( i =1 ,...,M )is viewed as a 1-by-N vector of N =352  X  160 pixels, and is apointinthe N -dimensional space. PCA computes the eigenvectors of the covariance matrix of the data ( DD T ). Because these eigenvectors can also be treated as points in the N-dimensional pixel space, we can also visualize each of them as an 352  X  160 image. We refer to these images as Eigen-Embryos . Since these eigenvectors account for the major variations among the data points [9], Eigen-Embryos can be considered as the  X  X ypical X  images that summarize the characteristics of images in the database.

In our experiments, we select only a reduced number M (
M &lt;N ) of Eigen-Embryos, those associated with the high-est eigenvalues. The value of M is chosen so that the re-tained eigenvalues maintain 90% of the  X  X otal energy X  (sum of squared eigenvalues). Figure 6: Artificial dataset presenting a X-like dis-tribution. The dark lines are: (a) PCA basis vectors (Eigen-Embryos) (b) ICA basis vectors (LGEs).
The Eigen-Embryos generated by PCA together provide a good description of the entire ISH image database [9]. However, individual Eigen-E mbryo may not capture correct characteristic in the database. Figure 6 illustrates this sit-uation using an artificial dataset  X  a cloud of 2-dimensional points in an  X  X  X -like shape. Figure 6(a) shows the two eigen-vectors (or Eigen-Embryos): they are orthogonal to each other and together they can describe the major variations of the point set. However, each of them fails to capture the  X  X -like X  distribution pattern of the data. A better set of vectors are shown in Figure 6(b), computed by ICA.
Therefore, we propose to use the Independent Compo-nent Analysis (ICA) to find a better set of image templates , which are more biologically significant and can show the latent gene expressions in the whole -embryo context. An intuitive way to describe ICA is through the blind source separation problem ( bss ): given a set of observed signals, ICA attempts to decompose them into a set of independent signals, without explicit knowledge about the signals (i.e. blind). The classical cocktail party problem is an exam-ple of bss . Consider being in a cocktail party which has several simultaneous conversations, music and noise. The properties of these sound sources are not known, but in most cases, they are not related and independent to each other. Given several different observations of the ambient sound, for example, the sound captured from different microphones located around the room, ICA takes advantage of the inde-pendent property of the sound sources and can recover the original conversations.

To relate this concept to our ISH images, Eigen-Embryos that summarize the ISH images in the database can be viewed as the microphone recordings. Our goal is to ex-tract the hidden conversations  X  the latent gene expression patterns in the images.

Formally, let the M -by-N matrix X be the collection of the M Eigen-Embryos (each row is a Eigen-Embryo), and let the M -by-N matrix S be the set of LGE patterns to be discovered. If B is the unknown M -by-M matrix that specifies the mixing of the latent patterns, then the  X  X ock-tail party X  model is the following Given a matrix X , ICA will compute the corresponding ma-trices B and S . Each row of S corresponds to a LGE and can be visualized as an image template (Figure 8). In our experiments, we use an implementation of ICA named Fast-ICA [7].
 Each image in the database can be represented using the LGEs. The LGE-representation I LGE of an image I is com-puted, by applying the following projection where S is the matrix formed by the LGEs as column vec-tors. We will also call I LGE the  X  LGE embedding  X  X fan image I . In this section, we present the experimental results of FEMine on the following issues: (1) automatic processing of embryo images; (2) qualitative evaluation of the  X  X igen-Embryo X  and  X  X GE X  patterns; and (3) the performance of classification, clustering, and content-based retrieval of ISH images using the LGE-representation.
We download all the ISH images of Drosophila embryos in developmental stages 4-6 from the BDGP database. This dataset contains 8,566 ISH images of highly variable quality: images may contain multiple embryos or incomplete embryos (Figure 5, top panels). Using the image processing module described in Section 2.1 (which includes embryo extraction, isolation and registration), we recover 6,800 high quality, 8-bit gray-level and 352  X  160-pixel ISH images, each con-taining a single embryo (or occasionally a single piece of the embryo, due to incomplete coverage of the original image) and no background (Figure 5, bottom panel). Thus, our embryo extraction rate is nearly 78%, significantly higher than the roughly 30% yield (personal communication from Dr. H. Peng) by previous simpler methods.

The 8,566 images record the expression of roughly 2000 genes. For the following experiments, we prepare a data set by manually select at most 2 images per gene, keeping only the images with the most relevant gene expression patterns. After this screening, our experimental database contains im-ages of 1,763 different genes.
From our database of 1763 processed embryo images, we build a training set with 127 handpicked images containing a variety of salient gene expression patterns. Then we ap-ply FEMine to extract the Eigen-Embryos and the LGEs of these images.

Figure 7 shows the top 10 Eigen-Embryos that amounts to about 90% of the total energy. A visual inspection sug-gest that Eigen-Embryos correspond to periodic spatial pat-terns over an embryo image, each with a different spatial frequency. Together, the Eigen-Embryos are able to recon-struct the numerical signals in the embryo images. However, each Eigen-Embryo does not correspond to biologically in-terpretable spatial patterns of gene expressions, such as that of the gap genes and the well-kn own stripe structures of the pair-rule gene expressions.

On the other hand, the LGEs perform much better in cap-turing biologically significant patterns. Figure 8 shows the 10 LGEs extracted from the top 10 Eigen-Embryos. A num-ber of typical early developmental expression pattern of the Drosophila genes are captured in the LGEs automatically, such as the segmentally repeated pattern, the anterior and posterior patterns, and so on. In the following experiments, we focus on LGEs only. With the 10 extracted LGEs, each of the 1,763 images can be represented as a 10-dim feature vector, using the LGE-embedding (Eq. 1). Each 10-dim im-age vector is also to unit length, to reduce the variations in pixel intensity among the images.
To provide an objective and quantitative validation of the usefulness of LGE-based representations of ISH images, we first conduct a cl assification experiment. The goal is to show that the LGE-based representation preserves essen-tial features of ISH images which can be picked up by a classifier to distinguish images of different type. We ex-periment with two kinds of classifiers: the support vector machine (SVM) [2, 3] and the k -nearest neighbor ( k -NN) classifier [11]. In our experiments, we observe that SVM classifiers always perform better than a k -NN classifier, and therefore only the results of SVM classifiers are reported.
We manually label ISH images for the classification ex-periment and construct 7 major classes of patterns (minor patterns with fewer than 8 images are not used in our exper-iment). Images in the same class either have the same body part annotation given by the biologist, or they have similar visual presentation. Among the 7 classes, the number of im-ages in a class ranges from 16 to 25. Totally, there are 131 images in 7 classes. Figure 9 shows the representative im-ages for the 7 classes in our experiments. For example, the images in class 1 have the pattern of  X  X nterior endoderm X , and those in class 3 show the pattern of  X  X esoderm X . Class 4 contains images that show the body and tail of a fruit fly, while class 5 contains the interesting patterns which are called  X  X air rule X .

We apply a standard SVM (i.e., the libsvm package [3]) for multiway classification. We experiment with various ker-nels, including the radial basis kernel, polynomial kernel, and linear kernel, and different parameter settings.
The goal of the classification experiment is to evaluate the representation ability of the LGEs. For a fair evalua-tion, we reduce the influence from the classifier by searching a good parameter setting for the SVM classifier. The search of a good parameters for the SVM classifier is done by uni-formly sampled from the parameter space. For each can-didate kernel/parameter configuration, we conduct 5-fold cross-validation on a subset of the database (in total, 96 images randomly sampled from each class). The configura-tion with the best cross-validation performance is chosen.
The next step is to applied the SVM with selected config-uration to the entire database (the entire set of 131 images), to obtain a realistic evaluation of the expression power of LGEs. Again, 5-fold cross-validation is performed to ob-tain the classification accuracy, and we report the mean and standard deviation of the classification accuracy. Our experiments show that the LGE representation of the ISH images achieves good classification accuracy, indicat-ing good representation power of the LGEs. Table 2 shows Table 2: Classification with the SVM classifier the best cross-validation accuracy of a SVM classifier using different choices of kernel functions (with best parameters found). We find that using a SVM with polynomial kernel achieves the best mean classification accuracy 85.42% with a standard deviation 7.22%. In fact, the LGE-representation consistently gives good classification accuracy regardless of the kernel choice.

Table 3 shows the confusion matrix of the classification of the 7 ISH image classes. In the table, each row corresponds to a class, and each column corresponds to a predicted class. The number at the i -th row and the j -th column shows the percentage of images in class i are classified as class Therefore, the values in the cells on the diagonal correspond to correct prediction. In this case, images in classes 3 and 6 are always classified correctly (100%). Also, all classes (except class 4) are classified with more than 75% accuracy.
We perform a clustering analysis of the ISH images, to see whether we can discover genes with correlated expressions, and major expression patterns in our database. Among the 1763 images, there are several ones that do not show sig-nificant body part ISH staining  X  we refer to these images as  X  X ninteresting X  images. We propose a two-stage cluster-ing procedure that first removes the uninteresting images via an initial clustering, and then re-clusters the rest of the images that exhibit significant diversity and variability ISH staining.

In the first stage of our clustering procedure, we apply ei-ther K-means or the Gaussian Mixture Model (GMM) [11] to the whole dataset (i.e., 1763 images), and we empirically set the total number of clusters K to be K =20 and K =30 in two different trials. By visual inspection, we exclude several large clusters of  X  X ninteresting X  images (not shown, but sim-ilar to the ones representing class 6 and class 7 in Figure 9). Thus we obtain a  X  X iltered X  dataset of 268 ISH images which potentially contain the interesting patterns of ISH staining in the embryonic body parts.

In the second stage of our clustering procedure, both K-means and the GMM are applied on the filtered dataset of 268 images to find K =20 clusters. Figure 10 shows sam-ple images from the clusters found by the Gaussian mixture model. Again for brevity, we only show images from 10 clusters (out of total 20 clusters). The clustering obtained via K-mean is similar and not reported here. Remarkably, each of the clusters we discover appeared to correspond to a unique gene expression pattern revealed by ISH. In partic-Table 3: Confusion matrix of the best SVM result ular, we notice that earlier blob-based approaches without the LGE embedding can not pick up delicate patterns such as the segmental repeats of the pair-rule genes (e.g., cluster 9 in Figure 10).

In our experiments, the clustering algorithm (either K-means or GMM) is repeated for 1,000 times with random initialization. Among results from repeated K-means runs, we pick the one with minimum distortion , that is, the sum of distances from data points to its cluster centroid is min-imum. Among the results of the GMM runs, we keep the one with the highest likelihood given the data set.
We would like to emphasize that FEMine is designed to be a user friendly expert system for image-based gene expres-sion analysis. An important function offered by our FEMine system is the content-based ISH-image retrieval for an arbi-trary query image. In Figure 11, we present a screen-shot of FEMine, to highlight its interface. Notice that it can display tables containing the thumbnails of the retrieved images, as well important annotations of each image, such as the name of the image file, the name of the gene expressed, and the body part description contained in BDGP, provided by spe-cialists. It also provides an automatic and instantaneous evaluation of the query results, by plotting the correspon-dent Precision vs. Recall curve, when the ground truth of a retrieval query is available.
We have developed FEMine, for automatic pattern min-ing in a Drosophila embryonic ISH image database. FEMine offers a wide range of tools for analysis, starting from basic image processing, feature extraction, and high-level pattern recognition functionality, such as pattern classification, im-age clustering, and content-based image retrieval. One of the main novelties of FEMine is the introduction and au-tomatic extraction of  X  X GEs X   X  the latent whole-embryo gene expression themes in Drosophila embryos. It is our be-lief that FEMine can offer an integrated toolbox to compre-hend and analyze existing and rapidly growing repositories of Drosophila embryo ISH images for a variety of scientific research problems. thenumberofimagesineachcluster.

