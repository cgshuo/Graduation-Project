 Alignment of functional neuroanatomy across individuals forms the basis for the study of the func-tional organization of the brain. It is important for localization of specific functional regions and characterization of functional systems in a population. Furthermore, the characterization of variabil-ity in location of specific functional areas is itself informative of the mechanisms of brain formation and reorganization. In this paper we propose to align neuroanatomy based on the functional geome-try of fMRI signals during specific cognitive processes. For each subject, we construct a map based on spectral embedding of the functional connectivity of the fMRI signals and register those maps to establish correspondence between functional areas in different subjects.
 Standard registration methods that match brain anatomy, such as the Talairach normalization [21] or non-rigid registration techniques like [10, 20], accurately match the anatomical structures across individuals. However the variability of the functional locations relative to anatomy can be substantial [8, 22, 23], which limits the usefulness of such alignment in functional experiments. The relationship between anatomy and function becomes even less consistent in the presence of pathological changes in the brain, caused by brain tumors, epilepsy or other diseases [2, 3]. Figure 1: Standard anatomical registration and the proposed functional geometry alignment. Func-tional geometry alignment matches the diffusion maps of fMRI signals of two subjects.
 Integrating functional features into the registration process promises to alleviate this challenge. Re-cently proposed methods match the centers of activated cortical areas [22, 26], or estimate dense correspondences of cortical surfaces [18]. The fMRI signals at the surface points serve as a feature vector, and registration is performed by maximizing the inter-subject fMRI correlation of matched points, while at the same time regularizing the surface warp to preserve cortical topology and pe-nalizing cortex folding and metric distortion, similar to [9]. In [7] registration of a population of subjects is accomplished by using the functional connectivity pattern of cortical points as a descrip-tor of the cortical surface. It is warped so that the Frobenius norm of the difference between the connectivity matrices of the reference subject and the matched subject is minimized, while at the same time a topology-preserving deformation of the cortex is enforced.
 All the methods described above rely on a spatial reference frame for registration, and use the func-tional characteristics as a feature vector of individual cortical surface points or the entire surface. This might have limitations in the case of severe pathological changes that cause a substantial re-organization of the functional structures. Examples include the migration to the other hemisphere, changes in topology of the functional maps, or substitution of functional roles played by one dam-aged region with another area. In contrast, our approach to functional registration does not rely on spatial consistency.
 Spectral embedding [27] represents data points in a map that reflects a large set of measured pair-wise affinity values in a euclidean space. Previously we used spectral methods to map voxels of a fMRI sequence into a space that captures joint functional characteristics of brain regions [14]. This approach represents the level of interaction by the density in the embedding. In [24], different embedding methods were compared in a study of parceled resting-state fMRI data. Functionally ho-mogeneous units formed clusters in the embedding. In [11] multidimensional scaling was employed to retrieve a low dimensional representation of positron emission tomography (PET) signals after selecting sets of voxels by the standard activation detection technique [12].
 Here we propose and demonstrate a functional registration method that operates in a space that reflects functional connectivity patterns of the brain. In this space, the connectivity structure is cap-tured by a structured distribution of points, or functional geometry . Each point in the distribution represents a location in the brain and the relation of its fMRI signal to signals at other locations. Fig. 1 illustrates the method. To register functional regions among two individuals, we first embed both fMRI volumes independently, and then obtain correspondences by matching the two point dis-tributions in the functional geometry. We argue that such a representation offers a more natural view of the co-activation patterns than the spatial structure augmented with functional feature vectors. The functional geometry can handle long-range reorganizations and topological variability in the functional organization of different individuals. Furthermore, by translating connectivity strength to distances we are able to regularize the registration effectively. Strong connections are preserved during registration in the map by penalizing high-frequencies in the map deformation field. The clinical goal of our work is to reliably localize language areas in tumor patients. The functional connectivity pattern for a specific area provides a refined representation of its activity that can aug-ment the individual activation pattern. Our approach is to utilize connectivity information to improve localization of the functional areas in tumor patients. Our method transfers the connectivity patterns from healthy subjects to tumor patients. The transferred patterns then serve as a patient-specific prior for functional localization, improving the accuracy of detection. The functional geometry we use is largely independent of the underlying anatomical organization. As a consequence, our method handles substantial changes in spatial arrangement of the functional areas that typically present sig-nificant challenges for anatomical registration methods. Such functional priors promise to improve detection accuracy in the challenging case of language area localization. The mapping of healthy networks to patients provides additional evidence for the location of the language areas. It promises to enhance accuracy and robustness of localization.
 In addition to localization, studies of reconfiguration mechanisms in the presence of lesions aim to understand how specific sub-areas are redistributed (e.g., do they migrate to a compact area, or to other intact language areas). While standard detection identifies the regions whose activation is correlated with the experimental protocol, we seek a more detailed description of the functional roles of the detected regions, based on the functional connectivity patterns.
 We evaluate the method on healthy control subjects and brain tumor patients who perform language mapping tasks. The language system is highly distributed across the cortex. Tumor growth some-times causes a reorganization that sustains language ability of the patient, even though the anatomy is severely changed. Our initial experimental results indicate that the proposed functional alignment outperforms anatomical registration in predicting activation in target subjects (both healthy controls and patients). Furthermore functional alignment can handle substantial reorganizations and is much less affected by the tumor presence than anatomical registration. We first review the representation of the functional geometry that captures the co-activation patterns in a diffusion map defined on the fMRI voxels [6, 14]. Given a fMRI sequence I  X  R T  X  N that contains N voxels, each characterized by an fMRI signal over T time points, we calculate matrix C  X  R N  X  N that assigns each pair of voxels  X  k, l  X  with corresponding time courses I k and I l a non-negative symmetric weight where corr is the correlation coefficient of the two signals I k and I l , and is the speed of weight decay. We define a graph whose vertices correspond to voxels and whose edge weights are deter-mined by C . In practice, we discard all edges that have a weight below a chosen threshold if they connect nodes with a large distance in the anatomical space. This construction yields a sparse graph which is then transformed into a Markov chain. Note that in contrast to methods like multidimen-sional scaling, this sparsity reflects the intuition that meaningful information about the connectivity structure is encoded by the high correlation values.
 We transform the graph into a Markov chain on the set of nodes by the normalized graph Laplacian construction [5]. The degree of each node g ( k ) = P l c ( k, l ) is used to define the directed edge weights of the Markov chain as which can be interpreted as transition probabilities along the graph edges. This set of probabilities defines a diffusion operator P f ( x ) = P p ( x, y ) f ( y ) on the graph vertices (voxels). The diffusion operator integrates all pairwise relations in the graph and defines a geometry on the entire set of fMRI signals.
 We embed the graph in a Euclidean space via an eigenvalue decomposition of P [6]. The eigenvalue decomposition of the operator P results in a sequence of decreasing eigen values  X  1 ,  X  2 . . . and cor-responding eigen vectors  X  1 ,  X  2 , . . . that satisfy P  X  i =  X  i  X  i and constitute the so-called diffusion map : where w  X  T is the dimensionality of the representation, and t is a parameter that controls scaling of the axes in this newly defined space.  X  k t  X  R w is the representation of voxel k in the functional geometry; it comprises the k th components of the first w eigenvectors. We will refer to R w as the functional space . The global structure of the functional connectivity is reflected in the point distribution  X  t . The axes of the eigenspace are the directions that capture the highest amount of structure in the connectivity landscape of the graph.
 This functional geometry is governed by the diffusion distance D t on the graph: D t ( k, l ) is defined through the probability of traveling between two vertices k and l by taking all paths of at most t steps Figure 2: Maps of two subjects in the process of registration: (a) Left and right: the axial and sagittal views of the points in the two brains. The two central columns show plots of the first three dimensions of the embedding in the functional geometry after coarse rotational alignment. (b) During alignment, a maps is represented as a Gaussian mixture model. The colors in both plots indicate clusters which are only used for visualization. into account. The transition probabilities are based on the functional connectivity of pairs of nodes. Thus the diffusion distance integrates the connectivity values over possible paths that connect two points and defines a geometry that captures the entirety of the connectivity structure. It corresponds to the operator P t parameterized by the diffusion time t : The distance D t is low if there is a large number of paths of length t with high transition probabilities between the nodes k and l .
 The diffusion distance corresponds to the Euclidean distance in the embedding space: k  X  t ( k )  X   X  t ( l ) k = D t ( k, l ) . The functional relations between fMRI signals are translated into spatial dis-tances in the functional geometry [14]. This particular embedding method is closely related to other spectral embedding approaches [17]; the parameter t controls the range of graph nodes that influence a certain local configuration.
 To facilitate notation, we assume the diffusion time t is fixed in the remainder of the paper, and omit it from the equations. The resulting maps are the basis for the functional registration of the fMRI volumes. Let  X  0 , and  X  1 be the functional maps of two subjects.  X  0 , and  X  1 are point clouds embedded in a w -dimensional Euclidean space. The points in the maps correspond to voxels and registration of the maps establishes correspondences between brain regions of the subjects. Our goal is to estimate correspondences of points in the two maps based on the structure in the two distributions determined by the functional connectivity structure in the data. We perform registration in the functional space by non-rigidly deforming the distributions until their overlap is maximized. At the same time, we regularize the deformation so that high frequency displacements of individual points, which would correspond to a change in the relations with strong connectivity, are penalized. We note that the embedding is defined up to rotation, order and sign of individual coordinate axes. However, for successful alignment it is essential that the embedding is consistent between the sub-jects, and we have to match the nuisance parameters of the embedding during alignment. In [19] a greedy method for sign matching was proposed. In our data the following procedure produces satisfying results. When computing the embedding, we set the sign of each individual coordinate typically have a long tail, and are centered at the origin, this step disambiguates the coordinate axis directions well.
 Fig. 2 illustrates the level of consistency of the maps across two subjects. It shows the first three dimensions of maps for two different control subjects. The colors illustrate clusters in the map and their corresponding positions in the brain. For illustration purposes the colors are matched based on the spatial location of the clusters. The two maps indicate that there is some degree of consistency of the mappings for different subjects.
 Eigenvectors may switch if the corresponding eigenvalues are similar [13]. We initialise the registra-tion using Procrustes analysis [4] so that the distance between a randomly chosen subset of vertices from the same anatomical part of the brain is minimised in functional space. This typically resolves ambiguity in the embedding with respect to rotation and the order of eigenvectors in the functional space.
 We employ the Coherent Point Drift algorithm for the subsequent non-linear registration of the functional maps [16]. We consider the points in  X  0 to be centroids of a Gaussian mixture model that is fitted to the points in  X  1 to minimize the energy where x k 0 and x l 1 are the points in the maps  X  0 and  X  1 during matching and  X  is a function that regularizes the deformation  X  of the point set. The minimization of E (  X  ) involves a trade-off be-tween its two terms controlled by  X  . The first term is a Gaussian kernel, that generates a continuous distribution for the entire map  X  0 in the functional space R w . By deforming x k 0 we increase the likelihood of the points in  X  1 with respect to the distribution defined by x k 0 . At the same time  X  (  X  ) encourages a smooth deformation field by penalizing high frequency local deformations by e.g., a radial basis function [15]. The first term in Eq. 5 moves the two point distributions so that their overlap is maximized. That is, regions that exhibit similar global connectivity characteristics are moved closer to each other. The regularization term induces a high penalty on changing strong functional connectivity relationships among voxels (which correspond to small distances or clusters in the map). At the same time, the regularization allows more changes between regions with weak connectivity (which correspond to large distances). In other words, it preserves the connectivity structure of strong networks, while being flexible with respect to weak connectivity between distant clusters.
 Once the registration of the two distributions in the functional geometry is completed, we assign correspondences between points in  X  0 and  X  1 by a simple matching algorithm that for any point in one map chooses the closest point in the other map. To validate the functional registration quantitatively we align pairs of subjects via (i) the proposed functional geometry alignment, and (ii) the anatomical non-rigid demons registration [25, 28]. We restrict the functional evaluation to the grey matter. Functional geometry embedding is performed on a random sampling of 8000 points excluding those that exhibit no activation (with a liberal threshold of p = 0 . 15 in the General Linear Model (GLM) analysis [12]). After alignment we evaluate the quality of the fit by (1) the accuracy of predicting the location of the active areas in the target subject and (2) the inter-subject correlation of BOLD signals after alignment. The first criterion is directly related to the clinical aim of localization of active areas.
 A. Predictive power: We evaluate if it is possible to establish correspondences, so that the activation in one subject lets us predict the activation in another subject after alignment. That is, we examine if the correspondences identify regions that exhibit a relationship with the task (in our experiment, a Figure 3: Mapping a region by functional geometry alignment: a reference subject (first column) aligned to a tumor patient (second and third columns, the tumor is shown in blue). The green region in the healthy subject is mapped to the red region by the proposed functional registration and to the yellow region by anatomical registration. Note that the functional alignment places the region narrowly around the tumor location, while the anatomical registration result intersects with the tumor. The slice of the anatomical scan with the tumor and the zoomed visualization of the registration results (fourth column) are also shown. language task) even if they are ambiguous or not detected based on the standard single-subject GLM analysis. That is, can we transfer evidence for the activation of specific regions between subjects, for example between healthy controls and tumor patients? In the following we refer to regions detected by the standard single subject fMRI analysis with an activation threshold of p = 0 . 05 (false discovery rate (FDR) corrected [1]) as above-threshold regions.
 We validate the accuracy of localizing activated regions in a target volume by measuring the average correlation of the t-maps (based on the standard GLM) between the source and the corresponding target regions after registration. A t-map indicates activation -i.e., a significant correlation with the task the subject is performing during fMRI acquisition -for each voxel in the fMRI volume. A high inter-subject correlation of the t-maps indicates that the aligned source t-maps are highly predictive of the t-map in the target fMRI data. Additionally, we measure the overlap between regions in the target image to which the above-threshold source regions are mapped, and the above-threshold regions in the target image. Note that for the registration itself neither the inter-subject correlation of fMRI signals, nor the correlation of t-maps is used. In other words, although we enforce homology in the pattern of correlations between two subjects, the correlations across subjects per se are not matched.
 B. Correlation of BOLD signal across subjects: To assess the relationship between the source and registered target regions relative to the fMRI activation, we measure the correlation between the fMRI signals in the above-threshold regions of the source volume and the fMRI signals at the corre-sponding locations in the target volume. Across-subject correlation of the fMRI signals indicates a relationship between the underlying functional processes. We are interested in two specific scenar-ios: (i) above -threshold regions in the target image that were matched to above-threshold regions in the source image, and (ii) below -threshold regions in the target image that were matched to above-threshold regions in the source image. This second group includes candidates for activation, even though they do not pass detection threshold in the particular volume. We do not expect correlation of signals for non-activated regions. We demonstrate the method on a set of 6 control subjects and 3 patients with low-grade tumors in one of the regions associated with language processing. For all 9 subjects fMRI data was acquired Figure 4: Validation: A. Correlation distribution of corresponding t-values after functional geometry alignment (FGA) and anatomical registration (AR) for control-control and control-tumor matches. B. correlation of the BOLD signals for activated regions mapped to activated regions (left) and activated regions mapped to sub-threshold regions (right). using a 3T GE Signa system (TR=2s, TE=40ms, flip angle=90  X  , slice gap=0mm, FOV=25.6cm, dimension 128  X  128  X  27 voxels, voxel size of 2  X  2  X  4 mm 3 ). The language task (antonym generation) block design was 5min 10s, starting with a 10s pre-stimulus period. Eight task and seven rest blocks each 20s long alternated in the design. For each subject, anatomical T1 MRI data was acquired and registered to the functional data. We perform pair-wise registration in all 36 image pairs, 21 of which include at least one patient.
 Fig.3 illustrates the effect of a tumor in a language region, and the corresponding registration results. An area of the brain associated with language is registered from a control subject to a tumor patient. The location of the tumor is shown in blue; the regions resulting from functional and anatomical reg-istration are indicated in red (FGA), and yellow (AR), respectively. While anatomical registration creates a large overlap between the mapped region and the tumor, functional geometry alignment maps the region to a plausible area narrowly surrounding the tumor. Fig. 4 reports quantitative com-parison of functional alignment vs. anatomical registration for the entire set of subjects. Functional geometry alignment achieves significantly higher correlation of t-values than anatomical registration significantly when registering a control subject and a tumor patient, compared to a pair of control subjects ( 0 . 08 vs. 0 . 06 , p = 0 . 007 ). For functional geometry alignment this drop is not significant ( 0 . 15 vs. 0 . 14 , p = 0 . 17 ). Functional geometry alignment predicts 50% of the above-threshold in the target brain, while anatomical registration predicts 29% (Fig. 4 (A)).
 These findings indicate that the functional alignment of language regions among source and tar-get subjects is less affected by the presence of a tumor and the associated reorganization than the matching of functional regions by anatomical registration. Furthermore the functional alignment has better predictive power for the activated regions in the target subject for both control-control and control-patient pairs. In our experiments this predictive power is affected onyl to a small degree by a tumor presence in the target. In contrast and as expected, the matching of functional regions by anatomical alignment is affected by the tumor.
 Activated source regions mapped to a target subject exhibit the following characteristics. If both source region and corresponding target region are above-threshold the average correlation between the source and target signals is significantly higher for functional geometry alignment ( 0 . 108 vs. 0 . 097 , p = 0 . 004 paired t-test). For above-threshold regions mapped to below-threshold regions the same significant difference exists ( 0 . 020 vs. 0 . 016 , p = 0 . 003 ), but correlations are significantly lower. This significant difference between functional geometry alignment and anatomical registra-tion vanishes for regions mapped from below-threshold regions in the source subject. The baseline of below-threshold region pairs exhibits very low correlation (  X  0 . 003 ) and no difference between the two methods.
 The fMRI signal correlation in the source and the target region is higher for functional alignment if the source region is activated. This suggests that even if the target region does not exhibit task specific behavior detectable by standard analysis, its fMRI signal still correlates with the activated source fMRI signal to a higher degree than non-activated region pairs. The functional connectivity structure is sufficiently consistent to support an alignment of the functional geometry between sub-jects. It identifies experimental correspondences between regions, even if their individual relation-ship to the task is ambiguous. We demonstrate that our alignment improves inter-subject correlation for activated source regions and their target regions, but not for the non-active source regions. This suggest that we enable localization of regions that would not be detected by standard analysis, but whose activations are similar to the source regions in the normal subjects. In this paper we propose and demonstrate a method for registering neuroanatomy based on the functional geometry of fMRI signals. The method offers an alternative to anatomical registration; it relies on matching a spectral embedding of the functional connectivity patterns of two fMRI volumes. Initial results indicate that the structure in the diffusion map that reflects functional con-nectivity enables accurate matching of functional regions. When used to predict the activation in a target fMRI volume the proposed functional registration exhibits higher predictive power than the anatomical registration. Moreover it is more robust to pathologies and the associated changes in the spatial organization of functional areas. The method offers advantages for the localization of activated but displaced regions in cases where tumor-induced changes of the hemodynamics make direct localization difficult. Functional alignment contributes evidence from healthy control sub-jects. Further research is necessary to evaluate the predictive power of the method for localization of specific functional areas.
 Acknowledgements This work was funded in part by the NSF IIS/CRCNS 0904625 grant, the NSF CAREER 0642971 grant, the NIH NCRR NAC P41-RR13218, NIH NIBIB NAMIC U54-EB005149, NIH U41RR019703, and NIH P01CA067165 grants, the Brain Science Foundation, and the Klarman Family Foundation.
 [1] Y. Benjamini and Y. Hochberg. Controlling the false discovery rate: a practical and powerful [2] S.B. Bonelli, R.H.W. Powell, M. Yogarajah, R.S. Samson, M.R. Symms, P.J. Thompson, M.J. [3] S. Bookheimer. Pre-surgical language mapping with functional magnetic resonance imaging. [4] F.L. Bookstein. Two shape metrics for biomedical outline data: Bending energy, procrustes [5] Fan R.K. Chung. Spectral Graph Theory . American Mathematical Society, 1997. [6] Ronald R. Coifman and St  X  ephane Lafon. Diffusion maps. App. Comp. Harm. An. , 21:5 X 30, [7] Bryan Conroy, Ben Singer, James Haxby, and Peter Ramadge. fmri-based inter-subject cortical [8] E. Fedorenko and N. Kanwisher. Neuroimaging of Language: Why Hasn X  X  a Clearer Picture [9] B. Fischl, M.I. Sereno, and A.M. Dale. Cortical surface-based analysis II: Inflation, flattening, [10] B. Fischl, M.I. Sereno, R.B.H. Tootell, and A.M. Dale. High-resolution intersubject averaging [11] KJ Friston, CD Frith, P. Fletcher, PF Liddle, and RSJ Frackowiak. Functional topography: [12] KJ Friston, AP Holmes, KJ Worsley, JB Poline, CD Frith, RSJ Frackowiak, et al. Statistical [13] V. Jain and H. Zhang. Robust 3D shape correspondence in the spectral domain. In Shape [14] Georg Langs, Dimitris Samaras, Nikos Paragios, Jean Honorio, Nelly Alia-Klein, Dardo [15] A. Myronenko and X. Song. Point set registration: Coherent point drift. IEEE Transactions [16] A. Myronenko, X. Song, and M.A. Carreira-Perpin  X  an. Non-rigid point set registration: Coher-[17] H.J. Qiu and E.R. Hancock. Clustering and Embedding Using Commute Times. IEEE TPAMI , [18] M.R. Sabuncu, B.D. Singer, B. Conroy, R.E. Bryan, P.J. Ramadge, and J.V. Haxby. Function-[19] L.S. Shapiro and J. Michael Brady. Feature-based correspondence: an eigenvector approach. [20] D. Shen and C. Davatzikos. HAMMER: hierarchical attribute matching mechanism for elastic [21] J. Talairach and P. Tournoux. Co-planar stereotaxic atlas of the human brain . Thieme New [22] B. Thirion, G. Flandin, P. Pinel, A. Roche, P. Ciuciu, and J.B. Poline. Dealing with the short-[23] B. Thirion, P. Pinel, S. M  X  eriaux, A. Roche, S. Dehaene, and J.B. Poline. Analysis of a [24] Bertrand Thirion, Silke Dodel, and Jean-Baptiste Poline. Detection of signal synchronizations [25] J.P. Thirion. Image matching as a diffusion process: an analogy with Maxwell X  X  demons. [26] D.C. Van Essen, H.A. Drury, J. Dickson, J. Harwell, D. Hanlon, and C.H. Anderson. An [27] U. Von Luxburg. A tutorial on spectral clustering. Statistics and Computing , 17(4):395 X 416, [28] H. Wang, L. Dong, J. O X  X aniel, R. Mohan, A.S. Garden, K.K. Ang, D.A. Kuban, M. Bonnen,
