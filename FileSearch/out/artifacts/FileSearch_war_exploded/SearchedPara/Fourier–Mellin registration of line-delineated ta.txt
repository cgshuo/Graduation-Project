 ORIGINAL PAPER Luke A. D. Hutchison  X  William A. Barrett Abstract Image registration (or alignment) is a useful pre-processing tool for assisting in manual data extraction from handwritten forms, as well as for preparing documents for batch OCR of specific page regions. A new technique is presented for fast registration of lined tabular document im-ages in the presence of a global affine transformation, using the Discrete Fourier X  X ellin Transform (DFMT). Each com-ponent of the affine transform is handled separately, which dramatically reduces the total parameter space of the prob-lem. This method is robust and deals with all components of the affine transform in a uniform way by working in the frequency domain. The DFMT is extended to handle shear, which can approximate a small amount of perspective dis-tortion. In order to limit registration to foreground pixels only, and to eliminate Fourier edge effects, a novel, locally adaptive foreground-background segmentation algorithm is introduced, based on the median filter, which eliminates the need for Blackman windowing as usually required by DFMT image registration. A novel information-theoretic optimiza-tion of the median filter is presented. An original method is demonstrated for automatically obtaining blank document templates from a set of registered document images. Keywords Document image registration  X  Deskewing  X  Background removal  X  Fourier X  X ellin transform  X  Transfor-mation reversal  X  Locally-adaptive thresholding  X  Microfilm processing  X  Tabular document images  X  Family history technology 1 Introduction The ability to register, or align, related images to one another in the presence of various image transformations is impor-tant in many image processing and document archival fields. In image registration, one image is stretched to align to an-other in its salient features, effectively undoing the relative transformation between the two images [1 X 4].
 ages share features which need to be correlated to make sense of the relationship between the images. For example, in medical image analysis, scans of internal organs taken at different times often need to be aligned to determine whether or not a disease has progressed. Image registration is also important when dealing with a set of document images that share a common template or form, for example batches of census records [ 5 ]. By first registering the images, more in-formation is available for reliably determining which pixels in the image are part of the original document form (Fig. 1 ), making table structure recognition [6 X 8] and content extrac-tion [ 9 ] potentially more reliable.
 ogy and the advent of affordable large-scale storage de-vices, several institutions interested in conventional record preservation and data extraction have turned to digital li-brary research to determine how to most effectively make old records accessible. One important technology in such preservation and extraction efforts is image registration. Saints, as curator of the world X  X  largest collection of ge-nealogical records, has archived more than 2.4 million rolls of genealogical microfilm, each roll containing an average of 1300 images. Between one-third and one-half of the im-ages in the collection were written on some sort of tabular form (parish registers, census records, death records, etc.). In order to distribute images for manual extraction of names for indexing, and to facilitate future Internet access to the original document images, these films are currently being scanned at approximately 200 dpi in 8-bit grayscale. Origi-nal page sizes range from 8.5  X  11 to 17 in.  X  20 in. Scanned images are typically 2000  X  3000 to 4000  X  5000 pixels in size.
 Unfortunately, handwritten information is currently hard to automatically extract in a reliable way [ 10 ], so most extraction work for genealogy is done manually by vol-unteers. For example, in October 2002, the complete, fully indexed US 1880 and Canadian 1881 censuses were released [ 11 ] for free access at www.familysearch.org .A total of 55 million names were extracted from these two censuses, after a total contribution of 15 million hours of volunteer time. The resulting indexed resource is invaluable for genealogists, because a list of records matching a given query may be returned almost instantaneously.
 these would greatly facilitate efforts to extract and make such collections of genealogical and digital library records accessible online. The software currently used in manual ex-traction of these names allows the user to create a field tem-plate from an example image. The template specifies where the table cells are expected to lie on the page (Fig. 2 a). For subsequent images, the program then highlights each cell in turn during data entry. The user also has a way to modify the grid by moving it or skewing it, because documents of-ten do not line up with the template (Fig. 2 b). Many users do not use this feature because it is time-consuming and complicated. As a result, many users do not use the pro-vided template system, or visually find the correct informa-tion for each field even if the template field does not line up correctly. Automatic document image registration would streamline and simplify this process, by aligning each doc-ument with the template grid, allowing extractors to get on with the work of extraction without worrying about creat-ing and aligning extraction templates. It would also enable templates to be created just once for an entire class of doc-uments and shared amongst extractors, or for algorithms to automatically create an extraction template in a reliable way, by taking a consensus of many document images [ 5 ]. read by computer rather than by a human (in the case of automatic indexing by OCR [ 12 ] or automatic handwriting recognition [ 10 , 13 , 14 ]), it is useful to have the image straightened out so that the table cells become axis-aligned rectangles, and so that the scale of all the images is exactly the same. This means that the text recognition algorithms can more easily identify corresponding table cells between different images, and in the case of OCR, the amount of global image distortion that must be coped with between different images is reduced.
 pression. Once a set of images is registered, it is relatively easy to find the common template across many images, and this can be stored once and subtracted from each image in a batch. This technique has been shown to work at the glyph level, for compression of machine-printed text: commonly occurring glyphs on the page are identified by clustering, and then the page is stored symbolically, with each symbol as an index into the library of common glyphs, with an as-sociated residual difference from the library version of the glyph [ 15 , 16 ]. 2 Related work 2.1 Skew detection The majority of previous work related to document image registration has been in skew detection and correction, e.g. correcting for rotational variation when a document is not axis-aligned on a scanner. Most skew detection algorithms are specifically designed to detect skew angle, so they do not easily extend to handle scale, translation or other transformations. However, as most of the body of document image registration literature deals with skew detection, it is described later. A description of full image registration techniques then follows in Sect. 2.2 .
 of a document is to find the angle at which a projection his-togram through the document has the strongest and the best-separated peaks, as determined by some cost function. For example, Postl [ 17 , 18 ] describes a  X  X imulated skew scan X  method, where a cost function (the  X  X remium X ) is maxi-mized while scanning through the document at a range of angles. Baird [ 19 ] reduces each connected component to a single point and builds projection profiles from the set of these points  X  this algorithm is designed to work well with machine-printed text where each character is separate, as op-posed to large tables filled with handwriting, where almost the entire image may be a single connected component. termining document rotation [ 21 ]. Amin [ 22 ] describes a method where the image is thresholded, and then groups of connected components are built, one scanline at a time. The Hough transform is applied to one connected component in each group to determine the skew angle. The algorithm is somewhat similar to the algorithm of Hinds et al. [ 23 ], who use run-lengths rather than connected components to choose points for Hough analysis. Using larger connected features such as this can reduce the computational complexity of the Hough transform [ 24 ], but such block-based data reduction methods do not often work well for tabular documents with handwritten content, because so much of the document ends up being connected as one component.
 expensive and is sensitive to noise. There is always a trade-off in the accuracy of the recovered parameters and the size of the accumulator array (and thus the computational com-plexity).
 tion by fitting a straight line to the set of baseline midpoints of the connected components in the image. Again, this is designed for machine print and is not suited to tabular docu-ments containing handwriting.
 ular microfilm images, wherein a vector-based template is extracted from the document, representing the lines of the document template. A snapping algorithm is used to match one document X  X  vector template to another. A consensus template is formed by combining several snapped grids to-gether, making the algorithm more robust to noise. The pro-duction of the consensus template also allows for discovery of the transformation that maps one image to another. This algorithm works well, but the author assumes that there is no major rotation of the document image away from axis align-ment, because the algorithm relies on axis-aligned projec-tion histograms to find table lines. The algorithm does allow for some variation in scale, by an exhaustive search through a small neighborhood of the scale parameter space.
 tion include gradient direction [ 26 ], eigenvectors of the co-variance matrix [ 27 , 28 ], texture directional evidence anal-ysis [ 29 ] and mathematical morphology [ 30 ]. A particu-larly interesting (and generalized) approach makes use of the Wigner X  X ille distribution [ 31 ]. 2.2 Full image registration: scale, rotation, translation Document skew detection methods such as those described previously are rarely designed to detect all components (ro-tation, scale, translation, and shear) of the affine transform that best maps one image to another. If such non-rotational transformations are present in a set of document images, a separate algorithm is usually needed to correct for these other components of the transform once skew angle has been detected and corrected for. This can lead to an unwieldy mix of fundamentally different algorithms that correct for each separate component of the transform; in other cases, the so-lution is not very general or does not handle some transform parameter at all.
 rotational and translational registration of form-based doc-uments, based on the detection of linear features. They demonstrate the efficacy of their method for a set of scanned forms. However, scale is not corrected for because it is not a consideration for scanned documents. Digital microfilm im-ages are usually produced with a camera, necessitating scale correction.
 registering images under rotation and scale variations, by warping an image in the image-space into log-polar form: in this form, changes of rotation and scale become simple shifts in x and y . The system does not handle translation however, and the center for the log-polar warp has to be chosen reli-ably for registration to work at all.
 down hierarchical fashion [ 34 , 35 ]. Wolberg and Zokai X  X  method in [ 34 ] is particularly interesting, as it recovers the parameters of a perspective distortion by breaking down the images into tiles, and then finding the best affine fit between pairs of tiles in the two images to be registered. The perspec-tive parameters are inferred by the piecewise-affine match between the images.
 correction may be performed by identifying common fea-tures between two images, and estimating the transform model that best maps the features in one image to the fea-tures in the other [ 2 , 4 ]. These methods can be complex (and invariant feature selection strategies must be chosen). 2.3 Frequency-domain image registration Frequency-domain techniques have long been used for im-age registration. Kuglin and Hines [ 36 ] originally proposed that phase correlation be used for translational registration in the frequency domain. Postl [ 17 ] described a Fourier-based method for skew detection, using a radial line integral through a 2D power spectrum to determine the rotation an-gle. De Castro and Morandi [ 37 ] presented a two-step pro-cess, first identifying the angle of rotation and then deter-mining the translational shift. These techniques do not easily extend to handle scale, however.
 troduced by the optical research community [ 38 ], and it was later used in digital signal and image processing [ 39 ]. More recently, the Fourier X  X ellin transform has been shown to be particularly useful in image registration when image scale variations are present [40 X 42]. Other areas in which this technique has been useful include image watermarking [ 43 ] and image region classification [ 44 ].
 ful technique for image registration because translation can be removed from consideration until rotation and scale have been corrected for, and by working with the Fourier X  X ellin log-polar mapping, full RST (rotation X  X cale X  X ranslation) registration can ideally be performed as a sequence of two simple 2D correlations (one using the log-polar spectrum to recover rotation and scale, and then one in image space to re-cover translation). As will be discussed in more detail later, the problem is actually made more complex than this in pe-riodic discretized space due to aliasing artifacts and  X  X dge effects. X  images, the 2D correlation involved in recovering rotation and scale is completely separable into two 1D correlations (which are significantly faster to compute, and suffer from fewer aliasing problems). We also perform the final transla-tional correlation in the frequency domain, meaning all pa-rameters are recovered in a consistent manner, by working in frequency space. We also present methods for overcom-ing Fourier edge effects, and extend Fourier X  X ellin image registration to handle shear distortion, which can correct for a small amount of perspective warp, as well as anisotropic scaling. 2.4 Fourier X  X ellin registration of tabular document images It does not appear that the Fourier X  X ellin transform has pre-viously been applied specifically to the registration of tabu-lar document images. It is a particularly powerful approach for this specific problem, because of the frequency-domain properties of line-delimited tabular documents. For example, in these documents table lines act as linear  X  X avefronts, X  which produce high-magnitude ridges of peaks in the fre-quency domain at right angles to the wavefront (Fig. 3 ). These allow for easy detection of the document rotation and scale. Document images also lend themselves well to pre-processing, because all useful information in a typical docu-ment is darker than its background, and foreground informa-tion is of low spatial density, allowing for automatic back-ground removal. These properties are exploited heavily in the presented specialization of Fourier X  X ellin techniques to tabular document image registration.
 3 Discrete Fourier and discrete Mellin transforms The Fourier X  X ellin transform has been used successfully for image registration under rotation, scale, and translation by employing a log-polar sampling of the frequency domain representation of an image [ 45 ].
 are examples of integral transforms , which take the general form where K ( X , t ) is called the integral kernel of the transform. The continuous Fourier transform is defined as and the Mellin transform is defined as is well known. The discrete version of the Mellin transform may be approximated by sampling a function at exponen-tially increasing intervals, and then weighting each sample by a function of the size of the sampling interval (taking care to avoid aliasing problems). The inverse of the Mellin transform represents a logarithmic mapping of the domain. form, it is sometimes called the  X  X cale transform X  in signal processing, as it transforms a scale operation in the signal domain into a simple translational offset in the Mellin do-main. This means that a system that is scale invariant in the signal domain is shift invariant under the Mellin trans-form [ 46 ]. Detection of shift in a signal is generally much easier than the detection of changes in scale, using simple correlation (Sect. 4.5 ). The Mellin transform therefore ren-ders a signal into a domain in which it is much easier to de-tect changes in scale between two signals that share salient features. 3.1 Two-dimensional Fourier and Mellin transforms Both the Fourier and Mellin transforms may be extended to 2D signals, or images. A 2D DFT has several interest-ing properties, such as the fact that the rotation of an image in 2D approximately results in a rotation by the same an-gle of the DFT (although this is an oversimplification, see Sect. 3.4 for details). The fact that rotation affects both the image and the frequency domains in similar ways is one of the properties of the Fourier transform that is made use of in the document image registration approach presented in this paper.
 crete Mellin transform may be obtained by sampling at exponentially-increasing concentric radii, producing a log-polar mapping of the domain, ( log  X , X ) (see Fig. 4 ). 3.2 The Fourier shift theorem A useful property of the Fourier transform that is exploited by the presented registration algorithm is given by the Fourier shift theorem from signal processing theory, which states that a translation (shift) of a signal results in a simple phase shift in the frequency domain, while the spectral mag-nitudes do not change. When working only with magnitudes in the frequency domain (ignoring phase), signal translation can therefore be completely removed from initial consider-ation. This simplifies the task of 2D image registration dra-matically, by reducing the parameter space for those parts of the registration task that can be reduced to operations on magnitudes only.
 ters in a registration problem can indeed be determined us-ing only magnitudes, because finding these parameters only involves analysis of the orientation and spacing of the princi-pal periodic features of an image, and does not depend upon the position of these features. Rotation and scale recovery are therefore shift-invariant in the image domain.
 information. Additionally, due to aliasing, translational re-covery cannot be performed directly upon the original frequency-domain representation of the input images. Once rotation and scale have been corrected for, the DFT of the corrected images can be taken, and the best translational off-set can be found directly by frequency-domain correlation. 3.3 The Discrete Fourier X  X ellin Transform (DFMT) The Discrete Fourier X  X ellin Transform (DFMT) is defined as the discrete Mellin transform of the discrete Fourier trans-form of a function. This yields a log-polar mapping of the frequency domain, ( log  X , X ) , in which rotation and scale in the image domain correspond to simple linear shifts (Fig. 4 ). Thus, detection of rotation and scale becomes a simple 2D correlation problem (Sects. 4.3 and 4.5 ). 3.4 Problems with the DFMT and Fourier X  X ellin image registration There are many issues that arise with trying to compute the Fourier X  X ellin transform in discretized space. For exam-ple, working directly with the 2D ( log  X , X ) space brings up sampling problems due to rotationally dependent alias-ing [ 45 , 47 ], where radially sampling at an arbitrary angle in an axis-aligned discrete domain (such as the DFT) results in aliasing artifacts that differ by angle. Performing full 2D correlation in ( log  X , X ) space can result in instability and inaccuracy of registration; using the correlation of two or-thogonal 1D projection histograms to estimate the full 2D correlation helps these problems by effectively averaging the sampling process over all angles or all scale offsets, but can unfortunately lead to spurious registrations due to collaps-ing of dimensionality. Standard Fourier X  X ellin registration also does not handle shear distortion or anisotropic scaling (meaning it is not a solution for registration under arbitrary affine transformation), and potentially has problems with spurious parameter recovery due to the non-commutativity of wrapping or tiling (induced by the periodicity of the DFT) with rotation (Fig. 5 ).
 from sharp, high-frequency transitions in image intensities where edges wrap or where an image is padded in size up to the next power of two. When this happens, axis-aligned ra-dial features, or cross artifacts , are created in the frequency domain, which can impede detection of rotation angle. As a preprocessing step for Fourier X  X ellin image registration, an apodization function, for example a Blackman or Gaussian window [ 45 , 48 ], is usually applied to the Fourier transform to try to curb some of these effects (Fig. 6 ). Unfortunately, such windowing requires that we somehow choose a circular subregion within the image to apodize, and we throw away the rest, meaning the image cannot be used in its entirety for registration. A better solution is presented in Sect. 4 ,which involves removing the document background using a median filter (Fig. 7 ).
 image registration for document images is that the final step relies upon standard 2D cross-correlation to correct for translation. This does not work well for document im-ages, because we are not interested in registering the page background (the paper or surrounding area), just the darker strokes on the paper. 4 Methods We present here a specialization of the DFMT which ex-ploits the properties of lined tabular document images to overcome most of the standard problems with using the Fourier X  X ellin transform for registration. 4.1 Preprocessing: automatic locally-adaptive background removal using the median filter Typically, a document is written with dark ink on light paper. To separate the document content from the paper, many thresholding algorithms attempt to find a threshold based on the global histogram of pixel intensities [ 49 ]. Better algorithms such as the Niblack algorithm [ 50 ]are locally adaptive, choosing the segmentation threshold according to statistical properties of a local neighborhood of each pixel (Fig. 9 d). We present here a novel algorithm for removal of unwanted background from an image without requiring that the document be thresholded.
 simply subtracting the median-filtered version of an image from the original. Median filtering removes the smaller fea-tures of a document image (writing, table lines, etc.), and subtraction from the original then leaves only these fea-tures (Fig. 8 ). This background removal method works be-cause foreground pixels are not usually spatially dense, and thus comprise substantially fewer than half the pixels in any reasonably-sized neighborhood of a document image. We use a circular kernel of a given radius in order to produce a filter with the least bias towards orientation-dependent prop-erties.
 produce a binary image mask, but leaves subtle foreground variations intact (Fig. 9 b). Keeping all grayscale informa-tion for the foreground image can provide a great deal more useful information than a thresholded (bitonal) image. Also, any black border around the page is removed as background, even though it is the same color as the document foreground pixels. In contrast, Fig. 9 d shows that the Niblack algorithm does not remove the black border from around the page, and can even have trouble with local changes in background intensity. If a binary image is required, the image may be thresholded after background removal, however it will usu-ally be better not to threshold for image registration, because non-thresholded document images contain less aliasing. hat transform [ 51 ], which is a subtraction of the result of the morphological closing operator from the original image, although these algorithms were not compared here.
 ground removal algorithm is parameterized  X  specifically, the optimal kernel size needs to be determined. Setting the median filter radius too small can cause problems: the median filter has to be big enough to fully remove the foreground features from the page, or foreground pixels will be marked as background, because they dominate the kernel area (Fig. 10 a). Setting the kernel size too big can cause ad-ditional problems however, because while the median filter preserves sharp grayscale transitions, it rounds off corners in 2D. This can change the shape of features in the resulting image, meaning that if the kernel is too big, the background will not be adequately removed (Fig. 10 c). Also, median filtering with kernels that are larger than needed imposes un-necessary computational overhead. It is important therefore to find the kernel size that maximizes foreground preser-vation, maximizes background removal, and minimizes running time. In practice, this parameter found to be fairly insensitive to change of image size and/or change in scale of the document contents. By observation a median filter kernel of radius 17 pixels was found to suffice for full-page document images of up to 1200  X  1000, and a radius of 22 was sufficient for images of up to 1600  X  1200, i.e. the ker-nel radius needed to be around 1.5% of the size of the largest dimension of the image. This obviously depends somewhat on the scale of features in the image  X  setting the kernel radius as a function of image size makes an assumption about pen stroke thickness and density relative to page size. The optimal kernel radius could be determined by looking at RMS error rates of the background-removed version of the image compared to the original, for various kernel sizes. median filter that helped reduce computation time by a factor of 2. 4.2 Further preprocessing At several stages in the registration system, the DFT of the document images is computed. 1 The DFT requires the input domain size to be a power of two, because it is defined as a log 2 divide-and-conqueror algorithm. The image size must therefore be rounded up to the next power of two be-fore computing the DFT, and the image must be padded with some value. Background removal can remove grayscale transitions at the edges when the image is padded. The larger of the two image dimensions is used when rounding up, in order to make the image square, which simplifies further processing.
 each document image in isolation, without comparing it to other documents. Correction of scale and translation, how-ever, requires two or more images to be registered to one another. We arbitrarily choose the first image, correct for ro-tation and shear so that it is axis-aligned, and then use this as our reference image, to which the scale and translation of the other images are matched. The first image may not be the optimal choice for a scale and translation reference point, due to nonaffine distortion, low image quality, or non-ideal size. A better system would use a consensus-based approach to ensure the reference image was not badly chosen. This is left as future work. 4.3 Recovery of rotation: finding document axis angles in the DFT Because of conservation of power under the Fourier trans-form (Rayleigh X  X  Theorem), the most significant and/or pe-riodic linear components of an image produce the strongest radial line integral in the power spectrum. These radial fea-tures pass through the origin of the frequency domain, and lie at right angles to the linear components in the image do-main that produce them. The most strongly periodic compo-nents of a tabular document are the lines forming the table itself. This makes it easy to find the angle of rotation and shear of the table, by just looking for the two largest peaks in the radial projection histogram of the power spectrum. The radial projection histogram is produced by taking a line integral through the origin of the power spectrum at small angular increments, over the range 0 X 180  X  .
 frequency domain are determined, relative to the (0, 0) fre-quency origin. (Care must be taken when working with the frequency domain, as the DFT places (0, 0) at the top left, meaning the frequency domain quadrants are all diagonally transposed). For all pixels in the incircle of the 2D DFT (i.e. where  X &lt; N / 2, and N is the size of each dimension of the DFT), the magnitude of point ( x , y ) is accumulated in a histogram in bin number b = ( X  mod 180 )/ 180  X  N B where N B is the total number of bins in the histogram. ( N plementation, giving an internal resolution of 0.044  X  ,i.e.an expected error of  X  0.022  X  . Linear interpolation can be used in this forward-mapping approach to distribute the magni-tude to the two neighboring bins of the fractional bin po-sition b , which somewhat reduces the effect of rotationally dependent aliasing , and empirically decreases the error rate for recovery of the rotation parameter by a significant factor. to the histogram (by 1D convolution with a Gaussian (with  X  = N quency domain) before searching for the peaks representing the table axes, in order to remove small, meaningless spikes in the histogram. Note however that too much smoothing can cause ambient noise in the radial projection histogram to end up being greater in magnitude than the true peaks, because the true peaks are so narrow that their total magni-tude is comparatively small. Thus, a 1D version of median filter background removal is applied to the radial projection histogram before smoothing, to remove the ambient signal noise (the 1D median-filtered version of the signal is sub-tracted from the signal itself, see Fig. 11 ).
 separated by approximately 90  X  are found. This is accom-plished by finding the angle  X  1 corresponding to the glob-ally maximum value in the radial projection histogram, then finding the local maximum  X  2 within the angular range of ( X  angles to one of the document axes.
 termine the angle of rotation, the 2D log-polar space is col-lapsed down via projection into two 1D profiles (correspond-ing to rotation and scale). This is done in the interest of efficiency compared to performing a full 2D correlation of the polar-mapped Fourier X  X ellin space. Spurious matches can result from attempting to correlate these projections, be-cause most power profiles lack strongly periodic features for general Fourier X  X ellin image registration, meaning rotation and scale are not distinctly separable.
 strong periodic features (arising from the table grid), mean-ing the angle of rotation may be found easily and separately from the scale of the images. In determination of rotation, we are looking only for the frequency-domain features that represent the strongest periodic components of the image, specifically the two largest maxima in the radial projections of the frequency domain, one corresponding to each table axis. This also allows us to handle table axes that are not separated by exactly 90  X  , which is not possible in standard Fourier X  X ellin registration, and as a result we may correct for shear distortion.
 ered using two 1D correlations, traced directly along radial lines corresponding to each axis in the Fourier X  X ellin trans-form. The rest of the transform need not be considered, as the table template comprises the strongest periodic features in the image.
 therefore completely separable when working with tabular document images, and angle of rotation can cleanly be de-termined before scale, with little chance of spurious match compared to Fourier X  X ellin registration of general images. This is possible because of the strong frequency-space fea-tures specific to the domain of tabular document image reg-istration.
 scribed, the intransitivity of wrapping (tiling) and rotation (Fig. 5 ) does not adversely affect the correct selection of rotation angle, since when radial features are wrapped at the edges of the frequency domain due to higher-order har-monics, they do not significantly affect the radial projec-tion histogram at any specific angle. Rotated-then-wrapped features get spread over a range of angles (from a view-point at the center of the frequency domain), meaning the true maxima in the histograms (corresponding to the table axes) are not likely to get disturbed. This is not true for general Fourier X  X ellin image registration, because wrapped harmonics change the entire surface of the log-polar trans-form, potentially making registration more difficult, as a full correlation is performed (rather than just looking for the two largest peaks in the histogram).
 lar document images, apodization is not needed to eliminate Fourier edge effects, which can otherwise impede rotational registration (Figs. 7 and 12 ), especially when the true docu-ment axis angles are close to 0  X  or 90  X  . Thus, the entire im-age (not just an arbitrarily chosen, windowed portion of it) can be used in the registration process. Additionally, detec-tion of rotation angles close to 0  X  or 90  X  is possible through background removal, eliminating some of the limitations of standard Fourier X  X ellin registration. 4.4 Recovery of shear Interestingly, by looking for the two most significant max-ima in a radial projection histogram, the two image axes are decoupled, since an angle is returned for each axis. Thus, we can separately determine the rotation angle (for the hori-zontal axis) and the shear angle (deviation of the vertical axis from the horizontal angle plus 90  X  ). Recovery of shear angle is not possible with standard Fourier X  X ellin image regis-tration, because, as previously noted, the log-polar space is nonlinearly distorted about the origin. It is made possible here by exploiting properties of this particular problem do-main, specifically that document tables produce a separate strong radial component in the frequency domain for each axis (Fig. 13 ). It should be noted that a shear of the image results in a shear in the frequency domain at 90  X  from the original shear direction, i.e. the resulting shear is not just a rotation of one axis relative to the other. Computation of the scale factor of registration should take this into account if handling significant degrees of shear is desired. 4.5 Recovery of scale factor Scale recovery happens in log-polar coordinates, as in stan-dard Fourier X  X ellin image registration. However, because we are dealing with tabular document images, only table lines are important for registration. Thus, determination of scale need only involve conversion to log-polar form of the Fourier magnitudes along the direction of radial projection maxima detected during determination of rotation and shear, and we end up performing two 1D discrete Mellin trans-forms rather than a single 2D Mellin transform to detect scale.
 ponential intervals along the radial features in the frequency domain that correspond to the document axes, the positive-and negative-frequency magnitudes (the magnitudes at 180  X  to each other, at the same radius from the origin) are summed. The resulting value is weighted by the size of the current exponential interval. The result is two log-radius his-tograms, one for each document axis (Fig. 14 a and b). The logarithmic base b can be chosen so as to yield any de-sired accuracy in scale determination. A base of b = 1 . 001 was found to give very good accuracy for a range of images (  X  0.5%).
 est to the origin, are subject to the greatest amount of alias-ing during the Mellin transform, because they are sampled the most densely, possibly hundreds of times (with differ-ent weightings) per pixel, depending on the logarithmic base used. The central pixels are therefore the least spatially in-formative in the log-r histogram. This can create significant problems in determination of scale [ 47 ]. To reduce some of these problems, the innermost 10% of the radius (the lowest 10% of frequencies) is therefore skipped during sampling, and table line frequency is obtained from higher-order har-monics. Because of high-magnitude/high-frequency noise, the outermost 30% of the radius is also not sampled. (Note that Stone and McGuire use an  X  H -filter X  to improve the SNR of the signal to get rid of high-frequency noise [ 45 ].) The values r MIN and r MAX in Fig. 14 are N  X  0 . 1and N  X  respectively.
 togram which can impede correlation: there can be a signif-icant amount of ambient noise in the signal (particularly in higher frequencies), much the same as for the radial projec-tion histogram used in the determination of rotation angle. The same method as was used in the rotation-recovery step is used to eliminate this, i.e. 1D background removal via the median filter is applied to eliminate the background noise (Fig. 11 ).
 axis. This is done by performing simple 1D correlations of each corresponding axis of the two images being registered (Fig. 14 c and d). This yields a log-scale factor for both hor-izontal and vertical document axes, i.e. the log of the x -and y -scale needed to stretch one image to another. An image is chosen as the base image for registration for this purpose. All other images are scaled/translated to the base image. izontal was used as the horizontal axis, meaning only rota-tions of  X  45  X  are handled by this approach. In practice, this does not present a problem for document image registration, although a better approach would try all four 90  X  document axis rotations to see which yields the best correlation with the base image.
 log b ( S ) corresponds to a change of scale by a factor of S : Thus, determination of scale reduces to a 1D correlation problem. This works much better than trying to stretch one DFT to match the other in non-log space, because resam-pling a DFT is problematic due to aliasing.
 the x -and y -axes, full affine anisotropic scaling is supported during registration. This can correct for some document dis-tortion due to scanning or camera angle artifacts, and is not possible with standard Fourier X  X ellin registration, which only yields a single global scale factor. 4.6 Recovery of translation offset Now that rotation, shear and scale have been recovered, the transformation matrix which inverts these transforms can be easily determined, and the transformed image is rendered into a temporary image buffer. The image in this buffer now needs only to be aligned with the base image using 2D cor-relation to recover the translation offset. Correlation is per-formed in the frequency domain, by pointwise multiplica-tion by the complex conjugate. The DFT of the temporary image buffer is computed, and the correlation is performed, followed by the inverse DFT, at which the global maximum in the inverse DFT is found. Its offset from the origin of the DFT gives the translation offset. 4.7 Pointwise mean of registered images Once a batch of images are all registered together, they can be overlaid on top of one another (as if printed on transpar-ent slides), and the mean value across all registered images that corresponds to each pixel in the output image can be used to give a consensus view of the entire batch of images (Fig. 15 b). This provides a quick window into the qualitative performance of the registration algorithm. Several examples of pointwise mean images, before and after registration, are showninSect. 5 . 4.8 Pointwise median of registered images Rather than taking the mean at each pixel across all regis-tered images (i.e. the pointwise mean), the median value at each pixel can be used instead (i.e. giving the pointwise me-dian). This gives an unbiased estimate of the average gray level at each pixel in the registered set. By using the me-dian rather than the mean, we are able to recover a fairly clean blank document template, based on a consensus of the images. Figure 15c shows a closeup of a pointwise median image.
 dian image, in locations where more than half the images contained handwriting rather than background. By comput-ing a pointwise quantile value, at a higher percentile than the median (i.e. higher than the 50th percentile), more of this handwriting can be excluded, at the expense of template line strength.
 ing step, to remove the background from the blank document template obtained from the pointwise median (Fig. 16 ). This can significantly clean up the document form that is obtained by registration. 5Results 5.1 Qualitative analysis Figures 17  X  20 show the results of applying the registration process to several real sets of images of tabular documents. The data sets range in age from 40 to 200 years. The first and second image for each data set show the result of pointwise-averaging all the images in the data set together before and after registration respectively; the third image for each data set shows a blank form obtained by computing the pointwise median of the registered images. The point-wise mean images show us that the document images are well-aligned in all data sets, as evidenced by the sharpness of the document template when performing a pointwise-average of all registered images. A counterexample, where registration did not fare so well, is shown in Fig. 22 .In the counterexample, all parameters but the vertical scale were recovered accurately, but the vertical scale could not be recovered because the line spacing in the document varied between images and even within a single image. This violates the requirements stipulated for input images that the linear features in the underlying form only differ by an affine transform, and it is not reasonable to expect the registration algorithm to fare well when the linear features in the form are not even registrable.
 registration system, namely the NIST handwriting recogni-tion data set, consisting of 3669 images (Fig. 21 ). Images were reduced in size from 2560  X  3300 to 1163  X  1500 to decrease processing time (by bringing the largest image dimension below the next power-of-two boundary), and be-cause the original data set consisted of bilevel images, for which registration does not always fare as well, perhaps be-cause it appears that the table lines consist of several axis-aligned pieces.
 tered well, despite the presence of multiple different forms in the data set. Some versions of the form contained printed instructions in the larger box at the bottom, and some had printed text above the box, which the user was to hand-write inside the empty box. Some versions included heading text at one of a range of positions at the top of the form, other versions did not include heading text. The printed text above each box (indicating what the participant should write) was different between the various versions of the form. These variations are visible in the pointwise mean image (Fig. 21 a), as well as in the pointwise variance im-age shown in Fig. 21 d, in which a variance of zero at a specific pixel across the set of registered images is repre-sented as black, and the largest variance is represented as white. The pointwise variance image shows that the printed text on the different form versions was inconsistent, but the box positions were actually very consistent, which is why the data set registered so well. There is a thin light-gray  X  X host X  around and within each box line in the pointwise variance image, which illustrates either nonexact registra-tion, or that there were small nonaffine variations between the input images. It was observed that the latter was the case, as relatively few of the lines in the input images were ex-actly straight. This was apparently due to distortion during photocopying of the forms before they were filled out by participants. 5.2 Quantitative analysis In order to quantitatively measure the accuracy of these methods, a representative tabular document image was se-lected, and subjected in turn to 100 instances of each trans-form distortion: rotation through various random (fractional) angles (between  X  45  X  and + 45  X  ), scaling by random frac-tional amounts (between 0.5 and 2.0), and translation by ran-dom sub-pixel distances in both x and y ; this resulted in a to-tal of 300 transformed images. Each transformed image was then registered to the original, and then the detected transfor-mation parameter was compared to the parameter that was originally used to distort the image. The RMS error over the 100 trials was measured.
 column gives the internal expected error in resolution of each parameter, due to an internal accuracy of twice the same value (e.g. the internal resolution of translation recov-ery is 1 pixel in both axes, making the internal resolution accurate to  X  0.5 pixel). This is the error rate to be expected before quadratic parameter fitting, where a second-order fit to the immediate neighborhood of the recovered parameter was used to improve accuracy.  X  X easured error X  shows the error rate that was measured after quadratic parameter The decrease in error in every case shows that the simple addi-tion of quadratic parameter fitting was able to improve pa-rameter resolution by a significant factor for this data set (approximately 20  X  for rotation, 2  X  for scale, and 3  X  for translation, even in the presence of aliasing artifacts). at a very high resolution (tenths/hundredths/thousandths of a pixel/percent/degree). The measured accuracy calculation after quadratic parameter fitting, for example, implies that an image would have to be 115,000 pixels wide to be mis-aligned by one pixel at the outside edges due to error in recovering rotation angle; a 3000-pixel wide image would have an average error in width of one pixel after scale cor-rection, and an average error during translational recovery of only 0.005% of its total width. The accuracy of parame-ter recovery was significantly above the internal accuracy of the system, meaning that with quadratic interpolation, alias-ing artifacts did not on average cause the system to perform worse than its absolute upper bounds of internal accuracy. than the amount of warp that is likely to be observed in most document images (due to lens distortion, printing distortion, or scanner lag). It is believed that these results are represen-tative of the approximate orders of magnitude of accuracy of the image registration algorithm under reasonable circum-stances (even with larger sources of variation than aliasing artifacts), due to the robust nature of the parameter recovery steps, and based on the qualitative evaluations of real data sets. In fact, it is difficult to test the accuracy of parameter recovery for a  X  X eal X  data set, as the actual registration pa-rameters are not known for real document images (hence the need for registration).
 tion accuracy could be added that determines what propor-tion of the black pixels in the pointwise median image that are also black in each registered image. This metric would also help detect when a specific image did not register well (flagging it for human intervention). This was not imple-mented in time for publication, and is left as future work. To implement this properly, and to give a reasonable mea-sure of true registration accuracy, locally adaptive registra-tion would need to additionally be implemented, or the met-ric would need to take into account small local errors in edge positions by a few pixels, otherwise the error function would be highly susceptible to sampling artifacts and small local changes in the shape of the table form. Such a quanti-tative measure would therefore not provide a good estimate of qualitative performance without additional work. For ex-ample, an image may have registered well from a qualita-tive point of view, but a ripple-distortion in a specific image may mean that only half the pixels in the form actually over-lapped with those in the template, even though those that didn X  X  overlap may have only been displaced by a few pixel positions.
 in registration data sets and the lack of consensus in the literature about consistent metrics for registration, quantita-tive comparison of document image registration algorithms is difficult. The analysis presented in Table 1 attempts to at least provide a quantitative upper bound to accuracy when the only source of error is aliasing artifacts, and we attempt to show qualitatively in this paper that various real-world data sets register relatively well even if the images are less ideal than those in this artificial data set. This suggests a good lower bound to performance for real-world data sets. 5.3 Registration under perspective distortion Often, document images have undergone non-affine trans-formations, such as perspective distortion (Fig. 23 ) or spher-ical distortion due to lens warping. Mild perspective distor-tion may be approximated by a shear and a separate scale factor for horizontal and vertical document axes, which is handled by Fourier X  X ellin document image registration as described.
 system performs under perspective distortion, digital pho-tographs were taken of a tabular document from various angles and distances. The camera was not brought closer than one meter from the document in order to not introduce significant spherical distortion, and the maximum deviation from the surface normal of the camera was 30  X  . Registration was largely successful in finding the best affine transforma-tion to reverse the perspective distortion (Fig. 24 ). Notice the ghosting at the edges of the pointwise mean of the reg-istered images, resulting from nonaffine components of the perspective distortion.
 that in an undistorted tabular image, frequency domain fea-tures corresponding to each document axis lie in a single straight line. This is not the case with document images that have undergone perspective distortion. To get around this, the log-r histogram used in scale recovery can be sampled over a small angular range of the angle determined in rota-tion recovery. Sampling over a small range of angles in this way unfortunately reduced accuracy of non-perspectively warped images in tests, due to the introduction of non-axis-aligned noise, and because frequency, corresponding to the DFT polar radius, is affected in as-yet-undetermined ways by perspective distortion. It was also observed that this strategy was not needed to find a good alignment with the perspectively warped images shown in Fig. 24 .Thisimplies that enough affine periodicity is present even with significant perspective distortion to allow the registration algorithm to find a reasonable affine approximation. 5.4 Run time In Table 2 , time taken to run the document image registration system on images of several different sizes is shown. Times are in seconds per image, e.g. to register 100 images, the total time needs to be multiplied by 100. Times were mea-sured on a P4-2.2GHz-HT system. Two concurrent threads were used for background removal and DFT operations, giv-ing a 30% speedup on the single-processor Hyperthreading architecture. On a true multiprocessing system, the speedup would be closer to 100% when multithreading these tasks. took the largest proportion of time for images of lower res-olution. As the resolution increased, rotation and translation became about equally prominent (because the DFT portion of those steps began to dominate the calculation). In partic-ular, notice how time taken to recover rotation and transla-tion suddenly jumped between the 2040  X  1383 and 2144  X  1779 images. This is because the largest image dimension crossed a power-of-two boundary (i.e. 2048), and so the im-age had to be padded up to the next power of two in size (i.e. 4096) before taking the DFT (see Sect. 4.2 ), resulting in an increase in processing time by a factor of around 4.5. This can actually happen for translation but not rotation for image sizes slightly smaller than a power of two, since when the temporary image buffer (representing the image with scale and rotation corrected for) is rendered prior to translation recovery, the rotated/scaled version can be bigger than the original, and so the DFT for translation might have to use the next size of two in power (even though it was not needed during the recovery of the rotation parameter). Making sure images are scaled to around 20% less than the next power of two in their largest dimension provides a window for rea-sonable differences in rotation and scale between images in the data set. Note though that images should be scaled using least bilinear interpolation, otherwise aliasing artifacts will cause problems with correct recovery of image parameters from the DFT.
 gorithm are highly parallelizable, allowing for significant speedups in hardware or on multiprocessing architectures. Both algorithms were multithreaded in the implementation of this system, providing significant speedups on sym-metric multiprocessing and hyperthreading architectures. Multiprocessing support that is even more scalable may be implemented by processing different images on different machines, since the registration process has very few processing dependencies between images. MPI (or some similar clustering system) would provide the necessary framework for scaling the algorithm for a clustered or supercomputing environment.
 removal was set to 1.5% of the largest image dimension, which typically works well for document images. However it is obvious from Table 2 that once an image gets to a certain size, the time taken to remove the background becomes ex-orbitant, and dominates the registration process. This is be-cause as the image dimensions scale up linearly, the image area and the median filter kernel both scale up quadratically, so the median filtering process scales as the fourth power of the image dimensions, i.e. O ( d 4 ) (because the kernel radius is proportional to the image dimension). Ways of optimizing median filtering, or optionally filtering lower-resolution ver-sions of the image to extract the background, are suggested in Sect. A.1 .
 scale differently to one another with the size of the image, due to differences in underlying algorithmic complexity. In the case of median filtering, time taken can also depend on the information-theoretical complexity of the image, due to the nature of the partial-sorting algorithm used.
 to plain deskew algorithms, but it is doing substantially more than plain deskewing or even RST (rotation X  X cale X  translation) registration, by performing accurate registration of tabular document images under full arbitrary affine trans-forms. 5.5 Resolution enhancement through frame averaging Note that it is possible to produce a pointwise mean (or me-dian) of the set of registered images at a higher resolution than that of any of the input images, because of subpixel registration. This has the effect of producing a much higher-resolution image of the document template than was origi-nally available. This technique is known as frame averaging or  X  X uper-resolution X  [ 53 ], and is used in several image pro-cessing fields (e.g. by the FBI to read low-resolution license plates in a sequence of video frames).
 technique to the NIST data set is shown in Fig. 25 .Thesu-perresolution image is obviously of higher resolution than the standard pointwise mean image, but is fuzzier. The fuzi-ness is due to aliasing of each image during original scan-ning, then antialiasing when the images were downsized for speed reasons prior to registration, but also because each im-age varied slightly due to small local nonaffine perturbations in the image that presumably arose due to photocopying, etc. These issues, taken collectively, approximate filtering with a Gaussian filter, so applying an unsharp mask cleans up the superresolution image nicely (Fig. 25 d). 5.6 Limitations of the presented registration algorithm Several assumptions are made by the image registration al-gorithm. For registration to be effective, the document must be written on a tabular form (i.e. it must have strong, axis-aligned rectilinear features), and each page must be written on the same form (although the manually added content of the form may differ).
 problems that commonly occur include: 1. Batches of seemingly related images may differ slightly, 2. Left and right pages sometimes differ in layout. 3. Lens distortion can warp the image in a nonaffine man-4. Nonlinear stretches of small bands of the document can 5. Bleedthrough from the other side of the page can occur, these problems occur in real data sets; however, the extent of such problems is likely to vary widely between data sets. In the random selection of data sets we have presented results for, only one had significant nonaffine distortion (inconsis-tent line spacing). In practice, common small distortions of the document page did not present a problem to achieving a good registration.
 document form differs across different images, see Figs. 17 , 19 ,and 21 , where the printed text in some fields on the form is not always in the same position. Differences in the posi-tions of document lines between document images is worse than differences in printed text, because most transform pa-rameter recovery steps (with the exception of translation) are based only on strongly periodic (linear) features.
 data sets, and it may present somewhat of a problem to regis-tration. Bleedthrough is more likely with the document fore-ground than the document form, and if the bleedthrough is significantly lighter than the ink on the front of the paper, the correct transform parameters are likely to be found regard-less of the present of fainter linear features. This is because the recovery process for each transform parameter chooses the strongest signal in its domain, and ignores the rest of the domain. 6 Future work 6.1 Locally adaptive registration, and addition of a qualitative metric A quantitative metric of registration accuracy could be added that determines what proportion of the black pixels in the pointwise median image are also black in each registered image. This metric would help detect when a specific image did not register well (flagging it for human intervention). To implement this properly, locally adaptive registration would need to be implemented, which snaps edges to the template within some small distance, so that after global affine trans-form correction, small local changes in the image template do not give an unreasonable value for the metric.
 form parameters are wildly out of range, an image should be flagged as badly registered, or other candidate parameter values should be sought instead. (This would also prevent large amounts of memory being allocated in the case of a huge scale parameter being recovered).
 duced, performance of the registration algorithm on a wide range of data sets should be measured, and sources of weak-ness determined. The frequency of nonaffine distortion in real historic data sets should also be investigated. 6.2 Consensus-based registration Currently, registration is a pairwise process, with one image chosen as the base image for registration. (This is, arbitrar-ily, the first image of the set.) A consensus-based approach could be investigated to ensure the base image was not badly chosen. Some kind of clustering algorithm could be used to distinguish the most appropriate image to use as a basis for scale registration, or to divide a set of images into sets of ho-mogeneous documents. It would be worth investigating the use of the quantitative metric described earlier in clustering. 6.3 Median filter parameter selection and optimization Methods for quickly and adaptively determining optimal median filter parameters for a specific image or set of im-ages would be very useful, to ensure high registration qual-ity and low running times. Histogram-based median filtering should be implemented, along with background removal us-ing a lower-resolution version of the image, in order to speed up the background removal stage of preprocessing.
 age would result in decreased accuracy in parameter recov-ery, and while that is generally true, the accuracy may poten-tially increase after bilinear scaling, if the original images were bilevel (thresholded). This is because aliasing artifacts can cause shallow diagonal lines to appear like several long axis-aligned segments, rather than a single diagonal line. It may also be possible to hierarchically increase the resolu-tion during recovery of some of the transform parameters to increase speed. 6.4 Document image compression through image registration Image registration may yield advantages in document image compression. As an initial test, we tried a simple scheme for compressing registered images as described later; further investigation into this technique is needed.
 ter, as in Fig. 17 (bottom), and subtracted this template from each registered image (Fig. 26 ). The resulting image, lacking the template, is approximately 14% smaller than the origi-nal when compressed using bzip2. Presumably, image-based compression algorithms would achieve similar or greater im-provements in compression. In this way, image information which is shared by many pages of a document may be stored once and removed from each page which shares the informa-tion.
 yond removal of the common image template, does not exploit properties of working in the image domain. Fur-ther research would involve locally adaptive registration and cleanup of after subtraction of the document template in or-der to better remove isolated noise after template subtrac-tion. In [ 54 ], a technique known as distance-ordered resid-ual coding is presented which may help in detecting small variations of a registered image from its template, and could be useful in greatly compressing registered images relative to their template.
 ing background removal to eliminate parts of the document with no useful content (such as the page background), or to compress those parts at a much lower spatial resolution. Some promising research has been completed in this field by Huang et. al., who separate a document image into fore-ground and background layers using the top hat transform (i.e. morphological closing) [ 51 , 55 ]. 7 Conclusions We have presented an algorithm for fast registration of tab-ular document images, based on the Fourier X  X ellin trans-form. This algorithm was qualitatively shown to be robust and accurate in aligning real data sets (including 165-year-old census records) consisting of microfilm images with typ-ical amounts of non-affine distortion. The registration sys-tem was also quantitatively shown to perform to very tight tolerances in a simulated data set under random variation in each affine component, and we argue that the combina-tion of qualitative and quantitative results gives good reason to believe this algorithm will perform well in general regis-tration of tabular documents. We suggest a possible method for quantitatively determining performance on real data sets where the true transform parameters are not known (mak-ing accuracy measurements difficult), and describe the ad-ditional work needed to make such a metric predictable and robust.
 introduced, based on the median filter, that overcomes many limitations of the Fourier X  X ellin transform as a tool for doc-ument image registration. Fourier X  X ellin image registration was adapted to exploit properties specific to the problem do-main of tabular image registration, and to deal with all com-ponents of the affine transform in a uniform way, by working in the frequency domain. The Fourier X  X ellin transform was extended to handle shear and anisotropic scaling (with a sep-arate scale factor for horizontal and vertical document axes). This can approximate a small amount of perspective distor-tion. A set of images with significant perspective distortion was shown to register well.
 generation of blank forms was presented, which uses the pointwise median of a set of registered images. A significant new optimization of the median filter was presented, which employs a layer of indirection to reduce the information-theoretic complexity of median filtering. Finally, it was sug-gested that image registration be investigated as a tool for predictive image compression.
 Appendix A.1 New optimization of the median filter A.2 Source code References
