 Artificial Intelligence Research Institute (IIIA) Spanish Scientific Research Council (CSIC) alessandro.farinelli@univr.it Graphical models such as Markov Random Fields (MRFs) have been successfully applied to a wide variety of applications such as image understanding [1], error correcting codes [2], protein folding [3] and multi-agent systems coordination [4]. Many of these practical problems can be formulated as finding the maximum a posteriori (MAP) assignment, namely the most likely joint variable as-signment in an MRF. The MAP problem is NP-hard [5], thus requiring approximate methods. Here we focus on a particular MAP approximate method: the (loopy) max-product belief propaga-tion [6, 7]. Max-product X  X  popularity stems from its very good empirical performance on general known to be correct in acyclic and single-cycle MRFs [11], although convergence is only guar-anteed in the acyclic case. Recently, some works have established that max-product is guarantee to return the optimal solution, if it converges, on MRFs corresponding to some specific problems, namely: (i) weighted b-matching problems [12, 13]; (ii) maximum weight independent set problems [14]; or (iii) problems whose equivalent nand Markov random field (NMRF) is a perfect graph [ ? ]. For weighted b-matching problems with a bipartite structure Huang and Jebara [15] establish that max-product algorithm always converges to the optimal.
 Despite these guarantees provided in these particular cases, for arbitrary MRFs little is known on the quality of the max-product fixed-point assignments. To the best of our knowledge, the only result in this line is the work of Wainwright et al. [16] where, given any arbitrary MRF, authors derive an upper bound on the absolute error of the max-product fixed-point assignment. This bound is calculated after running the max-sum algorithm and depends on the particular MRF (structure and parameters) and therefore provide no guarantees on the quality of max-product assignments on arbitrary MRFs with cycles.
 In this paper we provide quality guarantees for max-product fixed-points in general settings that can be calculated prior to the execution of the algorithm. To this end, we define worst-case bounds on the quality of any max-product fixed-point for any MRF, independently of its structure and parameters. Furthermore, we show how tighter guarantees can be obtained for MRFs with specific structures. For example, we prove that in 2-D grids max-product fixed points assignments have at least 33% of the quality of the optimum; and that for MRFs with large variable-disjoint cycles 1 they have at least 90% of the quality of the optimum. These results shed some light on the relationship between the quality of max-product assignments and the structure of MRFs.
 Our results build upon two main components: (i) the characterization of any fixed-point max-product assignment as a neighbourhood maximum in a specific region of the MRF [17]; and (ii) the worst-case bounds on the quality of a neighbourhood maximum obtained in the K-optimality framework [18, 19]. We combine these two results by: (i) generalising the worst-case bounds in [18, 19] to consider any arbitrary region; and (ii) assessing worst-case bounds for the specific region presented in [17] (for which any fixed-point max-product assignment is known to be maximal). 2.1 The max-sum algorithm in Pairwise Markov Random Fields A discrete pairwise Markov Random Field (MRF) is an undirected graphical model where each in-teraction is specified by a discrete potential function, defined on a single or a pair of variables. The structure of an MRF defines a graph G =  X  V,E  X  , in which the nodes V represent discrete variables, and edges E represent interactions between nodes. Then, an MRF contains a unary potential func-tion  X  s for each node s  X  V and a pairwise potential function  X  st for each edge ( s,t )  X  E ; the joint probability distribution of the MRF assumes the following form:  X  s ( x s ) ,  X ( x s ,x t ) which are well-defined if  X  s ( x s ) ,  X ( x s ,x t ) are strictly positive. Within this setting, the classical problem of maximum a posteriori (MAP) estimation corresponds to finding the most likely configuration under distribution p ( x ) in equation 1. In more formal terms, the MAP configuration x  X  = { x  X  s | s  X  V } is given by: where X N is the Cartesian product space in which x = { x s | s  X  V } takes values.
 Note that the MAP configuration may not be unique, that is, there may be multiple configurations, that attain the maximum in equation 1. In this work we assume that: (i) there is a unique MAP assignment (as assumed in [17]); and (ii) all potentials  X  s and  X  st are non-negative. The max-product algorithm is an iterative, local, message-passing algorithm for finding the MAP assignment in a discrete MRF as specified by equation 2. The max-sum algorithm is the corre-spondent of the max-product algorithm when we consider the log-likelihood domain. The standard update rules for max-sum algorithm are: where  X  ij is a normalization constant and N ( i ) is the set of indices for variables that are connected all messages are initialised to constant functions. At each following iteration, each variable x i aggre-gates all incoming messages and computes the belief b i ( x i ) , which is then used to obtain the max-sum assignment x MS . Specifically, for every variable x i  X  V we have x MS i = arg max x i b i ( x i ) . The convergence of the max-sum is usually characterized considering fixed points for the message update rules, i.e. when all the messages exchanged are equal to the last iteration. Now, the max-sum algorithm is known to be correct over acyclic and single-cycle graphs. Unfortunately, on general graphs the aggregation of messages flowing into each variable only represents an approximate solu-tion to the maximization problem. Nonetheless, it is possible to characterise the solution obtained by max-sum as we discuss below. 2.2 Neighborhood maximum characterisation of max-sum fixed points In [17], Weiss et al. characterize how well max-sum approximates the MAP assignment. In par-ticular, they find the conditions for a fixed-point max-sum assignment x MS to be neighbourhood maximum, namely greater than all other assignments in a specific large region around x MS . Notice that characterising an assignment as neighbourhood maximum is weaker than a global maximum, but stronger than a local maximum. Weiss et al. introduce the notion of Single Loops and Trees (SLT) region to characterise the assignments in such region.
 Definition 1 (SLT region) . An SLT-region of x in G includes all assignments x 0 that can be obtained from x by: (i) choosing an arbitrary subset S  X  V such that its vertex-induced subgraph contains at most one cycle per connected component; (ii) assigning arbitrary values to the variables in S while keeping the assignment to the other variables as in x .
 Hence, we say that an assignment x SLT is SLT-optimal if it is greater than any other assignment in its SLT region. Finally, the main result in [17] is the characterisation of any max-sum fixed-point assignments as an SLT-optimum. Figures 1(b)-(e) illustrate examples of assignments in the SLT-region in the complete graph of figure 1(a), here boldfaced nodes stand for variables that vary the assignment with respect to x SLT . In [18], Pearce et al. introduced worst-case bounds on the quality of a neighbourhood maximum in a region characterized by its size. Similary, Kiekintveld et al. introduced in [19] analogous worst-case bounds but using as a criterion the distance in the graph. In this section we generalize these bounds to use them for any neighbourhood maximum in a region characterized by arbitrary criteria. Concretely we show that our generalization can be used for bounding the quality of max-sum assignments. 3.1 C -optimal bounds Hereafter we propose a general notion of region optimality, the so-called C -optimality, and describe how to calculate bounds for a C -optimal assignment, namely an assignment that is neighbourhood maximum in a region characterized by an arbitrary C criteria. The concept of C -optimality requires the introduction of several concepts.
 Given A,B  X  V we say that B completely covers A if A  X  B . We say that B does not cover A at all if A  X  B =  X  . Otherwise, we say that B covers A partially. A region C  X  P ( V ) is a set composed by subsets of V . We say that A  X  V is covered by C if there is a C  X   X  C such that C  X  completely covers A .
 Given two assignments x A and x B , we define D ( x A ,x B ) as the set containing the variables whose values in x A and x B differ. An assignment is C -optimal if it cannot be improved by changing the values in any group of variables covered by C . That is, an assignment x A is C -optimal if for every assignment x B s.t. D ( x A ,x B ) is covered by C we have that  X  ( x A )  X   X  ( x B ) . For any S  X  E we define cc ( S, C ) = |{ C  X   X  C s.t S  X  C  X  }| , that is, the number of elements in C that cover S completely. We also define nc ( S, C ) = |{ C  X   X  X  s.t S  X  C  X  =  X  X | , that is, the number of elements in C that do not cover S at all. Proposition 1. Let G =  X  V,E  X  be a graphical model and C a region. If x C is a C -optimum then where cc  X  = min S  X  E cc ( S, C ) , nc  X  = min S  X  E nc ( S, C ) , and x  X  is the MAP assignment. Proof. The proof is a generalization of the one in [20] for k-optimality. For every C  X   X  X  , consider for all C  X   X  X  ,  X  ( x C )  X   X  ( x  X  ) holds, and hence:
Notice that although  X  ( x  X  ) is defined as the sum of unary potentials and pairwise potentials values we can always get rid of unary potentials by combining them into pairwise potentials without chang-classify each edge S  X  E into one of three disjoint groups, depending on whether C  X  covers S com-P by definition of x  X  , for every variable x i in a potential completely covered by C  X  we have that x i = x inequality in equation 4, we have that: defined sets cc ( S, C ) and nc ( S, C ) come into play. Grouping the sum by potentials and recall that cc  X  = min S  X  E cc ( S, C ) , the term on the left can be expressed as: Furthermore, recall that nc  X  = min S  X  E nc ( S, C ) , we can do the same with the right term:
After substituting these two results in equation 5 and rearranging terms, we obtain equation 3. 3.2 Size-optimal bounds as a specific case of C -optimal bounds Now we present the main result in [18] as a specific case of C -optimality. An assignment is k -size-optimal if it can not be improved by changing the value of any group of size k or fewer variables. Proposition 2. For any MRF and for any k -optimal assignment x k : Proof. This result is just a specific case of our general result where we take as a region all subsets of plus k  X  2 variables out of the remaining | V | X  2 ). The number of elements in C that do not cover obtain equation 6 by using | V | , cc  X  and nc  X  in equation 3, and simplifying. In this section we define quality guarantees for max-sum fixed-point assignments in MRFs with arbitary and specific structures. Our quality guarantees prove that the value of any max-sum fixed-point assignments can not be less than a fraction of the optimum.
 The main idea is that by virtue of the characterization of any max-sum fixed point assignment as SLT-optimal, we can select any region C composed of a combination of single cycles and trees of our graph and use it for computing its corresponding C -optimal bound by means of proposition 1. We start by proving that bounds for a given graph apply to its subgraphs. Then, we find that the bound for the complete graph applies to any MRF independently of its structure and parameters. Afterwards we provide tighter bounds for MRFs with specific structures. 4.1 C -optimal bounds based on the SLT region In this section we show that C -optimal bounds based on SLT-optimality for a given graph can be applied to any of its subgraphs.
 Proposition 3. Let G =  X  V,E  X  be a graphical model and C the SLT-region of G . Let G 0 =  X  V 0 ,E 0  X  be a subgraph of G . Then the bound of equation 3 for G holds for any SLT-optimal assignment in G 0 . Sketch of the proof . We can compose a region C 0 containing the same elements as C but removing those variables which are not contained in V 0 . Note that SLT-optimality on G 0 guarantees optimality in each element of C 0 . Observe that the bound obtained by applying equation 3 to C 0 is greater or equal than the bound obtained for C . Hence, the bound for G applies also to G 0 .
 A direct conclusion of proposition 3 is that any bound based on the SLT-region of a complete graph structure. In what follows we assess the bound for a complete graph.
 Proposition 4. Let G =  X  V,E  X  be a complete MRF. For any max-sum fixed point assignment x MS , Proof. Let C be a region containing every possible combination of three variables in V . Every set of three variables is part of the SLT-region because it can contain at most one cycle. The development in the proof of proposition 2 can be applied here for k = 3 to obtain equation 7.
 Corollary 5. For any MRF, any max-sum fixed point assignment x MS satisfies equation 7. Since any graph can be seen as a subgraph of the complete graph with the same number of vari-ables, the corollary is straightforward given propositions 3 and 4. Figure 2(a) plots this structure-independent bound when varying the number of variables. Observe that it rapidly decreases with Figure 3: Example of (a) a 3-3 bipartite graph and (b)-(p) sets of variables covered by the SLT-region. the number of variables and it is only significant on very small MRFs. In the next section, we show how to exploit the knowledge of the structure of an MRF to improve the bound X  X  significance. 4.2 SLT-bounds for specific MRF structures and independent of the MRF parameters In this section we show that for MRFs with specific structures, it is possible to provide bounds much tighter than the structure-independent bound provided by corollary 5. These structures include, but are not limited to, bipartite graphs, 2-D grids, and variable-disjoint cycle graphs. 4.2.1 Bipartite graphs In this section we define the C -optimal bound of equation 3 for any max-sum fixed point assignment in an n -m bipartite MRF. An n -m bipartite MRF is a graph whose vertices can be divided into two disjoint sets, one with n variables and another one with m variables, such that the n variables in the first set are connected to the m variables in the second set. Figure 3(a) depicts a 3-3 bipartite MRF. Proposition 6. For any MRF with n -m bipartite structure where m  X  n , and for any max-sum fixed point assignment x MS we have that: Proof. Let C A be a region including one out of the n variables and all of the m variables (in figure 3, elements (n)-(p)). Since the elements of this region are trees, we can guarantee optimality on them. The number of elements of the region is |C A | = n. It is clear that each edge in the graph is completely covered by one of the elements of C A , and hence cc  X  = 1 . Furthermore, every edge is partially covered, since all of the m variables are present in every element, and hence nc  X  = 0 . Applying equation 3 gives the bound 1 /n .
 Alternatively, we can define a region C B formed by taking sets of four variables, two from each set. Since the elements of C B are single-cycle graphs (in figure 3, elements (b)-(j)), we can guarantee when m &lt; n + 3 , and so equation 8 holds (details can be found in the additional material). Example 1. Consider the 3-3 bipartite MRF of figure 3(a). Figures 3(b)-(j) show the elements in the region C B composed of sets of four variables, two from each side. Therefore |C B | is 9. Then, for any edge S  X  E there are 4 sets in C B that contain its two variables. For example, the edge that links the upper left variable ( x 0 ) and the upper right variable ( x 3 ) is included in the subgraphs of figures 3(b), (c), (e) and (f). Moreover, for any edge S  X  E there is a single element in C B that does not cover it at all. For example, the only graph that does not include neither x 0 nor x 3 is the graph of figure 3(j). Thus, the bound is 4 / (9  X  1) = 1 / 2 .
 Figure 2(a) plots the bound of equation 8 for bipartite graphs when varying the number of variables. Note that although, also in this case, the value of the bound rapidly decreases with the number of variables, it is two times the values of the structure-independent bound (see equation 7). 4.2.2 Two-dimensional (2-D) grids In this section we define the C -optimal bound of equation 3 for any max-sum fixed point assignment in a two-dimensional grid MRF. An n -grid structure stands for a graph with n rows and n columns where each variable has 4 neighbours. Figure 4 (a) depicts a 4-grid MRF. Figure 4: Example of (a) a 4-grid graph and (b)-(e) sets of variables covered by the SLT-region. Proposition 7. For any MRF with an n grid structure where n is an even number, for any max-sum fixed point assignment x MS we have that Proof. We can partition columns in pairs joining column 1 with column ( n/ 2) + 1 , column 2 with column ( n/ 2) + 2 and so on. We can partition rows in the same way. Let C be a region where each element contains the vertices in a pair of rows at distance n 2 together with those in a pair of columns at distance n 2 . Note that optimality is guaranteed in each C  X   X  X  because variables in two non-consecutive rows and two non-consecutive columns create a single-cycle graph. Since we take every possible combination, |C| = ( n 2 ) 2 . Each edge is completely covered by n 2 elements and hence cc S at all. Substituting these values into equation 3 leads to equation 9.
 Example 2. Consider the 4-grid MRF of figure 4 (a). Figures 4 (b)-(e) show the vertex-induced subgraphs for each set of vertices in the region C formed by the combination of any pairs of rows in there are 2 sets that contain its two variables. For example, the edge that links the two first variables in the first row, namely x 0 and x 1 , is included in the subgraphs of figures (a) and (b). Moreover, for any edge S  X  E there is no set that contains no variable from S . Thus, the bound is 1 / 2 . Figure 2(a) plots the bound for 2-D grids when varying the number of variables. Note that when compared with the bound for complete and bipartite structures, the bound for 2-D grids decreases smoothly and tends to stabilize as the number of variables increases. In fact, observe that by equation 9, the bound for 2-D grids is never less that 1/3 independently of the grid size. 4.2.3 MRFs that are a union of variable-disjoint cycles In this section we assess a bound for MRFs composed of a set of variable-disjoint cycles, namely of cycles that do not share any variable.
 A common pattern shared by the bounds assessed so far is that they decrease as the number of vari-ables of an MRF grows. This section provides an example showing that there are specific structures for which C -optimality obtains significant bounds for large MRFs.
 Example 3. Consider the MRF composed of two variable-disjoint cycles of size 4 depicted in fig-ure 5(a). To create the region, we remove each of the variables of the first cycle, one at a time (see figures 5(b)-(e)). We act analogously with the second cycle. Hence, C is composed of 8 elements. Just by counting we observe that each edge is completely covered 6 times, so cc  X  = 6 . Since we are removing a single variable at a time, nc  X  = 0 . Hence, the bound for a max-sum fixed point in this MRF structure is 6 / 8 = 3 / 4 .
 The following result generalizes the previous example to MRFs containing d variable-disjoint cycles of size larger or equal to l .
 Proposition 8. For any MRF such that every pair of cycles is variable-disjoint and where there are at most d cycles of size l or larger, and for any max-sum fixed point assignment x MS , we have that: defining a region that includes an element for every possible edge removal from every cycle but one. The proof is omitted here due to lack of space but can be consulted in the additional material. Equation 10 shows that the bound: (i) decreases with the number of cycles; and (ii) increases as the maximum number of variables in each cycle grows. Figure 2(b) illustrates the relationship between the bound, the number of cycles ( d ), and the maximum size of the cycles ( l ). The first thing we observe is that the size of the cycles has more impact on the bound than the number of cycles. In fact, observe that by equation 10, the bound for a variable-disjoint cycle graph with a maximum a cycle is 20 , the quality for a fixed point is guaranteed to be at least 90% . Hence, quality guarantees for max-sum fixed points are good whenever: (i) the cycles in the MRF do not share any variables; and (ii) the smallest cycle in the MRF is large. Therefore, our result confirms and refines the recent results obtained for single-cycle MRFs [11]. 4.3 SLT-bounds for arbitrary MRF structures and independent of the MRF parameters In this section we discuss how to assess tight SLT-bounds for any arbitrary MRF structure. Similarly to [18, 20], we can use linear fractional programming (LFP) to compute the structure specific SLT bounds in any MRF with arbitrary structure. Let C be a region for all subsets in the SLT region of the graphical model G =  X  V,E  X  of an MRF. For each S  X  E , the LFP contains two LFP variables that represents the value of the edge S for the SLT-optimum, x MS , and for the MAP the value of the potentials for x MS and x  X  . Then, the optimal value of this LFP is a tight bound for any MRF with the given specific structure. Indeed, the solution of the LFP provides the values of potentials for x MS and x  X  that produce the worst-case MRF whose SLT-optimum has the lowest value with respect to the optimum. However, because this method requires to list all the sets in the SLT-region, the complexity of generating an LFP increases exponentially with the number of variables in the MRF. Therefore, although this method provides more flexibility to deal with any arbitrary structure, its computational cost does not scale with the size of MRFs in contrast with the structure specific SLT-bounds of section 4.2, that are assessed in constant time. We provided worst-case bounds on the quality of any max-product fixed point. With this aim, we have introduced C -optimality, which has proven a valuable tool to bound the quality of max-product fixed points. Concretely, we have proven that independently of an MRF structure, max-product has a quality guarantee that decreases with the number of variables of the MRF. Furthermore, our results allow to identify new classes of MRF structures, besides acyclic and single-cycle, for which we can provide theoretical guarantees on the quality of max-product assignments. As an example, we defined significant bounds for 2-D grids and MRFs with variable-disjoint cycles.
 Acknowledgments
 Many real-world problems can be represented using a graphical model and formulated as finding the maximum a posteriori assignment ( MAP ).
 Our results build upon two main components: a neighbourhood maximum in an specific region of the graphical model [Weiss and Freeman, 2001] Worst-case bounds on the quality of a neighbourhood maximum , generalization of [Pearce and Tambe, 2007] .  X  e.g.
