 Drausin Wulsin wulsin@seas.upenn.edu Shane Jensen stjensen@wharton.upenn.edu Brian Litt littb@mail.med.upenn.edu Our work is motivated by the structure of clinical in-tracranial electroencephalogram (iEEG) in the con-text of evaluating epilepsy patients for resective brain surgery. Consider a set of patients, each of whom has a number of seizures while being recorded in a hospi-tal X  X  epilepsy monitoring unit. The number of recorded seizures can range widely from only one to over fifty for a given patient, and the iEEG of each is defined by the activity of each recorded electrode channel. The num-ber of channels and their placement can range widely from patient to patient, often with 100-200 individual channels per patient.
 Current clinical practice involves clinicians examining the dynamics of seizures to ascertain important clini-cal factors like how similar (or dissimilar) an individ-ual patient X  X  seizures are to each other. Such informa-tion helps the physicians identify which areas of the brain to remove. Almost all steps of this decision pro-cess are currently manual, performed by neurophysiol-ogy physicians, whose training and decision processes can vary greatly. One might say that this work up to epilepsy surgery is still quite  X  X essy, X  which may help explain the mediocre outcomes of this surgery for extra-temporal lobe surgeries (de Tisi 2011).
 Statistical models can offer decision support for clini-cal questions like  X  X hat are the types of seizures that a patient has X  and  X  X hich other patients is this pa-tient similar to. X  A challenge of the data is that every seizure of every patient is unique, though there are similarities between seizures and patients. Currently, most approaches create models in space or time of a single seizure.
 This approach is not at all similar to a physician X  X  when analyzing a seizure. A physician appreciates that the dynamics of each seizure are unique but does not forget about the other seizures of that patient or even the other seizures of other patients. The other seizures inform the physician X  X  understanding of the current seizure in some way or another. We believe that hierarchical Bayesian models are a good class of models for this problem since they allow for individual models over local data while still allowing global data to have some influence in the model.  X  X onparametric X  Bayesian approaches are also attractive because they reduce the amount of necessary model selection. Comparing seizures between patients is challenging be-cause the number and placement of the iEEG channels is unique for every patient 1 . One approach to this problem is to use features of the data that generalize across an arbitrary number of channels. For example, (Schiff et al. 2005) present six intuitive features that seem to capture global properties of a seizure. While this approach is attractive because it is so straightfor-ward, we believe that it is likely to miss the important dynamics that can occur in just a few channels out of a hundred. In many cases, it is just a few channels that are of most clinical interest to physicians. An alternative approach to this problem is to treat each channel as an i.i.d. sample from an underlying distribution over the space of channel dynamics. In this setting, the number of channels actually present becomes less important, as they can just be thought of as observations from a channel distribution. Due to the complexity of neurophysiologic activity during a seizures, the distribution of channel behaviors will almost certainly be multi-modal. Mixture models are a straightforward approach to such density estimation, and in the case where our channel-features are continu-ous, we may use the familiar Gaussian Mixture Model (GMM).
 We thus are interested in using a nonparametric hi-erarchical Bayesian model that can incorporate some-thing like a GMM at the base level. One such model is the Hierarchical Dirichlet Process (HDP) of (Teh et al. 2006), where the hierarchy affects the weights over a collection of base models (e.g., Gaussians). Yet infer-ence in this model only yields clustering at the base level, i.e., the channels. While such channel clustering is potentially helpful for clinicians, seizure and patient level clustering is more in line with the most impor-tant clinical questions. Ideally, we would use a model that can cluster on all three levels at the same time . Figure 1 depicts such a scenario for 3 toy patients. An-other model, the Nested Dirichlet Process (NDP) of (Rodr  X  X guez et al. 2008), is similar to the HDP but in-volves multiple levels of clustering. The nesting struc-ture of the NDP means that higher-level atoms do not share the same lower-level atoms. In our seizure data application, that would mean that seizures of a differ-ent type would share no channel information, a trait that is unrealistic for multiple seizures, which may globally be  X  X ifferent X  but have subsets of channels that behave very similarly.
 We thus present a new model that in a sense blends the desirable aspects of both the HDP and NDP models. We call this model the multi-level clustering hierar-chical Dirichlet Process (MLC-HDP) because it simul-taneously clusters on multiple levels of a dataset and also retains a hierarchical structure. The novel contri-butions of this work are:  X  a model capable of clustering on multiple levels  X  demonstrations of how the MLC-HDP model sur- X  the ability of the MLC-HDP model to answer Consider again the structure of our epilepsy data 2 given in the schematic in Figure 1. This data has multiple levels on which we assume clustering oc-curs. Each level X  X  clustering can be thought of as a finite collection of atoms, which are multinomial at the higher levels and any arbitrary distribution at the base level. The seizure and patient levels X  X evels 2 and 1, respectively X  X re made up of multinomial atoms that represent priors over the atoms in the level below, so level-2 seizure atoms denote different seizure types, each of which is a prior over the base-atom channel-types. Level-1 patient atoms denote different patient types, each of which is a prior over the level-2 seizure-types.
 Consider a dataset with T patients, each t of which has J t seizures, each j of which has N tj channel ob-servations, which we call x tji  X  R d , where d is the feature-space dimension 3 . We model the observations unique base-distribution atoms with prior measure H (and parameters  X  ) for an arbitrary distribution F , where  X  tji are the parameters of the model, which are equal to those of a unique base-level atom  X  k In the rest of this paper, F is a multivariate Nor-mal with diagonal covariance, F (  X  ) = N (  X  ,  X  2 ) for  X   X  R d ,  X  2  X  R d + . In this paper, we will assume all priors are conjugate and so for our two-parameter Nor-mal base model will use a Normal scaled inverse- X  ( N -Inv- X  2 ) joint prior on  X  and  X  2 for H . See the Sup-plementary Materials for more details on the resulting posterior distribution and its sufficient statistics. For convenience, we use an indicator variable z (3) tji k to describe which base-level atom models channel i  X  X  activity in seizure j of patient t . Superscripts in variables denote the data-level with which they are associated.
 The set of base-atoms {  X  k }  X  k =1 have a corresponding set of stick-breaking priors (which we shall often call weights). In a 2-level HDP model of a single patient X  X  seizures, the parent/root DP G 0 has its weights  X  , and each seizure DP G j has its own set of weights  X  j  X  DP(  X ,  X  ), whose posterior is a balance between the parent DP X  X   X  and the frequency with which the observations of seizure j occur in the various base-level atoms. In our MLC-HDP version of the model, we have a set of multinomial weights atoms, {  X  (3) ` }  X  one of which we select to use for the base-level atom weights for seizure j .
 Each seizure-type atom, a prior over the base atoms, is a sample from a DP, where  X  (3) is a distribution over the positive inte-gers 4 . We let the indicator variable z (2) tj = ` denote which seizure-type patient t  X  X  seizure j belongs to. The patient-type atoms  X  (2) l have a similar construction as do the weights  X  (1) of the patient population over the various patient types. The indicator variable z (1) t = l denotes which patient-type patient t belongs to. Putting it all together, we have where for us H (  X  ) = N -Inv- X  2 ( n 0 ,  X  0 ,  X  0 ,  X  2 this model is equivalent to a standard DP. We de-pict this model schematically by the directed graphical model in Figure 2. 3.1. Notation Our implementation is very similar to the collapsed Gibbs sampler used by (Teh et al. 2006) for the HDP 5 . For convenience, we introduce a counts variable n and a sampled variable 6 m at each level of the model: n `k denotes the number of observations in base-atom k (channel-type) across the seizures in level-2 atom ` , with similar meanings for n (2) l` and n (1) l for lev-els 2 (seizure types) and 1 (patient types), respec-tively; m (3) `k denotes a sampled weight parameter on base-atom k for the level-2 atom ` ; m (2) l` and m (1) l similar. A dot (  X  ) in place of a subscript indicates a marginal count.
 While in theory the number of atoms at each level is infinite, the number that exist at any given point is finite because the number of data points in the model is finite. We thus use K to denote the current num-ber of non-empty base-level atoms, and L (2) and L (1) to denote the current number of level-2 and level-1 atoms. For algorithmic elegance, we sometimes use L (3) in place of K . We also keep an extra, empty atom at each level to represent selecting a new atom, in which case another extra atom is appended to the list.
 We explicitly sample the parameters  X  k = (  X  k ,  X  2 for our K base atoms, where  X  k describes the suffi-cient statistics for each base atom k  X  X  1 ,...,K } and let  X  K +1 describe those for new (empty) atom. The likelihood of x under atom k  X  X  1 ,...,K + 1 } is given as f k ( x ) = N ( x |  X  k ,  X  2 k ).
 For convenience, we denote the collection of channel-activities in a given seizure j of patient t as s tj { x uct of the likelihoods of the individual channel-observations. 3.2. Markov Chain Monte Carlo Sampling One can see from Figure 2 that there are a number of parameters of the MLC-HDP that need to be sampled. We break these variables into three main groups: the atom indicators, z ; the level parameters,  X  and  X  ; and the base parameters,  X  k . An optional fourth step is to place priors on the hyperparameters  X  and  X  and sample values for them as well. Of these steps, the first is usually the most computationally intensive. Below, we briefly summarize each of these four steps. Sampling atom indicators We sample atom indi-Sampling level parameters As previously de-Sampling base parameters Sampling the base pa-Sampling level hyperparameters We sample each A single sampling iteration for the full MLC-HDP proceeds through sampling the atom indicators, the level parameters (and, optionally, also the hyperpa-rameters), and the base parameters. Finally, any non-last empty base-and level-atoms are removed (and the appropriate indicator variables decremented ac-cordingly). The Supplementary Materials give explicit algorithms corresponding to these steps 8 . 4.1. Simulated data To explore some of the properties of the MLC-HDP in a controlled setting and to compare it with a similar model, we ran a 2-level version of it on the same sim-ulated data presented in (Rodr  X  X guez et al. 2008) and implemented the Nested Dirichlet Process model de-scribed in their paper. Briefly, samples were generated from one of four distributions (T1-T4), each of which is a mixture of two to four Gaussians. The parameters of the Gaussians are given in Table 1.
 We used a dataset with 5 samples from each of the four distributions, for 20 samples total. Each sample contained 100 observations from the particular distri-bution. We used the same hyperparameters described in (Rodr  X  X guez et al. 2008). Posterior inference for each model was run over 25 chains, each with a 5000 sample burn in and 10 sample thinning, gathering 400 samples for each chain or 10,000 samples total.
 We found that the MLC-HDP gives better estimates of the four true GMM distributions than the NDP, as shown graphically on the left of Figure 3. The MLC-HDP usually found three top-level atoms, whereas the NDP balanced roughly equally between two and three (supporting the result (Rodr  X  X guez et al. 2008) give in their Figure 3 for J = 20 and n = 100). The density function estimates of both methods for T3 and T4 are thus the same, since those two true distributions are the same except for a small additional mode at x = 10 in the fourth distribution. The Kullback-Liebler diver-gence 9 of the true density function to the estimated density function for each method, shown on the right of Figure 3, also illustrates how the MLC-HDP esti-mates are closer to the true distributions. The major difference between the MLC-HDP and NDP models is the fact that higher-level atoms in the NDP have their own sets of base atoms, whereas higher-level atoms in the MLC-HDP share base atoms. In datasets where different group types may have observations from the same or similar base distributions (e.g., T1 and T2), the NDP must estimate those base distributions inde-pendently for each group-level atom whereas the MLC-HDP estimates benefit from data across all groups. Another difficulty of having separate sub-atoms for each higher-level atom is that the total number of base atoms can quickly become computationally infeasible as the model is extended from two to three or more levels. For example, a modest-sized model of K = 55, ting) would have roughly 67,000 base atoms to sam-ple and calculate likelihoods under, a number we have anecdotally found to be far too large for practical use. 4.2. Human seizures on intracranial EEG We compiled a dataset of 193 intracranial EEG seizure records across 10 randomly-selected patients from the Children X  X  Hospital of Philadelphia. These patients display attributes common in epilepsy datasets in-tracranial EEG: unique electrode placement, large dis-crepancies in the number of seizures per patient, and differences in the number of useable channels within the seizures of a patient. Table 2 describes the number of seizures per patient as well as whether a patient X  X  seizures contain the same number of active electrodes. We extracted all the channel activities 10 from -30 to +90 seconds around the clinically-marked start of each seizure. We calculated a set of simple and intuitive features for each channel: the log 10 power in four clin-ically relevant frequency bands (4-8, 8-13, 13-30, 30-100 Hz) for each channel over the 120 seconds, using a sliding window of 500 ms with 50% overlap. These fea-tures were chosen because they closely resemble what we believe actual epileptologists look at when read-ing EEG. We concatenated the four features at each of the 479 time points to get a 1916-dimensional fea-ture vector for each channel and subsequently reduced it to 5 dimensions using PCA over all seizures of all patients 11 . The advantages of a hierarchical model In our first iEEG experiment, we examined how well the MLC-HDP model generalizes to held-out data com-pared with two standard Dirichlet Process (DP) mod-els 12 . For a given patient t , the models were evaluated after each seizure j , where the seizures j + 1 ,...,J t af-ter j were used as the held out testing set. The three models and their training data are described below M1 The channel-observations from seizures 1 ,...,j of M2 The channel-observations from seizures 1 ,...,j of M3 The same data as M2 is used but organized in the The models were evaluated using the using the condi-tional perplexity ( PP ) (Teh et al. 2006) of the future seizures j + 1 ,...,J t given the assigned base atoms for each channel,
PP ( s j +1 ,..., s J with Lower perplexity values indicate better models. We ran 25 chains each of the three models at each time point j = 1 ,...,J t  X  1. We used used 500 samples for burn in and 20 sample spacing to get 200 samples per chain per time point in each model, or 5000 total samples per time point.
 The results of these experiments for patient B are shown on the left side of Figure 4. Other patients had similar plots. In the DP model with only pa-tient B X  X  seizures (M1), the perplexity of the first two time points is quite high since the model has only the first few seizures as training data, and the subsequent seizures are somewhat to quite different from these. The DP model (M2) with all of the other seizures as training data in addition to those of M1 performs much better in the first few time points, but as M1 has more and more training seizures, its patient-specific model becomes better than the non-specific one (M2). Though it has the exact same training and testing data as the M2 model, the MLC-HDP (M3) model consis-tently performs better than both M1 and M2. We believe these results show the value of employing a hi-erarchical model organization when it is possible and appropriate. Such an organization allows a local model (such as one for a particular patient) to get informa-tion from other, related models (such as those for other patients) without being unduly influenced by them. Characteristics of epilepsy datasets like ours, where the number of seizures can vary widely between pa-tients, make hierarchical models like this particularly appropriate. To our knowledge, this works describes the first ever use in the epilepsy community of hierar-chical models to integrate information across multiple events and subjects. This experiment shows the im-provements such models can have.
 Seizure clustering performance In our second iEEG experiment, we compared the MLC-HDP X  X  seizure clustering (stored in the z (2) tj indicators vari-ables) to those of a board-certified epileptologist and those of a standard DP mixture. Comparing seizures between patients is not exactly straightforward be-cause their channels are located on the brain in com-pletely different configurations. Even seizures of the same patient may have different numbers of active channels from seizure to seizure as some drop in and out (see Table 2). The MLC-HDP solves this problem by defining seizure types as distributions over chan-nel types, so different numbers of channels are accom-modated simply as a different number of observations from a complex, multi-modal density (which for us is a mixture of Gaussians). For models like the DP (which is currently the only alternative for nonpara-metric clustering of seizures), we need features of a seizure that to not depend on the number of chan-nels present. While various metrics have been pro-posed and used in the epilepsy literature, we believe the six features of (Schiff et al. 2005) capture most of the important dynamics of a seizure, namely, the syn-chronization of different areas of the brain and their frequency characteristics during a seizure. These fea-tures were calculated using the same 500 ms time win-dow with 50% overlap. As with the channel features, we concatenated the six seizure features for each time point into a large vector (2874 dimensions) and then reduced them to 20 dimensions, retaining 72.3% of the variance.
 Clustering seizures, even for board-certified epileptol-ogists practicing in the same hospital, is an inherently subjective and uncertain task. We thus had two physi-cians cluster the same 193 seizures in our dataset (in-dependantly from and blind to the MLC-HDP X  X  clus-terings) to get an idea of the potential variability from one human professional to another. For the sake of our subsequent analysis, we arbitrarily chose one to be the  X  X old standard X  (though of course there is no such thing). The results we report do not substan-tially change when the other physician X  X  markings were used as the standard instead. To assess the similarity between two clusterings, we used Rand X  X  C-statistic (Rand 1971), which can accommodate different num-bers and labels of clusters between two assignments of the same N points.
 The average similarities of the DP, MLC-HDP, and human physician seizure clusters to those of the  X  X old standard X  clusterings are shown on the right side of Figure 4. We notice first that the two physicians usu-ally agree most closely with each other, as expected. Second, the MLC-HDP is almost always better than the DP and in some patients is very close to the other physician. In the one patient (patient H) where the MLC-HDP performs worse than the DP, the other doc-tor is even farther from the  X  X old standard X  clustering. This difference results from the methods differing in how much they split the very similar-looking seizures of patient H. The  X  X old standard X  doctor and DP split them less, whereas the MLC-HDP and other doctor split them more.
 We attribute the performance difference between the two models mostly to the fact that the DP simply has a less descriptive form of the data X  X ne that ignores the behavior of individual channels in favor of that of the population X  X han the humans and MLC-HDP. Anecdotally, the physicians both remarked that they sorted the seizures by often looking at the activity of just a handful of prominent channels. This fact, along with the superior clustering results shown in Figure 4, leads us to believe that any approach to modeling seizures must begin by modeling channels and build up from there, as our MLC-HDP does. We believe that the absence of such methods until now explains the non-existence of seizure clustering in the epilepsy literature. We describe a new hierarchical Dirichlet Process vari-ant, the multi-level clustering hierarchical Dirichlet Process (MLC-HDP), that simultaneously clusters on multiple levels of a dataset. In a simulation study we illustrate some advantages of this model over a simi-lar model, the Nested Dirichlet Process. Finally, we demonstrate how the MLC-HDP allows us to build models of seizures that account for the importance of individual channels while also integrating information from many seizures within and between patients. Such a model allows us answer important clinical questions like  X  X ow many seizure types does this patient have? X  and  X  X hat seizures of other patients is this seizure sim-ilar to?, X  questions that to the best of our knowledge have hitherto been unanswerable in the field of quan-titative epilepsy analysis.
 We thank Eric Marsh and Brenda Porter, of the Children X  X  Hospital of Philadelphia, for the contin-uous iEEG records, manual seizure clustering, and helpful discussion as well as Emily Fox for her help-ful ideas and discussion. This work was supported by NIH grants RO1-NS041811, RO1-NS48598, and 5U24NS063930-03, the Julies Hope Award from the Citizens United for Research in Epilepsy, and the Mirowski Discovery Fund for Epilepsy Research.
