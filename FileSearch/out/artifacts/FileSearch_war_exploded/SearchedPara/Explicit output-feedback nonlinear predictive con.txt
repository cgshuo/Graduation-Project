 1. Introduction
Nonlinear model predictive control (NMPC) involves the solution subjecttononlinearsystemdynamicsandstateandinputconstraints
Most recently, an advanced-step NMPC controller with reduced on-line computational costs has been proposed in Zavala and Biegler (2009) .TheNMPCalgorithmsarebasedonvariousnonlinear models.
Often these models are developed as first-principles models, but popular. In this paper we focus on explicit solution of output-feedback NMPC problems based on black-box models.

There exists a number of NMPC approaches based on various black-box models e.g. based on neural network models (e.g. feature of these NMPC approaches is that an on-line optimization needstobe performedinorder tocomputethe optimal controlinput. NMPC implementation is limited to processes where the sampling on-line computational complexity can be circumvented with an explicit approach to NMPC, where the only computation performed on-line would be a simple function evaluation.
 main contributions on explicit MPC, which have appeared in the important. Recently, several approaches to explicit solution of NMPC problems have been suggested. An approach for efficient on-line computation of NMPC for constrained input-affine non-general nonlinear systems with state and input constraints have been developed, based on the multi-parametric nonlinearprogram-ming (mp-NLP) ideas ( Fiacco, 1983 ). It has been shown that for convex mp-NLP problems, it is straightforward to impose toler-be ensured ( Johansen, 2004; Bemporad and Filippi, 2006 ). In
Grancharova et al. (2007a) , practical computational methods to handle non-convex mp-NLP problems have been suggested that not opment and implementation of explicit NMPC. Algorithms for solving mp-NLP problems, including the non-convex case, are that the mentioned methods for explicit NMPC are based on first-principles models of the systems and they assume that the state an approach for off-line computation of explicit stochastic NMPC black-box model (Gaussian process model) has been proposed. In addition to the mentioned methods, there exists another group of approaches for off-line computation of sub-optimal controllers, where the optimal solution is approximated by means of neural Bertsekas and Tsitsiklis, 1998;  X  Akesson and Toivonen, 2006 ).
This paper suggests an approximate mp-NLP approach to explicit systems described by black-box models (NARX models ( Chen and
Billings, 1989) ). In particular, neural network NARX models are applying the approximate mp-NLP algorithm in Grancharova et al. (2007a) .Adual-modecontrolstrategyisproposedinordertoachievean horizon control concept developed in Michalska and Mayne (1993) applyinganLQRinaneighborhoodoftheorigin.TheLQRdesignisbased on an augmented linear ARX model which takes into account the
The following abbreviation and notation will be used in the paper. The nonlinear model predictive control problem based on black-box model will be referred to as BB-NMPC problem. A 0 means that the square matrix A is positive definite. For x
Euclidean norm is J x J  X  some symmetric matrix A g 0as J x J A  X  2. Formulationof theBB-NMPCproblemasanmp-NLPproblem 2.1. Modelling of dynamic systems with NARX models
The black-box identification of nonlinear systems is an area imation theory, estimation theory, non-parametric regression and overview of this topic is given in Sj  X  oberg et al. (1995) . y  X  i  X  1  X  X  f  X  z  X  i  X  , y  X  ,  X  1  X 
Here, L isagivenlag, i denotestheconsecutiveindexofdatasamples by the black-box model, and y is a finite-dimensional vector of parameters. Thus, the function f is a concatenation of two map-observed inputs and outputs and maps them into the finite space of the outputs. The nonlinear mapping from the regressor network is called multilayer perceptron (MLP), which is probably the most frequently considered member of the neural network approximator. This particular choice was subjective. Any other choice of regressor vector composition or any other choice of mapping is possible until it enables satisfactory description of of the paper are not limited to MLP approach only.
 structure (number of layers and units) is determined, the model tion of errors between estimated and measured output signals: E  X  1 2 M et al. (2000) for more details. 2.2. Formulation of the BB-NMPC problem x  X  t  X  1  X  X  h  X  x  X  t  X  , u  X  t  X  X  ,  X  4  X  y  X  t  X  X  g  X  x  X  t  X  , u  X  t  X  X  ,  X  5  X  output vectors, and h : R n R m -R n and g : R n R m -R nonlinear functions. The following input and output constraints are imposed on the system (4) X (5): u min r u  X  t  X  r u max , y min r y  X  t  X  r y max :  X  6  X 
Assume that the dynamics of the nonlinear system (4) X (5) is approximated with an MLP neural network with NARX structure ~ z  X  t  X  X  sured values of the input u and the output y . Thus, ~ z  X  t  X  sented: ^ y  X  t  X  1 j y  X  X  f NN  X  ~ z  X  t  X  , u  X  t  X  , y  X  ,  X  8  X  ~ z  X  t  X  X  ~ z t j t is known and the control inputs u  X  t  X  k  X  X  u one-stepaheadpredictions,whereateachstepthepredictedoutput value is fed back to the regressor vector: y ~ z  X  The following assumptions are made:
A1. There exists u NN st A R m satisfying u min r u NN st y u
A2. y point for the NARX model (8), and Assumption A2 means that it is feasible for (6).

We consider the optimal regulation problem where the goal is to steer the output variable y to the origin by minimizing certain performance criterion. Suppose that a full measurement of the following optimization problem: Problem P1 : V  X  ~ z  X  t  X  X  X  min subject to ~ z t j t  X  ~ z  X  t  X  and : y min r y t  X  k j t r y max , k  X  1 , ... , N ,  X  12  X  u r u t  X  k r u max , k  X  0 , 1 , ... , N 1 ,  X  13  X  y y ~ z  X  J  X  U , ~ z  X  t  X  X  X  possible.
 compact form as follows: Problem P2: V  X  ~ z  X  X  min The BB-NMPC problem defines an mp-NLP, since it is NLP in U is chosen according to the receding horizon policy u ( t )  X  u Z  X f ~ z A R q j G  X  U , ~ z  X  r 0 for some U A R Nm g :  X  19  X  In parametric programming problems one seeks the solution Z the computationally expensive real-time optimization with a simple function evaluation. 3. Approximate mp-NLP approach to explicit BB-NMPC Definition 1 ( Feasibility on a discrete set ). Let Z R q U  X  ~ z  X  is feasible on V Z if G  X  U  X  v i  X  , v i  X  r 0, i In general, the exact solution of problem P2 cannot be found. In ing an explicit piecewise linear (PWL) approximate solution of state-space NMPC problems has been suggested. Here, the approx-imate mp-NLP approach is applied to explicitly solve the output-given only inbrief. Let Z R q be ahyper-rectangle whereweseek to sented as a k  X  d tree. The main idea of the approximate mp-NLP affine regressor feedback associated to a given region Z 0 these points, a local linear approximation ^ U 0  X  ~ z  X  X  K the whole hyper-rectangle Z 0 , is determined by applying the following procedure ( Grancharova et al., 2007a ): sider any hyper-rectangle Z 0 D Z with a set of points V  X f v 0 , v 1 , v 2 , ... , v N 1 g Z 0 . Compute K 0 and g following NLP:
Problem P3 : min subject to G  X  K 0 v i  X  g 0 , v i  X  r 0 , 8 v i A V 0 :  X  21  X  In (20), J ( K 0 v i + g 0 , v i ) is the sub-optimal cost, V corresponding to the close-to-global solution U * ( v The details about the generation of a set of points V computation of a close-to-global solution of problem P2 at these points can be found in Grancharova et al. (2007a) .
After a linear regressor feedback ^ U 0  X  ~ z  X  X  K 0 ~ z  X  g on the set V 0 Z 0 has been determined, an estimate ^ e 0 maximal cost function approximation error in Z 0 is computed as follows: ^ e  X  max
Assume the tolerance e 4 0 of the cost function approximation error is given. Denote with S Z 0 the volume of a given hyper-isusedtocomputetheexplicitapproximateoutput-feedbackNMPC
Algorithm 1. (Explicit approximate BB-NMPC) 1. Initialize the partition to the whole hyper-rectangle, i.e.
P  X f Z g . Mark the hyper-rectangle Z as unexplored. 2. Select any unexplored hyper-rectangle Z 0 A P . If no such hyper-rectangle exists, terminate. 3. Computeaclose-to-globalsolutiontoproblemP2atthecenter
Otherwise, go to step 7. 4. Define a set of points V 0  X f v 0 , v 1 , v 2 , ... , v step 7.
P3 was found, go to step 6. Otherwise, go to step 7.
Otherwise, split Z 0 into two hyper-rectangles Z 1 and Z 2 to step 2. 7. Computethe volume S Z 0 ofthe hyper-rectangle Z 0 .If S mark Z 0 as explored and infeasible and go to step 2. Otherwise, split Z 0 into hyper-rectangles Z 1 , ... , Z N s . Mark Z step 2.

The heuristic rules used to split a region in steps 6 and 7 of the algorithm can be found in Grancharova et al. (2007a) . This algorithm will terminate with a PWL function ^ U  X  ~ z  X  X  X  ^ u
 X  , ^ u of the set Z \ Z f . 4. Design of feedback control law in a neighborhood of the equilibrium
Generally, it will be difficult to guarantee that the local linearization at a nominal equilibrium point of an NN ARX model controller. Here, a dual-mode control strategy is proposed which aims at achieving an offset-free closed-loop response in the presence of bounded disturbances and/or model errors. With this strategy, the control is performed by the explicit BB-NMPC con-troller when the system is far from equilibrium, and by a Linear 4.1. Modelling of dynamic systems with linear ARX models 1994 ): y  X  t  X  1  X  X  A 1 y  X  t  X  X  A 2 y  X  t 1  X  X  X  A l  X  1 y  X  t l  X  X  B thatwillbevalidinaneighborhoodoftheequilibrium y  X  0, u  X  u the considered nonlinear dynamical system (4) X (5). In (23), the of the model (23), the least squares estimation method or the
Glad, 1994 ). 4.2. Design of linear quadratic regulator with integral action (23)tothe origin.In orderto achievean offset-freeperformance,the model (23) is augmented with the following output y int A takes into account the integral regulation error: y int  X  t  X  1  X  X  y int  X  t  X  X  T s y  X  t  X  ,  X  24  X  where T s is the sampling time. Let u e  X  t  X  u  X  t  X  u st extended system with input u e and output y e  X  [ y , y int by the linear ARX model: y e  X  t  X  1  X  X  A e 1 y e  X  t  X  X  A e 2 y e  X  t 1  X  X  X  A e l  X  1 l +1. Here, I p is the p -dimensional identity matrix, 0 p ~ z e  X  t  X  X 
This regressor vector can be also represented as ~ z e  X  t  X  X  X  z z 2  X  t  X  , ... , z l  X  l  X  1  X  t  X  , where z 1 ( t ), y , z between these elements are y e  X  t  X  1  X  X  z 1  X  t  X  1  X  , z 1  X  t  X  X  y e  X  t  X  X  z 2  X  t  X  1  X  , z 2  X  t  X  X  y e  X  t 1  X  X  z 3  X  t  X  1  X  , ^ z l  X  t  X  X  y e  X  t l  X  1  X  X  z l  X  1  X  t  X  1  X  , z l  X  1  X  t  X  X  y e  X  t l  X  ,  X  27  X  u e  X  t  X  X  z l  X  2  X  t  X  1  X  , z l  X  2  X  t  X  X  u e  X  t 1  X  X  z l  X  3  X  t  X  1  X  z l  X  3  X  t  X  X  u e  X  t 2  X  X  z l  X  4  X  t  X  1  X  , ^ z l  X  l  X  t  X  X  u e  X  t l  X  1  X  X  z l  X  l  X  1  X  t  X  1  X  , z l  X  l  X  1  X  t  X  X  u e  X  t l  X  :  X  28  X 
Then, the system (25) can be represented: ~ z e  X  t  X  1  X  X  ~ A e ~ z e  X  t  X  X  ~ B e u e  X  t  X  :  X  29  X 
For l 4 0, the matrices ~ A e and ~ B e in (29) are given by ~
A  X  2 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 4 ~
B
In (30) and (31), I 2 p and I m are identity matrices, 0 2 p dimensions 2 p m and m 2 p , respectively. If l  X  0, then and ~ B e  X  B e 1 .

The unconstrained LQR problem for system (29) solves the following optimization problem: min law: u  X  t  X  k  X  X  K ~ z e  X  t  X  k  X  , k Z 0 ,  X  33  X  where the controller gain matrix K is given by Ogata (1995) :
K  X  X  ~ B eT P ~ B e  X  R e  X  1 ~ B eT P ~ A e :  X  34  X  equation ( Ogata, 1995 ):
P  X  ~
A the control input applied to the system is u  X  t  X  k  X  X  K ~ z e  X  t  X  k  X  X  u st , k Z 0 :  X  36  X  4.3. Explicit dual-mode controller
Consider the closed-loop system: ~ z  X  t  X  k  X  X  X  ~ A e ~ B e K  X  ~ z e  X  t  X  k 1  X  , k Z 0 ,  X  37  X  related by ~ z  X  t  X  X  and I p ,0 p , I m ,0 m are defined above. Let G 1  X f ~ z A R q with g 1 A R q , g 1 4 0 and G 2  X f ~ z A R q j g 2 r ~ z r g the relation (38)) is a sufficiently accurate prediction of the dynamics of the nonlinear system (4) X (5) and the following conditions are satisfied: ~ z  X  t  X  k  X  A G 1 , k 4 0 ,  X  39  X  y min o  X  I p 0 p ... 0 p 0 m ... 0 m ~ z  X  t  X  k  X  o y max u min o K ~ z e  X  t  X  k  X  X  u st o u max , k Z 0 :  X  41  X  follows: u 9 performed bythe explicit BB-NMPCcontrollerwhen the systemisfar fromequilibrium,while the expressionsinthe secondandthirdrows set G 2 andtheLQRwillcontinuecontrollingthesystemafterwards.It ~ z (40)and(41),itisalsoobservedthattheoutputandinputconstraints never become active for the closed-loop system (37). 5. Design of an explicit output-feedback NMPC for regulation of a pH maintaining system
The dual-mode approach to explicit output-feedback NMPC, described in the previous two sections, is applied to design an explicit NMPC for regulation of a pH maintaining system. The mp-NLP approach to processes which are modelled with higher 5.1. The pH maintaining system
A simplified schematic diagram of the pH maintaining system ( Q constant. The effluent pH is the measured variable, which is controlled by manipulating the base flow rate.

In Henson and Seborg (1994) , a dynamic model of the pH maintaining system is derived, which is given in details in
Appendix A. The following state, input and output variables are defined ( Henson and Seborg, 1994 ): x  X  X  W a 4 W b 4 h 1 T , u  X  Q 3 , y  X  pH ,  X  43  X  ( Henson and Seborg, 1994 ): _ x  X  ~ f  X  x  X  X  ~ g  X  x  X  u ,  X  44  X  c  X  x , y  X  X  0 ,  X  45  X  5.2. ARX model identification 5.2.1. Neural network ARX model identification
The identification and the validation of the NN model of the pH designed to keep the level h 1 on the nominal value h 1 * dynamics, necessary for sampling time and regressor vector estimation of the dominant time constant and settling time. The dominant time constant was estimated in range between 65 and dynamics is necessary for the estimation of appropriate sampling time. Based on responses and iterative cut-and-try procedure, a was generated from a uniform random distribution and a rate of change of the signal of 50 s. The validation signal was obtained then it should respond well to a signal with less components.
The NN model represents a NARX model of the form (7) X (8). The one and is common to all black-box modelling approaches. The number of regressors (delayed inputs and outputs) was determined by the method described in He and Asada (1993) . A trade-off between modelling error and complexity was taken into the account.Thefinalselectionwasthatthesystemmodelhastheform: y  X  t  X  1  X  X  f NN  X  ~ z  X  t  X  , u  X  t  X  , y  X  ,  X  46  X  ~ z the developed black-box model describes the specified operating maintain the pH at value 4.8 (a pH maintaining system). The data of its performance were scaled to zero mean and variance 1. values.
 was optimized for each possible number of hidden neurons in a certain range. The Levenberg X  X arquardt method was used for procedure and after removing the unimportant weights, the optimal parameters of the model (46) X (47) were obtained, with thirteen neurons in the hidden layer. More about systematic network structure selection, pruning and other issues regarding neural networks modelling can be found in various literature 2000; Chen et al., 1990; He and Asada, 1993; Han et al., 1996; Principe et al., 2000; Venkatasubramanian and McAvoy, 1992 ). input signals. From the validation, it can be concluded that the black-box model captures the dynamics of the pH maintaining system relatively well. The resulting black-box model is not too selected software tool. 5.2.2. Linear ARX model identification
The equilibrium point of the pH maintaining system (the model model near this point clearly shows that it is not accurate (see Fig. 3 ).

In order to obtain accurate predictions when the output variable is close to zero, the following 1-st order linear ARX model is identified:
Higher order linear ARX models have been also obtained, however, simulations have shown that the dynamics of the pH maintaining system around the equilibrium is captured best by the 1-st order model (48). The simulated response of the ARX model (48) is depicted in Fig. 3 . 5.3. Design of explicit dual-mode controller
The approach described in Sections 3 and 4 is applied to design an explicit dual-mode controller for the pH maintaining system negative values.
 First, Algorithm 1 is applied to design an explicit approximate
BB-NMPC controller. The following control input constraint is imposed on the system: 0 : 4 r u r 0 : 4 :  X  49  X  y cost function (17) subject to the model (46) X (47) and the con-tion tolerance is chosen as e  X  Z 0  X  X  max  X  e a , e r min
Totally, 33 arithmetic operations are needed in real-time to compute the control input (23 comparisons, 5 multiplications and 5 additions).

Further, an unconstrained LQR is designed, which is used in a model (48): y  X  t  X  1  X  X  0 : 7704 y  X  t  X  X  0 : 0539 u e  X  t  X  ,  X  51  X  y int  X  t  X  1  X  X  y int  X  t  X  X  T s y  X  t  X  :  X  52  X  ~ z  X  t  X  1  X  X  ~ A e ~ z e  X  t  X  X  ~ B e u e  X  t  X  ,  X  53  X  which is characterized with regressor vector ~ z e  X  t  X  X  y  X  y  X  t  X  , y int  X  t  X  and matrices ~ A e  X  X  0 : 7704 T s puted LQR law for the system (53) is u This control law solves the optimization problem (32) with weighting matrices Q e  X  diag {10, 0.0005}, R e  X  10.
Then, the explicit dual-mode controller for the pH maintaining system is defined according to (42) with G 2 G 1  X f ~ z A ~ z r g 1 g , g 1  X  X  0 : 20 : 60 : 70 : 40 : 4 .
 Table 1 shows statistics about the performance decrease e well as the error e u in the control input with the approximate (measured in percentage) of the sub-optimal cost function and ones (respectively, V  X  ~ z  X  and u  X  ~ z  X  X  :  X 
In order to study the robustness of the explicit dual-mode ~ Q 2  X  0 : 53 ml = s (different from the nominal values Q 1 * Q  X  0.55 ml/s). In addition to the explicit dual-mode controller which maintains the pH on the required set point, a second controller (an LQR) is applied, which keeps the liquid level h The obtained trajectories of the control input u and the output rate Q 4 and the liquid level h 1 are depicted in Fig. 5 .
Itcan be seenfrom Fig. 4 thatthe outputvariable issteered tothe that the equilibrium value corresponding to the nominal model how the exact NMPC and the approximate explicit NMPC trajec-tories in Figs. 4 and 5 are obtained. The exact NMPC response is computed by solving at each time instant of an open-loop NMPC problem formulated for the first-principles model (44) X (45). In off-line as an approximation to problem P1, in which the NN ARX 0  X 0.2  X 0.15  X 0.1  X 0.05 0.05 0.1 0.15 model by itself represents another approximation. Then, its per-formance is simulated in closed-loop with the first-principles model (44) X (45). Thus, the performance degradation far from the origin is due to the approximations in the model and in the NMPC solution, while near the origin it is related to the use of LQR (pursuing an offset-free response) which differs from the exact performance degradation being representative for other initial conditions and scenarios. 6. Conclusions
In this paper, an approximate mp-NLP approach to explicit solution of output-feedback NMPC problems for constrained non-linear systems, based on black-box models, is developed. In particular, neural network ARX models are considered, but the approach can be easily applied to nonlinear systems modelled by
The approach is illustrated by designing an explicit dual-mode controller for a pH maintaining system. Simulation results show the output variable to the origin. The off-line computational complexity with the suggested approach could be circumvented 2009 ).

Appendix A. First-principles model of the pH maintaining system using conservation equations and equilibrium relations ( Henson for the tank outlet flows. Modeling assumptions include perfect mixing, constant density, and complete solubility of the ions involved. The model is presented briefly below according to Henson and Seborg (1994) .
 H 2 CO 3 ! HCO 3  X  H  X  ,  X  56  X 
HCO 3 ! CO  X  3  X  H  X  ,  X  57  X  0.4 0.35 0.3 0.25 0.2 0.2 -0.2 -0.4 -0.6 -0.8 -1 -1.2
H O ! OH  X  H  X  :  X  58  X  The corresponding equilibrium constants are
K  X   X  HCO 3  X  H
The chemical equilibria is modelled by defining two reaction Seborg, 1994 ):
W  X  X  H  X  i  X  OH i  X  HCO 3 i 2  X  CO  X  3 i ,  X  60  X 
W  X  X  H 2 CO 3 i  X  X  HCO 3 i  X  X  CO  X  3 i :  X  61  X 
The invariant W a is a charge related quantity, while W b
W and W b usingthefollowingrelations( HensonandSeborg,1994 ):
W pH  X  log  X  X  H  X   X  :  X  63  X 
In Henson and Seborg (1994) , a simplified model of the pH maintaining system is developed, where the dynamics of the pH transmitter and the flow dynamics of tank T 2 are neglected. The mass balance on tank T 1 yields:
A dh dt  X  Q 1 e  X  Q 2  X  Q 3 Q 4 ,  X  64  X 
T . The exit flow rate Q 4 is modelled as
Q  X  C v  X  h 1  X  l  X  s ,  X  65  X  where C v is a constant valve coefficient, s is a constant valve
T and Seborg, 1994 ):
A h
A h
Based on the above relations, a state space model of the pH maintaining system is obtained by defining the following state, input and output variables: x  X  X  W a 4 W b 4 h 1 T , u  X  Q 3 , y  X  pH :  X  68  X 
The state space model has the form ( Henson and Seborg, 1994 ): _ x  X  ~ f  X  x  X  X  ~ g  X  x  X  u ,  X  69  X  c  X  x , y  X  X  0 ,  X  70  X  where ~ f  X  x  X  X  c  X  x , y  X  X  x 1  X  10 y 14 10 y  X  x 2  X  1  X  2 10 K , K 2 in (72) is K The parameters of the model (69) X (73) are given in Henson and Seborg (1994) .
 References
