 As the integration of photovoltaic (PV) power plants into the electricity net-work becomes increasingly prevalent, utilities and grid operators confront major challenges in maintenance and regulation stemming from the variability of solar irradiance largely due to atmospheric interference (cloud and aerosol contents). Within one minute, the ground solar irradiance can decrease more than 80%, causing drastic drops in power output (see example in Figure 1 ), and such rapid fluctuations can be constantly observed. Therefore, reliable short-term solar irra-diance forecasting is the basis to control the usage of auxiliary systems such as batteries and gas generators [ 1 ].
 beam and a diffuse component, is an important indicator for PV power pro-duction. Current GHI forecasting methods can be categorized into two classes: statistical or physics based models. Statistical models use historical GHI data to train models such as ARMA [ 2 ] and ANN [ 3 ] to predict future irradiances. These tend to ignore physical atmospheric phenomenon, such as cloud micro-physics and their interactions, and only showed a marginal improvement over the benchmark persistent model (PM), which directly uses the present irradiance as the prediction. On the other hand, physics based models, such as Numerical Weather Prediction (NWP), utilize meteorological observations and measure-ments with wind, temperature, and humidity as key variables [ 4 ]. While NWP is preferred for forecast horizons of six hours or beyond, cloud imagery based techniques (satellite or ground-based) produce more accurate short-term fore-casts by propagating cloud movement into the future. Ground-based sensors with high spatial and temporal resolution, such as a Total Sky Imager (TSI) or Whole Sky Imager (WSI), are ideally suited to capture the local cloud variation for intra-hour predictions [ 5 ]. Deterministic methods were subsequently adopted as the standard approach, where the prediction is simply determined by the amount of cloud cover in the predicted sky image [ 6  X  8 ]. However, they overlook the correlated nature of time series data (temporal) and the strong dependence on environmental variables (spatial).
 With the support of cloud imagery, a stochastic model, rooted in observa-tional data and accounts for temporal dependency, is hence ideal for capturing the intrinsically non-deterministic nature of irradiance fluctuations. From the theoretical end, a Markov process was used to simulate the stochastic behav-ior of sunshine and cloud cover with respect to irradiance [ 9 ]. In practice, the Hidden Markov Model (HMM), which is widely used in natural language pro-cessing (NLP) tasks, made its first appearance in daily GHI prediction using temperature as observations and irradiance as hidden states [ 10 ]. In this paper, we are the first to propose a stochastic solar irradiance forecast-ing framework using Conditional Random Fields (CRFs). It accommodates a rich set of overlapping, interdependent and multi-granularity features, which boost performance over HMM. We estimate the cloud motion and extract features from the predicted TSI images, to provide a better context of the future than only historical statistics. Therefore, given the historical and predicted observation sequence, CRFs can output the most probable sequence of irradiance levels. Similar to making distinctions between appearances of identical phrases within different contexts in NLP, CRFs distinguish subtle variations of different com-binations of features in our application. In this paper, we make the following contributions : 1. Stochastic Modeling Framework. We examine the stochastic nature of 2. Correlated-Feature Engineering. We design a novel feature set that har-3. Systematic Evaluation. We implement a complete framework and evalu-imagery, the features we extracted from images, historical statistics, and mete-orological measurements. Section 3 contains a brief overview of the theory and application of the Linear-Chain CRF model, and other models for comparison. In Section 4 , we explain our experiment setup and model specifications, report our experimental findings and compare the performance of both stochastic and non-stochastic models. Finally in Section 5 we summarize our work. 2.1 Problem Setting and Related Work GHI consists of Direct Normal Irradiance (DNI), the solar beam component, and Diffuse Horizontal Irradiance (DHI), which emanates from the sky. The for-mer corresponds particularly to the interference of clouds on the optical path of sunlight, and the latter is rather a result of more complex atmospheric factors. The challenge of sky imaging based prediction is to accurately correlate image pixel values to irradiance for intra and inter-hour prediction over a location of interest. Satellite images are not suitable for very short-term irradiance predic-tions since they are taken every 30 minutes over a large area. TSI images of the hemispherical sky (see example of Figure 2(a) ) have a much higher spatial (sub-kilometer) and temporal (seconds) resolution to reflect the complexity of local meteorological conditions.
 tly: Fu et al. [ 12 ] solely made use of historical cloud features extracted from the sky imager and predicted GHI several minutes ahead via linear regression. Another class of methods calculates cloud velocity vectors allowing for the for-ward propagation of clouds [ 7 ]. Deterministic forecasting methods based on the predicted level of cloud cover in images often relies heavily on the robustness of the cloud motion estimation under the assumption that cloud cover is the only predictor of GHI.
 In our framework, we carefully analyze and examine TSI images with regards to their correlations with GHI and propose the use of stochastic modeling to utilize features that interdependently reflect complex atmospheric conditions. The inherent flexibility of this model allows us to introduce new features such as historical statistics of irradiance and meteorological measures, which are the key inputs of the existing time series models, creating a synergistic improvement on solar irradiance predictions. 2.2 Feature Engineering We process a TSI image dataset collected over a two-month period in the summer of 2014 from the Long Island Solar Farm (LISF). Corresponding irradiance and meteorological data were retrieved from the same location. We then carefully analyze and construct a combined set of features extracted from these sources. The full feature set is provided in Table 1 . These features are categorized by two aspects according to the time and type.
 Imagery-based Features. Figure 2 outlines our TSI image processing pipeline [ 13 ] that serves as a crucial step in our stochastic modeling framework. A nar-row strip on the TSI mirror, termed shadowband, blocks the intense sunlight and casts a band from the image center to the perimeter ( 2(a) ). The sun X  X  position can be located on the image geometrically. We first sample the image streams to discover meaningful cloud movement and undistort each frame from the curved optical surface to a horizontal plane ( 2(b) ). We then determine the cloud cover ( 2(c) ) and motion vectors for each cloud segment using cross correlation algo-rithms between consecutive images ( 2(d)2(e) ). To produce a predicted sky image, the cloud movements are propagated to various future time points.
 RBR indicates the presences of clouds and is negatively correlated with GHI. The spread of the data points, however, indicates the variance of cloud color. Another suitable attribute, cloud cover (Cc), shows a similar negative trend, yet it is more of a global statistic 3(c) . Cloud motion vectors at the sun X  X  vicinity derived from the image processing pipeline suggest potential irradiance fluctuations. Therefore we incorporate the sum, number and mean quantity of motion vectors (mv mv count ,mv mean ) in the feature sets. The shadowband brightness (SBbr) directly corresponds to DNI, a component of GHI. In order to retain enough complexity for better representation of various types of weather, we compare and select additional features such as the maximum and minimum blue channel value of an image (b max ,b min ), and the image intensity (int).
 to extract not only historical statistics but also from the predicted cloud images as well. Thus, imagery-based features in Table 1 are categorized into Historical Statistics such as mean and variance, and Propagated . Irradiance-based Features. Figure 3(a) displays a strong autocorrelation of adjacent 1-3 min irradiance of a typical cloudy day. Thus, we use the current irradiance measurement as a feature (rad( t  X  1)), which is also the basis for the benchmark, PM. In addition, the change in irradiance from time t t  X  1 ( X rad( t  X  1)) provides information on the trend, discretized to rising , falling , and unchanged . We also examine the extraterrestrial horizontal irradiance (EHI), which is atmospherically attenuated to GHI. The difference between EHI and GHI has been reported to be related to fluctuating weather conditions [ 3 ], and thus we adopted both the 5-min integral of the calculated difference (Diff and its third-order derivative (Diff derv ) as features.
 Meteorological-based Features. Meteorological measurements provide gen-eral weather attributes, and we collected the relative humidity (RH( t panel temperature (Temp panel ), and surface air temperature (Temp LISF. In this Section, we propose the stochastic models for the short-term solar irra-diance prediction (minutes ahead). First we introduce two stochastic models, the Linear Chain Conditional Random Field (CRF) model [ 14 ] and Hidden Markov Model (HMM). For comparison, we explain non-stochastic baseline mod-els. Section ( 4 ) will provide the detailed performance comparison among all mod-els introduced here. 3.1 Stochastic Modeling Linear-Chain Conditional Random Field. Conditional Random Field bel-ongs to the discriminative probabilistic models [ 14 , 15 ]. It is encoded by a bi-partite graph (Figure 4 ). As the name suggests, there are two types of nodes in the graph, one for the set of factors denoted as F (shaded boxes), the other for random variables denoted as V (circles). The graph is denoted by G =( V, F, E ). The edges E reflects the probabilistic dependency of factors F on elements of V . CRF directly models the conditional probability distribution P ( y ping, multi-granularity and non-independent features are involved. Both input x  X 
X (dark circles) and output y  X  Y (light circles) can be treated as real valued random variables, while in (Figure 4 ) V = X  X  Y includes both. labeled x A and y A for A  X  V .
 The normalizing factor is the partition function Z that sums over all configura-tions of y A . X  A ( x A , y A )  X  R + has the following form where  X  Ak are real valued parameters and f Ak ( y A , x A functions. In the experiments, the values of  X  Ak can be obtained by maximizing the log-likelihood using training data.
 bility distribution where Z ( x ) is an instance specific normalization function { 1 ,t } and the output y at { t  X  1 ,t } . This aspect of linear-chain CRF is similar to that of HMM.
 sample training data. If we use N sets of sample data, ( x each set forming a time sequence over t =1 , 2 ,...,T , the overall likelihood is form in the probability distributions, (  X  ) is a concave function, and each local optimum is also a global optimum.
 such as L-BFGS algorithms [ 16 , 17 ], which requires the marginal distributions p ( y t  X  1 ,y t | x t ). For Linear-chain CRF, distributions p ( y using the recursive backward-forward algorithms (for details see [ 18 ]). One finds where  X  t and  X  t are the forward and backward recursions, namely which are computed by The combination of L-BFGS and backward-forward algorithms then furnishes our training algorithm package, allowing statistical inference of the sample data. For forecasting, we use the dynamic programming algorithm to estimate the Viterbi path of a sequence of features x which maximizes the probability Each recursion gives us a prediction to the event for next step. Multistep fore-casting can be similarly achieved [ 19 ], leading to the predictions of 1-, 2-, and 5-minutes ahead.
 Hidden Markov Model. HMM is a canonical probabilistic model for sequen-tial or time series data that considers not only considers the transitions of the value in the sequence, but also introduces a corresponding dependent sequence of events. It is well known that HMM can be recast in a CRF form shown as follows: where, f ( y delta function, S stands for the space of all hidden states,  X  sition probability between two states and  X  jo for the emission probability. Note that we limit the feature functions to be binary indicator functions for both one state transition and one output emission instead of K real values with the state transitions. HMM models joint probability instead of conditional probabil-ity, which leads to these differences in the feature functions between the general CRF and HMM. The statistical inference algorithms for HMM are similar as the aforementioned Linear-Chain CRF. Historically, these inference algorithms were in fact first developed for HMM. In summary, HMM is a highly restricted Linear chain CRF model with a single feature function, which captures the RBR dependence, but no other useful features are used from TSI images.
 3.2 Non-Stochastic Models For comparison to the stochastic models, we also consider two non-stochastic models as our baselines. First, our baseline Persistent Model (PM) is a valid benchmark in the solar forecasting field [ 11 ]. Next, a straightforward extension of PM is to combine all terms with linear relationships, also known as Linear Regressions (LRs).
 Persistent Model (PM). The baseline persistent model (PM) assumes that the irradiance at time t is best predicted with its value previously observed at time t  X  1. Therefore, PM contains only one feature rad ( t set aforementioned in Section 2.2 : Recent studies have shown that this baseline is very difficult to beat for forecasts of GHI and DNI within 15 minutes [ 7 , 8 , 11 ].
 Linear Regression (LR). The Linear Regression (LR) model gives a linear relation between solar irradiance and the features introduced in the Linear-Chain CRF. We have We then minimize the objective function where w is the weight coefficient vector, b is an intercept, X is an N k is a regularization parameter. With the l 2-norm of the second term, the linear regression is also called Ridge Regression. k controls the degree of regularization and it helps the learned model from being overfitted.
 the sun in the image is the most direct indicator of cloud conditions and highly correlated with irradiance. We subsequently combine the persistent model (PM) with the extracted RBR feature as LR 2 which uses two features, rad ( t RBR ( t ). We then expand LR 2 to LR all , which incorporates all candidate features. Note that LR does not consider a sequence of predictions together. Although we incorporated the previous time stamp irradiance values as a feature, it solely focus on the current state prediction and prior or later prediction could not affect the current status. So, non-stochastic model is myopic compared to CRFs. In this Section, we present strong experimental evidence that the stochastic multi-feature CRF model outperforms all the other models, including Linear Regression, Hidden Markov model and Persistent Model. 4.1 Experimental Setup and model specification Our experimental data set consists of 345,600 raw TSI images and corresponding Pyranometer recordings for 24 days gathered at the LISF (Long Island Solar Farm), from April to August of 2013. The TSI images are received once per second, and sampled every 20 seconds to produce effective and accurate motion estimation. The length of our sample data sequence is T = 5760, obtained by uniformly sampling predicted images every minute from 10:00 am to 14:00 pm on each experiment day. Corresponding meteorological data from this location is retrieved from the LISF station. We included all cloud conditions which represent all weather types. Compared to average annual weather statistics, our dataset includes a smaller percentage of overcast and clear sky, and a larger fraction of the fluctuating weather conditions. It is therefore more difficult to predict, which is where the real challenge of solar irradiance forecasting lies. We evaluate the prediction performance using mean-absolute-error (MAE) and ran 24 fold cross validations to tune model parameters and evaluate performances.
 For CRF, we included all feature types shown in Table 1 for every timestamp. Since we could not see the future data in real time forecasting, we separate the sequence T into short segments of length n = 5, which imitates the real-time forecasting of 1-5 minutes ahead respectively. Recall the features we introduced in Section 2 : { x } = { rad( t  X  1) ,  X rad( t  X  1) , Diff To be comparable to the HMM features, we discretize the numerical features into categorical data. Regarding the output variable, irradiance readings are also discretized, and each value is mapped to an integer if the value falls in the corresponding interval. We tested different discretization levels (number of states), including n S =5 , 10 , 15 , 20 , 40 states and the best result was obtained with 10 states. We also tested with different feature combinations from Table 1 , which will be compared later. 4.2 Model Performance Comparisons The results of the different models are shown in Figure 5 . The performance of baseline PM is sensitive to cloud variability and decreases with respect to time span.Our stochastic models CRF and HMM show an average of 36% and 16% improvement, respectively, over the baseline PM and maintain a quite stable performance even with an increased prediction time span. Even though for a one minute prediction, HMM does not perform as well as PM or LR, but its per-formance is relatively constant throughout the 1-5 minute predictions. The LR model on the other hand, deteriorates quickly as the forecast horizon increases. LR all shows a similar trend as PM, while LR 2 particularly stands out for one minute predictions by taking advantage of the key features and the simplicity of the modeling. It merges with LR all after 3 minutes. CRF performs the best, or second best, for 1-5 minute predictions, and is consistent as the forecasting horizon expands.
 formance is achieved using a combination of Irradiance-based and Imagery-based features (1 , 3 , 4). Imagery-based features alone (3 , 4) cannot provide sufficient information about the previous trend of GHI, but Historical statistics features (1 , 2 , 3), on the other hand, do not include information on future cloud move-ment, and thus both showed less accuracy. Note that Meteorological-based fea-tures are generally useful proxies for longer term predictions which involve more seasonal changes and tend to introduce noise to our short-term predictions. different number of states. CRF finds the best result at 10 states and HMM at 15 states. Both of them suffer from a small number of states which increases discretization error, and a large number of states where models require a larger amount of training datasets.
 distribution of the difference  X GHI between the forecasted and measured solar irradiance. The peaks at zero for the CRF are higher than other models, and it has a smaller dispersion over the non-stochastic models. Within CRF model achieves an accumulated precision of roughly 80%.
 the 5-minute forecasted GHI with the ground measurement using CRF. Under such cloudy conditions, PM shows noticeable shifting effect for 5-minutes fore-cast, missing apparent spikes, and thus has a limited utility for grid operators. Both HMM and CRF cover the correct range of values for the measured irradi-ance from the pyranometer, while LR either over-predicts or under-predicts the solar irradiance. HMM captured all the large spikes but suffers from the lack of varying features to resolve finer changes. CRF is able to catch most of the fluctuations, and is more responsive to minor variations in irradiance compared to all the other models. In this paper, a novel framework of short-term (1  X  5 minute scale) solar irradi-ance forecasting based on Linear-Chain Conditional Random Field was proposed and evaluated. Our stochastic model can integrate a rich array of correlated TSI features from the cloud patterns to cope with the stochastic nature of irradiance fluctuation. The combination of historical statistics and cloud images from the TSI synergistically improves prediction performance. The experimental results showed that the CRF model demonstrated significant improvements over the baseline models in terms of the MAE measurement metrics, reduced the fore-casting discrepancy distribution, and generated a high-precision prediction. In particular, the averaged error rate for 1  X  5 minute predictions of the CRF model, measured with the MAE score, is 36% on average less than the baseline persistent model (PM).

