 Nowadays, most people are equipped with mobile devices that are able to acquire their real-time positions. This technical progress leads to the emergence and popularity of geo-social networks (GSN) such as Bikely and Foursquare. What is attractive in GSNs is that people can share their locations with their friends. For example, photos and videos can be tagged by their shooting places. Even the traditional on-line social net-works, e.g., Google+ and Facebook, have al so upgraded to support location sharing. With GSNs becoming popular, an enormous number of locations have been posted and accumulated into large datasets of users X  movements. This access to users X  mobility history offers an opportunity to improve the friend recommendation service of GSNs because a user X  X  historical movements signifi cantly reveal his personal interests [1, 2]. Thus, recommending friends with similar interests can be supplemented by finding peo-ple with similar movements.

One method to identify users with similar movements is to construct and compare their mobility profiles which are composed of their trajectory patterns [3]. Intuitively, a trajectory pattern is a sequence of places of interest which a user frequently visits. The frequency by which the pattern is followed is called its support value . For instance, every morning Pierre, a student in Oxford travels by train from his home to Oxford from which he walks to Trinity College. This daily routine can be described as a tra-jectory pattern: Home  X  Oxford station  X  Trinity College . Typical transition time between two successive visits can also be extracted and annotated on trajectory patterns.
Profiling user mobility has attracted a lot of research in recent years, and different models have been proposed, e.g., L  X  evy-walk [4 X 6] and Markov chains [7]. Compared with these mobility profile models, trajectory patterns provide a more concise repre-sentation of users X  typical movements as only the places which are meaningful to users are taken into account. This subsequently results in a more efficient comparison due to the elimination of the positions during transition between places, especially com-pared to those methods based on users X  raw trajectories [8, 2]. Thus, in this paper, we concentrate on measuring user similarity using trajectory patterns.
 Related Work. Measuring user similarity with trajectory patterns has been studied in a few papers. Ying et al. [9] propose a metric based on maximal trajectory pattern ( MTP ) similarity. A maximal trajectory pattern is a pattern that is not contained in any other patterns. For any two trajectory patterns from two users respectively, a similarity value is calculated by referring to the length of their longest common sequences. Two users X  similarity is then calculated as the weighted average of the similarity values of all pattern pairs. The weight assigned to two patterns is the average support values. Later, Chen et al. [10] identify and fix a weakness in the metric of Ying et al. [9] that the maximum similarity value (1.0) cannot be achieved even for two identical users. Our Motivations. In the literature, the effectiveness of a metric is assessed by the difference between the calculated similarity values and the ground-truth similarity ob-tained in other ways, e.g., by questionnaires. However, there are no formal principles to capture the basic properties that a valid user similarity metric on trajectory patterns should respect. Take the relation equality as an example. Intuitively, two users are equal or their similarity is maximum if and only if their mobility profiles are exactly the same. However, even the metric proposed by Chen et al. [10] fails to satisfy this property as it ignores the differences between support values. In other words, two users are con-sidered identical when they have the same trajectory patterns even if they visit these patterns with significantly distinctive frequencies. Without identifying design princi-ples first, we cannot propose a meaningful user similarity metric to capture the real similarity between users based on their trajectory patterns.
 Our Contributions. In this paper, we identify and define the basic principles that hold when measuring user similarity based on trajectory patterns. These principles enable us to re-evaluate existing metrics and discuss their insufficiency in capturing user similar-ity. Instead of fixing them, we propose for the first time a new metric which respects all the basic principles. Due to the importance of location semantics in identifying users X  hobbies, we extend our new metric to measure user similarity to take into account the semantics of visited locations. Last but not least, we perform extensive experiments on real-life trajectory datasets and demons trate the effectiveness of our metrics. In this section, we briefly introduce the basi c concepts related to p rofiling user mobility and describe existing user similarity metrics based on trajectory patterns.
 Basic Concepts. A trajectory is the path followed by a user through space in a certain time period. It can be considered as a trace of chronologically ordered spatio-temporal points which record the user X  X  geographical positions at different time points. Let L be the set of possible positions and T the totally ordered set of time points. A trajectory can be denoted as the sequence ( 1 ,t 1 ,..., n ,t n ) where i  X  X  and t i  X  X  ( 1  X  i  X  n ).

We u s e regions of interest (RoI) to represent the places which are meaningful to users, e.g., Trinity College in the example of Section 1. In fact, an RoI R can be seen as a set of adjacent geographic positions. Thus we have R  X  X  . As we previously mentioned, a trajectory pa ttern indicates one of a user X  X  regular traces of RoIs [3]. Thus we represent a trajectory pattern P as a sequence of RoIs, i.e., P =( R 1 ,...,R n ) ( n  X  1 ). It is also denoted as R 1  X  ...  X  R n in this paper. We use len ( P ) to denote its length, i.e., len ( P )= n . If a user sequentially travels all the RoIs of a trajectory pattern in a trajectory, then we say that the trajectory spatially contains the trajectory pattern or the trajectory pattern has an occurrence in the trajectory.
 Definition 1 (Spatial Containment). For a trajectory T and a trajectory pattern P = R subsequence of T , i.e., T =( 1 ,t 1 ,..., n ,t n ) such that  X  1  X  i  X  n, i  X  R i .
The movements of a user u in a time period can be stored as a dataset of trajectories and one trajectory pattern may have multiple occurrences in this dataset. We use sup-port value (denoted as sup u ( P ) ) to quantify the frequency of its occurrence. Its value is calculated as the percentage of the trajectories containing pattern P among all his tra-jectories. A trajectory pattern is frequent if its support value is larger than a threshold  X  .
As we discussed above, trajectory patterns captures users X  regular movements and their support values quantify their visiting fre quencies. These two aspects actually cover the regularity of user mobility. Thus we model user u  X  X  mobility profile M u as the pair P u , sup u . In the sequel, we use
In some works (e.g., see [10]), transition time between successive RoIs is also con-sidered when comparing two users. It is usually used as a discounter to the calculated user similarity. In this paper we only focus on the key step of user similarity calculation and users X  regularity on transition time can be added similarly as in [10, 11]. MTP-Based Metrics. We briefly describe the metric proposed by Ying et al. [9] and its revision by Chen et al. [10]. Both methods use the set of maximum trajectory patterns ( MTP ) to represent a user mobility profile so as to avoid duplicate comparison between trajectory patterns. Given two patterns P =( R 1 ,...,R n ) and Q =( R 1 ,...,R m ) ,we say that Q is a subsequence of P (denoted by Q $ P )ifthereexists j 1 ,...,j m ,such that R j i = R i ( 1  X  i  X  m ). Given user u  X  X  trajectory pattern set P u , the maximal trajectory pattern set is defined as M ( P u )= { P  X  X  u |  X  P  X  X  u s.t. P $ P } .
Themainideaofthetwo MTP -based metrics is to compute the similarity between maximal trajectory patterns and then combine the similarity values. The two metrics calculate the similarity between maximal patterns in the same way, which is based on the length of their longest common sequences . For two patterns P and Q , the set of their longest common sequences is { S | S $ P  X  S $ Q  X  (  X  S $ P  X  S $ Q, len ( S )  X  len ( S )) } .Let lenLCS ( P,Q ) be the length of their longest common sequences. Then
The difference between the two MTP -based metrics is the way to combine the sim-ilarity values between maximal trajectory patterns. Ying et al. [9] calculate the average weighted similarity as the final user similarity:
Chen et al. [10] find that the average similarity cannot guarantee the maximum sim-ilarity value (1.0) for iden tical mobility profiles. For example, suppose mobility profile M u with pattern set but share no common parts, i.e., lenLCS ( P i ,P j )=0 and sup u ( P i )= sup u ( P j ) for any 1  X  i = j  X  n , Thus, for 1  X  j  X  n we have sim ( P i ,P i )=1 and sim ( P i ,P j )=0 if i = j . The similarity of M u to itself, i.e., sim ( u,u ) , will be calculated as 1 n , instead of the intuitive value 1.0. Thus, Chen et al. [10] propose a dif-ferent combination method. First, for each maximal pattern P i of user u , the method finds the most similar maximal pattern of u , denoted as  X  u,u ( P i ) . Then they compute his relative similarity to u as In the end, the user similarity between u and u is defined as the average of the two relative similarities: sim ( u,u )= 1 2 ( sim ( u | u )+ sim ( u | u )) . In the above example, the two relative similarities are both 1.0, hence sim ( u,u )=1 . 0 .

In the rest of paper, we use MSTP to refer to the measurement of Ying et al. [9] as it is originally designed to measure user similarity with location semantics and MTP for themetricofChenetal.[10]. In this section, we present the basic principles that should hold when comparing users based on their trajectory patterns. Then we de monstrate by examples the insufficiencies of existing metrics with respect to the principles.

As we reduce the calculation of user similarity to the comparison of their mobility profiles, we investigate the basic principles that a valid similarity metric for two mo-bility profiles should satisfy. To begin with, we introduce two concepts about users X  mobility profiles. First, given two users u 1 and u 2 , we say that u 1  X  X  mobility profile is contained in u 2  X  X  mobility profile, denoted by M u 1  X  X  u 2 ,if P u 1  X  X  u 2 and  X 
P  X  X  u 1 , sup u 1 ( P )  X  sup u 2 ( P ) and M u 1 = M u 2 . Intuitively, this means that user u  X  X  regular movements are only part of those of u 2 . Second, we use M u 1 u 2 to repre-sent the mobility profile whose pattern set consists of all the common patterns shared profile M u 1 u 2 is contained in the mobility profile of u 1 , i.e., M u 1 u 2  X  X  u 1 . Example 1. Suppose four users whose pattern sets are For the sake of simplicity, we put the suppor t value in the parentheses for each pat-M Definition 2 (Principles). A valid similarity metric based on user mobility profiles should satisfy all the principles described below: 5. sim ( M u , M u )=1 ; The first two principles regulate the range of the similarity value between two users. Principle 3 says that user similarity is symmetric and principle 4 states that two users have the minimum similarity value, i.e., 0 if and only if they have no common regular movements. Principle 5 indicates that user similarity should be maximum, i.e., 1.0, when a user is compared to himself. The last two principles are about comparing the similarity of a user to different users. The intuition of principle 6 is that users sharing more regular movements with a user should be more similar to him than users sharing less common behaviours. For instance, in Example 1 user u 2 is more similar to u 3 than u 1 as u 2 travels pattern C more regularly than u 1 . Principle 7 says that a user is more similar to users who share more movements and have less different movements than those sharing less but having more different movements. The similarity values calculated with a valid metric should be consistent with this reasoning.

With these principles, we re-evaluate the existing metrics MSTP and MTP and find that they cannot satisfy all the principles. We use the following example to demonstrate their weaknesses.
 Example 2. Suppose the following five users:
Figure 1 depicts the mobility profiles in a rectangle region. We use grey circles to indicate RoIs and arrows between RoIs to represent the transition direction whose thick-ness implies support values. Table 1 shows the results given by the two metrics.
From Table 1, it is clear that both metrics satisfy principles 1, 2, 3 and 4. Princi-ple 5 is violated by metric MSTP as the similarity of any user to himself is not 1.0, which has been pointed out by Chen et al. [10]. Principle 6 is violated by both of them. Since M u 1  X  X  u 2  X  X  u 3 , according to principle 6, we have sim ( M u 3 , M u 1 ) &lt; sim ( M u 3 , M u 2 ) . However, both metrics compute the same similarity values for them, i.e., 0.5 and 0.1, respectively. Principle 7 does not hold for both of the metrics either. Ta ke t h e MTP metric as an example. According to its definition, sim ( M u 2 , M u 4 ) . However, the metric cannot distinguish u 2  X  X  similarity to u 4 and u 5 and outputs the same similarity value (0.58) in both cases.
 Neither of the metrics can give a precise evaluation of similarity for all users. From Figure 1, it is clear that the similarity values should decrease when comparing u 1 with the other users (from u 2 to u 5 ) X  u 2 should be the most similar one to u 1 as they share a same set of trajectory patterns while u 5 is the least. In this section, we propose for the first time user similarity metrics that satisfy all the basic principles discussed above. We first present a metric to measure user similarity based on their movement called mobility similarity and then extend the metric to handle location semantics, called location-semantic similarity . 4.1 Mobility Similarity The MTP -based metrics [9, 10] are problematic in comparing user similarity due to the inappropriate comparison between maximal trajectory patterns. In this section, we propose a new metric which does not compare maximal patterns but directly compare users X  original mobility profiles. Moreov er, instead of longest common patterns, we consider all common patterns of two users. Our main idea is to (1) compare two users basedonthe relative importance of their common patterns to each user X  X  mobility pro-file and (2) take into account the difference of two users X  frequencies by which they follow the common regular movements. Intu itively, if a user shares more common pat-terns with another user and their support values are also closer, then he is more similar to this user. This idea is consistent with the principles identified in Section 3.
We start with the calculation of the relative importance of the common patterns to a user mobility profile. A trajectory pattern can be interpreted as a description of users X  movement regularity . The more RoIs it contains and the more frequent it occurs, the more regularity of the user it can represent. With the regularity of trajectory patterns, we can then quantify the regularity of a users X  mobility profile. Given a user u ,the regularity that his mobility profile represents can be calculated as follows:
Given two users u and u , the relative importance of their common patterns with respect to u  X  X  mobility profile can be assessed by the ratio between the regularity of the common patterns and the whole pattern set of u . Recall that M uu is the mobility profile whose pattern set is composed of u and u  X  X  common patterns and the support value of any trajectory pattern is equal to that of user u . Thus,  X  uu is the movement regularity of user u expressed by the common patterns. Let  X  u,u | u be the relative im-portance of the common movements of u and u to u  X  X  mobility profile, then it can be
We proceed to quantify the difference between the support values of two users X  com-montrajectorypatterns.The Bray-Curtis similarity [12] delivers reliable similarity mea-surements, especially in ecology. It can also be adopted as a metric of the similarity be-tween two vectors. Given a user u , his support values of the trajectory patterns shared with u can be modelled as a vector of real numbers each of which corresponds to the support value of a common pattern. Due to its popularity and simplicity, we make use of Bray-Curtis similarity to assess the closeness of two users X  support values of their common patterns as the following: Finally, the similarity between users u and u can be calculated as It is easy to verify that our metric satisfies all the principles discussed in Section 3. We apply our metric to Example 2, and the results are shown in Table 2. We can see that our metric can give more precise similarity values which reflect the different similarities among users. Especially, the similarities of u 1 to the other users decrease from u 1 to u 5 . We u s e CPS to refer to our metric, as it mainly utilises common pattern sets of users. 4.2 Location-Semantic Similarity veal more about users X  similar hobbies. For instance, two users who live in different cities both like reading. According to their mobility, we cannot find their similarity be-cause they go to different book stores. How ever, when considering the functionalities of places, e.g.,  X  X ook store X , we will be able to discover their common interest. We call the functionalities of places location semantics . People always stay at a place for the service provided by the place. Given a traj ectory, we can learn the trace of places where the user stayed for a certain amount of time [10, 11]. By labelling each of such places with its functionality, we can obtain a trace of location semantics, called a semantic trajectory . Similar to mining trajectory patterns from geographic trajectories, we can also mine semantic trajectory patterns from a user X  X  semantic trajectories.

Let LS be the set of location semantics. Then a semantic trajectory pattern can be defined as a sequence of location semantic, i.e., (  X  1 ,..., X  n ) where for each 1  X  i  X  n ,  X  place usually corresponds to multiple locatio n semantics. For instance, some shopping malls contain both shops and restaurants. For a visit to a place, its functionality that a user really uses is thus not certain. This uncertainty can be modelled as a probability distribution over all possible location sem antics of the place, indicating the likelihood of how users use a functionality during their visits. A location semantic trajectory can thus be in the form of a sequence of sets of loca tion semantics each of which corresponds to a probability distribution. Mining semantic trajectory patterns from such probabilistic semantic trajectories has been studied and termed as probabilistic pattern mining [13]. However, due to its underlying complexity, we propose in this paper a different method to obtain the set of semantic trajectory patterns by exploring user mobility profiles.
Although the metric such as the MSTP metric [9] can calculate user similarity with location semantics, it ignores the uncertainty of the real purposes of users X  visits. Each location is assigned with a set of semantic tags, instead of a probability distribution on the tags. Furthermore, due to its dependence on maximal patterns, the MSTP metric with location semantics suffers the same problems as discussed in Section 3. In this paper, the calculation of user similarity with location semantics consists of two steps: 1. Transform trajectory patterns into seman tic trajectory patterns and calculate their 2. Calculate user similarity based on the obtained semantic trajectory patterns. Once semantic trajectory patterns and their support values are available, the metric given in the previous section can be used. Thus we focus on the first step. Associating a location with its location semantics a user uses have been recognised as the problem of labelling locations with semantic tags [14]. A semantic tag corresponds to a type of location semantics. Given an RoI R and  X   X  X S ,weuse Pr( tag ( R )=  X  ) to denote the probability that a user stays at R for its functionality  X  . For a trajectory pattern P =( R 1 ,...,R n ) , we represent its induced semantic pattern as lsp ( P ) . We assume the tag labelling of RoIs in a trajectory is i ndependent from each other. The likelihood that lsp ( P ) is Q =(  X  1 ,..., X  n ) , i.e., Pr ( lsp ( P )= Q ) , can be calculated as follows: For a semantic trajectory Q of a fixed length, any trajectory patterns of the same length in a user X  X  profile may have a (positive) probability to induce Q . Thus, the support value of Q can be calculated as: Similar to trajectory patterns, we should choose the representative location-semantic patterns to compare users X  similarity. A proper threshold of support values is thus re-quired. From the calculation of the support values of semantic patterns, we can see that they depend on their length and the number of trajectory patterns of the same length. Therefore, the threshold for semantic patterns cannot be uniform, which is different from frequent trajectory patterns. Let minPro be the minimum probability that a se-mantic tag is non-negligible to be the real semantic tag of an RoI. Then the threshold for a semantic pattern of length n can be calculated as the following: Intuitively, it equals to the support value of a semantic pattern, each of whose semantic tags has a larger probability than minPro in all the trajectory patterns of the same length. In the end, the semantic trajectory pattern set of user u is obtained as Example 3. Consider M u 3 from Example. 2 and suppose that LS consists of only two location semantic tags, e.g.,  X  1 = hotel and  X  2 = restaurant . For the sake of simplicity, we denote the distribution of an RoI R as a pair d R = p 1 ,p 2 with p 1 = Pr ( tag ( R )=  X  ) and p 2 = Pr ( tag ( R )=  X  2 ) . Suppose d A = 0 . 4 , 0 . 6 , d B = 0 . 2 , 0 . 8 and d
C = 0 . 5 , 0 . 5 . For the semantic trajectory pattern  X  1 , as patterns A , B and C can all 0 . 4=0 . 44 .If  X  =0 . 2 and minPro =0 . 2 , since we have 3 trajectory patterns with we compute the set P LS u 3 as follows If the distribution for RoI D is also 0 . 2 , 0 . 8 which is the same for RoI C ,then u 3 and u 5 will have identical semantic pattern sets, i.e., much more similar when considering location semantics. Our aim of the evaluation is t o check whether our metric can accurately capture the real similarity between users in practice as well as its consistency with the basic principles. The Dataset. We explore a real-life dataset of GP S trajectories collected by Yonsei University in Korea to evaluate the effectiveness of our metrics. It consists of 1,865 daily trajectories from 12 users, which cover a total length of 32,626 km. Although users moved in different cities or even count ries, we focus on their local movements in Seoul. We select six users in terms of the number of their trajectories. We construct another two additional users based on the dataset so as to help compare the performance of different metrics. One is based on the user with the identity 08 in the dataset by dividing the user into two ( 08  X  and 08 # ) since the user has different movement patterns in two different periods. The other two users ( 12  X  and 12 # ) are derived from user 12 by evenly dividing his trajectories into two parts.
 When constructing users X  mobility profiles, we adopt the approach of Chen et al. [10]. In their approach, stay points are first detect ed from trajectories, which represent the places a user are likely to have stayed in the tr ajectories. Then all s tay points are clus-tered into RoIs by a hierarchical clustering algorithm. Trajectories of stay points are then transformed into traces of RoIs from which user X  X  mobility profiles are constructed using a trajectory pattern mining tool [3]. The minimum support value is set to 0 . 1 in the experiments. Due to the page limit, we omit the values of other related parameters.
In Figure 2, we show the mobility similarities and location-semantic similarities be-tween all pairs of selected us ers by the three metrics  X  MSTP , MTP ,and CPS .Weuse different grey levels to distinguish the similarity values between users. A darker cell indicates that the corresponding pair of users are more similar.
 User Mobility Similarity. We have mentioned that the MTP -based metrics have been validated in the literature as effective way s to quantify users X  similarity using ground-truth data. Thus, by comparing the similarity values of our metric to the values of these two metrics, we can verify whether our metric correctly assesses user similarity.
In general, we have two main observations. First, if users are ordered according to their similarity values to a same user, our metric will output a similar order to the other two metrics. We take the similarity value of a user to another user computed with a given metric as a variable. Then we can calculate the covariance of two variables of a user with regard to different metrics. A positi ve covariance will indicate the user X  X  sim-ilarity values calculated by the two metrics are consistent. In other words, the similarity of a user to a given user has a similar ranking when calculated with the metrics. On average, the covariances of our metric with respect to MSTP and MTP are 0.09 and 0.04, respectively, which validates our observation that CPS is also consistent with the ground-truth. Second, when comparing Figure 2(b) and Figure 2(c), we observe that for some pairs of users, the similarity values calculated with our new metric have significant differences from the other two metrics. However, after projecting users X  original GPS trajectories on the map, we see that the similarity calculated with our metric is more pre-cise. For example, the similarity values between users 08  X  and 08 # have a rather large difference among the three metrics MSTP and MTP output 0.41 and 0.69 respectively, while CPS only gives 0.16. We plot their trajectories on the map and present them in Figure 2(d) and Figure 2(e). RoIs are labelled by red rectangles and users X  stay points are tagged by yellow dots. Blue lines represent the transition between stay points in a trajectory. We also name the RoIs and put their identities beside them. User 08 # has two more RoIs (E, F) than 08  X  . Furthermore, more than 57% of user 08 #  X  X  trajectories go through these two RoIs and only about 15% of his trajectories contain RoIs A , B and C . However, about 78% of 08  X   X  X  trajectories contain A , B and C . Therefore, the reasonable similarity value between 08 # and 08  X  should be around 0.20 after consid-ering the small proportion of common patterns and the large difference between their support values. By this example, we show that our metric indeed gives rise to a more precise similarity measurement.
 User Location-Sem antic Similarity. We proceed to illustrate the effectiveness of our metric when adding location semantics in user similarity calculation. Our major purpose is to check whether our metric can capture users X  similarity when location semantics are added, but not to learn the real similarity between the users. Thus, in our experiments we select five location semantic tags, and for each RoI we assign to it a probability distribution over the tags. Since only the metric proposed by Ying et al. [9] can han-dle location semantics, we show and compare the similarity values calculated by their method and our new CPS -based metric in Figure 2(f) and 2(g). Since the MSTP metric only considers the location semantic tags that an RoI may associate with non-negligible likelihoods, in the implementation of the me tric, we set the minimum probability as 0.2 and for each RoI we only consider the subset of location semantic tags with probabil-ities larger than 0.2. From Figure 2(f) and 2(g), we can see that our metric calculates similar similarity values to MSTP . This means our metric keeps the right ranking be-tween the similarity values of different p air of users as the effectiveness of the MSTP metric has been evaluated in [9]. Compared to the mobility similarity, an interesting observation is that the similarity between users 08  X  and 08 # increases to 0.59 from 0.16. This is mainly because the RoIs E and F have similar distributions to B and C. From the above discussion, we can conclude that our metric not only satisfies all the basic principles but also outputs more precise measurements for users X  similarity based on trajectory patterns and location semantics. We have identified a number of principles and proposed new metrics (with/without lo-cation semantics), when quantifying users X  similarity based on their trajectory patterns. The effectiveness of our metics is illustrated through extensive experiements. In the future, we want to evaluate our metrics on mor e real-life datasets, especially when con-sidering location semantics. This might lead to more efficient and effective ways to treat semantics in mobility data.

