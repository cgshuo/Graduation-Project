 A good measure for similarity between signals is necessary in many machine learning problems. However, the notion of  X  X imilarity X  between signals can be quite complex. For example, observing Fig. 1 , one would probably agree that Image-B is more  X  X imilar X  to Image-A than Image-C is. But why...? The configurations appearing in image-B are different than the ones observed in Image-A. What is it that makes those two images more similar than Image-C? Commonly used similarity measures would not be able to detect this type of similarity. For example, standard global similarity measures (e.g., Mutual Information [ 12 ], Correlation, SSD, etc.) require prior alignment or prior knowledge of dense correspondences between signals, and are therefore not applicable here. Dis-tance measures that are based on comparing empirical distributions of local features, such as  X  X ags of features X  (e.g., [ 11 ]), will not suffice either, since all three images contain similar types of local features (and therefore Image-C will also be determined similar to Image-A).
 In this paper we present a new notion of similarity between signals, and demonstrate its applicability to several machine learning problems and to several signal types. Observing the right side of Fig. 1 , it is evident that Image-B can be composed relatively easily from few large chunks of Image-A (see color-coded regions). Obviously, if we use small enough pieces, then any signal can be composed of any other (including Image-C from Image-A). We would like to employ this idea to indicate high similarity of Image-B to Image-A, and lower similarity of Image-C to Image-A. In other words, regions in one signal (the  X  X uery X  signal) which can be composed using large contiguous chunks of data from the other signal (the  X  X eference X  signal) are considered to have high local similarity. On the other hand, regions in the query signal which can be composed only by using small frag-mented pieces are considered locally dis similar. This induces a similarity score at every point in the signal based on the size of its largest surrounding region which can be found in the other signal (allowing for some distortions). This approach provides the ability to generalize and infer about new configurations in the query signal that were never observed in the reference signal, while preserving Figure 1: Inference by Composition  X  Basic concept.
 Left: What makes  X  X mage-B X  look more similar to  X  X mage-A X  than  X  X mage-C X  does? (None of the ballet configurations in  X  X mage-B X  appear in  X  X mage-A X !) Right: Image-B (the  X  X uery X ) can be composed using few large contiguous chunks from Image-A (the  X  X eference X ), whereas it is more difficult to compose Image-C this way. The large shared regions between B and A (indicated by colors) provide high evidence to their similarity. structural information. For instance, even though the two ballet configurations observed in Image-B (the  X  X uery X  signal) were never observed in Image-A (the  X  X eference X  signal), they can be inferred from Image-A via composition (see Fig. 1 ), whereas the configurations in Image-C are much harder to compose.
 Note that the shared regions between similar signals are typically irregularly shaped , and therefore cannot be restricted to predefined regularly shaped partitioning of the signal. The shapes of those re-gions are data dependent, and cannot be predefined. Our notion of signal composition is X  X eometric X  and data-driven. In that sense it is very different from standard decomposition methods (e.g., PCA, ICA, wavelets, etc.) which seek linear decomposition of the signal, but not geometric decomposi-tion. Other attempts to maintain the benefits of local similarity while maintaining global structural information have recently been proposed [ 8 ]. These have been shown to improve upon simple  X  X ags of features X , but are restricted to preselected partitioning of the image into rectangular sub-regions. In our previous work [ 5 ] we presented an approach for detecting irregularities in images/video as regions that cannot be composed from large pieces of data from other images/video. Our approach was restricted only to detecting local irregularities. In this paper we extend this approach to a general principled theory of  X  X imilarity by Composition X , from which we derive local and global similarity and dissimilarity measures between signals. We further show that this framework extends to a wider range of machine learning problems and to a wider variety of signals ( 1 D, 2 D, 3 D, .. signals). More formally, we present a statistical (generative) model for composing one signal from another. Using this model we derive information-theoretic measures for local and global similarities induced by shared regions. The local similarities of shared regions ( X  X ocal evidence scores X ) are accumulated reference signal. We further prove upper and lower bounds on the global evidence score, which are computationally tractable. We present both a theoretical and an algorithmic framework to compute, accumulate and weight those gathered  X  X ieces of evidence X .
 Similarity-by-Composition is not restricted to pairs of signals. It can also be applied to compute similarity of a signal to a group of signals (i.e., compose a query signal from pieces extracted from multiple reference signals). Similarly, it can be applied to measure similarity between two different groups of signals. Thus, Similarity-by-Composition is suitable for detection, retrieval, classifica-tion, and clustering. Moreover, it can also be used for measuring similarity or dissimilarity between different portions of the same signal . Intra-signal dissimilarities can be used for detecting irregu-larities or saliency, while intra-signal similarities can be used as affinity measures for sophisticated intra-signal clustering and segmentation.
 The importance of large shared regions between signals have been recognized by biologists for determining similarities between DNA sequences, amino acid chains, etc. Tools for finding large repetitions in biological data have been developed (e.g.,  X  X LAST X  [ 1 ]). In principle, results of such tools can be fed into our theoretical framework, to obtain similarity scores between biological data sequences in a principled information theoretic way.
 The rest of the paper is organized as follows: In Sec. 2 we derive information-theoretic measures for local and global  X  X vidence X  (similarity) induced by shared regions. Sec. 3 describes an algorithmic framework for computing those measures. Sec. 4 demonstrates the applicability of the derived local and global similarity measures for various machine learning tasks and several types of signal. We derive principled information-theoretic measures for local and global similarity between a  X  X uery X  Q (one or more signals) and a  X  X eference X  ref (one or more signals). Large shared re-gions between Q and ref provide high statistical evidence to their similarity. In this section we show how to quantify this statistical evidence. We first formulate the notion of  X  X ocal evidence X  for local regions within Q (Sec. 2.1 ). We then show how these pieces of local evidence can be integrated to provide  X  X lobal evidence X  for the entire query Q (Sec. 2.2 ). 2.1 Local Evidence Let R  X  Q be a connected region within Q . Assume that a similar region exists in ref . We would like to quantify the statistical significance of this region co-occurrence, and show that it increases with the size of R . To do so, we will compare the likelihood that R was generated by ref , versus the likelihood that it was generated by some random process.
 More formally, we denote by H ref the hypothesis that R was  X  X enerated X  by ref , and by H 0 the hypothesis that R was generated by a random process, or by any other application-dependent PDF (referred to as the  X  X ull hypothesis X ).
 H ref assumes the following model for the  X  X eneration X  of R : a region was taken from somewhere in ref , was globally transformed by some global transformation T , followed by some small possible local distortions, and then put into Q to generate R . T can account for shifts, scaling, rotations, etc. In the simplest case (only shifts), T is the corresponding location in ref .
 We can compute the likelihood ratio: where P ( T | H ref ) is the prior probability on the global transformations T (shifts, scaling, rotations), and P ( R | T, H ref ) is the likelihood that R was generated from ref at that location, scale, etc. (up to some local distortions which are also modelled by P ( R | T, H ref )  X  see algorithmic details in Sec. 3 ). If there are multiple corresponding regions in ref , (i.e., multiple T s), all of them contribute to the estimation of LR ( R ) . We define the Local Evidence Score of R to be the log likelihood ratio: LES is referred to as a  X  X ocal evidence score X , because the higher LES is, the smaller the proba-probability of getting a score LES ( R ) &gt; l for a randomly generated region R is smaller than 2  X  l (this is due to LES being a log-likelihood ratio [ 3 ]). High LES therefore provides higher statistical evidence that R was generated from ref .
 Note that the larger the region R  X  Q is, the higher its evidence score LES ( R | H ref ) (and therefore it will also provide higher statistical evidence to the hypothesis that Q was composed from ref ). For example, assume for simplicity that R has a single identical copy in ref , and that T is restricted to of the size of R . On the other hand, P ( R | H 0 ) decreases exponentially with the size of R . Therefore, the likelihood ratio of R increases, and so does its evidence score LES .
 LES can also be interpreted as the number of bits saved by describing the region R using ref , instead of describing it using H 0 : Recall that the optimal average code length of a random variable y with probability function P ( y ) is length ( y ) =  X  log ( P ( y )) . Therefore we can write the evidence score as LES ( R | H ref ) = length ( R | H 0 )  X  length ( R | H ref ) . Therefore, larger regions provide higher saving (in bits) in the description length of R .
 A region R induces  X  X verage savings per point X  for every point q  X  R , namely, LES ( R | H ref ) | R | is the number of points in R ). However, a point q  X  R may also be contained in other regions generated by ref , each with its own local evidence score. We can therefore define the maximal possible savings per point (which we will refer to in short as PES =  X  X oint Evidence Score X  ): For any point q  X  Q we define R [ q ] to be the region which provides this maximal score for q . Fig. 1 shows such maximal regions found in Image-B (the query Q ) given Image-A (the reference ref ). In practice, many points share the same maximal region. Computing an approximation of LES ( R | H ref ) , PES ( q | H ref ) , and R [ q ] can be done efficiently (see Sec 3 ). 2.2 Global Evidence We now proceed to accumulate multiple local pieces of evidence. Let R 1 , ..., R k  X  Q be k disjoint regions in Q , which have been generated independently from the examples in ref . Let R 0 = Q \ X  k i =1 R i denote the remainder of Q . Namely, S = { R 0 , R 1 , ..., R k } is a segmentation/division of
Q . Assuming that the remainder R 0 was generated i.i.d. by the null hypothesis H 0 , we can derive a global evidence score on the hypothesis that Q was generated from ref via the segmentation S (for simplicity of notation we use the symbol H ref also to denote the global hypothesis): GES ( Q | H ref , S ) = log Namely, the global evidence induced by S is the accumulated sum of the local evidences provided by the individual segments of S . The statistical significance of such an accumulated evidence is expressed by: P ( GES ( Q | H ref , S ) &gt; l | H 0 ) = P ( P k Consequently, we can accumulate local evidence of non-overlapping regions within Q which have similar regions in ref for obtaining global evidence on the hypothesis that Q was generated from ref . Thus, for example, if we found 5 regions within Q with similar copies in ref , each resulting with probability less than 10% of being generated by random, then the probability that Q was gen-erated by random is less than (10%) 5 = 0 . 001% (and this is despite the unfavorable assumption we made that the rest of Q was generated by random).
 So far the segmentation S was assumed to be given, and we estimated GES ( Q, H ref , S ) . In order to obtain the global evidence score of Q , we marginalize over all possible segmentations S of Q : Namely, the likelihood P ( S | H ref ) of a segmentation S can be interpreted as a weight for the like-lihood ratio score of Q induced by S . Thus, we would like P ( S | H ref ) to reflect the complexity of the segmentation S (e.g., its description length).
 From a practical point of view, in most cases it would be intractable to compute GES ( Q | H ref ) , as Eq. ( 3 ) involves summation over all possible segmentations of the query Q . However, we can derive upper and lower bounds on GES ( Q | H ref ) which are easy to compute : Claim 1. Upper and lower bounds on GES: max proof: See Appendix www.wisdom.weizmann.ac.il/  X vision/Composition.html .
 Practically, this claim implies that we do not need to scan all possible segmentations. The lower bound (left-hand side of Eq. ( 4 ) ) is achieved by the segmentation of Q with the best accumulated evidence score, P mentation description logP ( S | H ref ) =  X  length ( S ) . Obviously, every segmentation provides such a lower (albeit less tight) bound on the total evidence score. Thus, if we find large enough contiguous regions in Q , with supporting regions in ref (i.e., high enough local evidence scores), and define R 0 to be the remainder of Q , then S = R 0 , R 1 , ..., R k can provide a reasonable lower bound on GES ( Q | H ref ) . As to the upper bound on GES ( Q | H ref ) , this can be done by summing up the maximal point-wise evidence scores PES ( q | H ref ) (see Eq. 2 ) from all the points in Q (right-hand side of Eq. ( 4 )). Note that the upper bound is computed by finding the maximal evidence regions that pass through every point in the query, regardless of the region complexity length ( R ) . Both bounds can be estimated quite efficiently (see Sec. 3 ). The local and global evidence scores presented in Sec. 2 provide new local and global similarity measures for signal data, which can be used for various learning and inference problems (see Sec. 4 ). In this section we briefly describe the algorithmic framework used for computing PES , LES , and GES to obtain the local and global compositional similarity measures.
 Assume we are given a large region R  X  Q and would like to estimate its evidence score LES ( R | H ref ) . We would like to find similar regions to R in ref , that would provide large local evidence for R . However, (i) we cannot expect R to appear as is, and would therefore like to allow for global and local deformations of R , and (ii) we would like to perform this search efficiently. Both requirements can be achieved by breaking R into lots of small (partially overlapping) data patches, each with its own patch descriptor. This information is maintained via a geometric  X  X nsemble X  of lo-cal patch descriptors. The search for a similar ensemble in ref is done using efficient inference on a star graphical model, while allowing for small local displacement of each local patch [ 5 ]. For exam-ple, in images these would be small spatial patches around each pixel contained in the larger image region R , and the displacements would be small shifts in x and y . In video data the region R would be a space-time volumetric region, and it would be broken into lots of small overlapping space-time volumetric patches. The local displacements would be in x , y , and t (time). In audio these patches would be short time-frame windows, etc. In general, for any n-dimensional signal representation, the region R would be a large n-dimensional region within the signal, and the patches would be small n-dimensional overlapping regions within R . The local patch descriptors are signal and appli-cation dependent, but can be very simple. (For example, in images we used a SIFT-like [ 9 ] patch descriptor computed in each image-patch. See more details in Sec. 4 ). It is the simultaneous match-ing of all these simple local patch descriptors with their relative positions that provides the strong overall evidence score for the entire region R . The likelihood of R , given a global transformation T is captured by the following expression: P ( R | T, {  X  l i } , H ref ) = 1 /Z Q {  X  d i } are the descriptor distortions of each patch, and Z is a normalization factor. To estimate P ( R | T, H ref ) we marginalize over all possible local displacements {  X  l i } within a predefined lim-ited radius. In order to compute LES ( R | H ref ) in Eq. ( 1 ), we need to marginalize over all possible global transformations T . In our current implementation we used only global shifts, and assumed uniform distributions over all shifts, i.e., P ( T | H ref ) = 1 / | ref | . However, the algorithm can ac-commodate more complex global transformations. To compute P ( R | H ref ) , we used our inference algorithm described in [ 5 ], modified to compute likelihood (sum-product) instead of MAP (max-product). In a nutshell, the algorithm uses a few patches in R (e.g., 2 -3 ), exhaustively searching ref for those patches. These patches restrict the possible locations of R in ref , i.e., the possible can-didate transformations T for estimating P ( R | T, H ref ) . The search of each new patch is restricted to locations induced by the current list of candidate transformations T . Each new patch further reduces this list of candidate positions of R in ref . This computation of P ( R | H ref ) is efficient: O ( | db | ) + O ( | R | )  X  O ( | db | ) , i.e., approximately linear in the size of ref . In practice, we are not given a specific region R  X  Q in advance. For each point q  X  Q we want to estimate its maximal region R [ q ] and its corresponding evidence score LES ( R | H ref ) (Sec. 2.1 ). In (a) (b) (c) Figure 2: Detection of defects in grapefruit images. Using the single image (a) as a  X  X efer-ence X  of good quality grapefruits, we can detect defects (irregularities) in an image (b) of different grapefruits at different arrangements. Detected defects are highlighted in red (c). (a) Input1: Output1: (b) Input2: Output2: Figure 3: Detecting defects in fabric images (No prior examples). Left side of (a) and (b) show fabrics with defects. Right side of (a) and (b) show detected defects in red (points with small intra-image evidence LES ). Irregularities are measured relative to other parts of each image. order to perform this step efficiently, we start with a small surrounding region around q , break it into patches, and search only for that region in ref (using the same efficient search method described above). Locations in ref where good initial matches were found are treated as candidates, and are gradually  X  X rown X  to their maximal possible matching regions (allowing for local distortions in patch position and descriptor, as before). The evidence score LES of each such maximally grown region is computed. Using all these maximally grown regions we approximate PES ( q | H ref ) and R [ q ] (for all q  X  Q ). In practice, a region found maximal for one point is likely to be the maximal region for many other points in Q . Thus the number of different maximal regions in Q will tend to be significantly smaller than the number of points in Q .
 Having computed PES ( q | H ref )  X  q  X  Q , it is straightforward to obtain an upper bound on GES ( Q | H ref ) we need to perform an optimization over all possible segmentations S of Q . How-ever, any good segmentation can be used to provide a reasonable (although less tight) lower bound. Having extracted a list of disjoint maximal regions R 1 , ..., R k , we can use these to induce a reason-able (although not optimal) segmentation using the following heuristics: We choose the first segment to be the maximal region with the largest evidence score:  X  R 1 = argmax R second segment is chosen to be the largest of all the remaining regions after having removed their evaluating the evidence scores LES (  X  R i | H ref ) of these regions, we can obtain a reasonable lower bound on GES ( Q | H ref ) using the left-hand side of Eq. ( 4 ). For evaluating the lower bound, we also need to estimate log P ( S | H ref ) =  X  length ( S | H ref ) . This is done by summing the descrip-tion length of the boundaries of the individual regions within S . For more details see appendix in www.wisdom.weizmann.ac.il/  X vision/Composition.html . The global similarity measure GES ( Q | H ref ) can be applied between individual signals, and/or be-tween groups of signals (by setting Q and ref accordingly). As such it can be employed in machine learning tasks like retrieval, classification, recognition, and clustering. The local similarity mea-sure LES ( R | H ref ) can be used for local inference problems, such as local classification, saliency, segmentation, etc. For example, the local similarity measure can also be applied between different (a) (b) (c) Figure 4: Image Saliency and Segmentation. (a) Input image. (b) Detected salient points, i.e., points with low intra-image evidence scores LES (when measured relative to the rest of the image). (c) Image segmentation  X  results of clustering all the non-salient points into 4 clusters using normalized cuts. Each maximal region R [ q ] provides high evidence (translated to high affinity scores) that all the points within it should be grouped together (see text for more details). portions of the same signal (e.g., by setting Q to be one part of the signal, and ref to be the rest of the signal). Such intra-signal evidence can be used for inference tasks like segmentation, while the ab-sence of intra-signal evidence (local dis similarity) can be used for detecting saliency/irregularities. In this section we demonstrate the applicability of our measures to several of these problems, and apply them to three different types of signals: audio, images, video. For additional results as well as video sequences see www.wisdom.weizmann.ac.il/  X vision/Composition.html 1. Detection of Saliency/Irregularities (in Images) : Using our statistical framework, we define a point q  X  Q to be irregular if its best local evidence score LES ( R [ q ] | H ref ) is below some threshold. Irregularities can be inferred either relative to a database of examples, or relative to the signal itself. In Fig. 2 we show an example of applying this approach for detecting defects in fruit. Using a single image as a  X  X eference X  of good quality grapefruits (Fig. 2 .a, used as ref ), we can detect defects (irregularities) in an image of different grapefruits at different arrangements (Fig. 2 .b, used as the query Q ). The algorithm tried to compose Q from as large as possible pieces of ref . Points in Q with low LES (i.e., points whose maximal regions were small) were determined as irregular. These are highlighted in  X  X ed X  in Fig. 2 .c, and correspond to defects in the fruit.
 Alternatively, local saliency within a query signal Q can also be measured relative to other portions of
Q , e.g., by trying to compose each region in Q using pieces from the rest of Q . For each point q  X  Q we compute its intra-signal evidence score LES ( R [ q ] ) relative to the other (non-neighboring) parts of the image. Points with low intra-signal evidence are detected as salient. Examples of using intra-signal saliency to detect defects in fabric can be found in Fig. 3 . Another example of using the same algorithm, but for a completely different scenario (a ballet scene) can be found in Fig. 4 .b. We used a SIFT-like [ 9 ] patch descriptor, but computed densely for all local patches in the image. Points with low gradients were excluded from the inference (e.g., floor). 2. Signal Segmentation (Images) : For each point q  X  Q we compute its maximal evidence the case of saliency). Every maximal region provides evidence to the fact that all points within the region should be clustered/segmented together. Therefore, the value LES ( R [ q ] | H ref ) ) is added to affinity matrix. Thus, large regions which appear also in ref (in the case of a single image  X  other regions in Q ) are likely to be clustered together in Q . This way we foster the generation of segments based on high evidential co-occurrence in the examples rather than based on low level similarity as in [ 10 ]. An example of using this algorithm for image segmentation is shown in Fig. 4 .c. Note that we have not used explicitly low level similarity in neighboring point, as is customary in most image segmentation algorithms. Such additional information would improve the segmentation results. 3. Signal Classification (Video  X  Action Classification) : We have used the action video database of [ 4 ], which contains different types of actions ( X  X un X ,  X  X alk X ,  X  X umping-jack X ,  X  X ump-forward-on-two-legs X ,  X  X ump-in-place-on-two-legs X ,  X  X allop-sideways X ,  X  X ave-hand(s) X , X  X end X ) performed by nine different people (altogether 81 video sequences). We used a leave-one-out procedure for action classification. The number of correct classifications was 79 / 81 = 97 . 5% . These sequences contain a single person in the field of view (e.g., see Fig. 5 .a.). Our method can handle much more complex scenarios. To illustrate the capabilities of our method we further added a few more sequences (e.g., see Fig. 5 .b and 5 .c), where several people appear simultaneously in the field of view, with partial (a) (b) (c) (a) A sample  X  X alk X  sequence from the action database of [ 4 ]. (b),(c) Other more complex sequences with several walking people in the field of view. Despite partial occlusions, differences in scale, and complex backgrounds, these sequences were all classified correctly as  X  X alk X  sequences. For video sequences see www.wisdom.weizmann.ac.il/  X vision/Composition.html occlusions, some differences in scale, and more complex backgrounds. The complex sequences were all correctly classified (increasing the classification rate to 98% ).
 In our implementation, 3D space-time video regions were broken into small spatio-temporal video patches ( 7  X  7  X  4 ). The descriptor for each patch was a vector containing the absolute values of the temporal derivatives in all pixels of the patch, normalized to a unit length. Since stationary backgrounds have zero temporal derivatives, our method is not sensitive to the background, nor does it require foreground/background separation.
 Image patches and fragments have been employed in the task of class-based object recognition (e.g., [ 7 , 2 , 6 ]). A sparse set of informative fragments were learned for a large class of objects (the training set). These approaches are useful for recognition, but are not applicable to non-class based inference problems (such as similarity between pairs of signals with no prior data, clustering, etc.) 4. Signal Retrieval (Audio  X  Speaker Recognition) : We used a database of 31 speakers (male and female). All the speakers repeated three times a five-word sentence (2-3 seconds long) in a foreign language, recorded over a phone line. Different repetitions by the same person slightly varied from one another. Altogether the database contained 93 samples of the sentence. Such short speech signals are likely to pose a problem for learning-based (e.g., HMM, GMM) recognition system. We applied our global measure GES for retrieving the closest database elements. The highest GES recognized the right speaker 90 out of 93 cases (i.e., 97% correct recognition). Moreover, the second best GES was correct 82 out of 93 cases ( 88% ). We used a standard mel-frequency cepstrum frame descriptors for time-frames of 25 msec, with overlaps of 50% .
 Acknowledgments Thanks to Y. Caspi, A. Rav-Acha, B. Nadler and R. Basri for their helpful remarks. This work was supported by the Israeli Science Foundation (Grant 281/06) and by the Alberto Moscona Fund. The research was conducted at the Moross Laboratory for Vision &amp; Motor Control at the Weizmann Inst.
