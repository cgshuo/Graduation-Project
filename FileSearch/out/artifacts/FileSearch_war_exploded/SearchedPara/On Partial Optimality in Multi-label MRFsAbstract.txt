 Pushmeet Kohli 1 pkohli@microsoft.com Alexander Shekhovtsov 2 shekhovt@cmp.felk.cvut.cz Carsten Rother 1 carrot@microsoft.com Vladimir Kolmogorov 3 vnk@adastral.ucl.ac.uk Philip Torr 4 philiptorr@brookes.ac.uk Oxford Brookes University One of the major advances in computer vision in the past few years has been the development of efficient deterministic algorithms for solving discrete labeling problems. Labeling problems occur in many places from dense stereo and image segmentation (Boykov et al., 2001; Szeliski et al., 2006) to the use of picto-rial structures for object recognition (Felzenszwalb &amp; Huttenlocher, 2000). They can be shown to be equiv-alent to the problem of estimating the maximum a posterior ( map ) solution in graphical models such as Markov Random Fields ( mrf ) and Conditional Ran-dom Fields ( crf ), which is also often referred to as energy minimization .
 A number of powerful algorithms are present in the literature which deal with the problem. For cer-tain subclasses of the problem, it is possible to com-pute the exact solution in polynomial time: MRFs of bounded tree-width, e.g . (Lauritzen, 1998); with con-vex pairwise potentials (Ishikawa, 2003); with submod-ular potentials of binary (Hammer, 1965; Kolmogorov &amp; Zabih, 2004) or multi-label (Schlesinger &amp; Flach, 2000; Kovtun, 2004) variables; with permuted sub-modular potentials (Schlesinger, 2007). However, the problem of minimizing a general energy function is NP-hard. Nevertheless it is just these sorts of general en-ergies that occur in many vision problems and making progress towards their solution is of paramount impor-tance.
 Energy Minimization as a Linear Program General discrete energy minimization can be seen as an integer programming problem. Dropping inte-grality constraints leads to an attractive linear pro-gramming relaxation (LP-1). Unfortunately, linear programs arising from this scheme in vision applica-tions are of very large scale, and are not practical to solve with general methods. A number of algo-rithms have been developed (Schlesinger, 1976; Ko-val &amp; Schlesinger, 1976; Wainwright et al., 2003; Kol-mogorov, 2006; Werner, 2007) which attempt to solve this relaxation by exploiting the special structure of the problem. However, their common drawback is that they may converge to a suboptimal point. Other de-veloped methods for energy minimization include local search algorithms (Boykov et al., 2001), primal-dual method (Komodakis &amp; Tziritas, 2005), subgradient methods (Schlesinger &amp; Giginyak, 2007; Komodakis et al., 2007). Some local search algorithms provide approximation ratio guarantee for (semi-)metric en-ergies (Boykov et al., 2001; Komodakis &amp; Tziritas, 2005). Finally, there are methods which output a partial assignment of labels with guaranteed opti-mality certificate for binary (Hammer et al., 1984; Boros et al., 1991; Boros et al., 2006; Rother et al., 2007) and multi-label (Kovtun, 2003; Kovtun, 2004) problems. Dead-end elimination is another related method for identifying non-optimal assignments based on local sufficient conditions, it was originally pro-posed (Desmet et al., 1992) for predicting and design-ing the structures of proteins. In this paper we develop a novel method for obtaining partial optimal solutions of functions of multi-label variables.
 Our method works by first transforming the multi-label energy function to a function involving binary variables (Schlesinger &amp; Flach, 2006). This binary en-ergy is then minimized by applying the roof dual relax-ation (Boros &amp; Hammer, 2002; Hammer et al., 1984), which can be solved efficiently using a single graph cut. More importantly, solving the roof dual relax-ation results in an assignment of a subset of the vari-ables which is guaranteed to be valid for any optimal solution. This partially optimal solution can be used to constrain the state space of the original multi-label problem. As we show, this approach may be viewed as a different LP-relaxation of the multi-label energy minimization problem (LP-2).
 Comparing LP-1 with LP-2 We present a num-ber of theoretical results studying properties of LP-2 and relating LP-2 with LP-1. Our first result is that LP-1 is a tighter relaxation of the energy minimization problem compared to LP-2. We show in the paper that solutions of LP-1 necessarily satisfy the constraints de-rived by LP-2, so additional guarantees for methods based on LP-1 may follow. We also identify a sub-class of problems for which LP-2 is as tight as LP-1. Thus, for problems of this subclass LP-1 can be solved exactly and efficiently using combinatorial methods. It was recently demonstrated that the roof dual re-laxation performs well for a number of computer vi-sion applications (Kolmogorov &amp; Rother, 2007; Rother et al., 2007) which are naturally formulated as a binary energy minimization. However, it turns out that when multi-label problems are formulated as binary energy minimization the roof dual relaxation leaves many variables unassigned. We therefore use recently pro-posed enhancements of the roof dual technique called  X  X robing X  (Boros et al., 2006; Rother et al., 2007) which can often help resolve these ambiguities. Our last contribution is providing an alternative formula-tion of LP-2: we prove that it is equivalent to com-puting a decomposition of the energy into submodular and supermodular parts so that the sum of the lower bounds for each part is maximized. Precise details of this theoretical result are given in (Shekhovtsov et al., 2008, section 10).
 Although this is primarily a theoretical paper, we have performed a number of experiments with vari-ous energy models arising in vision applications, in-cluding image restoration, object-based segmentation, and image stitching. Our experiments show that the proposed method outperforms the competing method of (Kovtun, 2003) by labelling many more random variables. We also demonstrate that it may help solv-ing difficult problems by reducing their state space and applying other methods to the reduced problem. Let L = { 1 . . . K } be a set of labels. Let G = ( V , E ) be a graph, where the set of edges E  X  X  X V is antisym-metric and antireflexive, i.e . ( s, t )  X  E  X  ( t, s ) /  X  E . We denote an ordered pair ( s, t )  X  X  simply by st . Let each graph node s  X  V be assigned a label x s  X  L and let a labeling (or configuration ) be defined as x = { x s | s  X  V } 1 . Let {  X  s ( i )  X  R | i  X  L , s  X  V } be uni-variate potentials and {  X  st ( i, j )  X  R | i, j  X  X  , st  X  X  } be pairwise potentials of a random field. Let in addi-tion  X  const be a constant term, and let a concatenated vector of potentials, including the constant term, be denoted as  X  = (  X ,  X  const )  X   X  = R I X  X  const } , where set of indices I = { ( s, i ) | s  X  X  , i  X  X } X  X  ( st, ij ) | st  X  X  , i, j  X  X } corresponds to all univariate and pairwise terms. No-tation  X  I will thus refer to all components of  X  but the constant term. The energy of a configuration x of the random field is defined as:
E (x |  X  ) = X 2.1. LP-relaxation We will study two different relaxations of minimization of (2). Both relaxations can be written using the same formulation but will differ in the graph, number of labels and potential vector involved.
 Energy function (2) can be conveniently written using a scalar product in  X  as E (x |  X  ) =  X   X  (x) ,  X   X  , where  X  (x)  X  X  0 , 1 } I X  X  const } is defined by  X  (x) s ( i ) =  X   X  (x) st ( i, j ) =  X  { x notation minimization of E is expressed as: The LP-relaxation of (3) reviewed in, e.g ., (Werner, 2007) is constructed as follows. For each variable x s , a set of relaxed variables  X  s ( i )  X  [0 , 1], i  X  L is in-troduced. These variables are required to satisfy the normalization constraints Further, for each pair ( x s , x t ), st  X  X  the relaxed vari-ables  X  st ( i, j )  X  [0 , 1], i, j  X  L are introduced which must satisfy the marginalization constraints: The concatenated vector  X   X   X  satisfying these con-straints will be called a relaxed labeling. Indeed, a vector  X  with all integral components uniquely repre-sents a labeling x. When the integrality constraints are dropped we get the following relaxation of (3): where  X  G, L =  X   X   X  + | A X  I = 0 , B X  I = 1 ,  X  const = 1 is called the local (Wainwright et al., 2003) poly-tope of graph G . Here set  X  + denotes vectors from  X  with all nonnegative components, equalities A X  I = 0 express marginalization constraints (5), and equalities B X  I = 1 express normalization constraints (4). 2.2. Binary Energy Minimization Energy minimization problems with 2 labels ( |L| = 2) are conveniently described in terms of binary (or Boolean) variables, i.e . with set of labels being B = { 0 , 1 } . For clarity we will denote binary configurations by z. Univariate and pairwise terms of (2) can be written as:  X  s ( z s ) =  X  s (1) z s +  X  s (0)(1  X  z s ) ,  X  st ( z s , z t ) =  X  st (1 , 1) z s z t +  X  st (0 , 1)(1  X  z +  X  st (1 , 0) z s (1  X  z t ) +  X  st (0 , 0)(1  X  z s )(1  X  z Expanding brackets in (7) it is clear that (2) can be transformed to the form: which is a quadratic function of binary variables. Functions of the form B V 7 X  R are called pseudo-Boolean (Boros &amp; Hammer, 2002) and minimization (or maximization) of (8) is called quadratic Pseudo-boolean optimization.
 Calculating coefficients  X  from  X  is equivalent to choos-ing the reparametrization  X   X   X   X  with non-zero ele-ments being only  X   X  s (1),  X   X  st (1 , 1) and  X   X  const . It is easy to see that pseudo-Boolean optimization, en-ergy minimization with 2 labels and the MIN-CUT problem are all equivalent problems, and can be sim-ply converted one into another. It is also known that polynomially solvable MIN-CUT problems (those hav-ing weights of all edges in the graph non-negative) cor-respond to quadratic pseudo-Boolean problems with all weights  X  st being non-positive, which is equivalent to the condition of submodularity of E (  X |  X  ). 2.3. LP-relaxation of Binary Problems As shown in (Hammer et al., 1984), the LP relaxation (6) for the case of binary variables has special prop-erties, which in general do not hold in the multi-label case. First, there exists a half-integral optimal relaxed labeling  X   X  , i.e. all components are 0, 1 2 or 1. Second, if  X   X  is integral for some node s (i.e.  X   X  s (  X  ) = 0), then there exists a global minimum z of the original func-tion in which z s =  X  . In other words, by solving the LP relaxation we can obtain constraints on the global minima of the binary energy. These constraints can be expressed as where z min , z max  X  B V and inequalities are component-wise. For instance, 0  X  z s  X  1 implies no constraints on z s , while 0  X  z s  X  0 implies that z s is constrained to be 0.
 If (9) holds for all optimal solutions z, then the pair (z min , z max ) is said to define strong persistency; if (9) holds for some optimal solution z then (z min , z max ) de-fines weak persistency (Boros &amp; Hammer, 2002). It is important to note that the LP relaxation can be solved very efficiently by computing minimum cut/maximum flow in an appropriately constructed graph. The tech-nique in (Boros et al., 1991) is perhaps the most ef-ficient; we will refer to it as the Qudratic Pseudo-Boolean Optimization (QPBO) method 2 . It yields a pair (z min , z max ) defining strong persistency. Recently, two techniques were introduced which ex-tend the QPBO method. The first one is Prob-ing (Boros et al., 2006), or QPBO-P . It fixes a cer-tain node s to a particular label  X  , runs QPBO thus obtaining some information about global minimizers of the energy. This information is incorporated into the energy (e.g. if we learn that z s = z t for all opti-mal solutions then we contract nodes s and t ), and the  X  X robing X  is performed for other nodes until conver-gence. An efficient implementation of QPBO-P was described in (Rother et al., 2007). The second method is Improve , or QPBO-I (Rother et al., 2007). It takes an input labeling z and tries to improve its energy by fixing a subset of nodes to labels specified by z and running QPBO. These operations guarantee not to in-crease the energy, and in practice do often decrease it. We now address the problem of minimizing energy functions involving multi-label variables. 3.1. Converting Multi-label Problems Into As was discussed in Sec. 2.2, there are simple tran-sitions between energy minimization with two labels, MIN-CUT problem and the quadratic pseudo-Boolean optimization. Thus, it is not essentially important to which of those forms a multi-label problem will be reduced. The construction (Ishikawa, 2003; Kovtun, 2004; Schlesinger &amp; Flach, 2006) adopted to our nota-tion of binary energies is as follows.
 We start the transformation procedure by obtaining a reparametrization  X   X   X   X  which satisfies the following: This reparametrization is easy to construct. For ex-ample, to achieve  X   X  st ( i, 1) = 0 one needs to subtract  X  ( i ), which does not change the energy, and so on, see (Shekhovtsov et al., 2008) for details. Note that in the case of two labels, this reparametrization  X   X  imme-diately provides coefficients for writing a binary energy in the form (8).
 Let the tuple ( L , G,  X  ) define a multi-label energy min-imization problem. Let  X  L to refer to the set of the last K  X  1 labels of L , i.e.  X  L = { 2 . . . K } . The components of the equivalent binary energy minimization problem are given as follows (Fig 1):  X  Graph N = ( V, A ), where V = V  X   X  L and A =  X  Binary configuration z  X  B V . For a configuration  X  For a binary configuration z, the corresponding 1 2 3  X  Binary energy function It is already known that the above defined transforma-tion can be used together with st-mincut algorithms to efficiently and exactly solve lattice-submodular multi-label problems. In this paper, we broaden its appli-cability by showing how it can be used in conjunc-tion with roof-duality to obtain partial optimal solu-tions for general problems. An important aspect of the transformation is that (11) depends on the order-ing of L . This will lead to certain limitations in the sequel. An interesting question raised by reviewers is whether it is possible to use a different reduction to binary variables which does not depend on the or-der. This does not look straightforward. For exam-ple, a rather natural reduction suggested by review-ers is to use binary indicator variables z ( s,i ) =  X  { x and enforce constraint P i z ( s,i )  X  1 via K ( K  X  1) / 2 hard pairwise terms and constraints P i z ( s,i )  X  1 by adding sufficiently large negative value to all unary terms. Unfortunately, the LP relaxation of the result-ing binary problem can be shown to be degenerate (see (Shekhovtsov et al., 2008)). 3.2. Multi-label QPBO Let ( G, K,  X  ) define a multi-label energy minimization problem, and ( N, B ,  X  ) define the corresponding binary energy minimization problem. The LP-relaxation of the multi-label problem is defined as: while that of the binary problem defined as: We attempt minimization of E (x |  X  ) by applying QPBO and its extensions -P, -I (Boros et al., 2006; Rother et al., 2007) to the binary energy E (  X |  X  ). We call the new methods multi-label QPBO (-P,-I), or short MQPBO (-P,-I). As the original QPBO methods efficiently solves LP-2, it is important to see how LP-2 is related to the original problem min x E (x |  X  ) and to its relaxation LP-1. The following results apply. Statement 1. Let (z min , z max ) define strong per-sistency for E (  X |  X  ) such that E (z min ) &lt;  X  and E (z max ) &lt;  X  . Then any optimal configuration x  X  argmin L V E (  X |  X  ) must satisfy The proof (Shekhovtsov et al., 2008) is simply by using the relation (12).
 Thus for each variable s there is an interval of labels [ x s , x in an optimal solution. All labels outside the inter-val may therefore be safely discarded. As is seen, the ordering of L turns to be very important. While in many practical application there is a natural ordering defined, generally, constraints in the form of intervals derived from arbitrary ordering may be very weak. A pairwise term  X  st is called submodular (resp. super-modular) if Theorem 1. If the term  X  st is either submodular or supermodular for each edge st  X  E , the relaxations LP-1 and LP-2 coincide, and there exist a mapping between their optimal solutions.
 Proof sketch. We have already used the mapping (11) to relate integral solutions of the two problems such that the energy is preserved. It is quite straightforward to extend it to an injective mapping  X  of relaxed label-ings  X  to relaxed labelings  X  , preserving the associated primal costs of LP-1 and LP-2. However, inverting this mapping is not always possible, so there might be a so-lution  X  of LP-2, for which there is no corresponding solution  X  of LP-1. Under conditions of the theorem a correction to a solution  X  can be applied such that it remains optimal and has a preimage in the mapping  X  feasible to LP-1. See details in (Shekhovtsov et al., 2008).
 Corollary 1. It is known that LP-2 can be solved us-ing a network flow algorithm (Hammer et al., 1984). This implies that for a subclass of problems (defined by conditions of the above theorem) there exist efficient fully combinatorial algorithms to solve LP-1, which is an improvement over, e.g ., message passing algo-rithms such as TRW-S. But currently, we do not see applications for the case where a part of interactions is submodular and the other part is supermodular. The next result shows that strong persistency con-straints (17) can be also extended to relaxed labelings: Theorem 2. Let x min = x(z min ) , x max = x(z max ) be the output of MQPBO, and let  X   X   X  G, L be an optimal solution of LP-1. Then  X  s ; i = 0 for labels i outside the interval [ x min s , x max s ] for all s  X  X  . Proof sketch. Assume  X  violates constraints of the the-orem. Let then  X  =  X   X  . For the binary problem it fol-lows from the roof duality that a  X  X runcated X  solution,  X   X  may be constructed, which has non-zero weights  X   X  ( a ) only for labels a  X  B such that z min u  X  a  X  z max u  X  V and such that the primal cost is decreased:  X   X   X ,  X   X  &lt;  X   X ,  X   X  . It can then be mapped back to a so-lution  X   X  =  X   X  1  X   X  of LP-1 of a strictly lower cost than  X  . This contradicts to the optimality of  X  . See details in (Shekhovtsov et al., 2008).
 The theorem shows that LP-1 never selects nodes which are rejected by LP-2, this may be useful in the analysis of the algorithms related to LP-1. In this section we discuss in more detail the  X  X robing X  and  X  X mprove X  versions of MQPBO and show how they could be used in combination with other algorithms for minimization of multi-label energy functions. MQPBO-P. This enhancement applies the probing technique (Boros et al., 2006; Rother et al., 2007) to binarized energy functions. It computes stronger con-straints of the form (17) on the set of optimal config-urations. Our results show that these constraints al-low us to isolate the optimal labels for many random variables of the original energy function. In fact for certain energy functions we obtained the global mini-mum configuration. If latter is not the case then con-straints (17) lead to a simplified minimization problem with a smaller or restricted solution space, which can be further approached by any other minimization al-gorithms.
 As was mentioned above, MQPBO, and hence the probing extension, is not invariant to permutations of labels. While we are using a fixed ordering in all our experiments, the method could be potentially run under different orderings thus extracting multiple con-straints.
 MQPBO-P + X. Similar to QPBO+X (Rother et al., 2007), restriction of the energy function ob-tained by MQPBO(-P) is then minimized using any other minimization algorithm X . In our experiments we used max-product BP (Pearl, 1988), TRW-S (Kol-mogorov, 2006) and  X  -expansion algorithm (Boykov et al., 2001).
 MQPBO-I. By using QPBO-I (Rother et al., 2007) on the binarized problem any complete labelling of the multi-label MRF can be updated such that its energy never increases. This procedure can be seen as a local search algorithm. We now provide the results of using our method to minimize energy functions encountered in computer vision problems. To get a good understanding of the performance of our method we also tested it on syn-thetic energy functions.
 Synthetic Problems. The energy functions corre-sponding to the synthetic problems contained 50  X  50 multi-label variables which interacted under a 4-connected neighborhood. We used different numbers of labels and strengths of pairwise potentials in our ex-periments. Unary potentials  X  s ( x s ) are sampled uni-formly in { 0,1. . . 100 } . The pairwise potentials had the form of a linear truncated model  X  st ( x s , x t ) = min( | x s  X  x t | , T ), where T is the truncation and  X  is the pairwise strength. Fig. 2 shows comparison of MQPBO-P to (Kovtun, 2003), truncation T is fixed to 1. It is seen that the proposed method labels more variables for a range of parameters. To study the effect of non-convexity, we varied truncation T and strength  X  of the pairwise terms (Fig. 3). The number of la-bels in this case is fixed to 7. Our experiments show that MQPBO-P finds the globally optimal solution of energy functions where the pairwise term is small in magnitude or is nearly convex . As expected, the num-ber of variables labelled by the algorithm decrease with increase in the strength and non-convexity of the pair-wise terms (Fig. 3).
 Image Denoising. We now test the MQPBO-P algo-rithm on the problem of image denoising and restora-tion. There is a random variable for each pixel in the image. The label set for the problem is the set of intensities L I the pixels can take. The unary cost for taking a particular label (intensity) is defined as  X  ( x s ) = | I s  X   X  ( x s ) | where I s is the intensity of the pixel s in the image, and the function  X  maps the la-bels to their corresponding intensity levels. The pair-wise terms of the energy are defined as:  X  st ( x s , x t  X  min( | x s  X  x t | , T ) where  X  is a model parameter and T is the truncation used. Our experiments showed that the MQPBO-P algorithm performed quite well on the energy function and in some cases obtained the glob-ally optimal solution which was not achieved by other energy minimization algorithms (see Fig. 4).
 Object based Segmentation. We now show the results of using the MQPBO-P method for restricting the energy functions. Our results show that the restric-tion significantly reduces the number of variables and makes them amenable for minimization using other algorithms. We test the algorithm on the problem of object segmentation and recognition. We use the en-ergy function formulated in (Shotton et al., 2006). The binarized energy function corresponding to this prob-lem has around 10 7 variables and running MQPBO-P on it directly is quite time consuming. To reduce the size of the problem we first run the partial optimality algorithm described in (Kovtun, 2003), referred to as A-K. MQPBO-P is run on the restriction obtained us-ing A-K. This combined procedure leaves 694 variables unlabelled. The results are shown in Fig. 5.
 Image Stitching. Finally, we investigated an appli-cation where MQPBO-P shows its limitations. For panoramic stitching the unary terms are either zero or infinity, depending on the presence or absence of an image, and consequently the pairwise terms dominate the energy. We use the panoramic stitching formula-tion from (Agarwala et al., 2004) where pairwise terms model the visibility of a transition, different for each pair of images. The results are discussed in fig 6. This paper addressed the problem of minimizing non-submodular multi-label energy functions. These are used extensively in computer vision and are generally NP-hard to minimize. We present a method for ob-taining partially optimal solutions of such energies de-rived from roof-dual based methods for binary energy functions. We give new theoretical insights in the un-derlying LP relaxation, being efficiently solved by the method. Although this work is mainly theoretical in nature we hope to inspire people to use these ideas to develop better optimization algorithms. We also believe that this approach is useful for other impor-tant problems in computer vision such as MRF/CRF learning.
 We would like to thank the anonymous reviewers for their useful comments. A. Shekhovtsov thanks the European Commission grant 215078 (DIPLECS) and Czech government grant MSM6840770038 for support. V. Kolmogorov thanks EPSRC for support. P. Torr thanks EPSRC and PASCAL, EU for support.

