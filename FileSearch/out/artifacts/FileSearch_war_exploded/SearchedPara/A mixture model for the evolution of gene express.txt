 High-throughput functional data is emerging as an indispensible resource for generating a complete picture of genome-wide gene and protein function. Currently, gene function is often inferred through sequence comparisons with genes of known function in other species, though sequence similarity is no guarantee of shared biological function. Gene duplication, one of the primary forces of ge-nomic evolution, often gives rise to genes with high sequence similarity but distinct biological roles [1]. Differences in temporal and spatial gene expression patterns have also been posited to explain phenotypic differences among animals despite a surprisingly large degree of gene sequence simi-larity [2]. This observation and the increasingly wide availability of genome-wide gene expression profiles from related organisms has motivated us to develop statistical models to study the evolu-tion of gene expression along phylogenies, in order to identify lineages where gene expression and therefore gene function is likely to be conserved or diverged.
 Comparing gene expression patterns between distantly related multi-cellular organisms is challeng-ing because it is difficult to collect a wide range of functionally matching tissue samples. In some cases, matching samples simply may not exist because some organismal functions have been redis-tributed among otherwise homologous organs. For example, processes such as B-cell development are performed by both distinct and overlapping sets of tissues: primarily bone marrow in mammals; Bursa of Fabricus and bone marrow in birds; and likely kidney, spleen, and/or thymus in teleost fish (who lack bone marrow) [3]. Matching samples can also be hard to collect because anatomical ar-rangements of some of the queried organisms make isolation of specific tissues virtually impossible. For example, in frog, the kidneys are immediately adjacent to the ovaries and are typically covered in oocytes. By allowing tissue samples to be mixed and heterogeneous, though functionally related, it becomes possible to compare expression patterns describing a much larger range of functions across a much larger range of organisms.
 Current detailed statistical models of expression data assume measurements from matched samples in each organism. As such, comparative studies of gene expression to date have either resorted to simple, non-phylogenetic measures to compare expression patterns [4], or restricted their compar-isons to single-cellular organisms [5] or clearly homologous tissues in mammals [6].
 Here, we present Brownian Factor Phylogenetic Analysis (BFPA), a new model of gene expres-sion evolution that removes the earlier limitations of matched samples, therefore allowing detailed comparisons of expression patterns from the widely diverged multi-cellular organisms. Our model takes as input expression profiles of orthologous genes in multiple present-day organisms and a phy-logenetic tree connecting those organisms, and simultaneously reconstructs the expression profiles for the ancestral nodes in the phylogenetic tree while detecting links in the phylogeny where rapid change of the expression profile has occurred.
 We model the expression data from related organisms using a mixture of Gaussians model related to a mixture of constrained factor analyzers [7]. In our model, each mixture component represents a different pattern of conservation and divergence of gene expression along each link of the phyloge-netic tree. We assume a constrained linear mapping between the heterogeneous samples in different organisms and fit this mapping using maximum likelihood. We show that by expanding the amount of expression data that can be compared between species, our model generates more useful infor-mation for predicting gene function and is also better able to reconstruct the evolutionary history of gene expression as evidenced by its increased accuracy in reconstructing gene expression levels. Recent evolutionary models of gene expression treat it as a quantitative (i.e. real-valued) trait and model evolutionary change in expression levels as a Brownian motion process [8, 9]. Assuming Brownian motion, a given gene X  X  expression level x from an ancestral species  X  ( s ) is predicted to be Gaussian distributed with a mean x gene X  X  expression level in the ancestor and variance  X  2 t where  X  2 represents the expected rate of change per unit time. The ancestor-child relationships are specified using a phylogeny, such as that shown in Figure 1a for the vertebrates. The leaves of the phylogeny are associated with present-day species and the internal branch points with shared ances-tors. The exact position of the root of the phylogeny (not shown in the figure, but somewhere along branch  X  X  X ) cannot be established without additional information, and the outgroup species  X  X  X  is often used in place of the root of the tree. Nonetheless, the rooted phylogeny can be interpreted as a directed Gaussian graphical model, e.g. Figure 1b, whose nodes are variables representing expres-sion levels in the corresponding species and whose directed edges point from immediate ancestors to their children species. The conditional probability distribution (CPD) at each node is given by Equation 1.
 Typical uses of these evolutionary models are to compare different hypotheses about divergence times [8] or the structure of the phylogeny [9] by calculating the likelihood of the present-day ex-thus introducing bias [10], Felsenstein developed a method called restricted maximum likelihood (REML) [11], which specifies a distribution over the observed differences between present-day ex-pression levels rather than the expression levels themselves. In the following section, we propose changes to the Brownian motion model that not only allow for unmatched tissue samples, but also leverage the change observed in expression levels across multiple genes in order to classify genes into different patterns of expression evolution. We use x i to indicate the hidden expression profile of the i -th gene (out of N ortholog groups) in species s . Figure 1: Our statistical model and associated species phylogenies. (a) The phylogeny of the species measured in our dataset of human (H), mouse (M), chicken (C), frog (F), and tetraodon (T), as well as an example phylogeny of three hypothetical species x (b) Our statistical model showing how the outgroup species x pression levels  X  x factors applied to the variance terms  X  , which are specified by each conservation pattern c . 1 de-notes no scaling on that branch, whereas  X  &gt; 1 depicts a longer, and thus unconserved, branch. This particular conservation pattern represents a phylogeny where all species have conserved expression. The scale on the bottom shows hypothetical values for x for x to exhibit significantly different expression levels (rapid change).
 The input to our model are vectors of tissue-specific expression levels {  X  x i present-day species s  X  X  P  X  o } ; we distinguish the chosen outgroup species o from the rest of the present-day species P .  X  x i our model is to infer each gene X  X  corresponding pattern of gene expression evolution (conservation pattern) { c i } N represents the internal ancestral species in the phylogenetic tree (Figure 1). The likelihood function multivariate normal distribution with mean  X  and covariance  X  : Modeling branch lengths. Equation 2 reflects the central assumption of Brownian motion models [8, 9, 10] described in Equation 1, extended in two ways. BFPA extends this concept in two directions. First, we constrain all variances  X  as tissues are known to vary widely in expression divergence rates [12]. Secondly, we note that in studying a diverse lineage such as vertebrates, we expect to see large changes in expression for genes that have diverged in function, as compared to genes of conserved function. We therefore model the drift of a gene X  X  expression levels along each branch of the tree as following one of two rates: a slow rate, reflecting a functional constraint, and a fast rate, reflecting neutral or selected change. Correspondingly, for each branch of the phylogenetic tree above the species s , we define two rate parameters,  X  2 and initialize  X  1 fast-moving genes as outliers. Our method of modelling constrained and unconstrained change as scalar multiples of a common variance is similar to the discrete gamma method [13]. Linear relationship between ancestral and child tissues. We model tissues of child species as linear combinations of ancestral tissues. The matrix of coefficients  X  the child species X  tissues to that of its parent species is heavily constrained to leverage our prior understanding of the relationships of specific tissues [14]. To construct  X  clearly homologous (i.e. the heart) had their corresponding entry in  X  entries in the same row set to zero. For the remaining tissues, literature searches were conducted to determine which groups of tissues had broadly related function (i.e. immune tissues), and those entries were allowed to vary from zero. All other entries were constrained to be zero. Distinguishing intra-and inter-species variation. Equation 3 relates the observed expression levels of present-day species to the noiseless, inferred expression levels of the corresponding hidden nodes of each observed species. The variance factor  X  noise in the array measurements, and are estimated via maximum likelihood using multiple identical probes present on each microarray.
 Conservation pattern estimation. Our goal is to identify different types of expression evolution, including punctuated evolution, fully conserved expression, or rapid change along all branches of the phylogeny. We model the problem as a mixture model of conservation patterns , in which each conservation pattern specifies either constrained or fast change along each branch of the tree. Each conservation pattern K (
K j,s  X  X  1 , 2 } can be uniquely considered. In particular, a tree containing at least one ancestor incident to two long branches and one short are ambiguous because this tree cannot be distinguished from the same tree with that ancestor incident to three long branches. As a post-processing step, we consider short branches in those cases to be long, and sum over such ambiguous trees, leaving a total of J possible conservation patterns. Each pattern K as reflected in Equation 4. Because our graphical model contains no cycles, we can apply belief propagation to perform exact inference and obtain the posterior distributions P ( c i = K We can also estimate the distributions over expression levels of a species s 0 as Applying the expectation maximization (EM) algorithm yields the following maximum likeli-hood estimates of the model parameters, where E E Although we have rooted the phylogeny using a present-day species rather than place a hypothetical root as has been done in previous Brownian motion models, these two models are related because they are equivalent under the condition that all samples are matched. First, note that in traditional Brownian motion models, the location of the root is arbitrary if one assumes a constant, improper prior over the root expression levels, since any choice of root would give rise to the same probability distribution over the expression levels. By using a present-day species with observed expression levels as the root node, we avoid integrating over this improper prior. Because the root node prior expression level is a constant times the likelihood of all present-day species expression levels. Our conditional model therefore assigns identical likelihoods and marginals as REML. We present the results of applying our model to a novel dataset consisting of gene expression mea-surements of 4770 genes with unique, unambiguous orthology, i.e., each of the 4770 genes is present in only a single copy, across the following five present-day organisms: human, mouse, chicken, frog, and tetraodon. The phylogeny related these species is shown in Figure 1 with nodes labelled by the first letter of the species name. We set Tetradon as the root, so o = T and P = { H, M, C, F } and we label the internal ancestors by concatenating the labels of their present-day descendants, so A = { HM, HM C, HM CF } .
 Replicate microarray probe intensity measurements were taken for the 4770 genes across a total of 161 tissues (i.e., 322 microarrays in total) in the five organisms: 46 tissues from human, 55 from mouse, and 20 from each of the other three organisms. We applied a standard pre-processing pipeline to the array set to remove experimental artifacts and to transform the probe intensity measurements on each array to a common, variance-stabilized scale. Each array was first spatially detrended as described in [15]. Within a species, all arrays share the same probe set, so we applied VSN [16] to the arrays from each species to estimate an array-specific affine transform to transform the probe intensities to species-specific units. We next applied an arcsinh transform to the probe intensities to make the variance of the noise independent of the intensity measurement. For the final two pre-processing steps, we placed the transformed intensity measurements into a matrix for each species. The rows of this matrix correspond to genes and the columns are the measured tissues. First, to re-move probe bias in the transformed intensities, we subtracted the row median from each element and then to attempt to transform measurements from different species to a common scale, we subtracted the column means from each element and divided by the column length.
 First, we investigate the stability of our conservation pattern estimates by using parameters trained on different random subsamples of our genes. We then evaluate the predictive value of our algorithm BFPA using two tasks: a) predicting gene expression profiles in a new species given expression profiles in other species, and b) predicting Gene Ontology annotation using the conservation pattern inferred by our model.
 To perform the stability experiments, we first randomly split the dataset into five subsets, and used each subset individually to train the model using 100 iterations of EM. We then estimated P ( c i |  X  x i for the four other subsets of genes, and classified each gene into its most likely conservation pattern. Hence, each gene is classified four times by non-overlapping training sets. Figure 2 shows that the classifications are quite stable and that most genes are classified into few conservation patterns. Most genes that were uniquely classified into a single conservation pattern either were classified as fully (all) conserved or completely unconserved, resulting in relatively few high-confidence lineage-specific genes. 6.1 Functional associations of co-transcriptionally evolving genes Pairs of genes exhibiting correlated expression also tend to perform similar function. This guilt-by-association principle is often used to initially assign putative functions to genes. For example, a popular method for analyzing gene expression datasets is to cluster genes based on the pairwise Figure 2: Stability of conservation pattern assignments to genes . (left) Each gene was placed into one of four bins, denoting the number of unique patterns it was classified into. Most genes were consistently classified into one conservation pattern for all four of its independent classifications. (right) For all genes uniquely classified into a single conservation pattern, the number of present-day species adjacent to conserved links was computed. Most genes were either classified as fully (all) conserved or completely unconserved.
 Pearson correlation coefficient (PCC), then measure the enrichment of these clusters in Gene On-tology (GO) function and process annotations [17]. In this section, we introduce the evolutionary correlation coefficient (ECC), a simple modification of PCC to integrate model predictions, and ex-amine whether genes with the same annotated function are more similar in rank according the ECC or PCC measures. ECC scales the positively-transformed PCC by the marginal probability of the genes following the same expression evolution, assuming independent evolution.
 ECC can be applied using the output of either BFPA or the Brownian model. For the Brownian model, we trained and made predictions using only those matched samples in all five species. Those ten samples are the central nervous system (CNS), intestine, heart, kidney, liver, eye, muscle, spleen, stomach, and testis. We also introduce ECC-sequence, designed to measure the value of evolutionary information derived from sequence. First, the protein sequences of each gene were aligned using default parameters of MUSCLE [18]. These alignments were then inputted into PAML [19] together with the species tree shown in Figure 1 to estimate branch lengths. The PCC measure for each pair of genes was then scaled by the Pearson correlation coefficient of the branch lengths estimated by PAML to produce ECC-sequence.
 For all models, we first used the ECC/PCC similarity metric for each gene to rank all other genes in order of expression similarity. We then apply the Wilcoxon Rank Sum test to evaluate whether genes with the same GO annotations, as annotated for the mouse ortholog, are significantly higher in rank than all other genes. For this analysis, we only considered GO Process categories which have at least one of the 4770 genes annotated in that category. We also removed all genes which were not annotated in any category, resulting in a total of 3319 genes and 4246 categories.
 Figure 3 illustrates the distribution of smallest p -values achieved by each gene over all of their anno-tated functions. PCC is used as a baseline performance measure as it does not consider evolutionary information. We see that all evolutionary-based models outperform PCC in ranking genes with sim-ilar function much closer on average. ECC-sequence performs worse than PCC, suggesting that expression-based evolutionary metrics may provide additional information compared to those based on sequence. The relative performance of BFPA versus Brownian reflects an overall significant per-formance gap between our models and the existing ones. A control measure ECC-random is shown, which is computed by randomizing the gene labels of the data in each of the five organisms before learning. Finally, Brown+prior measures the performance of the Brownian model when the conser-vation pattern priors are allowed to be estimated, and performs better than the Brownian model but worse than BFPA, as expected. All differences between the distributions are statistically significant, as all pairwise p -values computed by the Kolmogorov-Smirnov test are less than 10  X  6 . Figure 3: Model performance. (left) A reverse cumulative distribution plot of p -values obtained from applying the Wilcoxon Rank Sum test using either a PCC or ECC-based similarity metric. The smallest p -value achieved for each gene across all its annotated functions is used in the distribution. translate into stronger associations between expression levels and gene function, which we interpret as better performance. (right) This graph shows the difference in the total number of expression values for which a particular method achieves the lowest error, sorted by species. 6.2 Reconstruction of gene expression levels Here we report the performance of our model in predicting the expression level of a gene in each of human, mouse, chicken, and frog, given its expression levels in the other species. Tetraodon is not predicted because it acts as an outgroup in our model. The model was trained using 100 EM iterations on half of the dataset, which was then used to predict the expression levels for each gene in each species in the other half of the dataset, and vice versa. To create a baseline performance expression level of a gene in the fifth species. We only compute predictions for the ten matched samples across all species so that we can compare errors made by our model against those of Brow-nian and the baseline, which require matched samples. Figure 3 shows that with the exception of the comparison against Brownian in chicken, BFPA achieves lower error than both Brownian and baseline in predicting expression measurements. We have presented a new model for the simultaneous evolution of gene expression levels across mul-tiple tissues and organs. Given expression data from present-day species, our model can be used to simultaneously infer the ancestral expression levels of orthologous genes as well as determine where in the phylogeny the gene expression levels underwent substantial change. BFPA extends previous Brownian models [8, 9] by introducing a constrained factor analysis framework to account for com-plex tissue relationships between different species and by adapting the discrete gamma method [13] to model quantitative gene expression data. Our model performs better than other Brownian models in functional association and expression prediction experiments, demonstrating that the evolution-ary history we infer better recovers the function of the gene. We have shown that this is in large part due to our ability to consider species-specific tissue measurements, a feature not implemented in any existing model to the best of our knowledge. We also showed that gene expression-based phylogenetic data may provide information not contained in sequence-based phylogenetic data in terms of helping predict the functional association of genes.
 Our model has a number of other applications outside of using it to study the evolutionary history of gene expression. Our ability to identify genes with conserved expression across multiple species will help in the inference of gene function from annotated to non-annotated species because unconserved expression patterns indicate a likely change in the biological function of a gene. We also expect identification of transcriptional cis -regulatory elements by focusing the search for cis -elements to those species identified as conserved in expression.
 While we have taken different profiled samples as representing different tissues, our methodology can be easily expanded to study evolutionary change in gene expression in response to different also easily extendible to other model organisms for which there are genomes and expression data for multiple closely related species (e.g. yeast, worm, fly, plants). We anticipate that the results obtained will be invaluable in the study of genome evolution and identification of cis -regulatory elements, whose phylogeny should reflect that of the gene expression patterns.
 All data used in this publication can be obtained by a request to the authors.
 References
